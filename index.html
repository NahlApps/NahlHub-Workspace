<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>NahlHub</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet" />

  <style>
    :root {
      --bg-light: #f5f7f8;
      --bg-dark: #020617;
      --card-light: #ffffff;
      --card-dark: #020617;
      --border-light: rgba(15, 23, 42, 0.08);
      --border-dark: rgba(148, 163, 184, 0.25);
      --accent: #f4ce14;
      --accent-soft: rgba(244, 206, 20, 0.12);
      --text-light: #0f172a;
      --text-dark: #e5e7eb;
      --muted-light: #6b7280;
      --muted-dark: #9ca3af;
      --surface-radius: 18px;
      --transition-fast: 0.18s ease-out;
    }

    * { box-sizing: border-box; }

    html, body {
      margin: 0; padding: 0; height: 100%;
      font-family: "Cairo", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body[data-theme="light"] {
      background: radial-gradient(circle at top left, rgba(244, 206, 20, 0.18), transparent 55%), var(--bg-light);
      color: var(--text-light);
    }

    body[data-theme="dark"] {
      background: radial-gradient(circle at top left, rgba(250, 204, 21, 0.14), transparent 50%),
        linear-gradient(145deg, #020617, #020617);
      color: var(--text-dark);
    }

    .app-shell {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 6px;
      gap: 8px;
      position: relative;
    }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid;
      backdrop-filter: blur(14px);
      gap: 12px;
      position: relative;
      z-index: 10;
    }

    body[data-theme="light"] .topbar { background: rgba(255,255,255,0.9); border-color: var(--border-light); }
    body[data-theme="dark"]  .topbar { background: rgba(15,23,42,0.9); border-color: var(--border-dark); }

    .topbar-left { display:flex; align-items:center; gap:10px; min-width:0; }

    .brand-logo {
      width: 30px; height: 30px; border-radius: 11px;
      display:flex; align-items:center; justify-content:center;
      font-weight:700; font-size:18px;
      background: radial-gradient(circle at 20% 0, #facc15, #f97316);
      color:#111827;
    }

    .brand-text { display:flex; flex-direction:column; gap:0; font-size:13px; line-height:1.2; }
    .brand-title { font-weight:700; letter-spacing:0.02em; white-space:nowrap; }
    .brand-subtitle { font-size:11px; opacity:0.75; }

    .topbar-right { display:flex; align-items:center; gap:6px; }

    .chip-group {
      display:inline-flex; padding:2px; border-radius:999px;
      border:1px solid transparent; background:transparent; gap:2px;
    }
    body[data-theme="light"] .chip-group { border-color: rgba(148,163,184,0.42); background: rgba(255,255,255,0.9); }
    body[data-theme="dark"]  .chip-group { border-color: rgba(148,163,184,0.4);  background: rgba(15,23,42,0.95); }

    .chip-btn {
      border:none; outline:none; border-radius:999px;
      padding:4px 10px; font-size:11px; cursor:pointer;
      background:transparent; color:inherit;
      display:inline-flex; align-items:center; justify-content:center; gap:6px;
      transition: background var(--transition-fast), color var(--transition-fast), transform var(--transition-fast), box-shadow var(--transition-fast);
      white-space:nowrap;
    }
    .chip-btn span.icon { font-size:13px; line-height:1; }

    .chip-btn.active {
      background: var(--accent);
      color:#111827;
      box-shadow: 0 6px 18px rgba(250,204,21,0.4);
      transform: translateY(-0.5px);
    }

    .chip-btn:not(.active):hover { background: rgba(148,163,184,0.25); }
    body[data-theme="dark"] .chip-btn:not(.active):hover { background: rgba(31,41,55,0.8); }

    .chip-btn-mini { border-radius:999px; padding:5px 7px; font-size:11px; }

    .status-pill {
      align-self: stretch;
      margin: 0 4px;
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: 1px solid transparent;
      max-width: 100%;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }
    body[data-theme="light"] .status-pill { background: rgba(255,255,255,0.9); border-color: var(--border-light); color: var(--muted-light); }
    body[data-theme="dark"]  .status-pill { background: rgba(15,23,42,0.9); border-color: var(--border-dark);  color: var(--muted-dark); }

    .status-pill.ok { border-color: rgba(34,197,94,0.7); color: rgba(34,197,94,0.95); }
    .status-pill.error { border-color: rgba(239,68,68,0.85); color: rgba(248,113,113,0.96); }

    .status-dot { width:7px; height:7px; border-radius:999px; background: var(--accent); }

    .main-panel { flex:1; display:flex; flex-direction:column; gap:8px; min-height:0; }

    .welcome-card {
      border-radius: var(--surface-radius);
      padding: 12px 14px;
      border: 1px solid;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    body[data-theme="light"] .welcome-card {
      background: linear-gradient(135deg, rgba(244,206,20,0.12), rgba(255,255,255,0.96));
      border-color: var(--border-light);
    }
    body[data-theme="dark"] .welcome-card {
      background: linear-gradient(145deg, rgba(250,204,21,0.16), rgba(15,23,42,0.96));
      border-color: rgba(148,163,184,0.45);
    }

    .welcome-header-line { display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .welcome-title { font-size:16px; font-weight:700; }
    .welcome-sub { font-size:12px; opacity:0.85; }

    .card {
      border-radius: var(--surface-radius);
      padding: 12px 14px 14px;
      border: 1px solid;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    body[data-theme="light"] .card { background: #fff; border-color: var(--border-light); }
    body[data-theme="dark"]  .card  { background: rgba(15,23,42,0.96); border-color: var(--border-dark); }

    .card-header { display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .card-title { font-size:15px; font-weight:600; }
    .card-caption { font-size:12px; opacity:0.7; }
    .card-body { display:flex; flex-direction:column; gap:10px; }

    .field-group { display:flex; flex-direction:column; gap:6px; }
    .field-label { font-size:12px; opacity:0.85; }

    .btn {
      border-radius: 999px;
      border: none;
      outline: none;
      padding: 9px 18px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: transform var(--transition-fast), box-shadow var(--transition-fast), background var(--transition-fast), color var(--transition-fast), opacity var(--transition-fast);
      white-space: nowrap;
    }

    .btn-primary {
      background: var(--accent);
      color: #111827;
      box-shadow: 0 8px 20px rgba(250,204,21,0.45);
    }
    .btn-primary:hover:enabled {
      transform: translateY(-0.5px);
      box-shadow: 0 10px 28px rgba(250,204,21,0.6);
    }
    .btn:disabled { opacity:0.6; cursor:default; box-shadow:none; transform:none; }

    .btn-ghost {
      background: transparent;
      color: inherit;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 11px;
      border: none;
      cursor: pointer;
    }
    body[data-theme="light"] .btn-ghost:hover { background: rgba(148,163,184,0.18); }
    body[data-theme="dark"] .btn-ghost:hover { background: rgba(31,41,55,0.9); }

    .otp-row { display:flex; align-items:center; justify-content:center; gap:10px; direction:ltr; }
    .otp-input {
      width:44px; height:44px; text-align:center;
      font-size:18px; font-weight:600;
      border-radius:16px; border:1px solid; outline:none;
      transition: border-color var(--transition-fast), box-shadow var(--transition-fast), background var(--transition-fast);
    }
    body[data-theme="light"] .otp-input { background: rgba(248,250,252,0.96); border-color: rgba(148,163,184,0.5); color: var(--text-light); }
    body[data-theme="dark"]  .otp-input { background: rgba(15,23,42,0.97); border-color: rgba(148,163,184,0.7); color: var(--text-dark); }

    .otp-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(250,204,21,0.55);
      background: rgba(255,251,235,0.96);
    }
    body[data-theme="dark"] .otp-input:focus { background: rgba(15,23,42,1); }

    .apps-layout { display:flex; flex-direction:column; gap:12px; min-height:0; flex:1; }
    .apps-header-row { display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap; }

    .workspace-card {
      flex:1; min-width:260px;
      display:flex; align-items:center; justify-content:space-between; gap:8px;
      border-radius:999px; padding:8px 12px; border:1px solid;
      cursor:pointer; position:relative;
      transition: box-shadow var(--transition-fast), border-color var(--transition-fast), background var(--transition-fast), transform var(--transition-fast);
    }
    body[data-theme="light"] .workspace-card { background: rgba(255,255,255,0.9); border-color: rgba(148,163,184,0.35); }
    body[data-theme="dark"]  .workspace-card { background: rgba(15,23,42,0.95); border-color: rgba(148,163,184,0.6); }

    .workspace-card:hover {
      box-shadow: 0 10px 28px rgba(15,23,42,0.12);
      border-color: rgba(250,204,21,0.7);
      transform: translateY(-0.5px);
    }

    .workspace-meta { display:flex; flex-direction:column; gap:2px; min-width:0; }
    .workspace-label { font-size:11px; opacity:0.7; }

    .workspace-name-row { display:flex; align-items:baseline; gap:6px; min-width:0; }

    .workspace-name {
      font-size:13px; font-weight:600;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      max-width:220px;
    }
    .workspace-role-pill {
      font-size:10px; padding:2px 7px; border-radius:999px;
      background: rgba(34,197,94,0.1); color:#15803d;
    }
    body[data-theme="dark"] .workspace-role-pill { background: rgba(34,197,94,0.2); color:#bbf7d0; }

    .workspace-dropdown-icon {
      width:24px; height:24px; border-radius:999px;
      display:flex; align-items:center; justify-content:center;
      font-size:13px; border:1px solid transparent;
    }
    body[data-theme="light"] .workspace-dropdown-icon { background: rgba(248,250,252,0.9); border-color: rgba(148,163,184,0.45); }
    body[data-theme="dark"]  .workspace-dropdown-icon { background: rgba(15,23,42,0.9); border-color: rgba(148,163,184,0.7); }

    .workspace-menu {
      position:absolute;
      inset-inline-start:0;
      inset-block-start:110%;
      min-width:100%;
      max-width:340px;
      border-radius:18px;
      border:1px solid;
      padding:6px;
      z-index:15;
      box-shadow: 0 18px 40px rgba(15,23,42,0.45);
    }
    body[data-theme="light"] .workspace-menu { background:#fff; border-color: rgba(148,163,184,0.4); }
    body[data-theme="dark"]  .workspace-menu { background: rgba(15,23,42,0.98); border-color: rgba(148,163,184,0.65); }

    .workspace-menu-item {
      width:100%;
      border-radius:12px;
      border:1px solid transparent;
      padding:6px 8px;
      font-size:12px;
      display:flex; align-items:center; justify-content:space-between; gap:6px;
      background:transparent; color:inherit;
      cursor:pointer; text-align:start;
      transition: background var(--transition-fast), border-color var(--transition-fast), transform var(--transition-fast);
    }

    .workspace-menu-item-main { display:flex; flex-direction:column; gap:2px; flex:1; min-width:0; }
    .workspace-menu-item-name { font-weight:500; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .workspace-menu-item-meta { font-size:11px; opacity:0.7; }

    .workspace-menu-item-role {
      font-size:10px; padding:1px 6px; border-radius:999px;
      background: rgba(34,197,94,0.08); color:#15803d;
    }
    body[data-theme="dark"] .workspace-menu-item-role { background: rgba(34,197,94,0.16); color:#bbf7d0; }

    body[data-theme="light"] .workspace-menu-item:hover { background: rgba(248,250,252,0.9); border-color: rgba(148,163,184,0.4); }
    body[data-theme="dark"]  .workspace-menu-item:hover { background: rgba(30,64,175,0.2); border-color: rgba(129,140,248,0.6); }

    .workspace-menu-item.active {
      border-color: rgba(250,204,21,0.9);
      background: rgba(250,204,21,0.12);
    }

    .view-toggle-group {
      display:inline-flex;
      border-radius:999px;
      padding:3px;
      border:1px solid transparent;
      background:transparent;
      gap:2px;
    }
    body[data-theme="light"] .view-toggle-group { border-color: rgba(148,163,184,0.35); background: rgba(255,255,255,0.9); }
    body[data-theme="dark"]  .view-toggle-group { border-color: rgba(148,163,184,0.5);  background: rgba(15,23,42,0.95); }

    .view-toggle-btn {
      border-radius:999px; border:none;
      padding:5px 10px; font-size:11px; cursor:pointer;
      display:inline-flex; align-items:center; gap:5px;
      background:transparent; color:inherit;
      transition: background var(--transition-fast), color var(--transition-fast), box-shadow var(--transition-fast), transform var(--transition-fast);
    }
    .view-toggle-btn span.icon { font-size:13px; }
    .view-toggle-btn.active {
      background: var(--accent);
      color:#111827;
      box-shadow: 0 6px 18px rgba(250,204,21,0.4);
      transform: translateY(-0.5px);
    }
    .view-toggle-btn:not(.active):hover { background: rgba(148,163,184,0.18); }
    body[data-theme="dark"] .view-toggle-btn:not(.active):hover { background: rgba(31,41,55,0.9); }

    .apps-section-card {
      border-radius: var(--surface-radius);
      padding: 12px 14px 14px;
      border: 1px solid;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    body[data-theme="light"] .apps-section-card { background:#fff; border-color: var(--border-light); }
    body[data-theme="dark"]  .apps-section-card { background: rgba(15,23,42,0.96); border-color: var(--border-dark); }

    .apps-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap:10px; }

    .app-card {
      border-radius:16px; border:1px solid;
      padding:10px; display:flex; flex-direction:column; gap:6px;
      transition: background var(--transition-fast), border-color var(--transition-fast), transform var(--transition-fast), box-shadow var(--transition-fast);
      cursor:pointer;
    }
    body[data-theme="light"] .app-card { background: rgba(255,255,255,0.96); border-color: rgba(148,163,184,0.35); }
    body[data-theme="dark"]  .app-card { background: rgba(15,23,42,0.96); border-color: rgba(148,163,184,0.55); }

    .app-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 26px rgba(15,23,42,0.18);
      border-color: rgba(250,204,21,0.9);
    }

    .app-card-header { display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .app-card-main { display:flex; align-items:center; gap:8px; min-width:0; }

    .app-card-icon {
      width:30px; height:30px; border-radius:999px;
      display:flex; align-items:center; justify-content:center;
      font-size:16px;
      background: rgba(244,206,20,0.15);
      color:#92400e;
      flex-shrink:0;
    }
    body[data-theme="dark"] .app-card-icon { background: rgba(250,204,21,0.16); color:#fbbf24; }

    .app-card-title { font-size:13px; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .app-card-tagline { font-size:11px; opacity:0.75; }
    .app-card-body { font-size:11px; opacity:0.78; height:2.4em; overflow:hidden; }

    .app-card-footer { display:flex; align-items:center; justify-content:space-between; font-size:11px; opacity:0.82; margin-top:4px; }

    .badge-soft { border-radius:999px; padding:2px 6px; font-size:10px; background: rgba(148,163,184,0.14); }
    .badge-installed { border-radius:999px; padding:2px 7px; font-size:10px; background: rgba(250,204,21,0.15); color:#92400e; }
    body[data-theme="dark"] .badge-installed { background: rgba(250,204,21,0.22); color:#facc15; }

    .app-card-actions { display:flex; gap:6px; }

    .btn-pill-sm {
      border-radius:999px; border:none;
      padding:4px 9px; font-size:10px; cursor:pointer;
      display:inline-flex; align-items:center; gap:4px;
      background: rgba(148,163,184,0.18);
      color:inherit;
      transition: background var(--transition-fast), transform var(--transition-fast);
    }
    .btn-pill-sm.primary { background: var(--accent); color:#111827; }
    .btn-pill-sm:hover { transform: translateY(-0.5px); }

    .app-view-card {
      border-radius: var(--surface-radius);
      padding: 12px 14px;
      border: 1px solid;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 240px;
    }
    body[data-theme="light"] .app-view-card { background:#fff; border-color: var(--border-light); }
    body[data-theme="dark"]  .app-view-card { background: rgba(15,23,42,0.96); border-color: var(--border-dark); }

    .app-view-header {
      display:flex; align-items:center; justify-content:space-between; gap:8px;
      border-bottom:1px solid;
      padding-bottom:6px;
    }
    body[data-theme="light"] .app-view-header { border-color: rgba(148,163,184,0.25); }
    body[data-theme="dark"]  .app-view-header { border-color: rgba(51,65,85,0.9); }

    .app-view-title { font-size:13px; font-weight:600; }
    .app-view-sub { font-size:11px; opacity:0.7; }

    .app-frame-wrap { width:100%; height: calc(100vh - 230px); max-height: calc(100vh - 220px); margin-top:4px; }
    .app-frame { width:100%; height:100%; border:none; display:block; background:transparent; }
    .app-frame-placeholder { width:100%; height:100%; display:flex; align-items:center; justify-content:center; font-size:12px; opacity:0.6; padding:10px; text-align:center; }

    .hidden { display:none !important; }

    .auth-overlay {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 12px;
      z-index: 30;
      backdrop-filter: blur(10px);
    }
    body[data-theme="light"] .auth-overlay {
      background: radial-gradient(circle at top, rgba(148,163,184,0.16), transparent 60%), rgba(15,23,42,0.18);
    }
    body[data-theme="dark"] .auth-overlay {
      background: radial-gradient(circle at top, rgba(15,23,42,0.95), rgba(15,23,42,0.98));
    }

    .auth-modal {
      width: 100%;
      max-width: 420px;
      border-radius: 22px;
      border: 1px solid;
      padding: 14px 12px 12px;
      box-shadow: 0 18px 40px rgba(15,23,42,0.55);
    }
    body[data-theme="light"] .auth-modal {
      background: linear-gradient(140deg, rgba(244,206,20,0.12), #ffffff);
      border-color: rgba(148,163,184,0.5);
    }
    body[data-theme="dark"] .auth-modal {
      background: radial-gradient(circle at top left, rgba(250,204,21,0.18), transparent 50%), rgba(15,23,42,0.98);
      border-color: rgba(148,163,184,0.6);
    }

    .auth-modal-header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 2px 4px 10px;
    }
    .auth-title { font-size:15px; font-weight:700; }
    .auth-sub { font-size:12px; opacity:0.78; }
    .auth-badge {
      font-size: 11px;
      border-radius: 999px;
      padding: 3px 8px;
      border: 1px solid rgba(148,163,184,0.6);
      opacity: 0.9;
    }
    .auth-modal-body { display:flex; flex-direction:column; gap:10px; }

    .input {
      flex:1;
      border-radius: 999px;
      border: 1px solid;
      padding: 8px 12px;
      font-size: 13px;
      outline: none;
      transition: border-color var(--transition-fast), box-shadow var(--transition-fast), background var(--transition-fast);
    }
    body[data-theme="light"] .input { background: rgba(248,250,252,0.95); border-color: rgba(148,163,184,0.5); color: var(--text-light); }
    body[data-theme="dark"]  .input { background: rgba(15,23,42,0.96); border-color: rgba(148,163,184,0.6); color: var(--text-dark); }

    .input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(250,204,21,0.55);
      background: rgba(255,251,235,0.9);
    }
    body[data-theme="dark"] .input:focus { background: rgba(15,23,42,0.98); }

    .dev-row {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      margin-top:6px;
      padding-top:8px;
      border-top: 1px dashed rgba(148,163,184,0.35);
    }

    .btn-link {
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 11px;
      opacity: 0.85;
      text-decoration: underline;
      color: inherit;
    }

    @media (min-width: 768px) {
      .app-shell { padding: 6px 10px; }
      .app-frame-wrap { height: calc(100vh - 210px); max-height: calc(100vh - 190px); }
    }
  </style>
</head>

<body data-theme="light">
  <div class="app-shell">
    <header class="topbar">
      <div class="topbar-left">
        <div class="brand-logo">N</div>
        <div class="brand-text">
          <div class="brand-title" data-i18n="hubTitle">NahlHub</div>
          <div class="brand-subtitle" data-i18n="hubSub">ØªØ·Ø¨ÙŠÙ‚Ø§ØªÙƒ ÙÙŠ Ù†Ø­Ù„ Ù‡Ø¨</div>
        </div>
      </div>

      <div class="topbar-right">
        <div class="chip-group">
          <button class="chip-btn" id="btnLangAr" type="button" data-lang="ar"><span>Ø¹Ø±Ø¨ÙŠ</span></button>
          <button class="chip-btn" id="btnLangEn" type="button" data-lang="en"><span>EN</span></button>
        </div>
        <button class="chip-btn chip-btn-mini" id="btnTheme" type="button">
          <span class="icon" id="themeIcon">ğŸŒ</span>
        </button>
      </div>
    </header>

    <div id="statusPill" class="status-pill">
      <span class="status-dot"></span>
      <span id="statusText"></span>
    </div>

    <div id="authOverlay" class="auth-overlay">
      <div class="auth-modal">
        <div class="auth-modal-header">
          <div>
            <div class="auth-title" data-i18n="welcomeTitle">Ù…Ø±Ø­Ø¨Ø§Ù‹ ğŸ‘‹</div>
            <div class="auth-sub" data-i18n="welcomeSub">Ø§Ø¯Ø®Ù„ Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø«Ù… Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„.</div>
          </div>
          <div class="auth-badge">
            <span data-i18n="step1Title">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</span> Â·
            <span data-i18n="step2Title">Ø±Ù…Ø²</span>
          </div>
        </div>

        <div class="auth-modal-body">
          <section id="stepMobile" class="card" style="margin:0">
            <div class="card-header">
              <div>
                <div class="card-title" data-i18n="step1Title">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</div>
                <div class="card-caption" data-i18n="step1Sub">Ø§Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„.</div>
              </div>
            </div>
            <div class="card-body">
              <div class="field-group">
                <label class="field-label" for="mobileInput" data-i18n="step1Label">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label>
                <input id="mobileInput" class="input" type="tel" inputmode="tel" autocomplete="tel" placeholder="5XXXXXXXX" />
              </div>
              <div style="display:flex; justify-content:flex-end; margin-top:6px;">
                <button id="btnSendOtp" class="btn btn-primary" type="button">
                  <span data-i18n="btnSendOtp">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²</span>
                </button>
              </div>

              <div class="dev-row">
                <button id="btnPing" class="btn-link" type="button">Ping API</button>
                <span style="font-size:11px; opacity:.7" id="devInfo"></span>
              </div>
            </div>
          </section>

          <section id="stepOtp" class="card hidden" style="margin:0">
            <div class="card-header">
              <div>
                <div class="card-title" data-i18n="step2Title">Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
                <div class="card-caption" data-i18n="step2Sub">Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ù¤ Ø£Ø±Ù‚Ø§Ù….</div>
              </div>
              <button type="button" class="btn-ghost" id="btnChangeMobile">
                <span data-i18n="changeMobile">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ù‚Ù…</span>
              </button>
            </div>
            <div class="card-body">
              <div class="otp-row">
                <input class="otp-input" id="otp1" type="tel" inputmode="numeric" maxlength="1" />
                <input class="otp-input" id="otp2" type="tel" inputmode="numeric" maxlength="1" />
                <input class="otp-input" id="otp3" type="tel" inputmode="numeric" maxlength="1" />
                <input class="otp-input" id="otp4" type="tel" inputmode="numeric" maxlength="1" />
              </div>

              <div style="display:flex; justify-content:flex-end; margin-top:10px;">
                <button id="btnVerifyOtp" class="btn btn-primary" type="button">
                  <span data-i18n="btnVerify">ØªØ£ÙƒÙŠØ¯</span>
                </button>
              </div>
            </div>
          </section>
        </div>

      </div>
    </div>

    <main class="main-panel">
      <section class="welcome-card" id="welcomeCard">
        <div class="welcome-header-line">
          <div>
            <div class="welcome-title" data-i18n="welcomeTitle">Ù…Ø±Ø­Ø¨Ø§Ù‹ ğŸ‘‹</div>
            <div class="welcome-sub" data-i18n="welcomeSub">Ø§Ø¯Ø®Ù„ Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø«Ù… Ø§Ø®ØªØ± Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„ ÙˆØ§Ù„ØªØ·Ø¨ÙŠÙ‚.</div>
          </div>
        </div>
      </section>

      <section id="stepApps" class="apps-layout hidden">
        <div class="apps-header-row">
          <div class="workspace-card" id="workspaceCard">
            <div class="workspace-meta">
              <div class="workspace-label" data-i18n="workspaceLabel">Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„</div>
              <div class="workspace-name-row">
                <div class="workspace-name" id="workspaceName">â€”</div>
                <span class="workspace-role-pill" id="workspaceRole">â€”</span>
              </div>
            </div>
            <div class="workspace-dropdown-icon"><span id="workspaceChevron">â–¾</span></div>
            <div id="workspaceMenu" class="workspace-menu hidden"></div>
          </div>

          <div class="view-toggle-group">
            <button id="btnViewApps" type="button" class="view-toggle-btn active">
              <span class="icon">âš™ï¸</span>
              <span data-i18n="viewApps">Apps</span>
            </button>
            <button id="btnViewMarketplace" type="button" class="view-toggle-btn">
              <span class="icon">ğŸ›’</span>
              <span data-i18n="viewMarketplace">Marketplace</span>
            </button>
          </div>

          <button class="btn-ghost" type="button" id="btnLogout">
            <span data-i18n="logout">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</span>
          </button>
        </div>

        <section id="sectionApps" class="apps-section-card">
          <div class="card-header" style="padding:0;">
            <div>
              <div class="card-title" data-i18n="yourAppsTitle">ØªØ·Ø¨ÙŠÙ‚Ø§ØªÙƒ</div>
              <div class="card-caption" id="userNameLabel"></div>
            </div>
          </div>
          <div class="card-body">
            <div id="appsGrid" class="apps-grid"></div>
          </div>
        </section>

        <section id="sectionMarketplace" class="apps-section-card hidden">
          <div class="card-header" style="padding:0;">
            <div>
              <div class="card-title" data-i18n="marketplaceTitle">App Marketplace</div>
              <div class="card-caption" data-i18n="marketplaceSub">Ø§Ø®ØªØ± Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„ ÙˆØ«Ø¨Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ù„ÙØ±ÙŠÙ‚Ùƒ.</div>
            </div>
          </div>
          <div class="card-body">
            <div id="marketplaceGrid" class="apps-grid"></div>
          </div>
        </section>

        <section id="sectionAppView" class="app-view-card hidden">
          <div class="app-view-header">
            <div>
              <div id="appViewTitle" class="app-view-title">NahlHub App</div>
              <div id="appViewSub" class="app-view-sub" data-i18n="appViewSub">
                Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¸Ø§Ù‡Ø± Ø¯Ø§Ø®Ù„ Ù†Ø­Ù„ Ù‡Ø¨. Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª.
              </div>
            </div>
            <button id="btnBackFromApp" type="button" class="btn-ghost">
              â† <span data-i18n="backToApps">Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª</span>
            </button>
          </div>
          <div class="app-frame-wrap">
            <iframe id="appFrame" class="app-frame hidden" src="" title="NahlHub App"></iframe>
            <div id="appFramePlaceholder" class="app-frame-placeholder">
              <span data-i18n="appPlaceholder">Ø§Ø®ØªØ± ØªØ·Ø¨ÙŠÙ‚Ø§Ù‹ Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø£Ùˆ Ù…Ù† Ø§Ù„Ù…ØªØ¬Ø±.</span>
            </div>
          </div>
        </section>
      </section>
    </main>
  </div>

  <script>
    (function () {
      "use strict";

      var HUB_APP_ID = "HUB";
      var API_URL = "/api/hub/manage";

      var STORAGE_SESSION_KEY = "nahlhub_session_key";
      var STORAGE_LANG = "nahlhub_lang";
      var STORAGE_THEME = "nahlhub_theme";

      var currentLang = localStorage.getItem(STORAGE_LANG) || "ar";
      var currentTheme = localStorage.getItem(STORAGE_THEME) || "light";
      var currentSessionKey = localStorage.getItem(STORAGE_SESSION_KEY) || null;

      var currentUser = null;
      var currentMobileRaw = "";
      var currentWorkspaces = [];
      var currentWorkspaceId = null;
      var currentWorkspaceRole = "";
      var currentWorkspaceApps = [];
      var currentTemplates = [];
      var currentMainView = "apps";

      var bodyEl = document.body;
      var statusPill = document.getElementById("statusPill");
      var statusText = document.getElementById("statusText");

      var welcomeCard = document.getElementById("welcomeCard");
      var authOverlay = document.getElementById("authOverlay");
      var stepMobile = document.getElementById("stepMobile");
      var stepOtp = document.getElementById("stepOtp");
      var stepApps = document.getElementById("stepApps");

      var mobileInput = document.getElementById("mobileInput");
      var btnSendOtp = document.getElementById("btnSendOtp");

      var otpInputs = [
        document.getElementById("otp1"),
        document.getElementById("otp2"),
        document.getElementById("otp3"),
        document.getElementById("otp4")
      ];

      var btnVerifyOtp = document.getElementById("btnVerifyOtp");
      var btnChangeMobile = document.getElementById("btnChangeMobile");

      var workspaceCard = document.getElementById("workspaceCard");
      var workspaceMenu = document.getElementById("workspaceMenu");
      var workspaceNameEl = document.getElementById("workspaceName");
      var workspaceRoleEl = document.getElementById("workspaceRole");

      var btnViewApps = document.getElementById("btnViewApps");
      var btnViewMarketplace = document.getElementById("btnViewMarketplace");

      var sectionApps = document.getElementById("sectionApps");
      var sectionMarketplace = document.getElementById("sectionMarketplace");
      var sectionAppView = document.getElementById("sectionAppView");

      var appsGrid = document.getElementById("appsGrid");
      var marketplaceGrid = document.getElementById("marketplaceGrid");

      var appFrame = document.getElementById("appFrame");
      var appFramePlaceholder = document.getElementById("appFramePlaceholder");
      var appViewTitle = document.getElementById("appViewTitle");

      var btnBackFromApp = document.getElementById("btnBackFromApp");
      var btnLogout = document.getElementById("btnLogout");

      var btnTheme = document.getElementById("btnTheme");
      var themeIcon = document.getElementById("themeIcon");
      var btnLangAr = document.getElementById("btnLangAr");
      var btnLangEn = document.getElementById("btnLangEn");

      var userNameLabel = document.getElementById("userNameLabel");

      var btnPing = document.getElementById("btnPing");
      var devInfo = document.getElementById("devInfo");

      // ---------------- i18n ----------------
      var tDict = {
        hubTitle: { ar: "NahlHub", en: "NahlHub" },
        hubSub: { ar: "ØªØ·Ø¨ÙŠÙ‚Ø§ØªÙƒ ÙÙŠ Ù†Ø­Ù„ Ù‡Ø¨", en: "Your apps in NahlHub" },
        welcomeTitle: { ar: "Ù…Ø±Ø­Ø¨Ø§Ù‹ ğŸ‘‹", en: "Welcome ğŸ‘‹" },
        welcomeSub: { ar: "Ø§Ø¯Ø®Ù„ Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø«Ù… Ø§Ø®ØªØ± Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„ ÙˆØ§Ù„ØªØ·Ø¨ÙŠÙ‚.", en: "Enter your mobile, then choose workspace and app." },
        step1Title: { ar: "Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„", en: "Mobile number" },
        step1Sub: { ar: "Ø§Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„.", en: "Enter your mobile." },
        step1Label: { ar: "Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„", en: "Mobile" },
        btnSendOtp: { ar: "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²", en: "Send code" },
        step2Title: { ar: "Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„", en: "Login code" },
        step2Sub: { ar: "Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ù¤ Ø£Ø±Ù‚Ø§Ù….", en: "Enter the 4-digit code." },
        changeMobile: { ar: "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ù‚Ù…", en: "Change number" },
        btnVerify: { ar: "ØªØ£ÙƒÙŠØ¯", en: "Confirm" },
        logout: { ar: "ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬", en: "Logout" },
        statusIdle: { ar: "Ø¬Ø§Ù‡Ø².", en: "Ready." },
        statusSendingOtp: { ar: "ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø² Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨...", en: "Sending WhatsApp code..." },
        statusOtpSent: { ar: "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø² Ø¹Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨.", en: "Code sent via WhatsApp." },
        statusVerifying: { ar: "ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚...", en: "Verifying..." },
        statusLoadingSession: { ar: "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¬Ù„Ø³Ø©...", en: "Checking session..." },
        statusError: { ar: "Ø­Ø¯Ø« Ø®Ø·Ø£. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.", en: "Something went wrong. Try again." },
        statusNoWorkspaces: { ar: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³Ø§Ø­Ø§Øª Ø¹Ù…Ù„ Ù…ØªØ§Ø­Ø©.", en: "No workspaces available." },
        statusLoadingWorkspace: { ar: "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ø³Ø§Ø­Ø§Øª Ø§Ù„Ø¹Ù…Ù„...", en: "Loading workspaces..." },
        statusLoadingApps: { ar: "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª...", en: "Loading apps..." },
        statusLoadingMarketplace: { ar: "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù…ØªØ¬Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª...", en: "Loading marketplace..." },
        workspaceLabel: { ar: "Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„", en: "Workspace" },
        yourAppsTitle: { ar: "ØªØ·Ø¨ÙŠÙ‚Ø§ØªÙƒ", en: "Your apps" },
        marketplaceTitle: { ar: "App Marketplace", en: "App Marketplace" },
        marketplaceSub: { ar: "Ø§Ø®ØªØ± Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„ ÙˆØ«Ø¨Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ù„ÙØ±ÙŠÙ‚Ùƒ.", en: "Choose a workspace and install the right apps for your team." },
        viewApps: { ar: "Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª", en: "Apps" },
        viewMarketplace: { ar: "Ø§Ù„Ù…ØªØ¬Ø±", en: "Marketplace" },
        appPlaceholder: { ar: "Ø§Ø®ØªØ± ØªØ·Ø¨ÙŠÙ‚Ø§Ù‹ Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø£Ùˆ Ù…Ù† Ø§Ù„Ù…ØªØ¬Ø±.", en: "Choose an app from your apps or from the marketplace." },
        appViewSub: { ar: "Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¸Ø§Ù‡Ø± Ø¯Ø§Ø®Ù„ Ù†Ø­Ù„ Ù‡Ø¨. Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª.", en: "The app is shown inside NahlHub. Use Back to return to apps." },
        backToApps: { ar: "Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª", en: "Apps" },
        userNotFound: { ar: "Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„. ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨.", en: "This mobile is not registered. Contact your admin to create an account." }
      };

      function t(key) {
        var entry = tDict[key];
        if (!entry) return key;
        return entry[currentLang] || entry.ar || key;
      }

      function applyLanguage() {
        document.documentElement.lang = currentLang;
        document.documentElement.dir = currentLang === "ar" ? "rtl" : "ltr";

        document.querySelectorAll("[data-i18n]").forEach(function (node) {
          var key = node.getAttribute("data-i18n");
          node.textContent = t(key);
        });

        btnLangAr.classList.toggle("active", currentLang === "ar");
        btnLangEn.classList.toggle("active", currentLang === "en");
        mobileInput.placeholder = "5XXXXXXXX";

        updateUserUi();
        renderApps();
        renderMarketplace();
      }

      function applyTheme() {
        bodyEl.setAttribute("data-theme", currentTheme);
        themeIcon.textContent = currentTheme === "light" ? "ğŸŒ" : "ğŸŒ™";
      }

      function setStatus(msgKeyOrText, type) {
        if (!msgKeyOrText) {
          statusText.textContent = "";
          statusPill.classList.remove("ok", "error");
          return;
        }
        var text = (tDict[msgKeyOrText] && tDict[msgKeyOrText][currentLang]) ? t(msgKeyOrText) : msgKeyOrText;
        statusPill.classList.remove("ok", "error");
        if (type === "ok") statusPill.classList.add("ok");
        else if (type === "error") statusPill.classList.add("error");
        statusText.textContent = text;
      }

      function postJson(payload) {
        var body = Object.assign({}, payload || {});
        if (!body.appId && !body.appid && HUB_APP_ID) body.appId = HUB_APP_ID;

        return fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        }).then(function (res) {
          return res.text().then(function (txt) {
            var data = null;
            try { data = JSON.parse(txt || "{}"); } catch (e) {}
            if (!res.ok) {
              var msg = (data && (data.error || data.message)) || ("HTTP " + res.status);
              throw new Error(msg);
            }
            return data || {};
          });
        });
      }

      function showStep(name) {
        stepMobile.classList.add("hidden");
        stepOtp.classList.add("hidden");
        stepApps.classList.add("hidden");

        if (name === "mobile") {
          authOverlay.classList.remove("hidden");
          stepMobile.classList.remove("hidden");
          setTimeout(function(){ mobileInput.focus(); }, 50);
        } else if (name === "otp") {
          authOverlay.classList.remove("hidden");
          stepOtp.classList.remove("hidden");
          setTimeout(function(){ otpInputs[0].focus(); }, 50);
        } else if (name === "apps") {
          authOverlay.classList.add("hidden");
          stepApps.classList.remove("hidden");
        }
      }

      otpInputs.forEach(function (input, idx) {
        input.addEventListener("input", function (e) {
          var value = e.target.value.replace(/\D/g, "");
          e.target.value = value.slice(0, 1);
          if (value && idx < otpInputs.length - 1) otpInputs[idx + 1].focus();
        });

        input.addEventListener("keydown", function (e) {
          if (e.key === "Backspace" && !e.target.value && idx > 0) otpInputs[idx - 1].focus();
          if (e.key === "ArrowLeft" && idx > 0) otpInputs[idx - 1].focus();
          if (e.key === "ArrowRight" && idx < otpInputs.length - 1) otpInputs[idx + 1].focus();
          if (e.key === "Enter") { e.preventDefault(); verifyOtp(); }
        });
      });

      function readOtp() {
        return otpInputs.map(function (el) { return el.value || ""; }).join("");
      }

      function clearOtpInputs() {
        otpInputs.forEach(function (el) { el.value = ""; });
      }

      function sendOtp() {
        var mobile = (mobileInput.value || "").trim();
        if (!mobile) {
          setStatus(currentLang === "ar" ? "Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„." : "Enter your mobile.", "error");
          mobileInput.focus();
          return;
        }

        currentMobileRaw = mobile;
        btnSendOtp.disabled = true;
        setStatus("statusSendingOtp");

        postJson({ action: "sendOtp", mobile: mobile })
          .then(function (res) {
            if (!res || res.success !== true) {
              var msg = (res && res.error) || (currentLang === "ar" ? "ØªØ¹Ø°Ø± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²." : "Failed to send code.");
              setStatus(msg, "error");
              return;
            }
            setStatus("statusOtpSent", "ok");
            clearOtpInputs();
            showStep("otp");
          })
          .catch(function (err) {
            setStatus((currentLang === "ar" ? "Ø®Ø·Ø£: " : "Error: ") + (err && err.message ? err.message : ""), "error");
          })
          .finally(function () {
            btnSendOtp.disabled = false;
          });
      }

      function verifyOtp() {
        var otp = readOtp();
        if (!otp || otp.length !== 4) {
          setStatus(currentLang === "ar" ? "Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ù¤ Ø£Ø±Ù‚Ø§Ù…." : "Enter the 4-digit code.", "error");
          otpInputs[0].focus();
          return;
        }

        btnVerifyOtp.disabled = true;
        setStatus("statusVerifying");

        postJson({ action: "verifyOtp", mobile: currentMobileRaw, otp: otp })
          .then(function (res) {
            if (!res || res.success !== true) {
              var msg = (res && res.error) || (currentLang === "ar" ? "Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ Ù…Ù†ØªÙ‡ÙŠ." : "Invalid or expired code.");
              setStatus(msg, "error");
              clearOtpInputs();
              otpInputs[0].focus();
              return;
            }

            if (res.userExists === false) {
              setStatus("userNotFound", "error");
              clearOtpInputs();
              otpInputs[0].focus();
              return;
            }

            currentSessionKey = res.sessionKey || null;
            currentUser = res.user || null;
            if (currentSessionKey) localStorage.setItem(STORAGE_SESSION_KEY, currentSessionKey);

            if (welcomeCard) welcomeCard.classList.add("hidden");
            updateUserUi();

            loadWorkspaces().then(function () {
              showStep("apps");
              setStatus("statusIdle");
            });
          })
          .catch(function (err) {
            setStatus((currentLang === "ar" ? "Ø®Ø·Ø£: " : "Error: ") + (err && err.message ? err.message : ""), "error");
          })
          .finally(function () {
            btnVerifyOtp.disabled = false;
          });
      }

      function updateUserUi() {
        if (!currentUser) { userNameLabel.textContent = ""; return; }
        var suffix = " Â· " + (currentUser.mobile || "");
        var greet = currentLang === "ar" ? ("Ù…Ø±Ø­Ø¨Ø§Ù‹ " + (currentUser.name || "")) : ("Hi " + (currentUser.name || ""));
        userNameLabel.textContent = greet + suffix;
      }

      function logout() {
        var prevSession = currentSessionKey;

        currentSessionKey = null;
        localStorage.removeItem(STORAGE_SESSION_KEY);
        currentUser = null;
        currentWorkspaces = [];
        currentWorkspaceId = null;
        currentWorkspaceApps = [];
        currentTemplates = [];
        appsGrid.innerHTML = "";
        marketplaceGrid.innerHTML = "";
        workspaceNameEl.textContent = "â€”";
        workspaceRoleEl.textContent = "â€”";
        setMainView("apps");

        if (welcomeCard) welcomeCard.classList.remove("hidden");
        setStatus("statusIdle");
        showStep("mobile");

        if (prevSession) {
          postJson({ action: "auth.logout", sessionKey: prevSession }).catch(function(){});
        }
      }

      function setMainView(view) {
        currentMainView = view;
        sectionApps.classList.toggle("hidden", view !== "apps");
        sectionMarketplace.classList.toggle("hidden", view !== "marketplace");
        sectionAppView.classList.toggle("hidden", view !== "app");

        btnViewApps.classList.toggle("active", view === "apps");
        btnViewMarketplace.classList.toggle("active", view === "marketplace");
      }

      function buildWorkspaceMenu() {
        workspaceMenu.innerHTML = "";
        if (!currentWorkspaces.length) {
          var empty = document.createElement("div");
          empty.className = "card-caption";
          empty.style.padding = "6px 4px";
          empty.textContent = t("statusNoWorkspaces");
          workspaceMenu.appendChild(empty);
          return;
        }

        currentWorkspaces.forEach(function (ws) {
          var btn = document.createElement("button");
          btn.type = "button";
          btn.className = "workspace-menu-item";
          if (ws.workspaceId === currentWorkspaceId) btn.classList.add("active");

          var main = document.createElement("div");
          main.className = "workspace-menu-item-main";

          var name = document.createElement("div");
          name.className = "workspace-menu-item-name";
          name.textContent = ws.name || ws.workspaceId;

          var meta = document.createElement("div");
          meta.className = "workspace-menu-item-meta";
          meta.textContent = (ws.slug || "") + (ws.plan ? " Â· " + ws.plan : "");

          main.appendChild(name);
          main.appendChild(meta);

          var rolePill = document.createElement("span");
          rolePill.className = "workspace-menu-item-role";
          rolePill.textContent = ws.role || "member";

          btn.appendChild(main);
          btn.appendChild(rolePill);

          btn.addEventListener("click", function (e) {
            e.stopPropagation();
            selectWorkspace(ws.workspaceId);
            workspaceMenu.classList.add("hidden");
          });

          workspaceMenu.appendChild(btn);
        });
      }

      function selectWorkspace(workspaceId) {
        var ws = currentWorkspaces.find(function (w) { return w.workspaceId === workspaceId; });
        if (!ws) return;

        currentWorkspaceId = workspaceId;
        currentWorkspaceRole = ws.role || "member";

        workspaceNameEl.textContent = ws.name || ws.workspaceId;
        workspaceRoleEl.textContent = ws.role === "admin" ? "admin" : "member";

        buildWorkspaceMenu();
        setStatus("statusLoadingApps");
        loadWorkspaceData();
      }

      function loadWorkspaces() {
        if (!currentUser || !currentUser.userId) return Promise.resolve();

        setStatus("statusLoadingWorkspace");
        return postJson({ action: "workspace.listForUser", userId: currentUser.userId })
          .then(function (res) {
            currentWorkspaces = (res && res.items) || [];
            if (!currentWorkspaces.length) {
              setStatus("statusNoWorkspaces", "error");
              return;
            }
            selectWorkspace(currentWorkspaces[0].workspaceId);
          })
          .catch(function (err) {
            setStatus((currentLang === "ar" ? "ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø­Ø§Øª: " : "Failed loading workspaces: ") + (err && err.message ? err.message : ""), "error");
          });
      }

      function loadWorkspaceData() {
        if (!currentWorkspaceId) return;

        Promise.all([
          postJson({ action: "marketplace.listWorkspaceApps", workspaceId: currentWorkspaceId }),
          postJson({ action: "marketplace.listTemplates", workspaceId: currentWorkspaceId })
        ])
          .then(function (results) {
            var appsRes = results[0] || {};
            var tplRes = results[1] || {};
            currentTemplates = tplRes.items || [];

            var tplById = {};
            currentTemplates.forEach(function (tpl) { tplById[tpl.templateId] = tpl; });

            currentWorkspaceApps = (appsRes.items || []).map(function (app) {
              var tpl = tplById[app.templateId] || {};
              return {
                workspaceAppId: app.workspaceAppId,
                appId: app.appId,
                templateId: app.templateId,
                name: (currentLang === "ar"
                      ? (app.nameAr || tpl.nameAr || app.name || tpl.name || app.templateId)
                      : (app.nameEn || tpl.nameEn || app.name || tpl.name || app.templateId)),
                category: tpl.category || app.category || "",
                shortDesc: (currentLang === "ar" ? (tpl.shortDescAr || tpl.shortDesc || "") : (tpl.shortDescEn || tpl.shortDesc || "")) || "",
                status: app.status || "",
                visibleInHub: app.visibleInHub || "",
                defaultRoute: tpl.defaultRoute || app.defaultRoute || "",
                iconUrl: tpl.iconUrl || "",
                featureTags: tpl.featureTags || ""
              };
            });

            renderApps();
            renderMarketplace();
            setStatus("statusIdle");
          })
          .catch(function (err) {
            setStatus((currentLang === "ar" ? "ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: " : "Failed loading data: ") + (err && err.message ? err.message : ""), "error");
          });
      }

      function renderApps() {
        if (!appsGrid) return;
        appsGrid.innerHTML = "";

        if (!currentWorkspaceApps || !currentWorkspaceApps.length) {
          var empty = document.createElement("div");
          empty.className = "card-caption";
          empty.textContent = currentLang === "ar" ? "Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ù…Ø«Ø¨ØªØ© ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø³Ø§Ø­Ø©." : "No apps installed in this workspace.";
          appsGrid.appendChild(empty);
          return;
        }

        currentWorkspaceApps.forEach(function (app) {
          var card = document.createElement("article");
          card.className = "app-card";

          var header = document.createElement("div");
          header.className = "app-card-header";

          var main = document.createElement("div");
          main.className = "app-card-main";

          var icon = document.createElement("div");
          icon.className = "app-card-icon";
          icon.textContent = "âœ¦";

          var titleWrap = document.createElement("div");
          var title = document.createElement("div");
          title.className = "app-card-title";
          title.textContent = app.name || app.templateId;

          var tagLine = document.createElement("div");
          tagLine.className = "app-card-tagline";
          tagLine.textContent = app.category || "";

          titleWrap.appendChild(title);
          titleWrap.appendChild(tagLine);

          main.appendChild(icon);
          main.appendChild(titleWrap);

          var statusBadge = document.createElement("span");
          statusBadge.className = "badge-installed";
          statusBadge.textContent = currentLang === "ar" ? "Ù…Ø«Ø¨Ù‘Øª" : "Installed";

          header.appendChild(main);
          header.appendChild(statusBadge);

          var body = document.createElement("div");
          body.className = "app-card-body";
          body.textContent = app.shortDesc || "";

          var footer = document.createElement("div");
          footer.className = "app-card-footer";

          var cat = document.createElement("span");
          cat.textContent = app.category || "â€”";

          var actions = document.createElement("div");
          actions.className = "app-card-actions";

          var openBtn = document.createElement("button");
          openBtn.type = "button";
          openBtn.className = "btn-pill-sm primary";
          openBtn.textContent = currentLang === "ar" ? "ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚" : "Open app";

          openBtn.addEventListener("click", function (e) {
            e.stopPropagation();
            openWorkspaceApp(app);
          });

          actions.appendChild(openBtn);
          footer.appendChild(cat);
          footer.appendChild(actions);

          card.appendChild(header);
          card.appendChild(body);
          card.appendChild(footer);

          card.addEventListener("click", function () { openWorkspaceApp(app); });

          appsGrid.appendChild(card);
        });
      }

      function renderMarketplace() {
        if (!marketplaceGrid) return;
        marketplaceGrid.innerHTML = "";

        if (!currentTemplates.length) {
          var empty = document.createElement("div");
          empty.className = "card-caption";
          empty.textContent = currentLang === "ar" ? "Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ·Ø¨ÙŠÙ‚Ø§Øª ÙÙŠ Ø§Ù„Ù…ØªØ¬Ø±." : "No apps available in marketplace.";
          marketplaceGrid.appendChild(empty);
          return;
        }

        currentTemplates.forEach(function (tpl) {
          var card = document.createElement("article");
          card.className = "app-card";

          var header = document.createElement("div");
          header.className = "app-card-header";

          var main = document.createElement("div");
          main.className = "app-card-main";

          var icon = document.createElement("div");
          icon.className = "app-card-icon";
          icon.textContent = "âœ´";

          var titleWrap = document.createElement("div");
          var title = document.createElement("div");
          title.className = "app-card-title";
          title.textContent = (currentLang === "ar" ? (tpl.nameAr || tpl.name || tpl.templateId) : (tpl.nameEn || tpl.name || tpl.templateId));

          var tagLine = document.createElement("div");
          tagLine.className = "app-card-tagline";
          tagLine.textContent = tpl.category || "";

          titleWrap.appendChild(title);
          titleWrap.appendChild(tagLine);

          main.appendChild(icon);
          main.appendChild(titleWrap);

          var statusSpan = document.createElement("span");
          statusSpan.className = "badge-soft";
          statusSpan.textContent = tpl.planRequired || "free";

          header.appendChild(main);
          header.appendChild(statusSpan);

          var body = document.createElement("div");
          body.className = "app-card-body";
          body.textContent = (currentLang === "ar" ? (tpl.shortDescAr || tpl.shortDesc || "") : (tpl.shortDescEn || tpl.shortDesc || ""));

          var footer = document.createElement("div");
          footer.className = "app-card-footer";

          var tags = document.createElement("span");
          tags.textContent = tpl.featureTags || "";

          var actions = document.createElement("div");
          actions.className = "app-card-actions";

          var installBtn = document.createElement("button");
          installBtn.type = "button";
          installBtn.className = "btn-pill-sm primary";

          var isInstalled = !!tpl.installed;

          installBtn.textContent = isInstalled ? (currentLang === "ar" ? "Ù…Ø«Ø¨Ù‘Øª" : "Installed") : (currentLang === "ar" ? "ØªØ«Ø¨ÙŠØª" : "Install");
          if (isInstalled) installBtn.disabled = true;

          installBtn.addEventListener("click", function (e) {
            e.stopPropagation();
            if (isInstalled) return;
            installTemplate(tpl);
          });

          actions.appendChild(installBtn);
          footer.appendChild(tags);
          footer.appendChild(actions);

          card.appendChild(header);
          card.appendChild(body);
          card.appendChild(footer);

          marketplaceGrid.appendChild(card);
        });
      }

      function installTemplate(tpl) {
        if (!currentWorkspaceId || !currentUser) return;
        setStatus("statusLoadingMarketplace");

        postJson({
          action: "marketplace.installApp",
          workspaceId: currentWorkspaceId,
          templateId: tpl.templateId,
          userId: currentUser.userId
        })
          .then(function (res) {
            if (!res || res.success !== true) {
              setStatus((res && res.error) || "Install failed", "error");
              return;
            }
            loadWorkspaceData();
          })
          .catch(function (err) {
            setStatus((currentLang === "ar" ? "ÙØ´Ù„ Ø§Ù„ØªØ«Ø¨ÙŠØª: " : "Install failed: ") + (err && err.message ? err.message : ""), "error");
          });
      }

      function openWorkspaceApp(app) {
        if (!app || !app.defaultRoute) {
          setStatus(currentLang === "ar" ? "Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ØºÙŠØ± Ù…Ù‡ÙŠØ£." : "App URL is not configured yet.", "error");
          setMainView("apps");
          return;
        }

        if (!currentWorkspaceId) {
          setStatus(currentLang === "ar" ? "Ø§Ø®ØªØ± Ù…Ø³Ø§Ø­Ø© Ø¹Ù…Ù„ Ø£ÙˆÙ„Ø§Ù‹." : "Please select a workspace first.", "error");
          return;
        }

        appViewTitle.textContent = app.name || app.templateId;
        appFramePlaceholder.classList.add("hidden");
        appFrame.classList.remove("hidden");

        var route = app.defaultRoute;
        var join = route.indexOf("?") >= 0 ? "&" : "?";
        appFrame.src = route + join + "workspaceId=" + encodeURIComponent(currentWorkspaceId);

        setMainView("app");
      }

      function tryAutoLogin() {
        if (!currentSessionKey) {
          showStep("mobile");
          return;
        }

        setStatus("statusLoadingSession");
        postJson({ action: "auth.me", sessionKey: currentSessionKey })
          .then(function (res) {
            if (!res || res.success !== true) {
              logout();
              return;
            }

            currentUser = res.user || null;
            if (welcomeCard) welcomeCard.classList.add("hidden");
            updateUserUi();

            loadWorkspaces().then(function () {
              showStep("apps");
              setStatus("statusIdle", "ok");
            });
          })
          .catch(function () {
            logout();
          });
      }

      function pingApi() {
        devInfo.textContent = "â€¦";
        fetch(API_URL + "?action=health")
          .then(function (r) {
            if (!r.ok) throw new Error("HTTP " + r.status);
            return r.json();
          })
          .then(function (d) {
            devInfo.textContent = (d && (d.ok || d.success)) ? "OK" : "ERR";
          })
          .catch(function () {
            devInfo.textContent = "ERR";
          });
      }

      // Events
      btnSendOtp.addEventListener("click", sendOtp);
      mobileInput.addEventListener("keydown", function (e) {
        if (e.key === "Enter") { e.preventDefault(); sendOtp(); }
      });

      btnVerifyOtp.addEventListener("click", verifyOtp);

      btnChangeMobile.addEventListener("click", function () {
        showStep("mobile");
        setStatus("statusIdle");
      });

      btnLogout.addEventListener("click", logout);

      btnTheme.addEventListener("click", function () {
        currentTheme = currentTheme === "light" ? "dark" : "light";
        localStorage.setItem(STORAGE_THEME, currentTheme);
        applyTheme();
      });

      btnLangAr.addEventListener("click", function () {
        currentLang = "ar";
        localStorage.setItem(STORAGE_LANG, currentLang);
        applyLanguage();
      });

      btnLangEn.addEventListener("click", function () {
        currentLang = "en";
        localStorage.setItem(STORAGE_LANG, currentLang);
        applyLanguage();
      });

      btnViewApps.addEventListener("click", function () { setMainView("apps"); });
      btnViewMarketplace.addEventListener("click", function () { setMainView("marketplace"); });
      btnBackFromApp.addEventListener("click", function () { setMainView("apps"); });

      workspaceCard.addEventListener("click", function (e) {
        e.stopPropagation();
        workspaceMenu.classList.toggle("hidden");
      });

      document.addEventListener("click", function () { workspaceMenu.classList.add("hidden"); });
      workspaceMenu.addEventListener("click", function (e) { e.stopPropagation(); });

      btnPing.addEventListener("click", pingApi);

      // Init
      applyTheme();
      applyLanguage();
      setStatus("statusIdle");
      pingApi();
      tryAutoLogin();
    })();
  </script>
</body>
</html>
