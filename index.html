<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>NahlHub â€“ Hub</title>

  <!-- Optional: Rounded font (you already like this one ğŸ˜Š) -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;600;800&display=swap" rel="stylesheet" />

  <style>
    :root {
      --bg: #f5f7fa;
      --card-bg: #ffffff;
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
      --danger: #dc2626;
      --muted: #6b7280;
      --border: #e5e7eb;
      --radius-lg: 16px;
      --radius-sm: 10px;
      --shadow-sm: 0 8px 24px rgba(15, 23, 42, 0.06);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "M PLUS Rounded 1c", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top right, #e0f2fe 0, #f9fafb 45%, #eef2ff 100%);
      color: #111827;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      padding: 14px 18px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      backdrop-filter: blur(12px);
      background: rgba(255, 255, 255, 0.8);
      border-bottom: 1px solid rgba(148, 163, 184, 0.18);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    header .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    header .logo-icon {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 18px rgba(34, 197, 94, 0.35);
      font-size: 18px;
      font-weight: 800;
      color: #ecfdf5;
    }

    header .logo-text-main {
      font-weight: 800;
      font-size: 18px;
    }

    header .logo-text-sub {
      font-size: 11px;
      color: var(--muted);
    }

    header .header-right {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--muted);
    }

    main {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 24px 16px 32px;
    }

    .page {
      width: 100%;
      max-width: 1080px;
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.4fr);
      gap: 18px;
      align-items: flex-start;
    }

    @media (max-width: 840px) {
      .page {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-sm);
      border: 1px solid rgba(148, 163, 184, 0.15);
      padding: 18px 18px 16px;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
      gap: 8px;
    }

    .card-title {
      font-size: 16px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-title-badge {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: #eff6ff;
      color: #1d4ed8;
      border: 1px solid #dbeafe;
    }

    .card-subtitle {
      font-size: 12px;
      color: var(--muted);
    }

    .pill-steps {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 10px;
      font-size: 11px;
    }

    .pill {
      padding: 4px 9px;
      border-radius: 999px;
      background: #f9fafb;
      border: 1px solid var(--border);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: #4b5563;
      white-space: nowrap;
    }

    .pill strong {
      font-size: 11px;
      color: #111827;
    }

    .field {
      margin-bottom: 10px;
    }

    .field label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .field small {
      display: block;
      font-size: 10px;
      color: var(--muted);
      margin-top: 2px;
    }

    input[type="text"],
    input[type="tel"],
    input[type="number"],
    input[type="password"],
    select {
      width: 100%;
      padding: 8px 10px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      font-family: inherit;
      font-size: 13px;
      outline: none;
      background: #f9fafb;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background-color 0.15s ease;
    }

    input:focus,
    select:focus {
      border-color: var(--primary);
      background: #ffffff;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.1);
    }

    button {
      font-family: inherit;
      font-size: 13px;
      border-radius: 999px;
      border: none;
      padding: 8px 14px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: background-color 0.15s ease, box-shadow 0.15s ease, transform 0.05s ease;
      white-space: nowrap;
    }

    button.btn-primary {
      background: var(--primary);
      color: #f9fafb;
      box-shadow: 0 8px 18px rgba(37, 99, 235, 0.25);
    }

    button.btn-primary:hover {
      background: var(--primary-hover);
      box-shadow: 0 10px 26px rgba(37, 99, 235, 0.3);
      transform: translateY(-1px);
    }

    button.btn-outline {
      background: #fff;
      border: 1px solid var(--border);
      color: #111827;
    }

    button.btn-danger {
      background: var(--danger);
      color: #fef2f2;
    }

    button:disabled {
      opacity: 0.6;
      cursor: default;
      transform: none;
      box-shadow: none;
    }

    .btn-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 4px;
    }

    .status {
      font-size: 11px;
      margin-top: 6px;
      min-height: 16px;
    }

    .status.ok {
      color: #16a34a;
    }

    .status.error {
      color: var(--danger);
    }

    .status.muted {
      color: var(--muted);
    }

    .otp-row {
      display: grid;
      grid-template-columns: 1.2fr auto;
      gap: 8px;
    }

    @media (max-width: 480px) {
      .otp-row {
        grid-template-columns: 1fr;
      }
    }

    .chips-row {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 6px;
    }

    .chip {
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 999px;
      background: #f3f4f6;
      color: #4b5563;
    }

    /* App area */

    #app-section {
      display: none;
    }

    .app-top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .user-pill {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      background: #f3f4ff;
      border: 1px solid #e0e7ff;
      font-size: 12px;
    }

    .user-avatar {
      width: 24px;
      height: 24px;
      border-radius: 999px;
      background: linear-gradient(135deg, #6366f1, #4f46e5);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #eef2ff;
      font-weight: 700;
      font-size: 12px;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 7px;
      border-radius: 999px;
      font-size: 10px;
      background: #eef2ff;
      color: #4338ca;
      border: 1px solid #e0e7ff;
    }

    .section-title {
      font-size: 13px;
      font-weight: 700;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .section-title span {
      font-size: 11px;
      font-weight: 500;
      color: var(--muted);
    }

    .workspace-row {
      display: grid;
      grid-template-columns: minmax(0, 1.3fr) minmax(0, 1.7fr);
      gap: 10px;
    }

    @media (max-width: 720px) {
      .workspace-row {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .list-box {
      border-radius: 12px;
      border: 1px dashed #e5e7eb;
      background: #f9fafb;
      padding: 8px 8px 6px;
      max-height: 260px;
      overflow: auto;
      font-size: 12px;
    }

    .list-item {
      padding: 6px 7px;
      border-radius: 9px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
      background: #ffffff;
      border: 1px solid #e5e7eb;
    }

    .list-item-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .list-item-title {
      font-weight: 600;
      font-size: 12px;
    }

    .list-item-sub {
      font-size: 11px;
      color: var(--muted);
    }

    .badge {
      font-size: 10px;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      color: #4b5563;
    }

    footer {
      text-align: center;
      font-size: 11px;
      color: var(--muted);
      padding: 8px 16px 14px;
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <div class="logo-icon">Ù†</div>
      <div>
        <div class="logo-text-main">NahlHub</div>
        <div class="logo-text-sub">Hub Ù„Ø­Ù„ÙˆÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø©</div>
      </div>
    </div>
    <div class="header-right">
      <span class="tag">
        <span>Ø¨ÙŠØ¦Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©</span> â€¢ <span>Beta</span>
      </span>
    </div>
  </header>

  <main>
    <div class="page">
      <!-- Auth / Login Card -->
      <section id="auth-section" class="card">
        <div class="card-header">
          <div>
            <div class="card-title">
              Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ NahlHub
              <span class="card-title-badge">ØªØ¬Ø±Ø¨Ø© Ø³Ø±ÙŠØ¹Ø© Ø¨Ø¯ÙˆÙ† ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±</span>
            </div>
            <div class="card-subtitle">
              Ø§Ø³ØªØ®Ø¯Ù… Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„Ùƒ ÙˆØ§Ø³ØªÙ‚Ø¨Ù„ Ø±Ù…Ø² ØªØ­Ù‚Ù‚ Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨.
            </div>
          </div>
        </div>

        <div class="pill-steps">
          <div class="pill"><strong>Ù¡</strong> Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„Ùƒ</div>
          <div class="pill"><strong>Ù¢</strong> Ø§Ø³ØªÙ‚Ø¨Ù„ Ø±Ù…Ø² OTP</div>
          <div class="pill"><strong>Ù£</strong> Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù€ Hub ÙˆØ¨ÙŠØ¦Ø§Øª Ø§Ù„Ø¹Ù…Ù„</div>
        </div>

        <!-- Step 1: Mobile -->
        <div class="field">
          <label for="loginMobile">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label>
          <input id="loginMobile" type="tel" inputmode="tel" placeholder="Ù…Ø«Ø§Ù„: 5xxxxxxxx" />
          <small>Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² ØªØ­Ù‚Ù‚ (OTP) Ø¹Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ù†ÙØ³ Ø§Ù„Ø±Ù‚Ù….</small>
        </div>

        <div class="btn-row">
          <button id="btnSendOtp" class="btn-primary">
            <span>Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚</span>
          </button>
        </div>

        <div id="otpSendStatus" class="status muted"></div>

        <hr style="border:none;border-top:1px dashed #e5e7eb;margin:10px 0 10px;" />

        <!-- Step 2: OTP -->
        <div class="field">
          <label for="loginOtp">Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ (OTP)</label>
          <div class="otp-row">
            <input id="loginOtp" type="text" inputmode="numeric" maxlength="6" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ù…ÙƒÙˆÙ† Ù…Ù† 4 Ø£Ø±Ù‚Ø§Ù…" />
            <button id="btnVerifyOtp" class="btn-outline">
              ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø±Ù…Ø² ÙˆØ§Ù„Ø¯Ø®ÙˆÙ„
            </button>
          </div>
          <small>Ø§Ù„Ø±Ù…Ø² ØµØ§Ù„Ø­ Ù„Ù…Ø¯Ø© Ù¡Ù  Ø¯Ù‚Ø§Ø¦Ù‚. Ù„Ø§ ØªØ´Ø§Ø±ÙƒÙ‡ Ù…Ø¹ Ø£ÙŠ Ø´Ø®Øµ.</small>
        </div>

        <div id="otpVerifyStatus" class="status"></div>

        <div class="chips-row">
          <span class="chip">ğŸ” Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±</span>
          <span class="chip">ğŸ“² ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</span>
          <span class="chip">ğŸ§ª Ù…Ù†Ø§Ø³Ø¨ Ù„ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ø£ÙˆÙ„ÙŠØ©</span>
        </div>
      </section>

      <!-- App / Hub Card -->
      <section id="app-section" class="card">
        <div class="card-header">
          <div>
            <div class="card-title">
              Ù„ÙˆØ­Ø© NahlHub
              <span class="card-title-badge">Workspaces & Marketplace</span>
            </div>
            <div class="card-subtitle">
              Ø£Ù†Ø´Ø¦ Ø¨ÙŠØ¦Ø§Øª Ø¹Ù…Ù„ØŒ Ø«Ø¨Ù‘Øª ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø¬Ø§Ù‡Ø²Ø©ØŒ ÙˆØ§Ø¨Ø¯Ø£ Ø§Ù„ØªØ¬Ø§Ø±Ø¨ Ù…Ø¹ ÙØ±ÙŠÙ‚Ùƒ.
            </div>
          </div>
          <div class="app-top-bar">
            <div id="userSummary" class="user-pill" style="display:none;">
              <div class="user-avatar" id="userAvatar">ğŸ‘¤</div>
              <div>
                <div id="userNameLabel">...</div>
                <div style="font-size:10px;color:var(--muted);" id="userMobileLabel"></div>
              </div>
            </div>
            <button id="btnLogout" class="btn-outline btn-sm" style="font-size:11px;padding-inline:10px;">
              ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬
            </button>
          </div>
        </div>

        <div class="workspace-row">
          <!-- Left: Workspaces -->
          <div>
            <div class="section-title">
              Ø¨ÙŠØ¦Ø§Øª Ø§Ù„Ø¹Ù…Ù„ (Workspaces)
              <span id="workspacesCountLabel"></span>
            </div>

            <div class="field">
              <label for="wsName">Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ¦Ø© Ø¹Ù…Ù„ Ø¬Ø¯ÙŠØ¯Ø©</label>
              <input id="wsName" type="text" placeholder="Ù…Ø«Ø§Ù„: ÙØ±ÙŠÙ‚ Ø§Ù„Ù…Ø§Ø±ÙƒØªÙ†Ù‚ØŒ ØªØ¬Ø±Ø¨Ø© NahlHub #1..." />
              <small>Ø³ÙŠØªÙ… ØªØ¹ÙŠÙŠÙ†Ùƒ ÙƒÙ€ Admin Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ¦Ø© ÙˆÙŠÙ…ÙƒÙ†Ùƒ Ø¯Ø¹ÙˆØ© Ø£Ø¹Ø¶Ø§Ø¡ Ù„Ø§Ø­Ù‚Ø§Ù‹.</small>
              <div class="btn-row">
                <button id="btnCreateWorkspace" class="btn-primary">
                  Ø¥Ù†Ø´Ø§Ø¡ Workspace
                </button>
              </div>
            </div>

            <div class="field">
              <label for="wsSelect">Ø¨ÙŠØ¦Ø§Øª Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ</label>
              <select id="wsSelect">
                <option value="">Ø§Ø®ØªØ± Ø¨ÙŠØ¦Ø© Ø¹Ù…Ù„</option>
              </select>
              <small>Ø§Ø®ØªØ± Workspace Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª ÙˆØªØ«Ø¨ÙŠØª ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† Marketplace.</small>
            </div>

            <div id="workspaceStatus" class="status muted"></div>

            <div class="list-box" id="wsListBox">
              <div id="wsListEmpty" class="status muted">
                Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ¦Ø§Øª Ø¹Ù…Ù„ Ø¨Ø¹Ø¯. Ø£Ù†Ø´Ø¦ Ø£ÙˆÙ„ Workspace Ù„Ø¨Ø¯Ø¡ Ø§Ù„ØªØ¬Ø±Ø¨Ø©.
              </div>
              <div id="wsList"></div>
            </div>
          </div>

          <!-- Right: Apps + Marketplace -->
          <div>
            <div class="section-title">
              ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ù€ Workspace
              <span id="appsWorkspaceLabel"></span>
            </div>

            <div class="list-box" style="margin-bottom:10px;">
              <div id="workspaceAppsStatus" class="status muted">
                Ø§Ø®ØªØ± Workspace Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø± Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ù…Ø«Ø¨Ù‘ØªØ©.
              </div>
              <div id="workspaceAppsList"></div>
            </div>

            <div class="section-title">
              Marketplace
              <span>Ù‚ÙˆØ§Ù„Ø¨ Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„ØªØ«Ø¨ÙŠØª</span>
            </div>

            <div class="list-box">
              <div id="marketplaceStatus" class="status muted">
                Ø§Ø®ØªØ± Workspace Ø«Ù… Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ù…ØªØ§Ø­Ø©.
              </div>
              <div id="marketplaceList"></div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <footer>
    NahlHub &copy; <span id="year"></span> â€“ Ù…Ù†ØµØ© Ø³Ø±ÙŠØ¹Ø© Ù„ØªØ¬Ø±Ø¨Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø¹Ù„Ù‰ Ø¬ÙˆØ¬Ù„ Ø´ÙŠØª + API
  </footer>

  <script>
    // --------- Global state ---------
    let nhSessionKey = null;
    let nhCurrentUser = null;
    let nhCurrentWorkspaceId = null;

    const apiEndpoint = "/api/hub/manage";

    // --------- Small helpers ---------
    function qs(id) {
      return document.getElementById(id);
    }

    function setStatus(el, text, type) {
      if (!el) return;
      el.textContent = text || "";
      el.classList.remove("ok", "error", "muted");
      if (type) el.classList.add(type);
    }

    function firstLetterOrEmoji(name) {
      if (!name) return "ğŸ‘¤";
      const trimmed = name.trim();
      if (!trimmed) return "ğŸ‘¤";
      return trimmed.charAt(0).toUpperCase();
    }

    function saveSessionToStorage() {
      if (typeof localStorage === "undefined") return;
      if (nhSessionKey) {
        localStorage.setItem("nh_sessionKey", nhSessionKey);
      } else {
        localStorage.removeItem("nh_sessionKey");
      }
    }

    function loadSessionFromStorage() {
      if (typeof localStorage === "undefined") return null;
      return localStorage.getItem("nh_sessionKey");
    }

    function showAppView() {
      qs("auth-section").style.display = "none";
      qs("app-section").style.display = "block";
      updateUserSummary();
    }

    function showAuthView() {
      qs("auth-section").style.display = "block";
      qs("app-section").style.display = "none";
    }

    function updateUserSummary() {
      const summary = qs("userSummary");
      const avatar = qs("userAvatar");
      const nameLabel = qs("userNameLabel");
      const mobileLabel = qs("userMobileLabel");

      if (!nhCurrentUser) {
        summary.style.display = "none";
        return;
      }
      summary.style.display = "flex";
      avatar.textContent = firstLetterOrEmoji(nhCurrentUser.name || nhCurrentUser.mobile || "");
      nameLabel.textContent = nhCurrentUser.name || "Ù…Ø³ØªØ®Ø¯Ù… NahlHub";
      mobileLabel.textContent = nhCurrentUser.mobile || "";
    }

    async function apiCall(action, body = {}) {
      const payload = Object.assign({ action }, body);
      // Forward sessionKey for authenticated actions (future-safe)
      if (nhSessionKey && !payload.sessionKey) {
        payload.sessionKey = nhSessionKey;
      }

      const res = await fetch(apiEndpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      let data;
      try {
        data = await res.json();
      } catch (err) {
        console.error("Failed to parse JSON from API:", err);
        throw new Error("ØªØ¹Ø°Ø± Ù‚Ø±Ø§Ø¡Ø© Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø®Ø§Ø¯Ù….");
      }

      // If Apps Script returns success:false, we still get HTTP 200
      return data;
    }

    // --------- Auth: send OTP ---------
    async function onSendOtpClick() {
      const mobileInput = qs("loginMobile");
      const statusEl = qs("otpSendStatus");

      const mobileRaw = (mobileInput.value || "").trim();
      if (!mobileRaw) {
        setStatus(statusEl, "Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø£ÙˆÙ„Ø§Ù‹.", "error");
        return;
      }

      const mobile = mobileRaw.replace(/\s+/g, "");
      setStatus(statusEl, "Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²... â³", "muted");

      const btn = qs("btnSendOtp");
      btn.disabled = true;

      try {
        const result = await apiCall("sendOtp", { mobile });

        if (!result || !result.success) {
          setStatus(
            statusEl,
            result && result.error
              ? "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²: " + result.error
              : "ØªØ¹Ø°Ø± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø². Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.",
            "error"
          );
          return;
        }

        setStatus(
          statusEl,
          "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ù…Ø² Ø¨Ù†Ø¬Ø§Ø­. Ø±Ø§Ù‚Ø¨ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ø±Ù‚Ù… Ù„Ø¥Ø³ØªÙ‚Ø¨Ø§Ù„ OTP.",
          "ok"
        );
      } catch (err) {
        console.error("sendOtp error:", err);
        setStatus(
          statusEl,
          "ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ø«Ù… Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.",
          "error"
        );
      } finally {
        btn.disabled = false;
      }
    }

    // --------- Auth: verify OTP ---------
    async function onVerifyOtpClick() {
      const mobileInput = qs("loginMobile");
      const otpInput = qs("loginOtp");
      const statusEl = qs("otpVerifyStatus");

      const mobileRaw = (mobileInput.value || "").trim();
      const otpRaw = (otpInput.value || "").trim();

      if (!mobileRaw) {
        setStatus(statusEl, "Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ù†ÙØ³ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø§Ù„Ø°ÙŠ Ø§Ø³ØªÙ‚Ø¨Ù„ Ø§Ù„Ø±Ù…Ø².", "error");
        return;
      }
      if (!otpRaw) {
        setStatus(statusEl, "Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ (OTP).", "error");
        return;
      }

      const mobile = mobileRaw.replace(/\s+/g, "");
      const otp = otpRaw.replace(/\s+/g, "");

      setStatus(statusEl, "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù…Ø²... â³", "muted");
      const btn = qs("btnVerifyOtp");
      btn.disabled = true;

      try {
        const result = await apiCall("verifyOtp", { mobile, otp });

        if (!result || !result.success) {
          setStatus(
            statusEl,
            result && result.error ? result.error : "Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ Ù…Ù†ØªÙ‡ÙŠ. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.",
            "error"
          );
          return;
        }

        // Expecting: result.sessionKey, result.user {userId, mobile, name}
        nhSessionKey = result.sessionKey || null;
        nhCurrentUser = result.user || null;
        saveSessionToStorage();

        setStatus(statusEl, "ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ù†Ø¬Ø§Ø­! Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù„ÙˆØ­Ø© NahlHub...", "ok");

        // Switch view and load workspaces
        showAppView();
        await loadWorkspaces();
      } catch (err) {
        console.error("verifyOtp error:", err);
        setStatus(
          statusEl,
          "ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù… Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.",
          "error"
        );
      } finally {
        btn.disabled = false;
      }
    }

    // --------- Auth: restore session ---------
    async function tryRestoreSession() {
      const storedKey = loadSessionFromStorage();
      if (!storedKey) return;

      nhSessionKey = storedKey;
      try {
        const result = await apiCall("auth.me", { sessionKey: storedKey });
        if (!result || !result.success || !result.user) {
          nhSessionKey = null;
          nhCurrentUser = null;
          saveSessionToStorage();
          return;
        }

        nhCurrentUser = result.user;
        showAppView();
        updateUserSummary();
        await loadWorkspaces();
      } catch (err) {
        console.warn("Failed to restore session:", err);
        nhSessionKey = null;
        nhCurrentUser = null;
        saveSessionToStorage();
      }
    }

    // --------- Logout ---------
    async function onLogoutClick() {
      try {
        if (nhSessionKey) {
          await apiCall("auth.logout", { sessionKey: nhSessionKey });
        }
      } catch (err) {
        console.warn("Logout error (ignored):", err);
      }
      nhSessionKey = null;
      nhCurrentUser = null;
      nhCurrentWorkspaceId = null;
      saveSessionToStorage();
      clearWorkspaceUI();
      showAuthView();
      setStatus(qs("otpVerifyStatus"), "", "muted");
    }

    // --------- Workspaces ---------
    function clearWorkspaceUI() {
      qs("wsSelect").innerHTML = '<option value="">Ø§Ø®ØªØ± Ø¨ÙŠØ¦Ø© Ø¹Ù…Ù„</option>';
      qs("wsList").innerHTML = "";
      qs("wsListEmpty").style.display = "block";
      setStatus(qs("workspaceStatus"), "", "muted");
      setStatus(qs("workspaceAppsStatus"), "Ø§Ø®ØªØ± Workspace Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ù…Ø«Ø¨Ù‘ØªØ©.", "muted");
      qs("workspaceAppsList").innerHTML = "";
      setStatus(qs("marketplaceStatus"), "Ø§Ø®ØªØ± Workspace Ø«Ù… Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ù…ØªØ§Ø­Ø©.", "muted");
      qs("marketplaceList").innerHTML = "";
      qs("workspacesCountLabel").textContent = "";
      qs("appsWorkspaceLabel").textContent = "";
    }

    async function loadWorkspaces() {
      if (!nhCurrentUser) return;
      const statusEl = qs("workspaceStatus");
      setStatus(statusEl, "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ¦Ø§Øª Ø§Ù„Ø¹Ù…Ù„... â³", "muted");

      try {
        const result = await apiCall("workspace.listForUser", {
          userId: nhCurrentUser.userId,
        });

        if (!result || !result.success) {
          setStatus(
            statusEl,
            result && result.error
              ? "ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ¦Ø§Øª Ø§Ù„Ø¹Ù…Ù„: " + result.error
              : "ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ¦Ø§Øª Ø§Ù„Ø¹Ù…Ù„.",
            "error"
          );
          return;
        }

        const items = result.items || [];
        renderWorkspaces(items);
        setStatus(statusEl, items.length ? "" : "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ¦Ø§Øª Ø¹Ù…Ù„ Ø¨Ø¹Ø¯.", items.length ? "muted" : "muted");
      } catch (err) {
        console.error("loadWorkspaces error:", err);
        setStatus(statusEl, "Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ¦Ø§Øª Ø§Ù„Ø¹Ù…Ù„.", "error");
      }
    }

    function renderWorkspaces(items) {
      const wsSelect = qs("wsSelect");
      const wsList = qs("wsList");
      const emptyLabel = qs("wsListEmpty");

      wsSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø¨ÙŠØ¦Ø© Ø¹Ù…Ù„</option>';
      wsList.innerHTML = "";

      if (!items || !items.length) {
        emptyLabel.style.display = "block";
        qs("workspacesCountLabel").textContent = "";
        nhCurrentWorkspaceId = null;
        qs("appsWorkspaceLabel").textContent = "";
        return;
      }

      emptyLabel.style.display = "none";

      items.forEach((ws) => {
        const opt = document.createElement("option");
        opt.value = ws.workspaceId;
        opt.textContent = `${ws.name} (${ws.role || "member"})`;
        wsSelect.appendChild(opt);

        const div = document.createElement("div");
        div.className = "list-item";
        const main = document.createElement("div");
        main.className = "list-item-main";
        const title = document.createElement("div");
        title.className = "list-item-title";
        title.textContent = ws.name;
        const sub = document.createElement("div");
        sub.className = "list-item-sub";
        sub.textContent = `Ø§Ù„Ø®Ø·Ø©: ${ws.plan || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©"} â€¢ Ø§Ù„Ø¯ÙˆØ±: ${ws.role || "member"}`;
        main.appendChild(title);
        main.appendChild(sub);

        const right = document.createElement("div");
        right.style.display = "flex";
        right.style.flexDirection = "column";
        right.style.alignItems = "flex-end";
        right.style.gap = "4px";

        const badge = document.createElement("div");
        badge.className = "badge";
        badge.textContent = ws.active === "Yes" ? "Ù…ÙØ¹Ù„" : "ØºÙŠØ± Ù…ÙØ¹Ù„";

        const btn = document.createElement("button");
        btn.className = "btn-outline";
        btn.style.fontSize = "11px";
        btn.textContent = "Ø§Ø®ØªÙŠØ§Ø±";
        btn.addEventListener("click", () => {
          wsSelect.value = ws.workspaceId;
          onWorkspaceChange();
        });

        right.appendChild(badge);
        right.appendChild(btn);

        div.appendChild(main);
        div.appendChild(right);
        wsList.appendChild(div);
      });

      qs("workspacesCountLabel").textContent = `(${items.length} Workspace)`;
    }

    async function onCreateWorkspaceClick() {
      if (!nhCurrentUser) return;

      const input = qs("wsName");
      const name = (input.value || "").trim();

      if (!name) {
        setStatus(qs("workspaceStatus"), "Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø¨ÙŠØ¦Ø© Ø§Ù„Ø¹Ù…Ù„.", "error");
        return;
      }

      setStatus(qs("workspaceStatus"), "Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ¦Ø© Ø§Ù„Ø¹Ù…Ù„... â³", "muted");
      const btn = qs("btnCreateWorkspace");
      btn.disabled = true;

      try {
        const result = await apiCall("workspace.create", {
          userId: nhCurrentUser.userId,
          name,
        });

        if (!result || !result.success) {
          setStatus(
            qs("workspaceStatus"),
            result && result.error
              ? "ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ Workspace: " + result.error
              : "ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ Workspace.",
            "error"
          );
          return;
        }

        input.value = "";
        setStatus(qs("workspaceStatus"), "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ¦Ø© Ø§Ù„Ø¹Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­.", "ok");
        await loadWorkspaces();
      } catch (err) {
        console.error("createWorkspace error:", err);
        setStatus(qs("workspaceStatus"), "Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Workspace.", "error");
      } finally {
        btn.disabled = false;
      }
    }

    async function onWorkspaceChange() {
      const select = qs("wsSelect");
      const id = select.value || "";
      nhCurrentWorkspaceId = id || null;
      qs("appsWorkspaceLabel").textContent = id ? `Workspace: ${select.options[select.selectedIndex].textContent}` : "";

      if (!id) {
        setStatus(qs("workspaceAppsStatus"), "Ø§Ø®ØªØ± Workspace Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª.", "muted");
        qs("workspaceAppsList").innerHTML = "";
        setStatus(qs("marketplaceStatus"), "Ø§Ø®ØªØ± Workspace Ø«Ù… Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ù…ØªØ§Ø­Ø©.", "muted");
        qs("marketplaceList").innerHTML = "";
        return;
      }

      await Promise.all([loadWorkspaceApps(id), loadMarketplace(id)]);
    }

    // --------- Workspace apps ---------
    async function loadWorkspaceApps(workspaceId) {
      const statusEl = qs("workspaceAppsStatus");
      setStatus(statusEl, "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ù…Ø«Ø¨Ù‘ØªØ©... â³", "muted");
      qs("workspaceAppsList").innerHTML = "";

      try {
        const result = await apiCall("marketplace.listWorkspaceApps", {
          workspaceId,
        });

        if (!result || !result.success) {
          setStatus(
            statusEl,
            result && result.error
              ? "ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª: " + result.error
              : "ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª.",
            "error"
          );
          return;
        }

        const items = result.items || [];
        renderWorkspaceApps(items);
        setStatus(
          statusEl,
          items.length ? "" : "Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ù…Ø«Ø¨Ù‘ØªØ© Ø¨Ø¹Ø¯. ÙŠÙ…ÙƒÙ†Ùƒ ØªØ«Ø¨ÙŠØª Ù‚ÙˆØ§Ù„Ø¨ Ù…Ù† Marketplace.",
          "muted"
        );
      } catch (err) {
        console.error("loadWorkspaceApps error:", err);
        setStatus(statusEl, "Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª.", "error");
      }
    }

    function renderWorkspaceApps(items) {
      const container = qs("workspaceAppsList");
      container.innerHTML = "";

      if (!items || !items.length) return;

      items.forEach((app) => {
        const div = document.createElement("div");
        div.className = "list-item";

        const main = document.createElement("div");
        main.className = "list-item-main";
        const title = document.createElement("div");
        title.className = "list-item-title";
        title.textContent = app.nameAr || app.nameEn || app.appId || "App";

        const sub = document.createElement("div");
        sub.className = "list-item-sub";
        sub.textContent = `Template: ${app.templateId || "â€”"} â€¢ Status: ${
          app.status || "â€”"
        }`;

        main.appendChild(title);
        main.appendChild(sub);

        const right = document.createElement("div");
        right.style.display = "flex";
        right.style.flexDirection = "column";
        right.style.alignItems = "flex-end";
        right.style.gap = "4px";

        const badge = document.createElement("div");
        badge.className = "badge";
        badge.textContent = app.visibleInHub === "Yes" ? "Ø¸Ø§Ù‡Ø± ÙÙŠ Hub" : "Ù…Ø®ÙÙŠ Ø¹Ù† Hub";

        right.appendChild(badge);

        div.appendChild(main);
        div.appendChild(right);

        container.appendChild(div);
      });
    }

    // --------- Marketplace ---------
    async function loadMarketplace(workspaceId) {
      const statusEl = qs("marketplaceStatus");
      setStatus(statusEl, "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚ÙˆØ§Ù„Ø¨ Marketplace... â³", "muted");
      qs("marketplaceList").innerHTML = "";

      try {
        const result = await apiCall("marketplace.listTemplates", { workspaceId });

        if (!result || !result.success) {
          setStatus(
            statusEl,
            result && result.error
              ? "ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Marketplace: " + result.error
              : "ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Marketplace.",
            "error"
          );
          return;
        }

        const items = result.items || [];
        renderMarketplace(items);
        setStatus(
          statusEl,
          items.length ? "" : "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙˆØ§Ù„Ø¨ Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ ÙÙŠ Marketplace.",
          "muted"
        );
      } catch (err) {
        console.error("loadMarketplace error:", err);
        setStatus(statusEl, "Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Marketplace.", "error");
      }
    }

    function renderMarketplace(items) {
      const container = qs("marketplaceList");
      container.innerHTML = "";

      if (!items || !items.length) return;

      items.forEach((tpl) => {
        const div = document.createElement("div");
        div.className = "list-item";

        const main = document.createElement("div");
        main.className = "list-item-main";

        const title = document.createElement("div");
        title.className = "list-item-title";
        const label = tpl.nameAr || tpl.nameEn || tpl.code || tpl.templateId || "Template";
        title.textContent = label;

        const sub = document.createElement("div");
        sub.className = "list-item-sub";
        const typeLabel = tpl.type === "module" ? "Ù…ÙˆØ¯ÙŠÙˆÙ„" : "ØªØ·Ø¨ÙŠÙ‚";
        const cat = tpl.category || "Ø¹Ø§Ù…";
        sub.textContent = `${typeLabel} â€¢ Ø§Ù„ØªØµÙ†ÙŠÙ: ${cat}`;

        main.appendChild(title);
        main.appendChild(sub);

        const right = document.createElement("div");
        right.style.display = "flex";
        right.style.flexDirection = "column";
        right.style.alignItems = "flex-end";
        right.style.gap = "4px";

        const badge = document.createElement("div");
        badge.className = "badge";
        badge.textContent = tpl.installed ? "Ù…Ø«Ø¨Ù‘Øª" : "ØºÙŠØ± Ù…Ø«Ø¨Ù‘Øª";

        const btn = document.createElement("button");
        btn.style.fontSize = "11px";
        if (tpl.installed) {
          btn.className = "btn-outline";
          btn.textContent = "Ù…Ø«Ø¨Ù‘Øª Ø¨Ø§Ù„ÙØ¹Ù„";
          btn.disabled = true;
        } else {
          btn.className = "btn-primary";
          btn.textContent = "ØªØ«Ø¨ÙŠØª";
          btn.addEventListener("click", () => onInstallTemplateClick(tpl));
        }

        right.appendChild(badge);
        right.appendChild(btn);
        div.appendChild(main);
        div.appendChild(right);

        container.appendChild(div);
      });
    }

    async function onInstallTemplateClick(tpl) {
      if (!nhCurrentWorkspaceId || !nhCurrentUser) return;

      const statusEl = qs("marketplaceStatus");
      setStatus(statusEl, `Ø¬Ø§Ø±ÙŠ ØªØ«Ø¨ÙŠØª ${tpl.nameAr || tpl.nameEn || "Ø§Ù„Ù‚Ø§Ù„Ø¨"}... â³`, "muted");

      try {
        // Generic install â€“ backend auto-detects app/module
        const result = await apiCall("marketplace.install", {
          workspaceId: nhCurrentWorkspaceId,
          templateId: tpl.templateId,
          userId: nhCurrentUser.userId,
        });

        if (!result || !result.success) {
          setStatus(
            statusEl,
            result && result.error
              ? "ØªØ¹Ø°Ø± ØªØ«Ø¨ÙŠØª Ø§Ù„Ù‚Ø§Ù„Ø¨: " + result.error
              : "ØªØ¹Ø°Ø± ØªØ«Ø¨ÙŠØª Ø§Ù„Ù‚Ø§Ù„Ø¨.",
            "error"
          );
          return;
        }

        setStatus(statusEl, "ØªÙ… ØªØ«Ø¨ÙŠØª Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­ âœ…", "ok");

        // Refresh lists
        await loadWorkspaceApps(nhCurrentWorkspaceId);
        await loadMarketplace(nhCurrentWorkspaceId);
      } catch (err) {
        console.error("installTemplate error:", err);
        setStatus(statusEl, "Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ«Ø¨ÙŠØª Ø§Ù„Ù‚Ø§Ù„Ø¨.", "error");
      }
    }

    // --------- Init ---------
    function wireEvents() {
      qs("btnSendOtp").addEventListener("click", (e) => {
        e.preventDefault();
        onSendOtpClick();
      });

      qs("btnVerifyOtp").addEventListener("click", (e) => {
        e.preventDefault();
        onVerifyOtpClick();
      });

      qs("btnLogout").addEventListener("click", (e) => {
        e.preventDefault();
        onLogoutClick();
      });

      qs("btnCreateWorkspace").addEventListener("click", (e) => {
        e.preventDefault();
        onCreateWorkspaceClick();
      });

      qs("wsSelect").addEventListener("change", (e) => {
        e.preventDefault();
        onWorkspaceChange();
      });

      // Enter key on OTP triggers verify
      qs("loginOtp").addEventListener("keyup", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          onVerifyOtpClick();
        }
      });

      // Enter on mobile triggers send OTP
      qs("loginMobile").addEventListener("keyup", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          onSendOtpClick();
        }
      });
    }

    document.addEventListener("DOMContentLoaded", async () => {
      qs("year").textContent = new Date().getFullYear();
      wireEvents();
      showAuthView();
      await tryRestoreSession();
    });
  </script>
</body>
</html>
