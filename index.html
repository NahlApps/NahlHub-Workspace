<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <title>NahlHub</title>

  <!-- Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap"
    rel="stylesheet"
  />

  <style>
    :root {
      --bg-light: #f5f7f8;
      --bg-dark: #020617;
      --card-light: #ffffff;
      --card-dark: #020617;
      --border-light: rgba(15, 23, 42, 0.08);
      --border-dark: rgba(148, 163, 184, 0.25);
      --accent: #f4ce14;
      --text-light: #0f172a;
      --text-dark: #e5e7eb;
      --muted-light: #6b7280;
      --muted-dark: #9ca3af;
      --surface-radius: 18px;
      --transition-fast: 0.18s ease-out;
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: "Cairo", system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", sans-serif;
    }

    body[data-theme="light"] {
      background: radial-gradient(
          circle at top left,
          rgba(244, 206, 20, 0.18),
          transparent 55%
        ),
        var(--bg-light);
      color: var(--text-light);
    }

    body[data-theme="dark"] {
      background: radial-gradient(
          circle at top left,
          rgba(250, 204, 21, 0.14),
          transparent 50%
        ),
        linear-gradient(145deg, #020617, #020617);
      color: var(--text-dark);
    }

    .app-shell {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 6px;
      gap: 8px;
      position: relative;
    }

    /* Topbar */

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid;
      backdrop-filter: blur(14px);
      gap: 12px;
      position: relative;
      z-index: 10;
    }

    body[data-theme="light"] .topbar {
      background: rgba(255, 255, 255, 0.72);
      border-color: var(--border-light);
    }

    body[data-theme="dark"] .topbar {
      background: rgba(15, 23, 42, 0.8);
      border-color: var(--border-dark);
    }

    .topbar-left {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
    }

    .brand-logo {
      width: 30px;
      height: 30px;
      border-radius: 11px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 18px;
      background: radial-gradient(circle at 20% 0, #facc15, #f97316);
      color: #111827;
    }

    .brand-text {
      display: flex;
      flex-direction: column;
      gap: 0;
      font-size: 13px;
      line-height: 1.2;
    }

    .brand-title {
      font-weight: 700;
      letter-spacing: 0.02em;
      white-space: nowrap;
    }

    .brand-subtitle {
      font-size: 11px;
      opacity: 0.75;
    }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .chip-group {
      display: inline-flex;
      padding: 2px;
      border-radius: 999px;
      border: 1px solid transparent;
      background: transparent;
      gap: 2px;
    }

    body[data-theme="light"] .chip-group {
      border-color: rgba(148, 163, 184, 0.42);
      background: rgba(255, 255, 255, 0.9);
    }

    body[data-theme="dark"] .chip-group {
      border-color: rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.95);
    }

    .chip-btn {
      border: none;
      outline: none;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
      cursor: pointer;
      background: transparent;
      color: inherit;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: background var(--transition-fast),
        color var(--transition-fast), transform var(--transition-fast),
        box-shadow var(--transition-fast);
      white-space: nowrap;
    }

    .chip-btn span.icon {
      font-size: 13px;
      line-height: 1;
    }

    .chip-btn.active {
      background: var(--accent);
      color: #111827;
      box-shadow: 0 6px 18px rgba(250, 204, 21, 0.4);
      transform: translateY(-0.5px);
    }

    .chip-btn:not(.active):hover {
      background: rgba(148, 163, 184, 0.25);
    }

    body[data-theme="dark"] .chip-btn:not(.active):hover {
      background: rgba(31, 41, 55, 0.8);
    }

    .chip-btn-mini {
      border-radius: 999px;
      padding: 5px 7px;
      font-size: 11px;
    }

    /* Apps burger menu (header) */

    .apps-menu-btn {
      border-radius: 999px;
      padding: 5px 9px;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .apps-menu-panel {
      position: absolute;
      top: 48px;
      inset-inline-end: 10px;
      min-width: 200px;
      max-width: 260px;
      max-height: 260px;
      overflow-y: auto;
      border-radius: 16px;
      border: 1px solid;
      padding: 6px;
      z-index: 20;
    }

    body[data-theme="light"] .apps-menu-panel {
      background: #ffffff;
      border-color: rgba(148, 163, 184, 0.4);
      box-shadow: 0 18px 30px rgba(15, 23, 42, 0.16);
    }

    body[data-theme="dark"] .apps-menu-panel {
      background: rgba(15, 23, 42, 0.98);
      border-color: rgba(148, 163, 184, 0.6);
      box-shadow: 0 18px 34px rgba(15, 23, 42, 0.8);
    }

    .apps-menu-item {
      width: 100%;
      border-radius: 12px;
      border: 1px solid transparent;
      padding: 6px 8px;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      background: transparent;
      color: inherit;
      cursor: pointer;
      text-align: start;
      transition: background var(--transition-fast),
        border-color var(--transition-fast), transform var(--transition-fast);
    }

    .apps-menu-item-title {
      font-weight: 500;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .apps-menu-item-cat {
      font-size: 11px;
      opacity: 0.6;
    }

    body[data-theme="light"] .apps-menu-item:hover {
      background: rgba(248, 250, 252, 0.9);
      border-color: rgba(148, 163, 184, 0.35);
    }

    body[data-theme="dark"] .apps-menu-item:hover {
      background: rgba(30, 64, 175, 0.2);
      border-color: rgba(129, 140, 248, 0.6);
    }

    .apps-menu-item.active {
      border-color: rgba(250, 204, 21, 0.9);
      background: rgba(250, 204, 21, 0.14);
    }

    /* Status pill */

    .status-pill {
      align-self: stretch;
      margin: 0 4px;
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: 1px solid transparent;
      max-width: 100%;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }

    body[data-theme="light"] .status-pill {
      background: rgba(255, 255, 255, 0.9);
      border-color: var(--border-light);
      color: var(--muted-light);
    }

    body[data-theme="dark"] .status-pill {
      background: rgba(15, 23, 42, 0.9);
      border-color: var(--border-dark);
      color: var(--muted-dark);
    }

    .status-pill.ok {
      border-color: rgba(34, 197, 94, 0.7);
      color: rgba(34, 197, 94, 0.95);
    }

    .status-pill.error {
      border-color: rgba(239, 68, 68, 0.85);
      color: rgba(248, 113, 113, 0.96);
    }

    .status-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--accent);
    }

    /* Main content */

    .main-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 0;
    }

    .welcome-card {
      border-radius: var(--surface-radius);
      padding: 12px 14px;
      border: 1px solid;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    body[data-theme="light"] .welcome-card {
      background: linear-gradient(
        135deg,
        rgba(244, 206, 20, 0.12),
        rgba(255, 255, 255, 0.96)
      );
      border-color: var(--border-light);
    }

    body[data-theme="dark"] .welcome-card {
      background: linear-gradient(
        145deg,
        rgba(250, 204, 21, 0.16),
        rgba(15, 23, 42, 0.96)
      );
      border-color: rgba(148, 163, 184, 0.45);
    }

    .welcome-header-line {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .welcome-title {
      font-size: 16px;
      font-weight: 700;
    }

    .welcome-sub {
      font-size: 12px;
      opacity: 0.85;
    }

    /* Generic card */

    .card {
      border-radius: var(--surface-radius);
      padding: 12px 14px 14px;
      border: 1px solid;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    body[data-theme="light"] .card {
      background: #ffffff;
      border-color: var(--border-light);
    }

    body[data-theme="dark"] .card {
      background: rgba(15, 23, 42, 0.96);
      border-color: var(--border-dark);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .card-title {
      font-size: 15px;
      font-weight: 600;
    }

    .card-caption {
      font-size: 12px;
      opacity: 0.7;
    }

    .card-body {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .field-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .field-label {
      font-size: 12px;
      opacity: 0.85;
    }

    .field-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .input {
      flex: 1;
      border-radius: 999px;
      border: 1px solid;
      padding: 8px 12px;
      font-size: 13px;
      outline: none;
      transition: border-color var(--transition-fast),
        box-shadow var(--transition-fast), background var(--transition-fast);
    }

    body[data-theme="light"] .input {
      background: rgba(248, 250, 252, 0.95);
      border-color: rgba(148, 163, 184, 0.5);
      color: var(--text-light);
    }

    body[data-theme="dark"] .input {
      background: rgba(15, 23, 42, 0.96);
      border-color: rgba(148, 163, 184, 0.6);
      color: var(--text-dark);
    }

    .input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(250, 204, 21, 0.55);
      background: rgba(255, 251, 235, 0.9);
    }

    body[data-theme="dark"] .input:focus {
      background: rgba(15, 23, 42, 0.98);
    }

    .btn {
      border-radius: 999px;
      border: none;
      outline: none;
      padding: 9px 18px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: transform var(--transition-fast),
        box-shadow var(--transition-fast), background var(--transition-fast),
        color var(--transition-fast), opacity var(--transition-fast);
      white-space: nowrap;
    }

    .btn-primary {
      background: var(--accent);
      color: #111827;
      box-shadow: 0 8px 20px rgba(250, 204, 21, 0.45);
    }

    .btn-primary:hover:enabled {
      transform: translateY(-0.5px);
      box-shadow: 0 10px 28px rgba(250, 204, 21, 0.6);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: default;
      box-shadow: none;
      transform: none;
    }

    .btn-ghost {
      background: transparent;
      color: inherit;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 11px;
      border: none;
      cursor: pointer;
    }

    body[data-theme="light"] .btn-ghost:hover {
      background: rgba(148, 163, 184, 0.18);
    }

    body[data-theme="dark"] .btn-ghost:hover {
      background: rgba(31, 41, 55, 0.9);
    }

    /* OTP row: left to right */

    .otp-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      direction: ltr;
    }

    .otp-input {
      width: 44px;
      height: 44px;
      text-align: center;
      font-size: 18px;
      font-weight: 600;
      border-radius: 16px;
      border: 1px solid;
      outline: none;
      transition: border-color var(--transition-fast),
        box-shadow var(--transition-fast), background var(--transition-fast);
    }

    body[data-theme="light"] .otp-input {
      background: rgba(248, 250, 252, 0.96);
      border-color: rgba(148, 163, 184, 0.5);
      color: var(--text-light);
    }

    body[data-theme="dark"] .otp-input {
      background: rgba(15, 23, 42, 0.97);
      border-color: rgba(148, 163, 184, 0.7);
      color: var(--text-dark);
    }

    .otp-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(250, 204, 21, 0.55);
      background: rgba(255, 251, 235, 0.96);
    }

    body[data-theme="dark"] .otp-input:focus {
      background: rgba(15, 23, 42, 1);
    }

    /* Apps layout */

    .apps-layout {
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 0;
      flex: 1;
    }

    #appsCard {
      padding-bottom: 12px;
    }

    .apps-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
      max-height: 220px;
      overflow-y: auto;
      padding-top: 4px;
    }

    .app-card {
      border-radius: 16px;
      border: 1px solid;
      padding: 10px 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      cursor: pointer;
      position: relative;
      transition: background var(--transition-fast),
        border-color var(--transition-fast), transform var(--transition-fast),
        box-shadow var(--transition-fast);
    }

    body[data-theme="light"] .app-card {
      background: rgba(255, 255, 255, 0.96);
      border-color: rgba(148, 163, 184, 0.35);
    }

    body[data-theme="dark"] .app-card {
      background: rgba(15, 23, 42, 0.96);
      border-color: rgba(148, 163, 184, 0.55);
    }

    .app-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 26px rgba(15, 23, 42, 0.18);
      border-color: rgba(250, 204, 21, 0.9);
    }

    .app-card-header {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .app-card-icon {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      background: rgba(244, 206, 20, 0.15);
      color: #92400e;
    }

    body[data-theme="dark"] .app-card-icon {
      background: rgba(250, 204, 21, 0.14);
      color: #facc15;
    }

    .app-card-title {
      font-size: 13px;
      font-weight: 600;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .app-card-body {
      font-size: 11px;
      opacity: 0.78;
      height: 2.4em;
      overflow: hidden;
    }

    .app-card-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 11px;
      opacity: 0.75;
      margin-top: 2px;
    }

    .badge-pinned {
      border-radius: 999px;
      padding: 2px 6px;
      font-size: 10px;
      background: rgba(250, 204, 21, 0.16);
      color: #92400e;
    }

    body[data-theme="dark"] .badge-pinned {
      background: rgba(250, 204, 21, 0.22);
      color: #facc15;
    }

    .app-view {
      flex: 1;
      border-radius: 14px;
      border: 1px solid;
      overflow: hidden;
      min-height: 220px;
    }

    body[data-theme="light"] .app-view {
      background: #ffffff;
      border-color: var(--border-light);
    }

    body[data-theme="dark"] .app-view {
      background: rgba(15, 23, 42, 0.96);
      border-color: var(--border-dark);
    }

    .app-view-header {
      padding: 7px 10px;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      border-bottom: 1px solid;
    }

    body[data-theme="light"] .app-view-header {
      border-color: rgba(148, 163, 184, 0.25);
      background: rgba(248, 250, 252, 0.96);
    }

    body[data-theme="dark"] .app-view-header {
      border-color: rgba(51, 65, 85, 0.9);
      background: rgba(15, 23, 42, 0.98);
    }

    .app-frame-wrap {
      width: 100%;
      height: calc(100vh - 260px);
      max-height: calc(100vh - 240px);
    }

    .app-frame {
      width: 100%;
      height: 100%;
      border: none;
      display: block;
      background: transparent;
    }

    .app-frame-placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      opacity: 0.6;
      padding: 10px;
      text-align: center;
    }

    .hidden {
      display: none !important;
    }

    /* Auth popup overlay */

    .auth-overlay {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 12px;
      z-index: 30;
      backdrop-filter: blur(10px);
    }

    body[data-theme="light"] .auth-overlay {
      background: radial-gradient(
          circle at top,
          rgba(148, 163, 184, 0.16),
          transparent 60%
        ),
        rgba(15, 23, 42, 0.18);
    }

    body[data-theme="dark"] .auth-overlay {
      background: radial-gradient(
          circle at top,
          rgba(15, 23, 42, 0.95),
          rgba(15, 23, 42, 0.98)
        );
    }

    .auth-modal {
      width: 100%;
      max-width: 420px;
      border-radius: 22px;
      border: 1px solid;
      padding: 14px 12px 12px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.55);
    }

    body[data-theme="light"] .auth-modal {
      background: linear-gradient(
        140deg,
        rgba(244, 206, 20, 0.12),
        #ffffff
      );
      border-color: rgba(148, 163, 184, 0.5);
    }

    body[data-theme="dark"] .auth-modal {
      background: radial-gradient(
          circle at top left,
          rgba(250, 204, 21, 0.18),
          transparent 50%
        ),
        rgba(15, 23, 42, 0.98);
      border-color: rgba(148, 163, 184, 0.6);
    }

    .auth-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 2px 4px 10px;
    }

    .auth-title {
      font-size: 15px;
      font-weight: 700;
    }

    .auth-sub {
      font-size: 12px;
      opacity: 0.78;
    }

    .auth-badge {
      font-size: 11px;
      border-radius: 999px;
      padding: 3px 8px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      opacity: 0.9;
    }

    .auth-modal-body {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    /* Hub header: workspace + nav */

    .hub-header-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
    }

    .workspace-select-wrap {
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 220px;
      max-width: 320px;
    }

    .workspace-select-row {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .workspace-tag {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      opacity: 0.85;
      white-space: nowrap;
    }

    .workspace-select {
      flex: 1;
      border-radius: 999px;
      border: 1px solid;
      padding: 7px 10px;
      font-size: 12px;
      outline: none;
      background: transparent;
    }

    body[data-theme="light"] .workspace-select {
      background: rgba(248, 250, 252, 0.95);
      border-color: rgba(148, 163, 184, 0.5);
      color: var(--text-light);
    }

    body[data-theme="dark"] .workspace-select {
      background: rgba(15, 23, 42, 0.96);
      border-color: rgba(148, 163, 184, 0.6);
      color: var(--text-dark);
    }

    .workspace-select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(250, 204, 21, 0.55);
    }

    .hub-nav-group {
      display: inline-flex;
      padding: 2px;
      border-radius: 999px;
      border: 1px solid transparent;
      gap: 2px;
    }

    body[data-theme="light"] .hub-nav-group {
      background: rgba(248, 250, 252, 0.96);
      border-color: rgba(148, 163, 184, 0.45);
    }

    body[data-theme="dark"] .hub-nav-group {
      background: rgba(15, 23, 42, 0.98);
      border-color: rgba(148, 163, 184, 0.6);
    }

    .hub-nav-btn {
      padding-inline: 12px;
      font-size: 11px;
    }

    /* Marketplace */

    .marketplace-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      justify-content: space-between;
    }

    .pill-filters {
      display: inline-flex;
      gap: 4px;
      padding: 2px;
      border-radius: 999px;
      border: 1px solid transparent;
    }

    body[data-theme="light"] .pill-filters {
      border-color: rgba(148, 163, 184, 0.3);
      background: rgba(248, 250, 252, 0.98);
    }

    body[data-theme="dark"] .pill-filters {
      border-color: rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.98);
    }

    .pill-btn {
      border-radius: 999px;
      border: none;
      padding: 4px 10px;
      font-size: 11px;
      cursor: pointer;
      background: transparent;
      color: inherit;
      transition: background var(--transition-fast),
        color var(--transition-fast), box-shadow var(--transition-fast);
    }

    .pill-btn.active {
      background: var(--accent);
      color: #111827;
      box-shadow: 0 6px 16px rgba(250, 204, 21, 0.4);
    }

    .marketplace-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 10px;
    }

    .marketplace-card {
      border-radius: 14px;
      border: 1px solid;
      padding: 8px 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 11px;
      position: relative;
    }

    body[data-theme="light"] .marketplace-card {
      background: rgba(255, 255, 255, 0.98);
      border-color: rgba(148, 163, 184, 0.35);
    }

    body[data-theme="dark"] .marketplace-card {
      background: rgba(15, 23, 42, 0.96);
      border-color: rgba(148, 163, 184, 0.6);
    }

    .marketplace-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    .marketplace-name {
      font-size: 12px;
      font-weight: 600;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .marketplace-type {
      font-size: 10px;
      border-radius: 999px;
      padding: 2px 6px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      white-space: nowrap;
    }

    .marketplace-desc {
      font-size: 11px;
      opacity: 0.78;
      max-height: 3em;
      overflow: hidden;
    }

    .marketplace-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .tag-pill {
      font-size: 10px;
      border-radius: 999px;
      padding: 2px 6px;
      background: rgba(148, 163, 184, 0.18);
    }

    body[data-theme="dark"] .tag-pill {
      background: rgba(31, 41, 55, 0.9);
    }

    .marketplace-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-top: 4px;
    }

    .installed-label {
      font-size: 10px;
      border-radius: 999px;
      padding: 2px 6px;
      background: rgba(34, 197, 94, 0.12);
      color: rgba(22, 163, 74, 0.96);
    }

    body[data-theme="dark"] .installed-label {
      background: rgba(22, 163, 74, 0.3);
      color: #bbf7d0;
    }

    @media (min-width: 768px) {
      .app-shell {
        padding: 6px 10px;
      }
      .main-panel {
        max-width: 100%;
        width: 100%;
        margin: 0;
      }
      .app-frame-wrap {
        height: calc(100vh - 260px);
        max-height: calc(100vh - 240px);
      }
      .apps-list {
        max-height: 220px;
      }
    }
  </style>
</head>
<body data-theme="light">
  <div class="app-shell">
    <!-- Apps burger panel -->
    <div id="appsMenuPanel" class="apps-menu-panel hidden"></div>

    <!-- Top bar -->
    <header class="topbar">
      <div class="topbar-left">
        <div class="brand-logo">N</div>
        <div class="brand-text">
          <div class="brand-title" data-i18n="hubTitle">NahlHub</div>
          <div class="brand-subtitle" data-i18n="hubSub">
            ØªØ·Ø¨ÙŠÙ‚Ø§ØªÙƒ ÙÙŠ Ù†Ø­Ù„ Ù‡Ø¨
          </div>
        </div>
      </div>
      <div class="topbar-right">
        <button
          class="chip-btn chip-btn-mini apps-menu-btn hidden"
          id="btnAppsMenu"
          type="button"
        >
          <span class="icon">â˜°</span>
          <span data-i18n="appsTitle">ØªØ·Ø¨ÙŠÙ‚Ø§ØªÙƒ</span>
        </button>

        <div class="chip-group">
          <button
            class="chip-btn"
            id="btnLangAr"
            type="button"
            data-lang="ar"
          >
            <span>Ø¹Ø±Ø¨ÙŠ</span>
          </button>
          <button
            class="chip-btn"
            id="btnLangEn"
            type="button"
            data-lang="en"
          >
            <span>EN</span>
          </button>
        </div>
        <button
          class="chip-btn chip-btn-mini"
          id="btnTheme"
          type="button"
        >
          <span class="icon" id="themeIcon">ğŸŒ</span>
        </button>
      </div>
    </header>

    <!-- Status -->
    <div id="statusPill" class="status-pill">
      <span class="status-dot"></span>
      <span id="statusText"></span>
    </div>

    <!-- AUTH POPUP -->
    <div id="authOverlay" class="auth-overlay">
      <div class="auth-modal">
        <div class="auth-modal-header">
          <div>
            <div class="auth-title" data-i18n="welcomeTitle">Ù…Ø±Ø­Ø¨Ø§Ù‹ ğŸ‘‹</div>
            <div class="auth-sub" data-i18n="welcomeSub">
              Ø§Ø¯Ø®Ù„ Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø«Ù… Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„.
            </div>
          </div>
          <div class="auth-badge">
            <span data-i18n="step1Title">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</span> Â·
            <span data-i18n="step2Title">Ø±Ù…Ø²</span>
          </div>
        </div>
        <div class="auth-modal-body">
          <!-- Step 1: Mobile -->
          <section id="stepMobile" class="card" style="margin: 0">
            <div class="card-header">
              <div>
                <div class="card-title" data-i18n="step1Title">
                  Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„
                </div>
                <div class="card-caption" data-i18n="step1Sub">
                  Ø§Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„.
                </div>
              </div>
            </div>
            <div class="card-body">
              <div class="field-group">
                <label
                  class="field-label"
                  for="mobileInput"
                  data-i18n="step1Label"
                >
                  Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„
                </label>
                <div class="field-row">
                  <input
                    id="mobileInput"
                    class="input"
                    type="tel"
                    inputmode="tel"
                    autocomplete="tel"
                    placeholder="5XXXXXXXX"
                  />
                </div>
              </div>
              <div class="field-row" style="justify-content: flex-end">
                <button
                  id="btnSendOtp"
                  class="btn btn-primary"
                  type="button"
                >
                  <span data-i18n="btnSendOtp">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²</span>
                </button>
              </div>
            </div>
          </section>

          <!-- Step 2: OTP -->
          <section id="stepOtp" class="card hidden" style="margin: 0">
            <div class="card-header">
              <div>
                <div class="card-title" data-i18n="step2Title">
                  Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„
                </div>
                <div class="card-caption" data-i18n="step2Sub">
                  Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ù¤ Ø£Ø±Ù‚Ø§Ù….
                </div>
              </div>
              <button
                type="button"
                class="btn-ghost"
                id="btnChangeMobile"
              >
                <span data-i18n="changeMobile">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ù‚Ù…</span>
              </button>
            </div>
            <div class="card-body">
              <div class="otp-row">
                <input
                  class="otp-input"
                  id="otp1"
                  type="tel"
                  inputmode="numeric"
                  maxlength="1"
                />
                <input
                  class="otp-input"
                  id="otp2"
                  type="tel"
                  inputmode="numeric"
                  maxlength="1"
                />
                <input
                  class="otp-input"
                  id="otp3"
                  type="tel"
                  inputmode="numeric"
                  maxlength="1"
                />
                <input
                  class="otp-input"
                  id="otp4"
                  type="tel"
                  inputmode="numeric"
                  maxlength="1"
                />
              </div>
              <div
                class="field-row"
                style="justify-content: flex-end; margin-top: 10px"
              >
                <button
                  id="btnVerifyOtp"
                  class="btn btn-primary"
                  type="button"
                >
                  <span data-i18n="btnVerify">ØªØ£ÙƒÙŠØ¯</span>
                </button>
              </div>
            </div>
          </section>
        </div>
      </div>
    </div>

    <!-- Main -->
    <main class="main-panel">
      <!-- Welcome -->
      <section class="welcome-card" id="welcomeCard">
        <div class="welcome-header-line">
          <div>
            <div class="welcome-title" data-i18n="welcomeTitle">Ù…Ø±Ø­Ø¨Ø§Ù‹ ğŸ‘‹</div>
            <div class="welcome-sub" data-i18n="welcomeSub">
              Ø§Ø¯Ø®Ù„ Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø«Ù… Ø§Ø®ØªØ± Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„ ÙˆØ§Ù„ØªØ·Ø¨ÙŠÙ‚.
            </div>
          </div>
        </div>
      </section>

      <!-- Hub header: workspace + nav -->
      <section id="hubHeader" class="card hidden">
        <div class="hub-header-row">
          <div class="workspace-select-wrap">
            <label class="field-label" for="workspaceSelect" data-i18n="workspaceLabel">
              Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„
            </label>
            <div class="workspace-select-row">
              <span class="workspace-tag" id="currentUserBadge"></span>
              <select id="workspaceSelect" class="workspace-select">
                <option value="" selected disabled data-i18n="workspacePlaceholder">
                  Ø§Ø®ØªØ± Ù…Ø³Ø§Ø­Ø© Ø¹Ù…Ù„
                </option>
              </select>
            </div>
          </div>
          <div class="hub-nav-group">
            <button
              type="button"
              class="chip-btn hub-nav-btn active"
              data-view="apps"
              id="btnViewApps"
            >
              <span data-i18n="navApps">ØªØ·Ø¨ÙŠÙ‚Ø§ØªÙƒ</span>
            </button>
            <button
              type="button"
              class="chip-btn hub-nav-btn"
              data-view="marketplace"
              id="btnViewMarketplace"
            >
              <span data-i18n="navMarketplace">Ù…ØªØ¬Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª</span>
            </button>
          </div>
        </div>
      </section>

      <!-- View: Your Apps -->
      <section id="viewApps" class="apps-layout hidden">
        <!-- Home cards -->
        <div class="card" id="appsCard">
          <div class="card-header">
            <div>
              <div class="card-title" data-i18n="appsTitle">
                ØªØ·Ø¨ÙŠÙ‚Ø§ØªÙƒ
              </div>
              <div class="card-caption" id="userNameLabel"></div>
            </div>
            <button
              class="btn-ghost"
              type="button"
              id="btnLogout"
            >
              <span data-i18n="logout">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</span>
            </button>
          </div>
          <div class="card-body">
            <div id="appsList" class="apps-list"></div>
          </div>
        </div>

        <div class="app-view hidden" id="appView">
          <div class="app-view-header">
            <div id="currentAppTitle" class="card-caption">
              <span data-i18n="appPlaceholder">
                Ø§Ø®ØªØ± ØªØ·Ø¨ÙŠÙ‚Ø§Ù‹ Ù…Ù† Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©.
              </span>
            </div>
            <button
              id="btnHome"
              class="btn-ghost hidden"
              type="button"
              aria-label="Home"
            >
              ğŸ 
            </button>
          </div>
          <div class="app-frame-wrap">
            <iframe
              id="appFrame"
              class="app-frame hidden"
              src=""
              title="NahlHub App"
            ></iframe>
            <div
              id="appFramePlaceholder"
              class="app-frame-placeholder"
            >
              <span data-i18n="appPlaceholder">
                Ø§Ø®ØªØ± ØªØ·Ø¨ÙŠÙ‚Ø§Ù‹ Ù…Ù† Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©.
              </span>
            </div>
          </div>
        </div>
      </section>

      <!-- View: Marketplace -->
      <section id="viewMarketplace" class="card hidden">
        <div class="card-header">
          <div>
            <div class="card-title" data-i18n="marketTitle">
              Ù…ØªØ¬Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª
            </div>
            <div class="card-caption" data-i18n="marketSub">
              Ø«Ø¨Ù‘Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø£Ùˆ Ø§Ù„Ø­Ø²Ù… Ø§Ù„Ø¬Ø§Ù‡Ø²Ø© Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠØ©.
            </div>
          </div>
        </div>
        <div class="card-body">
          <div class="marketplace-filters">
            <div class="pill-filters">
              <button
                type="button"
                class="pill-btn active"
                data-filter="all"
                id="filterAll"
              >
                <span data-i18n="filterAll">Ø§Ù„ÙƒÙ„</span>
              </button>
              <button
                type="button"
                class="pill-btn"
                data-filter="app"
                id="filterApps"
              >
                <span data-i18n="filterApps">ØªØ·Ø¨ÙŠÙ‚Ø§Øª</span>
              </button>
              <button
                type="button"
                class="pill-btn"
                data-filter="module"
                id="filterModules"
              >
                <span data-i18n="filterModules">Ø­Ø²Ù… (Modules)</span>
              </button>
            </div>
          </div>
          <div id="marketplaceEmpty" class="card-caption hidden">
            <span data-i18n="marketEmpty">
              Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± ÙÙŠ Ø§Ù„Ù…ØªØ¬Ø± Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.
            </span>
          </div>
          <div id="marketplaceGrid" class="marketplace-grid"></div>
        </div>
      </section>
    </main>
  </div>

  <script>
    (function () {
      "use strict";

      var API_URL = "/api/hub/manage";
      var STORAGE_SESSION_KEY = "nahlhub_session_key";
      var STORAGE_LANG = "nahlhub_lang";
      var STORAGE_THEME = "nahlhub_theme";
      var HUB_APP_ID = "HUB"; // Ø«Ø§Ø¨Øª Ù„Ù„Ù€ OTP ÙˆØ§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù€ Hub

      var currentLang = localStorage.getItem(STORAGE_LANG) || "ar";
      var currentTheme = localStorage.getItem(STORAGE_THEME) || "light";
      var currentSessionKey =
        localStorage.getItem(STORAGE_SESSION_KEY) || null;

      var currentUser = null;
      var workspaces = [];
      var currentWorkspaceId = null;
      var workspaceApps = [];
      var currentApps = [];
      var marketplaceItems = [];
      var templatesById = {};
      var currentMobileRaw = "";
      var currentHubView = "apps";
      var currentMarketplaceFilter = "all";

      var bodyEl = document.body;
      var statusPill = document.getElementById("statusPill");
      var statusText = document.getElementById("statusText");

      var welcomeCard = document.getElementById("welcomeCard");

      var authOverlay = document.getElementById("authOverlay");
      var stepMobile = document.getElementById("stepMobile");
      var stepOtp = document.getElementById("stepOtp");

      var mobileInput = document.getElementById("mobileInput");
      var btnSendOtp = document.getElementById("btnSendOtp");

      var otpInputs = [
        document.getElementById("otp1"),
        document.getElementById("otp2"),
        document.getElementById("otp3"),
        document.getElementById("otp4")
      ];
      var btnVerifyOtp = document.getElementById("btnVerifyOtp");
      var btnChangeMobile = document.getElementById("btnChangeMobile");

      var hubHeader = document.getElementById("hubHeader");
      var workspaceSelect = document.getElementById("workspaceSelect");
      var currentUserBadge = document.getElementById("currentUserBadge");

      var viewApps = document.getElementById("viewApps");
      var viewMarketplace = document.getElementById("viewMarketplace");

      var appsCard = document.getElementById("appsCard");
      var appsListEl = document.getElementById("appsList");
      var appView = document.getElementById("appView");
      var appFrame = document.getElementById("appFrame");
      var appFramePlaceholder = document.getElementById("appFramePlaceholder");
      var currentAppTitle = document.getElementById("currentAppTitle");
      var userNameLabel = document.getElementById("userNameLabel");
      var btnLogout = document.getElementById("btnLogout");
      var btnHome = document.getElementById("btnHome");

      var btnTheme = document.getElementById("btnTheme");
      var themeIcon = document.getElementById("themeIcon");
      var btnLangAr = document.getElementById("btnLangAr");
      var btnLangEn = document.getElementById("btnLangEn");

      var btnAppsMenu = document.getElementById("btnAppsMenu");
      var appsMenuPanel = document.getElementById("appsMenuPanel");

      var btnViewApps = document.getElementById("btnViewApps");
      var btnViewMarketplace = document.getElementById("btnViewMarketplace");

      var filterAll = document.getElementById("filterAll");
      var filterApps = document.getElementById("filterApps");
      var filterModules = document.getElementById("filterModules");
      var marketplaceGrid = document.getElementById("marketplaceGrid");
      var marketplaceEmpty = document.getElementById("marketplaceEmpty");

      var tDict = {
        hubTitle: { ar: "NahlHub", en: "NahlHub" },
        hubSub: {
          ar: "ØªØ·Ø¨ÙŠÙ‚Ø§ØªÙƒ ÙÙŠ Ù†Ø­Ù„ Ù‡Ø¨",
          en: "Your apps in NahlHub"
        },
        welcomeTitle: { ar: "Ù…Ø±Ø­Ø¨Ø§Ù‹ ğŸ‘‹", en: "Welcome ğŸ‘‹" },
        welcomeSub: {
          ar: "Ø§Ø¯Ø®Ù„ Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø«Ù… Ø§Ø®ØªØ± Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„ ÙˆØ§Ù„ØªØ·Ø¨ÙŠÙ‚.",
          en: "Enter your mobile, then choose a workspace and app."
        },
        step1Title: { ar: "Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„", en: "Mobile number" },
        step1Sub: { ar: "Ø§Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„.", en: "Enter your mobile." },
        step1Label: { ar: "Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„", en: "Mobile" },
        btnSendOtp: { ar: "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²", en: "Send code" },
        step2Title: { ar: "Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„", en: "Login code" },
        step2Sub: {
          ar: "Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ù¤ Ø£Ø±Ù‚Ø§Ù….",
          en: "Enter the 4-digit code."
        },
        changeMobile: { ar: "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ù‚Ù…", en: "Change number" },
        btnVerify: { ar: "ØªØ£ÙƒÙŠØ¯", en: "Confirm" },
        appsTitle: { ar: "ØªØ·Ø¨ÙŠÙ‚Ø§ØªÙƒ", en: "Your apps" },
        logout: { ar: "ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬", en: "Logout" },
        appPlaceholder: {
          ar: "Ø§Ø®ØªØ± ØªØ·Ø¨ÙŠÙ‚Ø§Ù‹ Ù…Ù† Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©.",
          en: "Choose an app from the home cards."
        },
        statusIdle: { ar: "Ø¬Ø§Ù‡Ø².", en: "Ready." },
        statusSendingOtp: {
          ar: "ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²...",
          en: "Sending code..."
        },
        statusOtpSent: {
          ar: "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø² Ø¥Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨.",
          en: "Code sent to WhatsApp."
        },
        statusVerifying: { ar: "ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚...", en: "Verifying..." },
        statusNoApps: {
          ar: "Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ù…ØªØ§Ø­Ø©.",
          en: "No apps available."
        },
        statusNoWorkspaces: {
          ar: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³Ø§Ø­Ø§Øª Ø¹Ù…Ù„ Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….",
          en: "No workspaces found for this user."
        },
        statusLoadingWorkspaces: {
          ar: "ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ø³Ø§Ø­Ø§Øª Ø§Ù„Ø¹Ù…Ù„...",
          en: "Loading workspaces..."
        },
        statusLoadingApps: {
          ar: "ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„...",
          en: "Loading workspace apps..."
        },
        statusLoadingMarketplace: {
          ar: "ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…ØªØ¬Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª...",
          en: "Loading marketplace..."
        },
        statusError: {
          ar: "Ø­Ø¯Ø« Ø®Ø·Ø£. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.",
          en: "Something went wrong. Try again."
        },
        statusInstallOk: {
          ar: "ØªÙ… ØªØ«Ø¨ÙŠØª Ø§Ù„Ø¹Ù†ØµØ± Ø¨Ù†Ø¬Ø§Ø­.",
          en: "Installed successfully."
        },
        statusInstallError: {
          ar: "ØªØ¹Ø°Ø± ØªØ«Ø¨ÙŠØª Ø§Ù„Ø¹Ù†ØµØ±.",
          en: "Failed to install item."
        },
        workspaceLabel: { ar: "Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„", en: "Workspace" },
        workspacePlaceholder: {
          ar: "Ø§Ø®ØªØ± Ù…Ø³Ø§Ø­Ø© Ø¹Ù…Ù„",
          en: "Select workspace"
        },
        navApps: { ar: "ØªØ·Ø¨ÙŠÙ‚Ø§ØªÙƒ", en: "Your apps" },
        navMarketplace: { ar: "Ù…ØªØ¬Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª", en: "Marketplace" },
        marketTitle: { ar: "Ù…ØªØ¬Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª", en: "App Marketplace" },
        marketSub: {
          ar: "Ø«Ø¨Ù‘Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø£Ùˆ Ø§Ù„Ø­Ø²Ù… Ø§Ù„Ø¬Ø§Ù‡Ø²Ø© Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠØ©.",
          en: "Install apps or modules into the current workspace."
        },
        filterAll: { ar: "Ø§Ù„ÙƒÙ„", en: "All" },
        filterApps: { ar: "ØªØ·Ø¨ÙŠÙ‚Ø§Øª", en: "Apps" },
        filterModules: { ar: "Ø­Ø²Ù… (Modules)", en: "Modules" },
        marketEmpty: {
          ar: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± ÙÙŠ Ø§Ù„Ù…ØªØ¬Ø± Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.",
          en: "No marketplace items for this workspace yet."
        }
      };

      function t(key) {
        var entry = tDict[key];
        if (!entry) return key;
        return entry[currentLang] || entry.ar || key;
      }

      function applyLanguage() {
        document.documentElement.lang = currentLang;
        document.documentElement.dir = currentLang === "ar" ? "rtl" : "ltr";

        var nodes = document.querySelectorAll("[data-i18n]");
        nodes.forEach(function (node) {
          var key = node.getAttribute("data-i18n");
          node.textContent = t(key);
        });

        if (currentLang === "ar") {
          btnLangAr.classList.add("active");
          btnLangEn.classList.remove("active");
          mobileInput.placeholder = "5XXXXXXXX";
        } else {
          btnLangAr.classList.remove("active");
          btnLangEn.classList.add("active");
          mobileInput.placeholder = "5XXXXXXXX";
        }

        if (currentUser) {
          updateUserUi();
        }
      }

      function applyTheme() {
        bodyEl.setAttribute("data-theme", currentTheme);
        themeIcon.textContent = currentTheme === "light" ? "ğŸŒ" : "ğŸŒ™";
      }

      function setStatus(msgKeyOrText, type) {
        if (!msgKeyOrText) {
          statusText.textContent = "";
          statusPill.classList.remove("ok", "error");
          return;
        }
        var text =
          tDict[msgKeyOrText] && tDict[msgKeyOrText][currentLang]
            ? t(msgKeyOrText)
            : msgKeyOrText;
        statusPill.classList.remove("ok", "error");
        if (type === "ok") statusPill.classList.add("ok");
        else if (type === "error") statusPill.classList.add("error");
        statusText.textContent = text;
      }

      function showAuthStep(name) {
        if (name === "mobile") {
          stepMobile.classList.remove("hidden");
          stepOtp.classList.add("hidden");
          authOverlay.classList.remove("hidden");
          mobileInput.focus();
        } else if (name === "otp") {
          stepMobile.classList.add("hidden");
          stepOtp.classList.remove("hidden");
          authOverlay.classList.remove("hidden");
          otpInputs[0].focus();
        }
      }

      function postJson(payload) {
        return fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload || {})
        }).then(function (res) {
          return res.text().then(function (txt) {
            try {
              return JSON.parse(txt || "{}");
            } catch (e) {
              console.error("Invalid JSON from backend:", txt);
              throw new Error("Invalid JSON from backend.");
            }
          });
        });
      }

      // OTP behaviour (L â†’ R)
      otpInputs.forEach(function (input, idx) {
        input.addEventListener("input", function (e) {
          var value = e.target.value.replace(/\D/g, "");
          e.target.value = value.slice(0, 1);
          if (value && idx < otpInputs.length - 1) {
            otpInputs[idx + 1].focus();
          }
        });

        input.addEventListener("keydown", function (e) {
          if (e.key === "Backspace" && !e.target.value && idx > 0) {
            otpInputs[idx - 1].focus();
          }
          if (e.key === "ArrowLeft" && idx > 0) {
            otpInputs[idx - 1].focus();
          }
          if (e.key === "ArrowRight" && idx < otpInputs.length - 1) {
            otpInputs[idx + 1].focus();
          }
          if (e.key === "Enter") {
            e.preventDefault();
            verifyOtp();
          }
        });
      });

      function readOtp() {
        return otpInputs
          .map(function (el) {
            return el.value || "";
          })
          .join("");
      }

      function clearOtpInputs() {
        otpInputs.forEach(function (el) {
          el.value = "";
        });
      }

      /* ===================== AUTH / OTP ===================== */

      function sendOtp() {
        var mobile = (mobileInput.value || "").trim();
        if (!mobile) {
          setStatus(
            currentLang === "ar" ? "Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„." : "Enter your mobile.",
            "error"
          );
          mobileInput.focus();
          return;
        }

        currentMobileRaw = mobile;
        btnSendOtp.disabled = true;
        setStatus("statusSendingOtp", null);

        postJson({ action: "sendOtp", appId: HUB_APP_ID, mobile: mobile })
          .then(function (res) {
            if (!res || !res.success) {
              var msg =
                (res && res.error) ||
                (currentLang === "ar"
                  ? "ØªØ¹Ø°Ø± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²."
                  : "Failed to send code.");
              setStatus(msg, "error");
              return;
            }
            setStatus("statusOtpSent", "ok");
            clearOtpInputs();
            showAuthStep("otp");
          })
          .catch(function (err) {
            console.error(err);
            setStatus("statusError", "error");
          })
          .finally(function () {
            btnSendOtp.disabled = false;
          });
      }

      function verifyOtp() {
        var otp = readOtp();
        if (!otp || otp.length !== 4) {
          setStatus(
            currentLang === "ar"
              ? "Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ù¤ Ø£Ø±Ù‚Ø§Ù…."
              : "Enter the 4-digit code.",
            "error"
          );
          otpInputs[0].focus();
          return;
        }

        btnVerifyOtp.disabled = true;
        setStatus("statusVerifying", null);

        postJson({
          action: "verifyOtp",
          appId: HUB_APP_ID,
          mobile: currentMobileRaw,
          otp: otp
        })
          .then(function (res) {
            if (!res || !res.success) {
              var msg =
                (res && res.error) ||
                (currentLang === "ar"
                  ? "Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ Ù…Ù†ØªÙ‡ÙŠ."
                  : "Invalid or expired code.");
              setStatus(msg, "error");
              clearOtpInputs();
              otpInputs[0].focus();
              return;
            }

            if (!res.userExists) {
              var msg2 =
                res.message ||
                (currentLang === "ar"
                  ? "ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù…Ø² ÙˆÙ„ÙƒÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯."
                  : "OTP verified but user not found.");
              setStatus(msg2, "error");
              return;
            }

            currentSessionKey = res.sessionKey || null;
            if (currentSessionKey) {
              localStorage.setItem(STORAGE_SESSION_KEY, currentSessionKey);
            }

            authOverlay.classList.add("hidden");
            if (welcomeCard) welcomeCard.classList.add("hidden");
            setStatus("statusIdle", null);

            loadCurrentUserAndWorkspaces();
          })
          .catch(function (err) {
            console.error(err);
            setStatus("statusError", "error");
          })
          .finally(function () {
            btnVerifyOtp.disabled = false;
          });
      }

      function loadCurrentUserAndWorkspaces() {
        if (!currentSessionKey) {
          showAuthStep("mobile");
          return;
        }

        setStatus("statusLoadingWorkspaces", null);

        postJson({ action: "auth.me", sessionKey: currentSessionKey })
          .then(function (res) {
            if (!res || !res.success) {
              currentSessionKey = null;
              localStorage.removeItem(STORAGE_SESSION_KEY);
              setStatus("statusIdle", null);
              showAuthStep("mobile");
              return;
            }

            currentUser = res.user || null;
            workspaces = res.workspaces || res.items || [];
            updateUserUi();
            renderWorkspacesUi();

            hubHeader.classList.remove("hidden");
            setActiveHubView("apps");

            if (!workspaces || !workspaces.length) {
              setStatus("statusNoWorkspaces", "error");
              return;
            }

            // Ø§Ø®ØªØ± Ø£ÙˆÙ„ Ù…Ø³Ø§Ø­Ø© Ø¹Ù…Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
            var firstWs = workspaces[0];
            currentWorkspaceId = firstWs.workspaceId;
            workspaceSelect.value = currentWorkspaceId;
            loadWorkspaceContext();
          })
          .catch(function (err) {
            console.error(err);
            setStatus("statusError", "error");
            showAuthStep("mobile");
          });
      }

      function logout() {
        var key = currentSessionKey;
        currentSessionKey = null;
        localStorage.removeItem(STORAGE_SESSION_KEY);
        currentUser = null;
        workspaces = [];
        currentWorkspaceId = null;
        workspaceApps = [];
        currentApps = [];
        marketplaceItems = [];
        templatesById = {};

        appFrame.src = "";
        appFrame.classList.add("hidden");
        appFramePlaceholder.classList.remove("hidden");
        currentAppTitle.textContent = t("appPlaceholder");
        appsListEl.innerHTML = "";
        appsCard.classList.remove("hidden");
        btnAppsMenu.classList.add("hidden");
        appsMenuPanel.classList.add("hidden");
        btnHome.classList.add("hidden");
        appView.classList.add("hidden");

        hubHeader.classList.add("hidden");
        viewApps.classList.add("hidden");
        viewMarketplace.classList.add("hidden");

        if (welcomeCard) welcomeCard.classList.remove("hidden");
        currentUserBadge.textContent = "";

        // Reset workspace select
        workspaceSelect.innerHTML = "";
        var opt = document.createElement("option");
        opt.value = "";
        opt.disabled = true;
        opt.selected = true;
        opt.setAttribute("data-i18n", "workspacePlaceholder");
        opt.textContent = t("workspacePlaceholder");
        workspaceSelect.appendChild(opt);

        setStatus("statusIdle", null);
        showAuthStep("mobile");

        if (!key) return;
        postJson({ action: "auth.logout", sessionKey: key }).catch(
          function () {}
        );
      }

      /* ===================== HUB: WORKSPACES ===================== */

      function updateUserUi() {
        if (!currentUser) {
          userNameLabel.textContent = "";
          currentUserBadge.textContent = "";
          return;
        }

        var suffix = " Â· " + (currentUser.mobile || "");
        var greetName =
          currentLang === "ar"
            ? "Ù…Ø±Ø­Ø¨Ø§Ù‹ " + (currentUser.name || "")
            : "Hi " + (currentUser.name || "");
        userNameLabel.textContent = greetName + suffix;

        var badgeText =
          currentLang === "ar"
            ? (currentUser.name || "Ù…Ø³ØªØ®Ø¯Ù…") + " Â· " + (currentUser.userId || "")
            : (currentUser.name || "User") + " Â· " + (currentUser.userId || "");
        currentUserBadge.textContent = badgeText;
      }

      function renderWorkspacesUi() {
        // clear and add placeholder
        workspaceSelect.innerHTML = "";
        var opt = document.createElement("option");
        opt.value = "";
        opt.disabled = true;
        opt.selected = true;
        opt.setAttribute("data-i18n", "workspacePlaceholder");
        opt.textContent = t("workspacePlaceholder");
        workspaceSelect.appendChild(opt);

        if (!workspaces || !workspaces.length) return;

        workspaces.forEach(function (ws) {
          var option = document.createElement("option");
          option.value = ws.workspaceId;
          var txt =
            (ws.name || ws.workspaceId) +
            (ws.plan ? " Â· " + ws.plan : "");
          option.textContent = txt;
          workspaceSelect.appendChild(option);
        });

        // reapply i18n text for placeholder
        applyLanguage();
      }

      function loadWorkspaceContext() {
        if (!currentWorkspaceId) return;

        setStatus("statusLoadingMarketplace", null);
        // Ø£ÙˆÙ„Ø§Ù‹: Ø­Ù…Ù„ Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ù…ØªØ¬Ø± (Apps + Modules)
        loadMarketplaceTemplates(currentWorkspaceId)
          .then(function () {
            setStatus("statusLoadingApps", null);
            return loadWorkspaceApps(currentWorkspaceId);
          })
          .then(function () {
            setStatus("statusIdle", null);
          })
          .catch(function (err) {
            console.error(err);
            setStatus("statusError", "error");
          });
      }

      function loadWorkspaceApps(workspaceId) {
        return postJson({
          action: "marketplace.listWorkspaceApps",
          workspaceId: workspaceId
        }).then(function (res) {
          workspaceApps = (res && res.items) || [];
          buildCurrentAppsFromWorkspace();
          renderApps();
          buildAppsMenu();
        });
      }

      function loadMarketplaceTemplates(workspaceId) {
        return postJson({
          action: "marketplace.listTemplates",
          workspaceId: workspaceId
        }).then(function (res) {
          marketplaceItems = (res && res.items) || [];
          templatesById = {};
          marketplaceItems.forEach(function (it) {
            if (it.templateId) {
              templatesById[it.templateId] = it;
            }
          });
          renderMarketplace();
        });
      }

      function buildCurrentAppsFromWorkspace() {
        currentApps = [];
        if (!workspaceApps || !workspaceApps.length) return;

        workspaceApps.forEach(function (wa) {
          if (String(wa.visibleInHub || "Yes") !== "Yes") return;

          var tpl = templatesById[wa.templateId] || null;
          var baseUrl = "";
          if (tpl && tpl.defaultRoute) {
            baseUrl = tpl.defaultRoute;
          }

          currentApps.push({
            appId: wa.appId,
            workspaceAppId: wa.workspaceAppId,
            workspaceId: wa.workspaceId,
            templateId: wa.templateId,
            name: wa.name,
            category: tpl ? tpl.category : "",
            descriptionAr: "",
            descriptionEn: tpl ? tpl.shortDesc : "",
            baseUrl: baseUrl,
            pinned: false
          });
        });
      }

      /* ===================== HUB: APPS VIEW ===================== */

      function renderApps() {
        appsListEl.innerHTML = "";
        appFrame.src = "";
        appFrame.classList.add("hidden");
        appFramePlaceholder.classList.remove("hidden");
        currentAppTitle.textContent = t("appPlaceholder");
        currentAppId = null;
        btnHome.classList.add("hidden");
        appView.classList.add("hidden");

        if (!currentApps || !currentApps.length) {
          setStatus("statusNoApps", "error");
          btnAppsMenu.classList.add("hidden");
          appsMenuPanel.classList.add("hidden");
          return;
        }

        btnAppsMenu.classList.remove("hidden");

        currentApps.forEach(function (app) {
          var card = document.createElement("div");
          card.className = "app-card";
          card.dataset.appId = app.appId;

          var header = document.createElement("div");
          header.className = "app-card-header";

          var icon = document.createElement("div");
          icon.className = "app-card-icon";
          icon.textContent = "â‹¯";

          var title = document.createElement("div");
          title.className = "app-card-title";
          title.textContent = app.name || app.appId;

          header.appendChild(icon);
          header.appendChild(title);

          var body = document.createElement("div");
          body.className = "app-card-body";
          body.textContent =
            currentLang === "ar"
              ? app.descriptionAr || app.descriptionEn || ""
              : app.descriptionEn || app.descriptionAr || "";

          var footer = document.createElement("div");
          footer.className = "app-card-footer";

          var catSpan = document.createElement("span");
          catSpan.textContent = app.category || "";

          footer.appendChild(catSpan);

          card.appendChild(header);
          card.appendChild(body);
          card.appendChild(footer);

          card.addEventListener("click", function () {
            openAppFromHome(app);
          });

          appsListEl.appendChild(card);
        });

        buildAppsMenu();
      }

      function buildAppsMenu() {
        appsMenuPanel.innerHTML = "";
        if (!currentApps || !currentApps.length) return;

        currentApps.forEach(function (app) {
          var item = document.createElement("button");
          item.type = "button";
          item.className = "apps-menu-item";
          item.dataset.appId = app.appId;

          var left = document.createElement("div");
          left.style.display = "flex";
          left.style.flexDirection = "column";
          left.style.gap = "2px";
          left.style.flex = "1";

          var title = document.createElement("div");
          title.className = "apps-menu-item-title";
          title.textContent = app.name || app.appId;

          var cat = document.createElement("div");
          cat.className = "apps-menu-item-cat";
          cat.textContent = app.category || "";

          left.appendChild(title);
          left.appendChild(cat);

          var dot = document.createElement("div");
          dot.style.width = "8px";
          dot.style.height = "8px";
          dot.style.borderRadius = "999px";
          dot.style.background = "rgba(34,197,94,0.9)";

          item.appendChild(left);
          item.appendChild(dot);

          item.addEventListener("click", function (e) {
            e.stopPropagation();
            openApp(app);
            appsMenuPanel.classList.add("hidden");
          });

          appsMenuPanel.appendChild(item);
        });

        updateAppsMenuActiveState();
      }

      function updateAppsMenuActiveState() {
        var items = appsMenuPanel.querySelectorAll(".apps-menu-item");
        items.forEach(function (item) {
          if (item.dataset.appId === currentAppId) {
            item.classList.add("active");
          } else {
            item.classList.remove("active");
          }
        });
      }

      var currentAppId = null;

      function openAppFromHome(app) {
        appsCard.classList.remove("hidden");
        btnHome.classList.remove("hidden");
        appView.classList.remove("hidden");
        openApp(app);
      }

      function openApp(app) {
        if (!app || !currentUser) return;
        currentAppId = app.appId;

        var name = app.name || "";
        currentAppTitle.textContent = name || "";

        var base = (app.baseUrl || "").trim();
        if (!base) {
          setStatus(
            currentLang === "ar"
              ? "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¨Ø· Ù„Ù‡Ø°Ø§ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚."
              : "No URL configured for this app.",
            "error"
          );
          return;
        }
        var sep = base.indexOf("?") === -1 ? "?" : "&";
        var finalUrl =
          base + sep + "appid=" + encodeURIComponent(currentUser.userId);

        appFramePlaceholder.classList.add("hidden");
        appFrame.classList.remove("hidden");
        appFrame.src = finalUrl;

        btnHome.classList.remove("hidden");
        appView.classList.remove("hidden");
        updateAppsMenuActiveState();
      }

      function goHome() {
        appFrame.classList.add("hidden");
        appFramePlaceholder.classList.remove("hidden");
        currentAppTitle.textContent = t("appPlaceholder");
        currentAppId = null;
        updateAppsMenuActiveState();
        appView.classList.add("hidden");
      }

      /* ===================== HUB: MARKETPLACE VIEW ===================== */

      function setMarketplaceFilter(filter) {
        currentMarketplaceFilter = filter;
        [filterAll, filterApps, filterModules].forEach(function (btn) {
          if (btn.dataset.filter === filter) btn.classList.add("active");
          else btn.classList.remove("active");
        });
        renderMarketplace();
      }

      function renderMarketplace() {
        marketplaceGrid.innerHTML = "";
        marketplaceEmpty.classList.add("hidden");

        if (!marketplaceItems || !marketplaceItems.length) {
          marketplaceEmpty.classList.remove("hidden");
          return;
        }

        var filtered = marketplaceItems.filter(function (item) {
          var type = (item.itemType || item.type || "app").toLowerCase();
          if (currentMarketplaceFilter === "all") return true;
          if (currentMarketplaceFilter === "app") return type === "app";
          if (currentMarketplaceFilter === "module") return type === "module";
          return true;
        });

        if (!filtered.length) {
          marketplaceEmpty.classList.remove("hidden");
          return;
        }

        filtered.forEach(function (item) {
          var card = document.createElement("div");
          card.className = "marketplace-card";

          var header = document.createElement("div");
          header.className = "marketplace-card-header";

          var nameEl = document.createElement("div");
          nameEl.className = "marketplace-name";
          nameEl.textContent = item.name || item.templateId;

          var typeEl = document.createElement("div");
          typeEl.className = "marketplace-type";
          var type = (item.itemType || item.type || "app").toLowerCase();
          typeEl.textContent =
            type === "module"
              ? currentLang === "ar"
                ? "Ø­Ø²Ù…Ø© (Module)"
                : "Module"
              : currentLang === "ar"
              ? "ØªØ·Ø¨ÙŠÙ‚"
              : "App";

          header.appendChild(nameEl);
          header.appendChild(typeEl);

          var desc = document.createElement("div");
          desc.className = "marketplace-desc";
          desc.textContent = item.shortDesc || item.description || "";

          var tagsWrap = document.createElement("div");
          tagsWrap.className = "marketplace-tags";
          if (item.featureTags) {
            String(item.featureTags)
              .split(",")
              .map(function (s) {
                return s.trim();
              })
              .filter(Boolean)
              .forEach(function (tag) {
                var tagEl = document.createElement("span");
                tagEl.className = "tag-pill";
                tagEl.textContent = "#" + tag;
                tagsWrap.appendChild(tagEl);
              });
          }

          var footer = document.createElement("div");
          footer.className = "marketplace-footer";

          var left = document.createElement("div");
          left.style.display = "flex";
          left.style.gap = "4px";
          left.style.alignItems = "center";

          if (item.installed) {
            var installed = document.createElement("span");
            installed.className = "installed-label";
            installed.textContent =
              currentLang === "ar" ? "Ù…Ø«Ø¨Ù‘Øª" : "Installed";
            left.appendChild(installed);
          }

          var cat = document.createElement("span");
          cat.className = "card-caption";
          cat.textContent = item.category || "";
          left.appendChild(cat);

          var btn = document.createElement("button");
          btn.type = "button";
          btn.className = "btn btn-primary";
          btn.disabled = !!item.installed;
          btn.textContent =
            currentLang === "ar"
              ? item.installed
                ? "Ù…Ø«Ø¨Ù‘Øª"
                : "ØªØ«Ø¨ÙŠØª"
              : item.installed
              ? "Installed"
              : "Install";

          btn.addEventListener("click", function () {
            installMarketplaceItem(item);
          });

          footer.appendChild(left);
          footer.appendChild(btn);

          card.appendChild(header);
          card.appendChild(desc);
          if (tagsWrap.childNodes.length) card.appendChild(tagsWrap);
          card.appendChild(footer);

          marketplaceGrid.appendChild(card);
        });
      }

      function installMarketplaceItem(item) {
        if (!currentWorkspaceId || !currentUser) return;

        setStatus(
          currentLang === "ar"
            ? "ÙŠØªÙ… ØªØ«Ø¨ÙŠØª Ø§Ù„Ø¹Ù†ØµØ±..."
            : "Installing item...",
          null
        );

        postJson({
          action: "marketplace.installApp",
          workspaceId: currentWorkspaceId,
          templateId: item.templateId,
          name: item.name,
          userId: currentUser.userId
        })
          .then(function (res) {
            if (!res || !res.success) {
              var msg =
                (res && res.error) || t("statusInstallError");
              setStatus(msg, "error");
              return;
            }

            setStatus("statusInstallOk", "ok");
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø³ÙŠØ§Ù‚ Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© + Ø­Ø§Ù„Ø© "Installed"
            loadWorkspaceContext();
          })
          .catch(function (err) {
            console.error(err);
            setStatus("statusInstallError", "error");
          });
      }

      /* ===================== HUB NAV (Apps / Marketplace) ===================== */

      function setActiveHubView(view) {
        currentHubView = view;

        [btnViewApps, btnViewMarketplace].forEach(function (btn) {
          if (btn.dataset.view === view) btn.classList.add("active");
          else btn.classList.remove("active");
        });

        viewApps.classList.add("hidden");
        viewMarketplace.classList.add("hidden");

        if (view === "apps") {
          viewApps.classList.remove("hidden");
        } else if (view === "marketplace") {
          viewMarketplace.classList.remove("hidden");
        }
      }

      /* ===================== EVENTS ===================== */

      btnSendOtp.addEventListener("click", sendOtp);
      mobileInput.addEventListener("keydown", function (e) {
        if (e.key === "Enter") {
          e.preventDefault();
          sendOtp();
        }
      });

      btnVerifyOtp.addEventListener("click", verifyOtp);

      btnChangeMobile.addEventListener("click", function () {
        showAuthStep("mobile");
        setStatus("statusIdle", null);
      });

      btnLogout.addEventListener("click", logout);

      btnTheme.addEventListener("click", function () {
        currentTheme = currentTheme === "light" ? "dark" : "light";
        localStorage.setItem(STORAGE_THEME, currentTheme);
        applyTheme();
      });

      btnLangAr.addEventListener("click", function () {
        currentLang = "ar";
        localStorage.setItem(STORAGE_LANG, currentLang);
        applyLanguage();
        setStatus("statusIdle", null);
        renderApps();
        renderMarketplace();
      });

      btnLangEn.addEventListener("click", function () {
        currentLang = "en";
        localStorage.setItem(STORAGE_LANG, currentLang);
        applyLanguage();
        setStatus("statusIdle", null);
        renderApps();
        renderMarketplace();
      });

      btnAppsMenu.addEventListener("click", function (e) {
        e.stopPropagation();
        if (appsMenuPanel.classList.contains("hidden")) {
          buildAppsMenu();
          appsMenuPanel.classList.remove("hidden");
        } else {
          appsMenuPanel.classList.add("hidden");
        }
      });

      document.addEventListener("click", function () {
        appsMenuPanel.classList.add("hidden");
      });

      appsMenuPanel.addEventListener("click", function (e) {
        e.stopPropagation();
      });

      btnHome.addEventListener("click", function (e) {
        e.stopPropagation();
        goHome();
      });

      workspaceSelect.addEventListener("change", function () {
        currentWorkspaceId = workspaceSelect.value || null;
        if (!currentWorkspaceId) return;
        loadWorkspaceContext();
      });

      btnViewApps.addEventListener("click", function () {
        setActiveHubView("apps");
      });

      btnViewMarketplace.addEventListener("click", function () {
        setActiveHubView("marketplace");
      });

      filterAll.addEventListener("click", function () {
        setMarketplaceFilter("all");
      });
      filterApps.addEventListener("click", function () {
        setMarketplaceFilter("app");
      });
      filterModules.addEventListener("click", function () {
        setMarketplaceFilter("module");
      });

      /* ===================== INIT ===================== */

      applyTheme();
      applyLanguage();
      setStatus("statusIdle", null);
      showAuthStep("mobile");

      if (currentSessionKey) {
        // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        loadCurrentUserAndWorkspaces();
      }
    })();
  </script>
</body>
</html>
