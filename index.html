<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <title>NahlHub</title>

  <!-- Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap"
    rel="stylesheet"
  />

  <style>
    :root {
      --bg-light: #f5f7f8;
      --bg-dark: #020617;
      --card-light: #ffffff;
      --card-dark: #020617;
      --border-light: rgba(15, 23, 42, 0.08);
      --border-dark: rgba(148, 163, 184, 0.25);
      --accent: #f4ce14;
      --accent-soft: rgba(244, 206, 20, 0.18);
      --text-light: #0f172a;
      --text-dark: #e5e7eb;
      --muted-light: #6b7280;
      --muted-dark: #9ca3af;
      --surface-radius: 18px;
      --transition-fast: 0.18s ease-out;
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: "Cairo", system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", sans-serif;
    }

    body[data-theme="light"] {
      background: radial-gradient(
          circle at top left,
          rgba(244, 206, 20, 0.18),
          transparent 55%
        ),
        var(--bg-light);
      color: var(--text-light);
    }

    body[data-theme="dark"] {
      background: radial-gradient(
          circle at top left,
          rgba(250, 204, 21, 0.14),
          transparent 50%
        ),
        linear-gradient(145deg, #020617, #020617);
      color: var(--text-dark);
    }

    .app-shell {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 6px;
      gap: 8px;
      position: relative;
    }

    /* Topbar */

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid;
      backdrop-filter: blur(14px);
      gap: 12px;
      position: relative;
      z-index: 10;
    }

    body[data-theme="light"] .topbar {
      background: rgba(255, 255, 255, 0.72);
      border-color: var(--border-light);
    }

    body[data-theme="dark"] .topbar {
      background: rgba(15, 23, 42, 0.8);
      border-color: var(--border-dark);
    }

    .topbar-left {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
    }

    .brand-logo {
      width: 30px;
      height: 30px;
      border-radius: 11px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 18px;
      background: radial-gradient(circle at 20% 0, #facc15, #f97316);
      color: #111827;
    }

    .brand-text {
      display: flex;
      flex-direction: column;
      gap: 0;
      font-size: 13px;
      line-height: 1.2;
    }

    .brand-title {
      font-weight: 700;
      letter-spacing: 0.02em;
      white-space: nowrap;
    }

    .brand-subtitle {
      font-size: 11px;
      opacity: 0.75;
    }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .chip-group {
      display: inline-flex;
      padding: 2px;
      border-radius: 999px;
      border: 1px solid transparent;
      background: transparent;
      gap: 2px;
    }

    body[data-theme="light"] .chip-group {
      border-color: rgba(148, 163, 184, 0.42);
      background: rgba(255, 255, 255, 0.9);
    }

    body[data-theme="dark"] .chip-group {
      border-color: rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.95);
    }

    .chip-btn {
      border: none;
      outline: none;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
      cursor: pointer;
      background: transparent;
      color: inherit;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: background var(--transition-fast),
        color var(--transition-fast), transform var(--transition-fast),
        box-shadow var(--transition-fast);
      white-space: nowrap;
    }

    .chip-btn span.icon {
      font-size: 13px;
      line-height: 1;
    }

    .chip-btn.active {
      background: var(--accent);
      color: #111827;
      box-shadow: 0 6px 18px rgba(250, 204, 21, 0.4);
      transform: translateY(-0.5px);
    }

    .chip-btn:not(.active):hover {
      background: rgba(148, 163, 184, 0.25);
    }

    body[data-theme="dark"] .chip-btn:not(.active):hover {
      background: rgba(31, 41, 55, 0.8);
    }

    .chip-btn-mini {
      border-radius: 999px;
      padding: 5px 7px;
      font-size: 11px;
    }

    /* Apps burger menu (header) */

    .apps-menu-btn {
      border-radius: 999px;
      padding: 5px 9px;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .apps-menu-panel {
      position: absolute;
      top: 48px;
      inset-inline-end: 10px;
      min-width: 200px;
      max-width: 260px;
      max-height: 260px;
      overflow-y: auto;
      border-radius: 16px;
      border: 1px solid;
      padding: 6px;
      z-index: 20;
    }

    body[data-theme="light"] .apps-menu-panel {
      background: #ffffff;
      border-color: rgba(148, 163, 184, 0.4);
      box-shadow: 0 18px 30px rgba(15, 23, 42, 0.16);
    }

    body[data-theme="dark"] .apps-menu-panel {
      background: rgba(15, 23, 42, 0.98);
      border-color: rgba(148, 163, 184, 0.6);
      box-shadow: 0 18px 34px rgba(15, 23, 42, 0.8);
    }

    .apps-menu-item {
      width: 100%;
      border-radius: 12px;
      border: 1px solid transparent;
      padding: 6px 8px;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      background: transparent;
      color: inherit;
      cursor: pointer;
      text-align: start;
      transition: background var(--transition-fast),
        border-color var(--transition-fast), transform var(--transition-fast);
    }

    .apps-menu-item-title {
      font-weight: 500;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .apps-menu-item-cat {
      font-size: 11px;
      opacity: 0.6;
    }

    body[data-theme="light"] .apps-menu-item:hover {
      background: rgba(248, 250, 252, 0.9);
      border-color: rgba(148, 163, 184, 0.35);
    }

    body[data-theme="dark"] .apps-menu-item:hover {
      background: rgba(30, 64, 175, 0.2);
      border-color: rgba(129, 140, 248, 0.6);
    }

    .apps-menu-item.active {
      border-color: rgba(250, 204, 21, 0.9);
      background: rgba(250, 204, 21, 0.14);
    }

    /* Status pill */

    .status-pill {
      align-self: stretch;
      margin: 0 4px;
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: 1px solid transparent;
      max-width: 100%;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }

    body[data-theme="light"] .status-pill {
      background: rgba(255, 255, 255, 0.9);
      border-color: var(--border-light);
      color: var(--muted-light);
    }

    body[data-theme="dark"] .status-pill {
      background: rgba(15, 23, 42, 0.9);
      border-color: var(--border-dark);
      color: var(--muted-dark);
    }

    .status-pill.ok {
      border-color: rgba(34, 197, 94, 0.7);
      color: rgba(34, 197, 94, 0.95);
    }

    .status-pill.error {
      border-color: rgba(239, 68, 68, 0.85);
      color: rgba(248, 113, 113, 0.96);
    }

    .status-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--accent);
    }

    /* Main content */

    .main-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 0;
    }

    .welcome-card {
      border-radius: var(--surface-radius);
      padding: 12px 14px;
      border: 1px solid;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    body[data-theme="light"] .welcome-card {
      background: linear-gradient(
        135deg,
        rgba(244, 206, 20, 0.12),
        rgba(255, 255, 255, 0.96)
      );
      border-color: var(--border-light);
    }

    body[data-theme="dark"] .welcome-card {
      background: linear-gradient(
        145deg,
        rgba(250, 204, 21, 0.16),
        rgba(15, 23, 42, 0.96)
      );
      border-color: rgba(148, 163, 184, 0.45);
    }

    .welcome-header-line {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .welcome-title {
      font-size: 16px;
      font-weight: 700;
    }

    .welcome-sub {
      font-size: 12px;
      opacity: 0.85;
    }

    /* Generic card */

    .card {
      border-radius: var(--surface-radius);
      padding: 12px 14px 14px;
      border: 1px solid;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    body[data-theme="light"] .card {
      background: #ffffff;
      border-color: var(--border-light);
    }

    body[data-theme="dark"] .card {
      background: rgba(15, 23, 42, 0.96);
      border-color: var(--border-dark);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .card-title {
      font-size: 15px;
      font-weight: 600;
    }

    .card-caption {
      font-size: 12px;
      opacity: 0.7;
    }

    .card-body {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .field-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .field-label {
      font-size: 12px;
      opacity: 0.85;
    }

    .field-row {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .input {
      flex: 1;
      border-radius: 999px;
      border: 1px solid;
      padding: 8px 12px;
      font-size: 13px;
      outline: none;
      transition: border-color var(--transition-fast),
        box-shadow var(--transition-fast), background var(--transition-fast);
      min-width: 0;
    }

    body[data-theme="light"] .input {
      background: rgba(248, 250, 252, 0.95);
      border-color: rgba(148, 163, 184, 0.5);
      color: var(--text-light);
    }

    body[data-theme="dark"] .input {
      background: rgba(15, 23, 42, 0.96);
      border-color: rgba(148, 163, 184, 0.6);
      color: var(--text-dark);
    }

    .input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(250, 204, 21, 0.55);
      background: rgba(255, 251, 235, 0.9);
    }

    body[data-theme="dark"] .input:focus {
      background: rgba(15, 23, 42, 0.98);
    }

    select.input {
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      padding-inline-end: 28px;
      background-image: linear-gradient(
        45deg,
        transparent 50%,
        rgba(148, 163, 184, 0.9) 55%
      ),
      linear-gradient(
        135deg,
        rgba(148, 163, 184, 0.9) 45%,
        transparent 50%
      );
      background-position:
        calc(100% - 14px) 50%,
        calc(100% - 9px) 50%;
      background-size: 7px 7px, 7px 7px;
      background-repeat: no-repeat;
    }

    .btn {
      border-radius: 999px;
      border: none;
      outline: none;
      padding: 9px 18px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: transform var(--transition-fast),
        box-shadow var(--transition-fast), background var(--transition-fast),
        color var(--transition-fast), opacity var(--transition-fast);
      white-space: nowrap;
    }

    .btn-primary {
      background: var(--accent);
      color: #111827;
      box-shadow: 0 8px 20px rgba(250, 204, 21, 0.45);
    }

    .btn-primary:hover:enabled {
      transform: translateY(-0.5px);
      box-shadow: 0 10px 28px rgba(250, 204, 21, 0.6);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: default;
      box-shadow: none;
      transform: none;
    }

    .btn-ghost {
      background: transparent;
      color: inherit;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 11px;
      border: none;
      cursor: pointer;
    }

    body[data-theme="light"] .btn-ghost:hover {
      background: rgba(148, 163, 184, 0.18);
    }

    body[data-theme="dark"] .btn-ghost:hover {
      background: rgba(31, 41, 55, 0.9);
    }

    /* OTP row: left to right */

    .otp-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      direction: ltr;
    }

    .otp-input {
      width: 44px;
      height: 44px;
      text-align: center;
      font-size: 18px;
      font-weight: 600;
      border-radius: 16px;
      border: 1px solid;
      outline: none;
      transition: border-color var(--transition-fast),
        box-shadow var(--transition-fast), background var(--transition-fast);
    }

    body[data-theme="light"] .otp-input {
      background: rgba(248, 250, 252, 0.96);
      border-color: rgba(148, 163, 184, 0.5);
      color: var(--text-light);
    }

    body[data-theme="dark"] .otp-input {
      background: rgba(15, 23, 42, 0.97);
      border-color: rgba(148, 163, 184, 0.7);
      color: var(--text-dark);
    }

    .otp-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(250, 204, 21, 0.55);
      background: rgba(255, 251, 235, 0.96);
    }

    body[data-theme="dark"] .otp-input:focus {
      background: rgba(15, 23, 42, 1);
    }

    .hidden {
      display: none !important;
    }

    /* Auth popup overlay */

    .auth-overlay {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 12px;
      z-index: 30;
      backdrop-filter: blur(10px);
    }

    body[data-theme="light"] .auth-overlay {
      background: radial-gradient(
          circle at top,
          rgba(148, 163, 184, 0.16),
          transparent 60%
        ),
        rgba(15, 23, 42, 0.18);
    }

    body[data-theme="dark"] .auth-overlay {
      background: radial-gradient(
          circle at top,
          rgba(15, 23, 42, 0.95),
          rgba(15, 23, 42, 0.98)
        );
    }

    .auth-modal {
      width: 100%;
      max-width: 420px;
      border-radius: 22px;
      border: 1px solid;
      padding: 14px 12px 12px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.55);
    }

    body[data-theme="light"] .auth-modal {
      background: linear-gradient(
        140deg,
        rgba(244, 206, 20, 0.12),
        #ffffff
      );
      border-color: rgba(148, 163, 184, 0.5);
    }

    body[data-theme="dark"] .auth-modal {
      background: radial-gradient(
          circle at top left,
          rgba(250, 204, 21, 0.18),
          transparent 50%
        ),
        rgba(15, 23, 42, 0.98);
      border-color: rgba(148, 163, 184, 0.6);
    }

    .auth-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 2px 4px 10px;
    }

    .auth-title {
      font-size: 15px;
      font-weight: 700;
    }

    .auth-sub {
      font-size: 12px;
      opacity: 0.78;
    }

    .auth-badge {
      font-size: 11px;
      border-radius: 999px;
      padding: 3px 8px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      opacity: 0.9;
    }

    .auth-modal-body {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    /* Hub layout */

    .hub-layout {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .hub-top-row {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    @media (min-width: 768px) {
      .hub-top-row {
        flex-direction: row;
      }
    }

    .view-tabs {
      display: inline-flex;
      padding: 3px;
      border-radius: 999px;
      border: 1px solid;
    }

    body[data-theme="light"] .view-tabs {
      border-color: rgba(148, 163, 184, 0.42);
      background: rgba(255, 255, 255, 0.9);
    }

    body[data-theme="dark"] .view-tabs {
      border-color: rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.96);
    }

    .view-tab-btn {
      border: none;
      outline: none;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 12px;
      cursor: pointer;
      background: transparent;
      color: inherit;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: background var(--transition-fast),
        color var(--transition-fast), transform var(--transition-fast);
      white-space: nowrap;
    }

    .view-tab-btn.active {
      background: var(--accent);
      color: #111827;
      box-shadow: 0 6px 18px rgba(250, 204, 21, 0.35);
      transform: translateY(-0.5px);
    }

    /* Apps list */

    .apps-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 10px;
    }

    .app-card {
      border-radius: 16px;
      border: 1px solid;
      padding: 10px 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      cursor: pointer;
      position: relative;
      transition: background var(--transition-fast),
        border-color var(--transition-fast), transform var(--transition-fast),
        box-shadow var(--transition-fast);
    }

    body[data-theme="light"] .app-card {
      background: rgba(255, 255, 255, 0.96);
      border-color: rgba(148, 163, 184, 0.35);
    }

    body[data-theme="dark"] .app-card {
      background: rgba(15, 23, 42, 0.96);
      border-color: rgba(148, 163, 184, 0.55);
    }

    .app-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 26px rgba(15, 23, 42, 0.18);
      border-color: rgba(250, 204, 21, 0.9);
    }

    .app-card-header {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .app-card-icon {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      background: rgba(244, 206, 20, 0.15);
      color: #92400e;
    }

    body[data-theme="dark"] .app-card-icon {
      background: rgba(250, 204, 21, 0.14);
      color: #facc15;
    }

    .app-card-title {
      font-size: 13px;
      font-weight: 600;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .app-card-body {
      font-size: 11px;
      opacity: 0.78;
      height: 2.4em;
      overflow: hidden;
    }

    .app-card-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 11px;
      opacity: 0.75;
      margin-top: 2px;
    }

    .badge-pinned {
      border-radius: 999px;
      padding: 2px 6px;
      font-size: 10px;
      background: rgba(250, 204, 21, 0.16);
      color: #92400e;
    }

    body[data-theme="dark"] .badge-pinned {
      background: rgba(250, 204, 21, 0.22);
      color: #facc15;
    }

    /* Marketplace */

    .marketplace-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 10px;
    }

    .market-card {
      border-radius: 16px;
      border: 1px solid;
      padding: 10px 10px 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    body[data-theme="light"] .market-card {
      background: rgba(255, 255, 255, 0.96);
      border-color: rgba(148, 163, 184, 0.35);
    }

    body[data-theme="dark"] .market-card {
      background: rgba(15, 23, 42, 0.96);
      border-color: rgba(148, 163, 184, 0.55);
    }

    .market-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .market-card-title {
      font-size: 13px;
      font-weight: 600;
    }

    .market-card-tag {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.16);
    }

    .market-card-body {
      font-size: 11px;
      opacity: 0.8;
      min-height: 32px;
    }

    .market-card-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    .market-installed {
      font-size: 10px;
      border-radius: 999px;
      padding: 2px 6px;
      background: rgba(34, 197, 94, 0.14);
      color: rgba(22, 163, 74, 0.96);
    }

    /* Gift Engine placeholder */

    .gift-placeholder {
      font-size: 12px;
      opacity: 0.85;
      padding: 6px 4px;
    }

    @media (min-width: 768px) {
      .app-shell {
        padding: 6px 10px;
      }
      .main-panel {
        max-width: 100%;
        width: 100%;
        margin: 0;
      }
    }
  </style>
</head>
<body data-theme="light">
  <div class="app-shell">
    <!-- Apps burger panel -->
    <div id="appsMenuPanel" class="apps-menu-panel hidden"></div>

    <!-- Top bar -->
    <header class="topbar">
      <div class="topbar-left">
        <div class="brand-logo">N</div>
        <div class="brand-text">
          <div class="brand-title" data-i18n="hubTitle">NahlHub</div>
          <div class="brand-subtitle" data-i18n="hubSub">
            ØªØ·Ø¨ÙŠÙ‚Ø§ØªÙƒ ÙÙŠ Ù†Ø­Ù„ Ù‡Ø¨
          </div>
        </div>
      </div>
      <div class="topbar-right">
        <button
          class="chip-btn chip-btn-mini apps-menu-btn hidden"
          id="btnAppsMenu"
          type="button"
        >
          <span class="icon">â˜°</span>
          <span data-i18n="appsTitle">ØªØ·Ø¨ÙŠÙ‚Ø§ØªÙƒ</span>
        </button>

        <div class="chip-group">
          <button
            class="chip-btn"
            id="btnLangAr"
            type="button"
            data-lang="ar"
          >
            <span>Ø¹Ø±Ø¨ÙŠ</span>
          </button>
          <button
            class="chip-btn"
            id="btnLangEn"
            type="button"
            data-lang="en"
          >
            <span>EN</span>
          </button>
        </div>
        <button
          class="chip-btn chip-btn-mini"
          id="btnTheme"
          type="button"
        >
          <span class="icon" id="themeIcon">ğŸŒ</span>
        </button>
      </div>
    </header>

    <!-- Status -->
    <div id="statusPill" class="status-pill">
      <span class="status-dot"></span>
      <span id="statusText"></span>
    </div>

    <!-- AUTH POPUP -->
    <div id="authOverlay" class="auth-overlay">
      <div class="auth-modal">
        <div class="auth-modal-header">
          <div>
            <div class="auth-title" data-i18n="welcomeTitle">Ù…Ø±Ø­Ø¨Ø§Ù‹ ğŸ‘‹</div>
            <div class="auth-sub" data-i18n="welcomeSub">
              Ø§Ø¯Ø®Ù„ Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø«Ù… Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„.
            </div>
          </div>
          <div class="auth-badge">
            <span data-i18n="step1Title">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</span> Â·
            <span data-i18n="step2Title">Ø±Ù…Ø²</span>
          </div>
        </div>
        <div class="auth-modal-body">
          <!-- Step 1: Mobile (inside popup) -->
          <section id="stepMobile" class="card" style="margin: 0">
            <div class="card-header">
              <div>
                <div class="card-title" data-i18n="step1Title">
                  Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„
                </div>
                <div class="card-caption" data-i18n="step1Sub">
                  Ø§Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„.
                </div>
              </div>
            </div>
            <div class="card-body">
              <div class="field-group">
                <label
                  class="field-label"
                  for="mobileInput"
                  data-i18n="step1Label"
                >
                  Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„
                </label>
                <div class="field-row">
                  <input
                    id="mobileInput"
                    class="input"
                    type="tel"
                    inputmode="tel"
                    autocomplete="tel"
                    placeholder="5XXXXXXXX"
                  />
                </div>
              </div>
              <div class="field-row" style="justify-content: flex-end">
                <button
                  id="btnSendOtp"
                  class="btn btn-primary"
                  type="button"
                >
                  <span data-i18n="btnSendOtp">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²</span>
                </button>
              </div>
            </div>
          </section>

          <!-- Step 2: OTP (inside popup) -->
          <section id="stepOtp" class="card hidden" style="margin: 0">
            <div class="card-header">
              <div>
                <div class="card-title" data-i18n="step2Title">
                  Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„
                </div>
                <div class="card-caption" data-i18n="step2Sub">
                  Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ù¤ Ø£Ø±Ù‚Ø§Ù….
                </div>
              </div>
              <button
                type="button"
                class="btn-ghost"
                id="btnChangeMobile"
              >
                <span data-i18n="changeMobile">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ù‚Ù…</span>
              </button>
            </div>
            <div class="card-body">
              <div class="otp-row">
                <input
                  class="otp-input"
                  id="otp1"
                  type="tel"
                  inputmode="numeric"
                  maxlength="1"
                />
                <input
                  class="otp-input"
                  id="otp2"
                  type="tel"
                  inputmode="numeric"
                  maxlength="1"
                />
                <input
                  class="otp-input"
                  id="otp3"
                  type="tel"
                  inputmode="numeric"
                  maxlength="1"
                />
                <input
                  class="otp-input"
                  id="otp4"
                  type="tel"
                  inputmode="numeric"
                  maxlength="1"
                />
              </div>
              <div
                class="field-row"
                style="justify-content: flex-end; margin-top: 10px"
              >
                <button
                  id="btnVerifyOtp"
                  class="btn btn-primary"
                  type="button"
                >
                  <span data-i18n="btnVerify">ØªØ£ÙƒÙŠØ¯</span>
                </button>
              </div>
            </div>
          </section>
        </div>
      </div>
    </div>

    <!-- Main -->
    <main class="main-panel">
      <!-- Welcome (before login) -->
      <section class="welcome-card" id="welcomeCard">
        <div class="welcome-header-line">
          <div>
            <div class="welcome-title" data-i18n="welcomeTitle">Ù…Ø±Ø­Ø¨Ø§Ù‹ ğŸ‘‹</div>
            <div class="welcome-sub" data-i18n="welcomeSub">
              Ø§Ø¯Ø®Ù„ Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø«Ù… Ø§Ø®ØªØ± Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„ ÙˆØ§Ù„ØªØ·Ø¨ÙŠÙ‚.
            </div>
          </div>
        </div>
      </section>

      <!-- Hub main after login -->
      <section id="hubMain" class="hub-layout hidden">
        <!-- Workspace + View Tabs -->
        <div class="hub-top-row">
          <div class="card" style="flex: 1 1 0">
            <div class="card-header">
              <div>
                <div class="card-title" data-i18n="workspaceLabel">
                  Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„
                </div>
                <div class="card-caption" id="userNameLabel"></div>
              </div>
              <button
                class="btn-ghost"
                type="button"
                id="btnLogout"
              >
                <span data-i18n="logout">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</span>
              </button>
            </div>
            <div class="card-body">
              <div class="field-group">
                <label
                  class="field-label"
                  for="workspaceSelect"
                  data-i18n="workspaceSelectLabel"
                >
                  Ø§Ø®ØªØ± Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„
                </label>
                <div class="field-row">
                  <select
                    id="workspaceSelect"
                    class="input"
                  ></select>
                  <button
                    type="button"
                    class="btn-ghost"
                    id="btnNewWorkspace"
                  >
                    <span>ï¼‹</span>
                    <span data-i18n="newWorkspace">Ù…Ø³Ø§Ø­Ø© Ø¬Ø¯ÙŠØ¯Ø©</span>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div class="card" style="flex: 0 0 260px; max-width: 100%">
            <div class="card-header">
              <div class="card-title" data-i18n="viewsTitle">
                Ø¹Ø±Ø¶
              </div>
            </div>
            <div class="card-body">
              <div class="view-tabs">
                <button
                  id="btnViewApps"
                  type="button"
                  class="view-tab-btn active"
                >
                  <span data-i18n="viewApps">ØªØ·Ø¨ÙŠÙ‚Ø§ØªÙƒ</span>
                </button>
                <button
                  id="btnViewMarketplace"
                  type="button"
                  class="view-tab-btn"
                >
                  <span data-i18n="viewMarketplace">Ù…ØªØ¬Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª</span>
                </button>
                <button
                  id="btnViewGift"
                  type="button"
                  class="view-tab-btn"
                >
                  <span data-i18n="viewGift">Gift Engine</span>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Your apps -->
        <section id="appsSection" class="card">
          <div class="card-header">
            <div>
              <div class="card-title" data-i18n="appsTitle">
                ØªØ·Ø¨ÙŠÙ‚Ø§ØªÙƒ
              </div>
              <div class="card-caption" data-i18n="appsSub">
                Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ù…Ø«Ø¨Ù‘ØªØ© Ø¯Ø§Ø®Ù„ Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠØ©.
              </div>
            </div>
          </div>
          <div class="card-body">
            <div id="appsList" class="apps-list"></div>
            <div id="appsEmpty" class="card-caption hidden">
              <span data-i18n="appsEmpty">
                Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ù…Ø«Ø¨ØªØ© Ø¨Ø¹Ø¯ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø³Ø§Ø­Ø©. ÙŠÙ…ÙƒÙ†Ùƒ ØªØ«Ø¨ÙŠØªÙ‡Ø§ Ù…Ù† Ù…ØªØ¬Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª.
              </span>
            </div>
          </div>
        </section>

        <!-- Marketplace -->
        <section id="marketplaceSection" class="card hidden">
          <div class="card-header">
            <div>
              <div class="card-title" data-i18n="marketplaceTitle">
                Ù…ØªØ¬Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª
              </div>
              <div class="card-caption" data-i18n="marketplaceSub">
                Ø«Ø¨Ù‘Øª ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø£Ùˆ Ø­Ø²Ù… Modules Ø¥Ù„Ù‰ Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„.
              </div>
            </div>
          </div>
          <div class="card-body">
            <div class="field-group">
              <div class="field-label" data-i18n="marketAppsLabel">
                ØªØ·Ø¨ÙŠÙ‚Ø§Øª ÙØ±Ø¯ÙŠØ©
              </div>
              <div id="marketAppsList" class="marketplace-list"></div>
              <div id="marketAppsEmpty" class="card-caption hidden">
                <span data-i18n="marketAppsEmpty">
                  Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.
                </span>
              </div>
            </div>

            <div class="field-group">
              <div class="field-label" data-i18n="marketModulesLabel">
                Ø­Ø²Ù… Modules
              </div>
              <div id="marketModulesList" class="marketplace-list"></div>
              <div id="marketModulesEmpty" class="card-caption hidden">
                <span data-i18n="marketModulesEmpty">
                  Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø²Ù… Modules Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.
                </span>
              </div>
            </div>
          </div>
        </section>

        <!-- Gift Engine -->
        <section id="giftSection" class="card hidden">
          <div class="card-header">
            <div>
              <div class="card-title">Gift Engine</div>
              <div class="card-caption" data-i18n="giftSub">
                Ù…Ø±ÙƒØ² Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ ÙˆØ§Ù„ØªØ­ÙÙŠØ² Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠ ØªØ·Ø¨ÙŠÙ‚Ø§ØªÙƒ (Ù‚Ø±ÙŠØ¨Ø§Ù‹ ğŸ”œ).
              </div>
            </div>
          </div>
          <div class="card-body">
            <div class="gift-placeholder">
              <span data-i18n="giftPlaceholder">
                Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Gift Engine Ù„Ù…Ù†Ø­ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ ÙˆØ§Ù„Ø£Ø±ØµØ¯Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ØªÙØ§Ø¹Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
                ÙˆØ­Ø¬ÙˆØ²Ø§ØªÙ‡Ù…. ÙŠÙ…ÙƒÙ†Ùƒ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ø±Ø¨Ø·Ù‡ Ø¨ØªØ·Ø¨ÙŠÙ‚Ø§ØªÙƒ Ù…Ù† Ù†ÙØ³ Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„.
              </span>
            </div>
          </div>
        </section>
      </section>
    </main>
  </div>

  <script>
    (function () {
      "use strict";

      var API_URL = "/api/hub/manage";
      var HUB_APP_ID = "NAHLHUB_HUB";

      var STORAGE_SESSION_KEY = "nahlhub_session_key";
      var STORAGE_LANG = "nahlhub_lang";
      var STORAGE_THEME = "nahlhub_theme";

      var currentLang = localStorage.getItem(STORAGE_LANG) || "ar";
      var currentTheme = localStorage.getItem(STORAGE_THEME) || "light";
      var currentSessionKey =
        localStorage.getItem(STORAGE_SESSION_KEY) || null;

      var currentUser = null;
      var currentMobileRaw = "";

      var currentWorkspaces = [];
      var currentWorkspaceId = null;
      var workspaceAppsAll = [];
      var currentApps = [];

      var marketplaceApps = [];
      var marketplaceModules = [];

      var currentView = "apps";

      var bodyEl = document.body;
      var statusPill = document.getElementById("statusPill");
      var statusText = document.getElementById("statusText");

      var welcomeCard = document.getElementById("welcomeCard");
      var hubMain = document.getElementById("hubMain");

      var authOverlay = document.getElementById("authOverlay");
      var stepMobile = document.getElementById("stepMobile");
      var stepOtp = document.getElementById("stepOtp");

      var mobileInput = document.getElementById("mobileInput");
      var btnSendOtp = document.getElementById("btnSendOtp");

      var otpInputs = [
        document.getElementById("otp1"),
        document.getElementById("otp2"),
        document.getElementById("otp3"),
        document.getElementById("otp4"),
      ];
      var btnVerifyOtp = document.getElementById("btnVerifyOtp");
      var btnChangeMobile = document.getElementById("btnChangeMobile");

      var userNameLabel = document.getElementById("userNameLabel");
      var btnLogout = document.getElementById("btnLogout");

      var workspaceSelect = document.getElementById("workspaceSelect");
      var btnNewWorkspace = document.getElementById("btnNewWorkspace");

      var btnViewApps = document.getElementById("btnViewApps");
      var btnViewMarketplace = document.getElementById("btnViewMarketplace");
      var btnViewGift = document.getElementById("btnViewGift");

      var appsSection = document.getElementById("appsSection");
      var marketplaceSection = document.getElementById("marketplaceSection");
      var giftSection = document.getElementById("giftSection");

      var appsListEl = document.getElementById("appsList");
      var appsEmptyEl = document.getElementById("appsEmpty");

      var marketAppsList = document.getElementById("marketAppsList");
      var marketAppsEmpty = document.getElementById("marketAppsEmpty");
      var marketModulesList = document.getElementById("marketModulesList");
      var marketModulesEmpty = document.getElementById("marketModulesEmpty");

      var btnTheme = document.getElementById("btnTheme");
      var themeIcon = document.getElementById("themeIcon");
      var btnLangAr = document.getElementById("btnLangAr");
      var btnLangEn = document.getElementById("btnLangEn");

      var btnAppsMenu = document.getElementById("btnAppsMenu");
      var appsMenuPanel = document.getElementById("appsMenuPanel");

      var tDict = {
        hubTitle: { ar: "NahlHub", en: "NahlHub" },
        hubSub: {
          ar: "ØªØ·Ø¨ÙŠÙ‚Ø§ØªÙƒ ÙÙŠ Ù†Ø­Ù„ Ù‡Ø¨",
          en: "Your apps in NahlHub",
        },
        welcomeTitle: { ar: "Ù…Ø±Ø­Ø¨Ø§Ù‹ ğŸ‘‹", en: "Welcome ğŸ‘‹" },
        welcomeSub: {
          ar: "Ø§Ø¯Ø®Ù„ Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø«Ù… Ø§Ø®ØªØ± Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„ ÙˆØ§Ù„ØªØ·Ø¨ÙŠÙ‚.",
          en: "Enter your mobile, then choose a workspace and app.",
        },
        step1Title: { ar: "Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„", en: "Mobile number" },
        step1Sub: {
          ar: "Ø§Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„.",
          en: "Enter your mobile.",
        },
        step1Label: { ar: "Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„", en: "Mobile" },
        btnSendOtp: { ar: "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²", en: "Send code" },
        step2Title: { ar: "Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„", en: "Login code" },
        step2Sub: {
          ar: "Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ù¤ Ø£Ø±Ù‚Ø§Ù….",
          en: "Enter the 4-digit code.",
        },
        changeMobile: { ar: "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ù‚Ù…", en: "Change number" },
        btnVerify: { ar: "ØªØ£ÙƒÙŠØ¯", en: "Confirm" },
        appsTitle: { ar: "ØªØ·Ø¨ÙŠÙ‚Ø§ØªÙƒ", en: "Your apps" },
        appsSub: {
          ar: "Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ù…Ø«Ø¨Ù‘ØªØ© Ø¯Ø§Ø®Ù„ Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠØ©.",
          en: "Apps installed in the current workspace.",
        },
        appsEmpty: {
          ar: "Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ù…Ø«Ø¨ØªØ© Ø¨Ø¹Ø¯ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø³Ø§Ø­Ø©. ÙŠÙ…ÙƒÙ†Ùƒ ØªØ«Ø¨ÙŠØªÙ‡Ø§ Ù…Ù† Ù…ØªØ¬Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª.",
          en: "No apps installed in this workspace yet. Install from the marketplace.",
        },
        logout: { ar: "ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬", en: "Logout" },
        workspaceLabel: { ar: "Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„", en: "Workspace" },
        workspaceSelectLabel: {
          ar: "Ø§Ø®ØªØ± Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„",
          en: "Select workspace",
        },
        newWorkspace: { ar: "Ù…Ø³Ø§Ø­Ø© Ø¬Ø¯ÙŠØ¯Ø©", en: "New workspace" },
        viewsTitle: { ar: "Ø¹Ø±Ø¶", en: "View" },
        viewApps: { ar: "ØªØ·Ø¨ÙŠÙ‚Ø§ØªÙƒ", en: "Your apps" },
        viewMarketplace: { ar: "Ù…ØªØ¬Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª", en: "App marketplace" },
        viewGift: { ar: "Gift Engine", en: "Gift Engine" },
        marketplaceTitle: {
          ar: "Ù…ØªØ¬Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª",
          en: "App marketplace",
        },
        marketplaceSub: {
          ar: "Ø«Ø¨Ù‘Øª ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø£Ùˆ Ø­Ø²Ù… Modules Ø¥Ù„Ù‰ Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„.",
          en: "Install apps or modules into this workspace.",
        },
        marketAppsLabel: { ar: "ØªØ·Ø¨ÙŠÙ‚Ø§Øª ÙØ±Ø¯ÙŠØ©", en: "Single apps" },
        marketAppsEmpty: {
          ar: "Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.",
          en: "No apps available yet.",
        },
        marketModulesLabel: { ar: "Ø­Ø²Ù… Modules", en: "Modules" },
        marketModulesEmpty: {
          ar: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø²Ù… Modules Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.",
          en: "No modules available yet.",
        },
        giftSub: {
          ar: "Ù…Ø±ÙƒØ² Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ ÙˆØ§Ù„ØªØ­ÙÙŠØ² Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠ ØªØ·Ø¨ÙŠÙ‚Ø§ØªÙƒ (Ù‚Ø±ÙŠØ¨Ø§Ù‹ ğŸ”œ).",
          en: "Gift & incentives center for your app users (coming soon ğŸ”œ).",
        },
        giftPlaceholder: {
          ar: "Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Gift Engine Ù„Ù…Ù†Ø­ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ ÙˆØ§Ù„Ø£Ø±ØµØ¯Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ØªÙØ§Ø¹Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ­Ø¬ÙˆØ²Ø§ØªÙ‡Ù…. ÙŠÙ…ÙƒÙ†Ùƒ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ø±Ø¨Ø·Ù‡ Ø¨ØªØ·Ø¨ÙŠÙ‚Ø§ØªÙƒ Ù…Ù† Ù†ÙØ³ Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„.",
          en: "Gift Engine will be used to grant gifts and credits based on user engagement and bookings. Later you'll connect it to your apps in this workspace.",
        },
        statusIdle: { ar: "Ø¬Ø§Ù‡Ø².", en: "Ready." },
        statusSendingOtp: {
          ar: "ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²...",
          en: "Sending code...",
        },
        statusOtpSent: {
          ar: "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø² Ø¥Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨.",
          en: "Code sent to WhatsApp.",
        },
        statusVerifying: { ar: "ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚...", en: "Verifying..." },
        statusNoApps: {
          ar: "Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ù…ØªØ§Ø­Ø©.",
          en: "No apps available.",
        },
        statusError: {
          ar: "Ø­Ø¯Ø« Ø®Ø·Ø£. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.",
          en: "Something went wrong. Try again.",
        },
        statusLoadingHub: {
          ar: "ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ø³Ø§Ø­Ø§Øª Ø§Ù„Ø¹Ù…Ù„ ÙˆØ§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª...",
          en: "Loading workspaces and apps...",
        },
        statusNoWorkspaces: {
          ar: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³Ø§Ø­Ø§Øª Ø¹Ù…Ù„ Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨.",
          en: "No workspaces linked to this account.",
        },
        statusInstalled: {
          ar: "ØªÙ… Ø§Ù„ØªØ«Ø¨ÙŠØª.",
          en: "Installed.",
        },
        statusInstalling: {
          ar: "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ«Ø¨ÙŠØª...",
          en: "Installing...",
        },
      };

      function t(key) {
        var entry = tDict[key];
        if (!entry) return key;
        return entry[currentLang] || entry.ar || key;
      }

      function applyLanguage() {
        document.documentElement.lang = currentLang;
        document.documentElement.dir = currentLang === "ar" ? "rtl" : "ltr";

        var nodes = document.querySelectorAll("[data-i18n]");
        nodes.forEach(function (node) {
          var key = node.getAttribute("data-i18n");
          node.textContent = t(key);
        });

        if (currentLang === "ar") {
          btnLangAr.classList.add("active");
          btnLangEn.classList.remove("active");
          mobileInput.placeholder = "5XXXXXXXX";
        } else {
          btnLangAr.classList.remove("active");
          btnLangEn.classList.add("active");
          mobileInput.placeholder = "5XXXXXXXX";
        }

        updateUserUi();
      }

      function applyTheme() {
        bodyEl.setAttribute("data-theme", currentTheme);
        themeIcon.textContent = currentTheme === "light" ? "ğŸŒ" : "ğŸŒ™";
      }

      function setStatus(msgKeyOrText, type) {
        if (!msgKeyOrText) {
          statusText.textContent = "";
          statusPill.classList.remove("ok", "error");
          return;
        }
        var text =
          tDict[msgKeyOrText] && tDict[msgKeyOrText][currentLang]
            ? t(msgKeyOrText)
            : msgKeyOrText;
        statusPill.classList.remove("ok", "error");
        if (type === "ok") statusPill.classList.add("ok");
        else if (type === "error") statusPill.classList.add("error");
        statusText.textContent = text;
      }

      function showAuthStep(name) {
        stepMobile.classList.add("hidden");
        stepOtp.classList.add("hidden");

        if (name === "mobile") {
          authOverlay.classList.remove("hidden");
          stepMobile.classList.remove("hidden");
          mobileInput.focus();
        } else if (name === "otp") {
          authOverlay.classList.remove("hidden");
          stepOtp.classList.remove("hidden");
          otpInputs[0].focus();
        }
      }

      function showHubMain() {
        authOverlay.classList.add("hidden");
        hubMain.classList.remove("hidden");
        if (welcomeCard) welcomeCard.classList.add("hidden");
      }

      function hideHubMain() {
        hubMain.classList.add("hidden");
        if (welcomeCard) welcomeCard.classList.remove("hidden");
      }

      function postJson(payload) {
        return fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload || {}),
        }).then(function (res) {
          return res.json().catch(function () {
            throw new Error("Server did not return valid JSON.");
          });
        });
      }

      /* OTP behaviour (L â†’ R) */
      otpInputs.forEach(function (input, idx) {
        input.addEventListener("input", function (e) {
          var value = e.target.value.replace(/\D/g, "");
          e.target.value = value.slice(0, 1);
          if (value && idx < otpInputs.length - 1) {
            otpInputs[idx + 1].focus();
          }
        });

        input.addEventListener("keydown", function (e) {
          if (e.key === "Backspace" && !e.target.value && idx > 0) {
            otpInputs[idx - 1].focus();
          }
          if (e.key === "ArrowLeft" && idx > 0) {
            otpInputs[idx - 1].focus();
          }
          if (e.key === "ArrowRight" && idx < otpInputs.length - 1) {
            otpInputs[idx + 1].focus();
          }
          if (e.key === "Enter") {
            e.preventDefault();
            verifyOtp();
          }
        });
      });

      function readOtp() {
        return otpInputs
          .map(function (el) {
            return el.value || "";
          })
          .join("");
      }

      function clearOtpInputs() {
        otpInputs.forEach(function (el) {
          el.value = "";
        });
      }

      function sendOtp() {
        var mobile = (mobileInput.value || "").trim();
        if (!mobile) {
          setStatus(
            currentLang === "ar"
              ? "Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„."
              : "Enter your mobile.",
            "error"
          );
          mobileInput.focus();
          return;
        }

        currentMobileRaw = mobile;
        btnSendOtp.disabled = true;
        setStatus("statusSendingOtp", null);

        postJson({ action: "sendOtp", mobile: mobile, appId: HUB_APP_ID })
          .then(function (res) {
            if (!res || !res.success) {
              var msg =
                (res && res.error) ||
                (currentLang === "ar"
                  ? "ØªØ¹Ø°Ø± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²."
                  : "Failed to send code.");
              setStatus(msg, "error");
              return;
            }
            setStatus("statusOtpSent", "ok");
            clearOtpInputs();
            showAuthStep("otp");
          })
          .catch(function (err) {
            console.error("sendOtp error:", err);
            setStatus("statusError", "error");
          })
          .finally(function () {
            btnSendOtp.disabled = false;
          });
      }

      function verifyOtp() {
        var otp = readOtp();
        if (!otp || otp.length !== 4) {
          setStatus(
            currentLang === "ar"
              ? "Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ù¤ Ø£Ø±Ù‚Ø§Ù…."
              : "Enter the 4-digit code.",
            "error"
          );
          otpInputs[0].focus();
          return;
        }

        btnVerifyOtp.disabled = true;
        setStatus("statusVerifying", null);

        postJson({
          action: "verifyOtp",
          mobile: currentMobileRaw,
          otp: otp,
          appId: HUB_APP_ID,
        })
          .then(function (res) {
            if (!res || !res.success) {
              var msg =
                (res && res.error) ||
                (currentLang === "ar"
                  ? "Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ Ù…Ù†ØªÙ‡ÙŠ."
                  : "Invalid or expired code.");
              setStatus(msg, "error");
              clearOtpInputs();
              otpInputs[0].focus();
              return;
            }

            if (res.userExists === false) {
              // In the future â†’ show sign-up suggestion
              setStatus(
                currentLang === "ar"
                  ? "Ø§Ù„ÙƒÙˆØ¯ ØµØ­ÙŠØ­ Ù„ÙƒÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯. ØªÙˆØ§ØµÙ„ Ù…Ø¹ ÙØ±ÙŠÙ‚ Ù†Ø­Ù„."
                  : "Code is valid but user not found. Please contact Nahl team.",
                "error"
              );
              return;
            }

            currentSessionKey = res.sessionKey || null;
            if (currentSessionKey) {
              localStorage.setItem(STORAGE_SESSION_KEY, currentSessionKey);
            }

            // Load full hub state (user + workspaces + apps + marketplace)
            loadHubState();
          })
          .catch(function (err) {
            console.error("verifyOtp error:", err);
            setStatus("statusError", "error");
          })
          .finally(function () {
            btnVerifyOtp.disabled = false;
          });
      }

      function loadHubState() {
        if (!currentSessionKey) {
          showAuthStep("mobile");
          return;
        }

        setStatus("statusLoadingHub", null);

        postJson({
          action: "hub.loadState",
          sessionKey: currentSessionKey,
        })
          .then(function (res) {
            if (!res || !res.success) {
              console.warn("hub.loadState error:", res);
              setStatus(
                (res && res.error) ||
                  (currentLang === "ar"
                    ? "ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù…Ø³Ø§Ø­Ø§Øª Ø§Ù„Ø¹Ù…Ù„."
                    : "Failed to load workspaces."),
                "error"
              );
              showAuthStep("mobile");
              return;
            }

            currentUser = res.user || null;
            currentWorkspaces = res.workspaces || [];
            workspaceAppsAll = res.workspaceApps || [];
            marketplaceApps = res.marketplaceApps || [];
            marketplaceModules = res.marketplaceModules || [];

            if (!currentWorkspaces.length) {
              setStatus("statusNoWorkspaces", "error");
            }

            currentWorkspaceId =
              res.workspaceId ||
              (currentWorkspaces[0] && currentWorkspaces[0].workspaceId) ||
              null;

            updateUserUi();
            renderWorkspaces();
            recomputeCurrentApps();
            renderApps();
            renderMarketplace();
            showHubMain();
            setStatus("statusIdle", null);
          })
          .catch(function (err) {
            console.error("hub.loadState error:", err);
            setStatus("statusError", "error");
            showAuthStep("mobile");
          });
      }

      function updateUserUi() {
        if (!currentUser) {
          userNameLabel.textContent = "";
          return;
        }
        var suffix = " Â· " + (currentUser.mobile || "");
        var greetName =
          currentLang === "ar"
            ? "Ù…Ø±Ø­Ø¨Ø§Ù‹ " + (currentUser.name || "")
            : "Hi " + (currentUser.name || "");
        userNameLabel.textContent = greetName + suffix;
      }

      function renderWorkspaces() {
        workspaceSelect.innerHTML = "";

        if (!currentWorkspaces.length) {
          var opt = document.createElement("option");
          opt.value = "";
          opt.textContent =
            currentLang === "ar"
              ? "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³Ø§Ø­Ø§Øª Ø¹Ù…Ù„"
              : "No workspaces";
          workspaceSelect.appendChild(opt);
          workspaceSelect.disabled = true;
          return;
        }

        workspaceSelect.disabled = false;

        currentWorkspaces.forEach(function (ws) {
          var opt = document.createElement("option");
          opt.value = ws.workspaceId;
          var label =
            (currentLang === "ar" ? ws.nameAr || ws.name : ws.nameEn || ws.name) ||
            ws.name ||
            ws.workspaceId;
          opt.textContent = label;
          if (ws.workspaceId === currentWorkspaceId) {
            opt.selected = true;
          }
          workspaceSelect.appendChild(opt);
        });
      }

      function recomputeCurrentApps() {
        if (!workspaceAppsAll || !workspaceAppsAll.length) {
          currentApps = [];
          return;
        }
        currentApps = workspaceAppsAll.filter(function (a) {
          return a.workspaceId === currentWorkspaceId;
        });
      }

      function renderApps() {
        appsListEl.innerHTML = "";
        appsEmptyEl.classList.add("hidden");

        if (!currentApps || !currentApps.length) {
          appsEmptyEl.classList.remove("hidden");
          return;
        }

        currentApps.forEach(function (app) {
          var card = document.createElement("div");
          card.className = "app-card";
          card.dataset.appId = app.appId;

          var header = document.createElement("div");
          header.className = "app-card-header";

          var icon = document.createElement("div");
          icon.className = "app-card-icon";
          icon.textContent = "â‹¯";

          var title = document.createElement("div");
          title.className = "app-card-title";
          var name =
            currentLang === "ar"
              ? app.appNameAr || app.appNameEn || app.name
              : app.appNameEn || app.appNameAr || app.name;
          title.textContent = name || app.appId;

          header.appendChild(icon);
          header.appendChild(title);

          var body = document.createElement("div");
          body.className = "app-card-body";
          var desc =
            currentLang === "ar"
              ? app.descriptionAr || app.descriptionEn
              : app.descriptionEn || app.descriptionAr;
          body.textContent = desc || app.description || "";

          var footer = document.createElement("div");
          footer.className = "app-card-footer";

          var catSpan = document.createElement("span");
          catSpan.textContent = app.category || "";

          var pinnedSpan = document.createElement("span");
          if (app.pinned || app.isPrimary) {
            pinnedSpan.className = "badge-pinned";
            pinnedSpan.textContent =
              currentLang === "ar" ? "Ù…Ø«Ø¨Ù‘Øª" : "Pinned";
          }

          footer.appendChild(catSpan);
          if (pinnedSpan.textContent) footer.appendChild(pinnedSpan);

          card.appendChild(header);
          card.appendChild(body);
          card.appendChild(footer);

          card.addEventListener("click", function () {
            if (!app.baseUrl) {
              setStatus(
                currentLang === "ar"
                  ? "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¨Ø· Ù„Ù„ØªØ·Ø¨ÙŠÙ‚. ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙƒØªØ§Ù„ÙˆØ¬."
                  : "This app has no URL configured. Check catalog settings.",
                "error"
              );
              return;
            }
            var sep = app.baseUrl.indexOf("?") === -1 ? "?" : "&";
            var url =
              app.baseUrl +
              sep +
              "appid=" +
              encodeURIComponent(app.appId || "");
            window.open(url, "_blank");
          });

          appsListEl.appendChild(card);
        });
      }

      function renderMarketplace() {
        marketAppsList.innerHTML = "";
        marketModulesList.innerHTML = "";
        marketAppsEmpty.classList.add("hidden");
        marketModulesEmpty.classList.add("hidden");

        if (!marketplaceApps || !marketplaceApps.length) {
          marketAppsEmpty.classList.remove("hidden");
        } else {
          marketplaceApps.forEach(function (tpl) {
            var card = document.createElement("div");
            card.className = "market-card";

            var header = document.createElement("div");
            header.className = "market-card-header";

            var title = document.createElement("div");
            title.className = "market-card-title";
            title.textContent = tpl.name || tpl.templateId;

            var tag = document.createElement("div");
            tag.className = "market-card-tag";
            tag.textContent = tpl.category || "App";

            header.appendChild(title);
            header.appendChild(tag);

            var body = document.createElement("div");
            body.className = "market-card-body";
            body.textContent = tpl.shortDesc || tpl.description || "";

            var footer = document.createElement("div");
            footer.className = "market-card-footer";

            var installedSpan = document.createElement("span");
            installedSpan.className = "market-installed";
            installedSpan.textContent =
              tpl.installed && currentLang === "ar"
                ? "Ù…Ø«Ø¨Ù‘Øª"
                : tpl.installed
                ? "Installed"
                : "";

            var btn = document.createElement("button");
            btn.type = "button";
            btn.className = "btn btn-primary";
            btn.textContent = tpl.installed
              ? currentLang === "ar"
                ? "Ù…Ø«Ø¨Ù‘Øª"
                : "Installed"
              : currentLang === "ar"
              ? "ØªØ«Ø¨ÙŠØª"
              : "Install";
            if (tpl.installed) {
              btn.disabled = true;
            }

            btn.addEventListener("click", function () {
              installTemplate(tpl.templateId, "App", btn);
            });

            footer.appendChild(installedSpan);
            footer.appendChild(btn);

            card.appendChild(header);
            card.appendChild(body);
            card.appendChild(footer);

            marketAppsList.appendChild(card);
          });
        }

        if (!marketplaceModules || !marketplaceModules.length) {
          marketModulesEmpty.classList.remove("hidden");
        } else {
          marketplaceModules.forEach(function (tpl) {
            var card = document.createElement("div");
            card.className = "market-card";

            var header = document.createElement("div");
            header.className = "market-card-header";

            var title = document.createElement("div");
            title.className = "market-card-title";
            title.textContent = tpl.name || tpl.templateId;

            var tag = document.createElement("div");
            tag.className = "market-card-tag";
            tag.textContent =
              currentLang === "ar" ? "Module" : "Module";

            header.appendChild(title);
            header.appendChild(tag);

            var body = document.createElement("div");
            body.className = "market-card-body";
            body.textContent = tpl.shortDesc || tpl.description || "";

            var footer = document.createElement("div");
            footer.className = "market-card-footer";

            var installedSpan = document.createElement("span");
            installedSpan.className = "market-installed";
            installedSpan.textContent =
              tpl.installed && currentLang === "ar"
                ? "Ù…Ø«Ø¨Ù‘Øª"
                : tpl.installed
                ? "Installed"
                : "";

            var btn = document.createElement("button");
            btn.type = "button";
            btn.className = "btn btn-primary";
            btn.textContent = tpl.installed
              ? currentLang === "ar"
                ? "Ù…Ø«Ø¨Ù‘Øª"
                : "Installed"
              : currentLang === "ar"
              ? "ØªØ«Ø¨ÙŠØª Ø§Ù„Ø­Ø²Ù…Ø©"
              : "Install module";
            if (tpl.installed) {
              btn.disabled = true;
            }

            btn.addEventListener("click", function () {
              installTemplate(tpl.templateId, "Module", btn);
            });

            footer.appendChild(installedSpan);
            footer.appendChild(btn);

            card.appendChild(header);
            card.appendChild(body);
            card.appendChild(footer);

            marketModulesList.appendChild(card);
          });
        }
      }

      function installTemplate(templateId, type, buttonEl) {
        if (!currentWorkspaceId || !currentUser) {
          setStatus(
            currentLang === "ar"
              ? "Ø§Ø®ØªØ± Ù…Ø³Ø§Ø­Ø© Ø¹Ù…Ù„ Ø£ÙˆÙ„Ø§Ù‹."
              : "Select a workspace first.",
            "error"
          );
          return;
        }

        var originalText = buttonEl.textContent;
        buttonEl.disabled = true;
        buttonEl.textContent = t("statusInstalling");

        postJson({
          action: "marketplace.installTemplate",
          workspaceId: currentWorkspaceId,
          templateId: templateId,
          userId: currentUser.userId,
        })
          .then(function (res) {
            if (!res || !res.success) {
              console.warn("installTemplate error:", res);
              setStatus(
                (res && res.error) ||
                  (currentLang === "ar"
                    ? "ØªØ¹Ø°Ø± Ø§Ù„ØªØ«Ø¨ÙŠØª."
                    : "Failed to install."),
                "error"
              );
              buttonEl.disabled = false;
              buttonEl.textContent = originalText;
              return;
            }

            setStatus("statusInstalled", "ok");
            // Refresh hub state to see newly installed apps
            loadHubState();
          })
          .catch(function (err) {
            console.error("installTemplate error:", err);
            setStatus("statusError", "error");
            buttonEl.disabled = false;
            buttonEl.textContent = originalText;
          });
      }

      function setView(view) {
        currentView = view;

        btnViewApps.classList.remove("active");
        btnViewMarketplace.classList.remove("active");
        btnViewGift.classList.remove("active");

        appsSection.classList.add("hidden");
        marketplaceSection.classList.add("hidden");
        giftSection.classList.add("hidden");

        if (view === "apps") {
          btnViewApps.classList.add("active");
          appsSection.classList.remove("hidden");
        } else if (view === "marketplace") {
          btnViewMarketplace.classList.add("active");
          marketplaceSection.classList.remove("hidden");
        } else if (view === "gift") {
          btnViewGift.classList.add("active");
          giftSection.classList.remove("hidden");
        }
      }

      function logout() {
        currentSessionKey = null;
        localStorage.removeItem(STORAGE_SESSION_KEY);
        currentUser = null;
        currentWorkspaces = [];
        currentWorkspaceId = null;
        workspaceAppsAll = [];
        currentApps = [];
        marketplaceApps = [];
        marketplaceModules = [];

        hideHubMain();
        authOverlay.classList.remove("hidden");
        showAuthStep("mobile");
        setStatus("statusIdle", null);
      }

      /* Events */

      btnSendOtp.addEventListener("click", sendOtp);
      mobileInput.addEventListener("keydown", function (e) {
        if (e.key === "Enter") {
          e.preventDefault();
          sendOtp();
        }
      });

      btnVerifyOtp.addEventListener("click", verifyOtp);

      btnChangeMobile.addEventListener("click", function () {
        showAuthStep("mobile");
        setStatus("statusIdle", null);
      });

      btnLogout.addEventListener("click", logout);

      btnTheme.addEventListener("click", function () {
        currentTheme = currentTheme === "light" ? "dark" : "light";
        localStorage.setItem(STORAGE_THEME, currentTheme);
        applyTheme();
      });

      btnLangAr.addEventListener("click", function () {
        currentLang = "ar";
        localStorage.setItem(STORAGE_LANG, currentLang);
        applyLanguage();
        setStatus("statusIdle", null);
        renderApps();
        renderMarketplace();
      });

      btnLangEn.addEventListener("click", function () {
        currentLang = "en";
        localStorage.setItem(STORAGE_LANG, currentLang);
        applyLanguage();
        setStatus("statusIdle", null);
        renderApps();
        renderMarketplace();
      });

      workspaceSelect.addEventListener("change", function () {
        var val = workspaceSelect.value || "";
        if (!val) return;
        currentWorkspaceId = val;
        recomputeCurrentApps();
        renderApps();
      });

      btnViewApps.addEventListener("click", function () {
        setView("apps");
      });
      btnViewMarketplace.addEventListener("click", function () {
        setView("marketplace");
      });
      btnViewGift.addEventListener("click", function () {
        setView("gift");
      });

      btnNewWorkspace.addEventListener("click", function () {
        setStatus(
          currentLang === "ar"
            ? "Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³Ø§Ø­Ø© Ø¹Ù…Ù„ Ø¬Ø¯ÙŠØ¯Ø© Ø³ÙŠØªÙ… ÙÙŠ Ù†Ø³Ø®Ø© Ù„Ø§Ø­Ù‚Ø©."
            : "Creating new workspace will be implemented in a later version.",
          "error"
        );
      });

      btnAppsMenu.addEventListener("click", function (e) {
        e.stopPropagation();
        // (Optional future: show all apps in a small menu)
        appsMenuPanel.classList.toggle("hidden");
      });

      document.addEventListener("click", function () {
        appsMenuPanel.classList.add("hidden");
      });

      appsMenuPanel.addEventListener("click", function (e) {
        e.stopPropagation();
      });

      /* Init */

      applyTheme();
      applyLanguage();
      setStatus("statusIdle", null);

      if (currentSessionKey) {
        // Try to restore session
        loadHubState();
      } else {
        showAuthStep("mobile");
      }
    })();
  </script>
</body>
</html>
