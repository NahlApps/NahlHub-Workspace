<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>NahlHub</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet" />

  <!-- (KEEP YOUR SAME CSS AS YOU PROVIDED) -->
<link rel="stylesheet" href="/style.css">

</head>

<body data-theme="light">
  <div class="app-shell">
    <!-- Top bar -->
    <header class="topbar">
      <div class="topbar-left">
        <div class="brand-logo">N</div>
        <div class="brand-text">
          <div class="brand-title" data-i18n="hubTitle">NahlHub</div>
          <div class="brand-subtitle" data-i18n="hubSub">ØªØ·Ø¨ÙŠÙ‚Ø§ØªÙƒ ÙÙŠ Ù†Ø­Ù„ Ù‡Ø¨</div>
        </div>
      </div>

      <div class="topbar-right">
        <div class="chip-group">
          <button class="chip-btn" id="btnLangAr" type="button" data-lang="ar"><span>Ø¹Ø±Ø¨ÙŠ</span></button>
          <button class="chip-btn" id="btnLangEn" type="button" data-lang="en"><span>EN</span></button>
        </div>
        <button class="chip-btn chip-btn-mini" id="btnTheme" type="button">
          <span class="icon" id="themeIcon">ğŸŒ</span>
        </button>
      </div>
    </header>

    <!-- Status -->
    <div id="statusPill" class="status-pill">
      <span class="status-dot"></span>
      <span id="statusText"></span>
    </div>

    <!-- AUTH POPUP -->
    <div id="authOverlay" class="auth-overlay">
      <div class="auth-modal">
        <div class="auth-modal-header">
          <div>
            <div class="auth-title" data-i18n="welcomeTitle">Ù…Ø±Ø­Ø¨Ø§Ù‹ ğŸ‘‹</div>
            <div class="auth-sub" data-i18n="welcomeSub">Ø§Ø¯Ø®Ù„ Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø«Ù… Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„.</div>
          </div>
          <div class="auth-badge">
            <span data-i18n="step1Title">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</span> Â· <span data-i18n="step2Title">Ø±Ù…Ø²</span>
          </div>
        </div>

        <div class="auth-modal-body">
          <!-- Step 1 -->
          <section id="stepMobile" class="card" style="margin:0;">
            <div class="card-header">
              <div>
                <div class="card-title" data-i18n="step1Title">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</div>
                <div class="card-caption" data-i18n="step1Sub">Ø§Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„.</div>
              </div>
            </div>
            <div class="card-body">
              <div class="field-group">
                <label class="field-label" for="mobileInput" data-i18n="step1Label">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label>
                <input id="mobileInput" class="input" type="tel" inputmode="tel" autocomplete="tel" placeholder="5XXXXXXXX" />
              </div>

              <div style="display:flex; justify-content:flex-end; margin-top:6px;">
                <button id="btnSendOtp" class="btn btn-primary" type="button">
                  <span data-i18n="btnSendOtp">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²</span>
                </button>
              </div>
            </div>
          </section>

          <!-- Step 2 -->
          <section id="stepOtp" class="card hidden" style="margin:0;">
            <div class="card-header">
              <div>
                <div class="card-title" data-i18n="step2Title">Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
                <div class="card-caption" data-i18n="step2Sub">Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ù¤ Ø£Ø±Ù‚Ø§Ù….</div>
              </div>
              <button type="button" class="btn-ghost" id="btnChangeMobile">
                <span data-i18n="changeMobile">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ù‚Ù…</span>
              </button>
            </div>

            <div class="card-body">
              <div class="otp-row">
                <input class="otp-input" id="otp1" type="tel" inputmode="numeric" maxlength="1" />
                <input class="otp-input" id="otp2" type="tel" inputmode="numeric" maxlength="1" />
                <input class="otp-input" id="otp3" type="tel" inputmode="numeric" maxlength="1" />
                <input class="otp-input" id="otp4" type="tel" inputmode="numeric" maxlength="1" />
              </div>
              <div style="display:flex; justify-content:flex-end; margin-top:10px;">
                <button id="btnVerifyOtp" class="btn btn-primary" type="button">
                  <span data-i18n="btnVerify">ØªØ£ÙƒÙŠØ¯</span>
                </button>
              </div>
            </div>
          </section>
        </div>
      </div>
    </div>

    <!-- Main -->
    <main class="main-panel">
      <section class="welcome-card" id="welcomeCard">
        <div class="welcome-header-line">
          <div>
            <div class="welcome-title" data-i18n="welcomeTitle">Ù…Ø±Ø­Ø¨Ø§Ù‹ ğŸ‘‹</div>
            <div class="welcome-sub" data-i18n="welcomeSub">Ø§Ø¯Ø®Ù„ Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø«Ù… Ø§Ø®ØªØ± Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„ ÙˆØ§Ù„ØªØ·Ø¨ÙŠÙ‚.</div>
          </div>
        </div>
      </section>

      <section id="stepApps" class="apps-layout hidden">
        <div class="apps-header-row">
          <div class="workspace-card" id="workspaceCard">
            <div class="workspace-meta">
              <div class="workspace-label" data-i18n="workspaceLabel">Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„</div>
              <div class="workspace-name-row">
                <div class="workspace-name" id="workspaceName">â€”</div>
                <span class="workspace-role-pill" id="workspaceRole">â€”</span>
              </div>
            </div>
            <div class="workspace-dropdown-icon"><span id="workspaceChevron">â–¾</span></div>
            <div id="workspaceMenu" class="workspace-menu hidden"></div>
          </div>

          <div class="view-toggle-group">
            <button id="btnViewApps" type="button" class="view-toggle-btn active">
              <span class="icon">âš™ï¸</span><span data-i18n="viewApps">Apps</span>
            </button>
            <button id="btnViewMarketplace" type="button" class="view-toggle-btn">
              <span class="icon">ğŸ›’</span><span data-i18n="viewMarketplace">Marketplace</span>
            </button>
          </div>

          <button class="btn-ghost" type="button" id="btnLogout"><span data-i18n="logout">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</span></button>
        </div>

        <section id="sectionApps" class="apps-section-card">
          <div class="card-header" style="padding:0;">
            <div>
              <div class="card-title" data-i18n="yourAppsTitle">ØªØ·Ø¨ÙŠÙ‚Ø§ØªÙƒ</div>
              <div class="card-caption" id="userNameLabel"></div>
            </div>
          </div>
          <div class="card-body"><div id="appsGrid" class="apps-grid"></div></div>
        </section>

        <section id="sectionMarketplace" class="apps-section-card hidden">
          <div class="card-header" style="padding:0;">
            <div>
              <div class="card-title" data-i18n="marketplaceTitle">App Marketplace</div>
              <div class="card-caption" data-i18n="marketplaceSub">Ø§Ø®ØªØ± Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„ ÙˆØ«Ø¨Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ù„ÙØ±ÙŠÙ‚Ùƒ.</div>
            </div>
          </div>
          <div class="card-body"><div id="marketplaceGrid" class="apps-grid"></div></div>
        </section>

        <section id="sectionAppView" class="app-view-card hidden">
          <div class="app-view-header">
            <div>
              <div id="appViewTitle" class="app-view-title">NahlHub App</div>
              <div id="appViewSub" class="app-view-sub" data-i18n="appViewSub">
                Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¸Ø§Ù‡Ø± Ø¯Ø§Ø®Ù„ Ù†Ø­Ù„ Ù‡Ø¨. Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª.
              </div>
            </div>
            <button id="btnBackFromApp" type="button" class="btn-ghost">â† <span data-i18n="backToApps">Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª</span></button>
          </div>
          <div class="app-frame-wrap">
            <iframe id="appFrame" class="app-frame hidden" src="" title="NahlHub App"></iframe>
            <div id="appFramePlaceholder" class="app-frame-placeholder"><span data-i18n="appPlaceholder">Ø§Ø®ØªØ± ØªØ·Ø¨ÙŠÙ‚Ø§Ù‹ Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø£Ùˆ Ù…Ù† Ø§Ù„Ù…ØªØ¬Ø±.</span></div>
          </div>
        </section>
      </section>
    </main>
  </div>

  <script>
    (function () {
      "use strict";

      var HUB_APP_ID = "HUB";
      var API_URL = "/api/hub/manage";

      var STORAGE_SESSION_KEY = "nahlhub_session_key";
      var STORAGE_LANG = "nahlhub_lang";
      var STORAGE_THEME = "nahlhub_theme";

      var currentLang = localStorage.getItem(STORAGE_LANG) || "ar";
      var currentTheme = localStorage.getItem(STORAGE_THEME) || "light";
      var currentSessionKey = localStorage.getItem(STORAGE_SESSION_KEY) || null;

      var currentUser = null;
      var currentMobileRaw = "";
      var currentCountryCode = ""; // (optional future UI, now blank)
      var currentWorkspaces = [];
      var currentWorkspaceId = null;
      var currentWorkspaceRole = "";
      var currentWorkspaceApps = [];
      var currentTemplates = [];
      var currentMainView = "apps";

      var bodyEl = document.body;
      var statusPill = document.getElementById("statusPill");
      var statusText = document.getElementById("statusText");

      var welcomeCard = document.getElementById("welcomeCard");
      var authOverlay = document.getElementById("authOverlay");
      var stepMobile = document.getElementById("stepMobile");
      var stepOtp = document.getElementById("stepOtp");
      var stepApps = document.getElementById("stepApps");

      var mobileInput = document.getElementById("mobileInput");
      var btnSendOtp = document.getElementById("btnSendOtp");

      var otpInputs = [
        document.getElementById("otp1"),
        document.getElementById("otp2"),
        document.getElementById("otp3"),
        document.getElementById("otp4")
      ];
      var btnVerifyOtp = document.getElementById("btnVerifyOtp");
      var btnChangeMobile = document.getElementById("btnChangeMobile");

      var workspaceCard = document.getElementById("workspaceCard");
      var workspaceMenu = document.getElementById("workspaceMenu");
      var workspaceNameEl = document.getElementById("workspaceName");
      var workspaceRoleEl = document.getElementById("workspaceRole");

      var btnViewApps = document.getElementById("btnViewApps");
      var btnViewMarketplace = document.getElementById("btnViewMarketplace");

      var sectionApps = document.getElementById("sectionApps");
      var sectionMarketplace = document.getElementById("sectionMarketplace");
      var sectionAppView = document.getElementById("sectionAppView");

      var appsGrid = document.getElementById("appsGrid");
      var marketplaceGrid = document.getElementById("marketplaceGrid");

      var appFrame = document.getElementById("appFrame");
      var appFramePlaceholder = document.getElementById("appFramePlaceholder");
      var appViewTitle = document.getElementById("appViewTitle");

      var btnBackFromApp = document.getElementById("btnBackFromApp");
      var btnLogout = document.getElementById("btnLogout");

      var btnTheme = document.getElementById("btnTheme");
      var themeIcon = document.getElementById("themeIcon");
      var btnLangAr = document.getElementById("btnLangAr");
      var btnLangEn = document.getElementById("btnLangEn");

      var userNameLabel = document.getElementById("userNameLabel");

      var tDict = {
        hubTitle: { ar: "NahlHub", en: "NahlHub" },
        hubSub: { ar: "ØªØ·Ø¨ÙŠÙ‚Ø§ØªÙƒ ÙÙŠ Ù†Ø­Ù„ Ù‡Ø¨", en: "Your apps in NahlHub" },
        welcomeTitle: { ar: "Ù…Ø±Ø­Ø¨Ø§Ù‹ ğŸ‘‹", en: "Welcome ğŸ‘‹" },
        welcomeSub: { ar: "Ø§Ø¯Ø®Ù„ Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø«Ù… Ø§Ø®ØªØ± Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„ ÙˆØ§Ù„ØªØ·Ø¨ÙŠÙ‚.", en: "Enter your mobile, then choose workspace and app." },
        step1Title: { ar: "Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„", en: "Mobile number" },
        step1Sub: { ar: "Ø§Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„.", en: "Enter your mobile." },
        step1Label: { ar: "Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„", en: "Mobile" },
        btnSendOtp: { ar: "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²", en: "Send code" },
        step2Title: { ar: "Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„", en: "Login code" },
        step2Sub: { ar: "Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ù¤ Ø£Ø±Ù‚Ø§Ù….", en: "Enter the 4-digit code." },
        changeMobile: { ar: "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ù‚Ù…", en: "Change number" },
        btnVerify: { ar: "ØªØ£ÙƒÙŠØ¯", en: "Confirm" },
        logout: { ar: "ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬", en: "Logout" },
        statusIdle: { ar: "Ø¬Ø§Ù‡Ø².", en: "Ready." },
        statusSendingOtp: { ar: "ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø² Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨...", en: "Sending WhatsApp code..." },
        statusOtpSent: { ar: "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø² Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨.", en: "WhatsApp code sent." },
        statusVerifying: { ar: "ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚...", en: "Verifying..." },
        statusError: { ar: "Ø­Ø¯Ø« Ø®Ø·Ø£. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.", en: "Something went wrong. Try again." },
        statusNoWorkspaces: { ar: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³Ø§Ø­Ø§Øª Ø¹Ù…Ù„ Ù…ØªØ§Ø­Ø©.", en: "No workspaces available." },
        statusLoadingWorkspace: { ar: "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ø³Ø§Ø­Ø§Øª Ø§Ù„Ø¹Ù…Ù„...", en: "Loading workspaces..." },
        statusLoadingApps: { ar: "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª...", en: "Loading apps..." },
        statusLoadingMarketplace: { ar: "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù…ØªØ¬Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª...", en: "Loading marketplace..." },
        workspaceLabel: { ar: "Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„", en: "Workspace" },
        yourAppsTitle: { ar: "ØªØ·Ø¨ÙŠÙ‚Ø§ØªÙƒ", en: "Your apps" },
        marketplaceTitle: { ar: "App Marketplace", en: "App Marketplace" },
        marketplaceSub: { ar: "Ø§Ø®ØªØ± Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„ ÙˆØ«Ø¨Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ù„ÙØ±ÙŠÙ‚Ùƒ.", en: "Choose a workspace and install the right apps for your team." },
        viewApps: { ar: "Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª", en: "Apps" },
        viewMarketplace: { ar: "Ø§Ù„Ù…ØªØ¬Ø±", en: "Marketplace" },
        appPlaceholder: { ar: "Ø§Ø®ØªØ± ØªØ·Ø¨ÙŠÙ‚Ø§Ù‹ Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø£Ùˆ Ù…Ù† Ø§Ù„Ù…ØªØ¬Ø±.", en: "Choose an app from your apps or from the marketplace." },
        appViewSub: { ar: "Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¸Ø§Ù‡Ø± Ø¯Ø§Ø®Ù„ Ù†Ø­Ù„ Ù‡Ø¨. Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª.", en: "The app is shown inside NahlHub. Use Back to return to apps." },
        backToApps: { ar: "Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª", en: "Apps" },
        userNotFound: { ar: "Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„. ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨.", en: "This mobile is not registered. Contact your admin to create an account." }
      };

      function t(key) {
        var entry = tDict[key];
        if (!entry) return key;
        return entry[currentLang] || entry.ar || key;
      }

      function applyLanguage() {
        document.documentElement.lang = currentLang;
        document.documentElement.dir = currentLang === "ar" ? "rtl" : "ltr";

        document.querySelectorAll("[data-i18n]").forEach(function (node) {
          var key = node.getAttribute("data-i18n");
          node.textContent = t(key);
        });

        btnLangAr.classList.toggle("active", currentLang === "ar");
        btnLangEn.classList.toggle("active", currentLang === "en");

        mobileInput.placeholder = "5XXXXXXXX";
        updateUserUi();
      }

      function applyTheme() {
        bodyEl.setAttribute("data-theme", currentTheme);
        themeIcon.textContent = currentTheme === "light" ? "ğŸŒ" : "ğŸŒ™";
      }

      function setStatus(msgKeyOrText, type) {
        var text = (tDict[msgKeyOrText] && tDict[msgKeyOrText][currentLang]) ? t(msgKeyOrText) : msgKeyOrText;
        statusPill.classList.remove("ok", "error");
        if (type === "ok") statusPill.classList.add("ok");
        else if (type === "error") statusPill.classList.add("error");
        statusText.textContent = text || "";
      }

      function postJson(payload) {
        var body = Object.assign({}, payload || {});
        if (!body.appId && !body.appid && HUB_APP_ID) body.appId = HUB_APP_ID;

        return fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        }).then(function (res) {
          return res.json().catch(function () {
            throw new Error("Invalid JSON from backend.");
          });
        });
      }

      function showStep(name) {
        stepMobile.classList.add("hidden");
        stepOtp.classList.add("hidden");
        stepApps.classList.add("hidden");

        if (name === "mobile") {
          authOverlay.classList.remove("hidden");
          stepMobile.classList.remove("hidden");
          mobileInput.focus();
        } else if (name === "otp") {
          authOverlay.classList.remove("hidden");
          stepOtp.classList.remove("hidden");
          otpInputs[0].focus();
        } else if (name === "apps") {
          authOverlay.classList.add("hidden");
          stepApps.classList.remove("hidden");
        }
      }

      // OTP input behavior
      otpInputs.forEach(function (input, idx) {
        input.addEventListener("input", function (e) {
          var value = e.target.value.replace(/\D/g, "");
          e.target.value = value.slice(0, 1);
          if (value && idx < otpInputs.length - 1) otpInputs[idx + 1].focus();
        });

        input.addEventListener("keydown", function (e) {
          if (e.key === "Backspace" && !e.target.value && idx > 0) otpInputs[idx - 1].focus();
          if (e.key === "ArrowLeft" && idx > 0) otpInputs[idx - 1].focus();
          if (e.key === "ArrowRight" && idx < otpInputs.length - 1) otpInputs[idx + 1].focus();
          if (e.key === "Enter") { e.preventDefault(); verifyOtp(); }
        });
      });

      function readOtp() {
        return otpInputs.map(function (el) { return el.value || ""; }).join("");
      }

      function clearOtpInputs() {
        otpInputs.forEach(function (el) { el.value = ""; });
      }

      function sendOtp() {
        var mobile = (mobileInput.value || "").trim();
        if (!mobile) {
          setStatus(currentLang === "ar" ? "Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„." : "Enter your mobile.", "error");
          mobileInput.focus();
          return;
        }

        currentMobileRaw = mobile;
        btnSendOtp.disabled = true;
        setStatus("statusSendingOtp");

        postJson({ action: "sendOtp", mobile: mobile, countryCode: currentCountryCode })
          .then(function (res) {
            if (!res || !res.success) {
              setStatus((res && res.error) || (currentLang === "ar" ? "ØªØ¹Ø°Ø± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²." : "Failed to send code."), "error");
              return;
            }
            setStatus("statusOtpSent", "ok");
            clearOtpInputs();
            showStep("otp");
          })
          .catch(function () { setStatus("statusError", "error"); })
          .finally(function () { btnSendOtp.disabled = false; });
      }

      function verifyOtp() {
        var otp = readOtp();
        if (!otp || otp.length !== 4) {
          setStatus(currentLang === "ar" ? "Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ù¤ Ø£Ø±Ù‚Ø§Ù…." : "Enter the 4-digit code.", "error");
          otpInputs[0].focus();
          return;
        }

        btnVerifyOtp.disabled = true;
        setStatus("statusVerifying");

        postJson({ action: "verifyOtp", mobile: currentMobileRaw, otp: otp })
          .then(function (res) {
            if (!res || !res.success) {
              setStatus((res && res.error) || (currentLang === "ar" ? "Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ Ù…Ù†ØªÙ‡ÙŠ." : "Invalid or expired code."), "error");
              clearOtpInputs();
              otpInputs[0].focus();
              return;
            }

            if (res.userExists === false) {
              setStatus("userNotFound", "error");
              clearOtpInputs();
              otpInputs[0].focus();
              return;
            }

            currentSessionKey = res.sessionKey || null;
            currentUser = res.user || null;

            if (currentSessionKey) localStorage.setItem(STORAGE_SESSION_KEY, currentSessionKey);

            if (welcomeCard) welcomeCard.classList.add("hidden");
            updateUserUi();

            // âœ… ENTER HUB IMMEDIATELY, then load data
            showStep("apps");
            setStatus("statusLoadingWorkspace");
            loadWorkspaces().then(function () {
              setStatus("statusIdle");
            });
          })
          .catch(function () { setStatus("statusError", "error"); })
          .finally(function () { btnVerifyOtp.disabled = false; });
      }

      function updateUserUi() {
        if (!currentUser) { userNameLabel.textContent = ""; return; }
        var suffix = " Â· " + (currentUser.mobile || "");
        var greetName = currentLang === "ar" ? "Ù…Ø±Ø­Ø¨Ø§Ù‹ " + (currentUser.name || "") : "Hi " + (currentUser.name || "");
        userNameLabel.textContent = greetName + suffix;
      }

      function logout() {
        currentSessionKey = null;
        localStorage.removeItem(STORAGE_SESSION_KEY);
        currentUser = null;
        currentWorkspaces = [];
        currentWorkspaceId = null;
        currentWorkspaceApps = [];
        currentTemplates = [];
        appsGrid.innerHTML = "";
        marketplaceGrid.innerHTML = "";
        workspaceNameEl.textContent = "â€”";
        workspaceRoleEl.textContent = "â€”";
        setMainView("apps");

        if (welcomeCard) welcomeCard.classList.remove("hidden");
        setStatus("statusIdle");
        showStep("mobile");
      }

      function setMainView(view) {
        currentMainView = view;
        sectionApps.classList.toggle("hidden", view !== "apps");
        sectionMarketplace.classList.toggle("hidden", view !== "marketplace");
        sectionAppView.classList.toggle("hidden", view !== "app");
        btnViewApps.classList.toggle("active", view === "apps");
        btnViewMarketplace.classList.toggle("active", view === "marketplace");
      }

      function buildWorkspaceMenu() {
        workspaceMenu.innerHTML = "";
        if (!currentWorkspaces.length) {
          var empty = document.createElement("div");
          empty.className = "card-caption";
          empty.style.padding = "6px 4px";
          empty.textContent = t("statusNoWorkspaces");
          workspaceMenu.appendChild(empty);
          return;
        }

        currentWorkspaces.forEach(function (ws) {
          var btn = document.createElement("button");
          btn.type = "button";
          btn.className = "workspace-menu-item";
          if (ws.workspaceId === currentWorkspaceId) btn.classList.add("active");

          var main = document.createElement("div");
          main.className = "workspace-menu-item-main";

          var name = document.createElement("div");
          name.className = "workspace-menu-item-name";
          name.textContent = ws.name || ws.workspaceId;

          var meta = document.createElement("div");
          meta.className = "workspace-menu-item-meta";
          meta.textContent = (ws.slug || "") + (ws.plan ? " Â· " + ws.plan : "");

          main.appendChild(name);
          main.appendChild(meta);

          var rolePill = document.createElement("span");
          rolePill.className = "workspace-menu-item-role";
          rolePill.textContent = ws.role || "member";

          btn.appendChild(main);
          btn.appendChild(rolePill);

          btn.addEventListener("click", function (e) {
            e.stopPropagation();
            selectWorkspace(ws.workspaceId);
            workspaceMenu.classList.add("hidden");
          });

          workspaceMenu.appendChild(btn);
        });
      }

      function selectWorkspace(workspaceId) {
        var ws = currentWorkspaces.find(function (w) { return w.workspaceId === workspaceId; });
        if (!ws) return;

        currentWorkspaceId = workspaceId;
        currentWorkspaceRole = ws.role || "member";

        workspaceNameEl.textContent = ws.name || ws.workspaceId;
        workspaceRoleEl.textContent = (ws.role === "admin") ? "admin" : "member";

        buildWorkspaceMenu();
        setStatus("statusLoadingApps");
        loadWorkspaceData();
      }

      function loadWorkspaces() {
        if (!currentUser || !currentUser.userId) return Promise.resolve();

        return postJson({ action: "workspace.listForUser", userId: currentUser.userId })
          .then(function (res) {
            currentWorkspaces = (res && res.items) || [];
            if (!currentWorkspaces.length) {
              setStatus("statusNoWorkspaces", "error");
              return;
            }
            selectWorkspace(currentWorkspaces[0].workspaceId);
          })
          .catch(function () { setStatus("statusError", "error"); });
      }

      function loadWorkspaceData() {
        if (!currentWorkspaceId) return;

        Promise.all([
          postJson({ action: "marketplace.listWorkspaceApps", workspaceId: currentWorkspaceId }),
          postJson({ action: "marketplace.listTemplates", workspaceId: currentWorkspaceId })
        ])
        .then(function (results) {
          var appsRes = results[0] || {};
          var tplRes = results[1] || {};

          currentTemplates = tplRes.items || [];

          var tplById = {};
          currentTemplates.forEach(function (tpl) { tplById[tpl.templateId] = tpl; });

          currentWorkspaceApps = (appsRes.items || []).map(function (app) {
            var tpl = tplById[app.templateId] || {};
            return {
              workspaceAppId: app.workspaceAppId,
              appId: app.appId,
              templateId: app.templateId,
              name: app.name || tpl.name || app.templateId,
              category: tpl.category || "",
              shortDesc: (currentLang === "ar" ? (tpl.shortDescAr || "") : (tpl.shortDescEn || "")),
              status: app.status || "",
              visibleInHub: app.visibleInHub || "",
              defaultRoute: tpl.defaultRoute || app.defaultRoute || "",
              iconUrl: tpl.iconUrl || "",
              featureTags: tpl.featureTags || ""
            };
          });

          renderApps();
          renderMarketplace();
          setStatus("statusIdle");
        })
        .catch(function () { setStatus("statusError", "error"); });
      }

      function renderApps() {
        appsGrid.innerHTML = "";
        if (!currentWorkspaceApps.length) {
          var empty = document.createElement("div");
          empty.className = "card-caption";
          empty.textContent = currentLang === "ar" ? "Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ù…Ø«Ø¨ØªØ© ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø³Ø§Ø­Ø©." : "No apps installed in this workspace.";
          appsGrid.appendChild(empty);
          return;
        }

        currentWorkspaceApps.forEach(function (app) {
          var card = document.createElement("article");
          card.className = "app-card";

          var header = document.createElement("div");
          header.className = "app-card-header";

          var main = document.createElement("div");
          main.className = "app-card-main";

          var icon = document.createElement("div");
          icon.className = "app-card-icon";
          icon.textContent = "âœ¦";

          var titleWrap = document.createElement("div");
          var title = document.createElement("div");
          title.className = "app-card-title";
          title.textContent = app.name || app.templateId;

          var tagLine = document.createElement("div");
          tagLine.className = "app-card-tagline";
          tagLine.textContent = app.category || "";

          titleWrap.appendChild(title);
          titleWrap.appendChild(tagLine);

          main.appendChild(icon);
          main.appendChild(titleWrap);

          var statusBadge = document.createElement("span");
          statusBadge.className = "badge-installed";
          statusBadge.textContent = currentLang === "ar" ? "Ù…Ø«Ø¨Ù‘Øª" : "Installed";

          header.appendChild(main);
          header.appendChild(statusBadge);

          var body = document.createElement("div");
          body.className = "app-card-body";
          body.textContent = app.shortDesc || "";

          var footer = document.createElement("div");
          footer.className = "app-card-footer";

          var cat = document.createElement("span");
          cat.textContent = app.category || "â€”";

          var actions = document.createElement("div");
          actions.className = "app-card-actions";

          var openBtn = document.createElement("button");
          openBtn.type = "button";
          openBtn.className = "btn-pill-sm primary";
          openBtn.textContent = currentLang === "ar" ? "ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚" : "Open app";

          openBtn.addEventListener("click", function (e) {
            e.stopPropagation();
            openWorkspaceApp(app);
          });

          actions.appendChild(openBtn);
          footer.appendChild(cat);
          footer.appendChild(actions);

          card.appendChild(header);
          card.appendChild(body);
          card.appendChild(footer);

          card.addEventListener("click", function () { openWorkspaceApp(app); });

          appsGrid.appendChild(card);
        });
      }

      function renderMarketplace() {
        marketplaceGrid.innerHTML = "";
        if (!currentTemplates.length) {
          var empty = document.createElement("div");
          empty.className = "card-caption";
          empty.textContent = currentLang === "ar" ? "Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ·Ø¨ÙŠÙ‚Ø§Øª ÙÙŠ Ø§Ù„Ù…ØªØ¬Ø±." : "No apps available in marketplace.";
          marketplaceGrid.appendChild(empty);
          return;
        }

        currentTemplates.forEach(function (tpl) {
          var card = document.createElement("article");
          card.className = "app-card";

          var header = document.createElement("div");
          header.className = "app-card-header";

          var main = document.createElement("div");
          main.className = "app-card-main";

          var icon = document.createElement("div");
          icon.className = "app-card-icon";
          icon.textContent = "âœ´";

          var titleWrap = document.createElement("div");
          var title = document.createElement("div");
          title.className = "app-card-title";
          title.textContent = (currentLang === "ar" ? (tpl.nameAr || tpl.templateId) : (tpl.nameEn || tpl.templateId));

          var tagLine = document.createElement("div");
          tagLine.className = "app-card-tagline";
          tagLine.textContent = tpl.category || "";

          titleWrap.appendChild(title);
          titleWrap.appendChild(tagLine);

          main.appendChild(icon);
          main.appendChild(titleWrap);

          var statusSpan = document.createElement("span");
          statusSpan.className = "badge-soft";
          statusSpan.textContent = tpl.planRequired || "free";

          header.appendChild(main);
          header.appendChild(statusSpan);

          var body = document.createElement("div");
          body.className = "app-card-body";
          body.textContent = (currentLang === "ar" ? (tpl.shortDescAr || "") : (tpl.shortDescEn || ""));

          var footer = document.createElement("div");
          footer.className = "app-card-footer";

          var tags = document.createElement("span");
          tags.textContent = tpl.featureTags || "";

          var actions = document.createElement("div");
          actions.className = "app-card-actions";

          var installBtn = document.createElement("button");
          installBtn.type = "button";
          installBtn.className = "btn-pill-sm primary";
          var isInstalled = !!tpl.installed;
          installBtn.textContent = isInstalled ? (currentLang === "ar" ? "Ù…Ø«Ø¨Ù‘Øª" : "Installed") : (currentLang === "ar" ? "ØªØ«Ø¨ÙŠØª" : "Install");
          if (isInstalled) installBtn.disabled = true;

          installBtn.addEventListener("click", function (e) {
            e.stopPropagation();
            if (isInstalled) return;
            installTemplate(tpl);
          });

          actions.appendChild(installBtn);
          footer.appendChild(tags);
          footer.appendChild(actions);

          card.appendChild(header);
          card.appendChild(body);
          card.appendChild(footer);

          marketplaceGrid.appendChild(card);
        });
      }

      function installTemplate(tpl) {
        if (!currentWorkspaceId || !currentUser) return;
        setStatus("statusLoadingMarketplace");

        postJson({
          action: "marketplace.install",
          workspaceId: currentWorkspaceId,
          templateId: tpl.templateId,
          userId: currentUser.userId
        })
        .then(function (res) {
          if (!res || !res.success) {
            setStatus((res && res.error) || "Install failed", "error");
            return;
          }
          loadWorkspaceData();
        })
        .catch(function () { setStatus("statusError", "error"); });
      }

      function openWorkspaceApp(app) {
        if (!app || !app.defaultRoute) {
          setStatus(currentLang === "ar" ? "Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ØºÙŠØ± Ù…Ù‡ÙŠØ£." : "App URL is not configured yet.", "error");
          setMainView("apps");
          return;
        }

        if (!currentWorkspaceId) {
          setStatus(currentLang === "ar" ? "Ø§Ø®ØªØ± Ù…Ø³Ø§Ø­Ø© Ø¹Ù…Ù„ Ø£ÙˆÙ„Ø§Ù‹." : "Please select a workspace first.", "error");
          return;
        }

        appViewTitle.textContent = app.name || app.templateId;
        appFramePlaceholder.classList.add("hidden");
        appFrame.classList.remove("hidden");

        var route = app.defaultRoute;
        var join = route.indexOf("?") >= 0 ? "&" : "?";

        // âœ… Pass workspaceId + sessionKey (helps apps that need auth)
        appFrame.src =
          route +
          join +
          "workspaceId=" + encodeURIComponent(currentWorkspaceId) +
          "&sessionKey=" + encodeURIComponent(currentSessionKey || "");

        setMainView("app");
      }

      function tryResumeSession() {
        if (!currentSessionKey) {
          showStep("mobile");
          return;
        }

        setStatus(currentLang === "ar" ? "Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø©..." : "Restoring session...");
        postJson({ action: "auth.me", sessionKey: currentSessionKey })
          .then(function (res) {
            if (!res || !res.success || !res.user) {
              localStorage.removeItem(STORAGE_SESSION_KEY);
              currentSessionKey = null;
              showStep("mobile");
              setStatus("statusIdle");
              return;
            }

            currentUser = res.user;
            if (welcomeCard) welcomeCard.classList.add("hidden");
            updateUserUi();

            showStep("apps");
            return loadWorkspaces().then(function () {
              setStatus("statusIdle");
            });
          })
          .catch(function () {
            showStep("mobile");
            setStatus("statusIdle");
          });
      }

      // Events
      btnSendOtp.addEventListener("click", sendOtp);
      mobileInput.addEventListener("keydown", function (e) {
        if (e.key === "Enter") { e.preventDefault(); sendOtp(); }
      });
      btnVerifyOtp.addEventListener("click", verifyOtp);
      btnChangeMobile.addEventListener("click", function () {
        showStep("mobile");
        setStatus("statusIdle");
      });

      btnLogout.addEventListener("click", logout);

      btnTheme.addEventListener("click", function () {
        currentTheme = currentTheme === "light" ? "dark" : "light";
        localStorage.setItem(STORAGE_THEME, currentTheme);
        applyTheme();
      });

      btnLangAr.addEventListener("click", function () {
        currentLang = "ar";
        localStorage.setItem(STORAGE_LANG, currentLang);
        applyLanguage();
        if (currentWorkspaceId) { renderApps(); renderMarketplace(); }
      });

      btnLangEn.addEventListener("click", function () {
        currentLang = "en";
        localStorage.setItem(STORAGE_LANG, currentLang);
        applyLanguage();
        if (currentWorkspaceId) { renderApps(); renderMarketplace(); }
      });

      btnViewApps.addEventListener("click", function () { setMainView("apps"); });
      btnViewMarketplace.addEventListener("click", function () { setMainView("marketplace"); });
      btnBackFromApp.addEventListener("click", function () { setMainView("apps"); });

      workspaceCard.addEventListener("click", function (e) {
        e.stopPropagation();
        workspaceMenu.classList.toggle("hidden");
      });

      document.addEventListener("click", function () { workspaceMenu.classList.add("hidden"); });
      workspaceMenu.addEventListener("click", function (e) { e.stopPropagation(); });

      // Init
      applyTheme();
      applyLanguage();
      setStatus("statusIdle");
      tryResumeSession();
    })();
  </script>
</body>
</html>
