<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <title>NahlHub</title>

  <!-- Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap"
    rel="stylesheet"
  />

  <style>
    :root {
      --bg-light: #f5f7f8;
      --bg-dark: #020617;
      --card-light: #ffffff;
      --card-dark: #020617;
      --border-light: rgba(15, 23, 42, 0.08);
      --border-dark: rgba(148, 163, 184, 0.25);
      --accent: #f4ce14;
      --accent-soft: rgba(244, 206, 20, 0.16);
      --text-light: #0f172a;
      --text-dark: #e5e7eb;
      --muted-light: #6b7280;
      --muted-dark: #9ca3af;
      --danger: #ef4444;
      --surface-radius: 18px;
      --transition-fast: 0.18s ease-out;
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: "Cairo", system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", sans-serif;
    }

    body[data-theme="light"] {
      background: radial-gradient(
          circle at top left,
          rgba(244, 206, 20, 0.18),
          transparent 55%
        ),
        var(--bg-light);
      color: var(--text-light);
    }

    body[data-theme="dark"] {
      background: radial-gradient(
          circle at top left,
          rgba(250, 204, 21, 0.14),
          transparent 50%
        ),
        linear-gradient(145deg, #020617, #020617);
      color: var(--text-dark);
    }

    .app-shell {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 6px;
      gap: 8px;
      position: relative;
    }

    /* Topbar */

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid;
      backdrop-filter: blur(14px);
      gap: 12px;
      position: relative;
      z-index: 10;
    }

    body[data-theme="light"] .topbar {
      background: rgba(255, 255, 255, 0.72);
      border-color: var(--border-light);
    }

    body[data-theme="dark"] .topbar {
      background: rgba(15, 23, 42, 0.8);
      border-color: var(--border-dark);
    }

    .topbar-left {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
    }

    .brand-logo {
      width: 30px;
      height: 30px;
      border-radius: 11px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 18px;
      background: radial-gradient(circle at 20% 0, #facc15, #f97316);
      color: #111827;
    }

    .brand-text {
      display: flex;
      flex-direction: column;
      gap: 0;
      font-size: 13px;
      line-height: 1.2;
    }

    .brand-title {
      font-weight: 700;
      letter-spacing: 0.02em;
      white-space: nowrap;
    }

    .brand-subtitle {
      font-size: 11px;
      opacity: 0.75;
    }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .chip-group {
      display: inline-flex;
      padding: 2px;
      border-radius: 999px;
      border: 1px solid transparent;
      background: transparent;
      gap: 2px;
    }

    body[data-theme="light"] .chip-group {
      border-color: rgba(148, 163, 184, 0.42);
      background: rgba(255, 255, 255, 0.9);
    }

    body[data-theme="dark"] .chip-group {
      border-color: rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.95);
    }

    .chip-btn {
      border: none;
      outline: none;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
      cursor: pointer;
      background: transparent;
      color: inherit;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: background var(--transition-fast),
        color var(--transition-fast), transform var(--transition-fast),
        box-shadow var(--transition-fast);
      white-space: nowrap;
    }

    .chip-btn span.icon {
      font-size: 13px;
      line-height: 1;
    }

    .chip-btn.active {
      background: var(--accent);
      color: #111827;
      box-shadow: 0 6px 18px rgba(250, 204, 21, 0.4);
      transform: translateY(-0.5px);
    }

    .chip-btn:not(.active):hover {
      background: rgba(148, 163, 184, 0.25);
    }

    body[data-theme="dark"] .chip-btn:not(.active):hover {
      background: rgba(31, 41, 55, 0.8);
    }

    .chip-btn-mini {
      border-radius: 999px;
      padding: 5px 7px;
      font-size: 11px;
    }

    /* Status pill */

    .status-pill {
      align-self: stretch;
      margin: 0 4px;
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: 1px solid transparent;
      max-width: 100%;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }

    body[data-theme="light"] .status-pill {
      background: rgba(255, 255, 255, 0.9);
      border-color: var(--border-light);
      color: var(--muted-light);
    }

    body[data-theme="dark"] .status-pill {
      background: rgba(15, 23, 42, 0.9);
      border-color: var(--border-dark);
      color: var(--muted-dark);
    }

    .status-pill.ok {
      border-color: rgba(34, 197, 94, 0.7);
      color: rgba(34, 197, 94, 0.95);
    }

    .status-pill.error {
      border-color: rgba(239, 68, 68, 0.85);
      color: rgba(248, 113, 113, 0.96);
    }

    .status-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--accent);
    }

    /* Main content */

    .main-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 0;
    }

    .welcome-card {
      border-radius: var(--surface-radius);
      padding: 12px 14px;
      border: 1px solid;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    body[data-theme="light"] .welcome-card {
      background: linear-gradient(
        135deg,
        rgba(244, 206, 20, 0.12),
        rgba(255, 255, 255, 0.96)
      );
      border-color: var(--border-light);
    }

    body[data-theme="dark"] .welcome-card {
      background: linear-gradient(
        145deg,
        rgba(250, 204, 21, 0.16),
        rgba(15, 23, 42, 0.96)
      );
      border-color: rgba(148, 163, 184, 0.45);
    }

    .welcome-header-line {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .welcome-title {
      font-size: 16px;
      font-weight: 700;
    }

    .welcome-sub {
      font-size: 12px;
      opacity: 0.85;
    }

    /* Generic card */

    .card {
      border-radius: var(--surface-radius);
      padding: 12px 14px 14px;
      border: 1px solid;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    body[data-theme="light"] .card {
      background: #ffffff;
      border-color: var(--border-light);
    }

    body[data-theme="dark"] .card {
      background: rgba(15, 23, 42, 0.96);
      border-color: var(--border-dark);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .card-title {
      font-size: 15px;
      font-weight: 600;
    }

    .card-caption {
      font-size: 12px;
      opacity: 0.7;
    }

    .card-body {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .field-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .field-label {
      font-size: 12px;
      opacity: 0.85;
    }

    .field-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .input {
      flex: 1;
      border-radius: 999px;
      border: 1px solid;
      padding: 8px 12px;
      font-size: 13px;
      outline: none;
      transition: border-color var(--transition-fast),
        box-shadow var(--transition-fast), background var(--transition-fast);
    }

    body[data-theme="light"] .input {
      background: rgba(248, 250, 252, 0.95);
      border-color: rgba(148, 163, 184, 0.5);
      color: var(--text-light);
    }

    body[data-theme="dark"] .input {
      background: rgba(15, 23, 42, 0.96);
      border-color: rgba(148, 163, 184, 0.6);
      color: var(--text-dark);
    }

    .input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(250, 204, 21, 0.55);
      background: rgba(255, 251, 235, 0.9);
    }

    body[data-theme="dark"] .input:focus {
      background: rgba(15, 23, 42, 0.98);
    }

    .btn {
      border-radius: 999px;
      border: none;
      outline: none;
      padding: 9px 18px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: transform var(--transition-fast),
        box-shadow var(--transition-fast), background var(--transition-fast),
        color var(--transition-fast), opacity var(--transition-fast);
      white-space: nowrap;
    }

    .btn-primary {
      background: var(--accent);
      color: #111827;
      box-shadow: 0 8px 20px rgba(250, 204, 21, 0.45);
    }

    .btn-primary:hover:enabled {
      transform: translateY(-0.5px);
      box-shadow: 0 10px 28px rgba(250, 204, 21, 0.6);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: default;
      box-shadow: none;
      transform: none;
    }

    .btn-ghost {
      background: transparent;
      color: inherit;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 11px;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    body[data-theme="light"] .btn-ghost:hover {
      background: rgba(148, 163, 184, 0.18);
    }

    body[data-theme="dark"] .btn-ghost:hover {
      background: rgba(31, 41, 55, 0.9);
    }

    /* OTP row: left to right */

    .otp-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      direction: ltr;
    }

    .otp-input {
      width: 44px;
      height: 44px;
      text-align: center;
      font-size: 18px;
      font-weight: 600;
      border-radius: 16px;
      border: 1px solid;
      outline: none;
      transition: border-color var(--transition-fast),
        box-shadow var(--transition-fast), background var(--transition-fast);
    }

    body[data-theme="light"] .otp-input {
      background: rgba(248, 250, 252, 0.96);
      border-color: rgba(148, 163, 184, 0.5);
      color: var(--text-light);
    }

    body[data-theme="dark"] .otp-input {
      background: rgba(15, 23, 42, 0.97);
      border-color: rgba(148, 163, 184, 0.7);
      color: var(--text-dark);
    }

    .otp-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(250, 204, 21, 0.55);
      background: rgba(255, 251, 235, 0.96);
    }

    body[data-theme="dark"] .otp-input:focus {
      background: rgba(15, 23, 42, 1);
    }

    /* Hub layout */

    .hub-layout {
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 0;
    }

    .ws-and-tabs {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    @media (min-width: 720px) {
      .ws-and-tabs {
        flex-direction: row;
        align-items: flex-end;
        justify-content: space-between;
        gap: 16px;
      }
    }

    .ws-selector {
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-width: 0;
    }

    .ws-select-wrap {
      position: relative;
    }

    .ws-select {
      width: 100%;
      border-radius: 999px;
      border: 1px solid;
      padding: 8px 32px 8px 12px;
      font-size: 13px;
      appearance: none;
      outline: none;
      background: transparent;
      cursor: pointer;
    }

    body[data-theme="light"] .ws-select {
      background: rgba(248, 250, 252, 0.9);
      border-color: rgba(148, 163, 184, 0.5);
      color: var(--text-light);
    }

    body[data-theme="dark"] .ws-select {
      background: rgba(15, 23, 42, 0.96);
      border-color: rgba(148, 163, 184, 0.6);
      color: var(--text-dark);
    }

    .ws-select-icon {
      position: absolute;
      inset-inline-start: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 12px;
      pointer-events: none;
      opacity: 0.6;
    }

    .hub-nav {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px;
      border-radius: 999px;
      border: 1px solid transparent;
    }

    body[data-theme="light"] .hub-nav {
      background: rgba(248, 250, 252, 0.95);
      border-color: rgba(148, 163, 184, 0.4);
    }

    body[data-theme="dark"] .hub-nav {
      background: rgba(15, 23, 42, 0.96);
      border-color: rgba(148, 163, 184, 0.6);
    }

    .hub-nav-btn {
      font-size: 11px;
      padding: 5px 12px;
    }

    .hub-nav-btn.active {
      background: var(--accent);
      color: #111827;
      box-shadow: 0 6px 16px rgba(250, 204, 21, 0.45);
    }

    /* Apps grid */

    .apps-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
    }

    .app-card {
      border-radius: 16px;
      border: 1px solid;
      padding: 10px 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      cursor: pointer;
      position: relative;
      transition: background var(--transition-fast),
        border-color var(--transition-fast), transform var(--transition-fast),
        box-shadow var(--transition-fast);
    }

    body[data-theme="light"] .app-card {
      background: rgba(255, 255, 255, 0.96);
      border-color: rgba(148, 163, 184, 0.35);
    }

    body[data-theme="dark"] .app-card {
      background: rgba(15, 23, 42, 0.96);
      border-color: rgba(148, 163, 184, 0.55);
    }

    .app-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 26px rgba(15, 23, 42, 0.18);
      border-color: rgba(250, 204, 21, 0.9);
    }

    .app-card-header {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .app-card-icon {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      background: rgba(244, 206, 20, 0.15);
      color: #92400e;
    }

    body[data-theme="dark"] .app-card-icon {
      background: rgba(250, 204, 21, 0.14);
      color: #facc15;
    }

    .app-card-title {
      font-size: 13px;
      font-weight: 600;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .app-card-body {
      font-size: 11px;
      opacity: 0.78;
      height: 2.4em;
      overflow: hidden;
    }

    .app-card-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 11px;
      opacity: 0.75;
      margin-top: 2px;
    }

    .badge-pinned {
      border-radius: 999px;
      padding: 2px 6px;
      font-size: 10px;
      background: rgba(250, 204, 21, 0.16);
      color: #92400e;
    }

    body[data-theme="dark"] .badge-pinned {
      background: rgba(250, 204, 21, 0.22);
      color: #facc15;
    }

    .badge-soft {
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 10px;
      background: rgba(148, 163, 184, 0.18);
      opacity: 0.85;
    }

    .empty-state {
      font-size: 12px;
      opacity: 0.75;
      padding: 6px 4px;
    }

    /* Marketplace list */

    .marketplace-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .mp-item {
      border-radius: 14px;
      border: 1px solid;
      padding: 8px 10px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    body[data-theme="light"] .mp-item {
      background: rgba(255, 255, 255, 0.96);
      border-color: rgba(148, 163, 184, 0.3);
    }

    body[data-theme="dark"] .mp-item {
      background: rgba(15, 23, 42, 0.96);
      border-color: rgba(148, 163, 184, 0.5);
    }

    .mp-item-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .mp-item-title {
      font-size: 13px;
      font-weight: 600;
    }

    .mp-item-sub {
      font-size: 11px;
      opacity: 0.75;
    }

    .mp-item-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-top: 4px;
    }

    .mp-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    /* Gift Engine stub */

    .gift-body {
      font-size: 12px;
      opacity: 0.8;
      line-height: 1.6;
    }

    .hidden {
      display: none !important;
    }

    /* Auth overlay */

    .auth-overlay {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 12px;
      z-index: 30;
      backdrop-filter: blur(10px);
    }

    body[data-theme="light"] .auth-overlay {
      background: radial-gradient(
          circle at top,
          rgba(148, 163, 184, 0.16),
          transparent 60%
        ),
        rgba(15, 23, 42, 0.18);
    }

    body[data-theme="dark"] .auth-overlay {
      background: radial-gradient(
          circle at top,
          rgba(15, 23, 42, 0.95),
          rgba(15, 23, 42, 0.98)
        );
    }

    .auth-modal {
      width: 100%;
      max-width: 420px;
      border-radius: 22px;
      border: 1px solid;
      padding: 14px 12px 12px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.55);
    }

    body[data-theme="light"] .auth-modal {
      background: linear-gradient(
        140deg,
        rgba(244, 206, 20, 0.12),
        #ffffff
      );
      border-color: rgba(148, 163, 184, 0.5);
    }

    body[data-theme="dark"] .auth-modal {
      background: radial-gradient(
          circle at top left,
          rgba(250, 204, 21, 0.18),
          transparent 50%
        ),
        rgba(15, 23, 42, 0.98);
      border-color: rgba(148, 163, 184, 0.6);
    }

    .auth-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 2px 4px 10px;
    }

    .auth-title {
      font-size: 15px;
      font-weight: 700;
    }

    .auth-sub {
      font-size: 12px;
      opacity: 0.78;
    }

    .auth-badge {
      font-size: 11px;
      border-radius: 999px;
      padding: 3px 8px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      opacity: 0.9;
    }

    .auth-modal-body {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    @media (min-width: 768px) {
      .app-shell {
        padding: 6px 10px;
      }
      .main-panel {
        max-width: 100%;
        width: 100%;
        margin: 0;
      }
    }
  </style>
</head>
<body data-theme="light">
  <div class="app-shell">
    <!-- Top bar -->
    <header class="topbar">
      <div class="topbar-left">
        <div class="brand-logo">N</div>
        <div class="brand-text">
          <div class="brand-title" data-i18n="hubTitle">NahlHub</div>
          <div class="brand-subtitle" data-i18n="hubSub">
            ØªØ·Ø¨ÙŠÙ‚Ø§ØªÙƒ ÙÙŠ Ù†Ø­Ù„ Ù‡Ø¨
          </div>
        </div>
      </div>
      <div class="topbar-right">
        <div class="chip-group">
          <button
            class="chip-btn"
            id="btnLangAr"
            type="button"
            data-lang="ar"
          >
            <span>Ø¹Ø±Ø¨ÙŠ</span>
          </button>
          <button
            class="chip-btn"
            id="btnLangEn"
            type="button"
            data-lang="en"
          >
            <span>EN</span>
          </button>
        </div>
        <button
          class="chip-btn chip-btn-mini"
          id="btnTheme"
          type="button"
        >
          <span class="icon" id="themeIcon">ğŸŒ</span>
        </button>
      </div>
    </header>

    <!-- Status -->
    <div id="statusPill" class="status-pill">
      <span class="status-dot"></span>
      <span id="statusText"></span>
    </div>

    <!-- AUTH POPUP -->
    <div id="authOverlay" class="auth-overlay">
      <div class="auth-modal">
        <div class="auth-modal-header">
          <div>
            <div class="auth-title" data-i18n="welcomeTitle">Ù…Ø±Ø­Ø¨Ø§Ù‹ ğŸ‘‹</div>
            <div class="auth-sub" data-i18n="welcomeSub">
              Ø§Ø¯Ø®Ù„ Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø«Ù… Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„.
            </div>
          </div>
          <div class="auth-badge">
            <span data-i18n="step1Title">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</span> Â·
            <span data-i18n="step2Title">Ø±Ù…Ø²</span>
          </div>
        </div>
        <div class="auth-modal-body">
          <!-- Step 1: Mobile -->
          <section id="stepMobile" class="card" style="margin:0">
            <div class="card-header">
              <div>
                <div class="card-title" data-i18n="step1Title">
                  Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„
                </div>
                <div class="card-caption" data-i18n="step1Sub">
                  Ø§Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„.
                </div>
              </div>
            </div>
            <div class="card-body">
              <div class="field-group">
                <label
                  class="field-label"
                  for="mobileInput"
                  data-i18n="step1Label"
                >
                  Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„
                </label>
                <div class="field-row">
                  <input
                    id="mobileInput"
                    class="input"
                    type="tel"
                    inputmode="tel"
                    autocomplete="tel"
                    placeholder="5XXXXXXXX"
                  />
                </div>
              </div>
              <div class="field-row" style="justify-content:flex-end">
                <button
                  id="btnSendOtp"
                  class="btn btn-primary"
                  type="button"
                >
                  <span data-i18n="btnSendOtp">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²</span>
                </button>
              </div>
            </div>
          </section>

          <!-- Step 2: OTP -->
          <section id="stepOtp" class="card hidden" style="margin:0">
            <div class="card-header">
              <div>
                <div class="card-title" data-i18n="step2Title">
                  Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„
                </div>
                <div class="card-caption" data-i18n="step2Sub">
                  Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ù¤ Ø£Ø±Ù‚Ø§Ù….
                </div>
              </div>
              <button
                type="button"
                class="btn-ghost"
                id="btnChangeMobile"
              >
                <span data-i18n="changeMobile">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ù‚Ù…</span>
              </button>
            </div>
            <div class="card-body">
              <div class="otp-row">
                <input
                  class="otp-input"
                  id="otp1"
                  type="tel"
                  inputmode="numeric"
                  maxlength="1"
                />
                <input
                  class="otp-input"
                  id="otp2"
                  type="tel"
                  inputmode="numeric"
                  maxlength="1"
                />
                <input
                  class="otp-input"
                  id="otp3"
                  type="tel"
                  inputmode="numeric"
                  maxlength="1"
                />
                <input
                  class="otp-input"
                  id="otp4"
                  type="tel"
                  inputmode="numeric"
                  maxlength="1"
                />
              </div>
              <div
                class="field-row"
                style="justify-content:flex-end;margin-top:10px"
              >
                <button
                  id="btnVerifyOtp"
                  class="btn btn-primary"
                  type="button"
                >
                  <span data-i18n="btnVerify">ØªØ£ÙƒÙŠØ¯</span>
                </button>
              </div>
            </div>
          </section>
        </div>
      </div>
    </div>

    <!-- Main -->
    <main class="main-panel">
      <!-- Welcome (optional banner) -->
      <section class="welcome-card" id="welcomeCard">
        <div class="welcome-header-line">
          <div>
            <div class="welcome-title" data-i18n="welcomeTitle">Ù…Ø±Ø­Ø¨Ø§Ù‹ ğŸ‘‹</div>
            <div class="welcome-sub" data-i18n="welcomeSub">
              Ø§Ø¯Ø®Ù„ Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø«Ù… Ø§Ø®ØªØ± Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„ ÙˆØ§Ù„ØªØ·Ø¨ÙŠÙ‚.
            </div>
          </div>
        </div>
      </section>

      <!-- Hub section (after login) -->
      <section id="hubSection" class="hub-layout hidden">
        <!-- Header: user info + workspace + nav -->
        <div class="card" id="hubHeaderCard">
          <div class="card-header">
            <div>
              <div class="card-title" data-i18n="hubMainTitle">
                Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… NahlHub
              </div>
              <div class="card-caption" id="hubUserLabel"></div>
            </div>
            <button
              class="btn-ghost"
              type="button"
              id="btnLogout"
            >
              <span data-i18n="logout">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</span>
            </button>
          </div>
          <div class="card-body">
            <div class="ws-and-tabs">
              <div class="ws-selector">
                <label
                  class="field-label"
                  for="workspaceSelect"
                  data-i18n="workspaceLabel"
                >
                  Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„
                </label>
                <div class="ws-select-wrap">
                  <select
                    id="workspaceSelect"
                    class="ws-select"
                  ></select>
                  <span class="ws-select-icon">â–¾</span>
                </div>
                <div
                  id="workspaceHint"
                  class="card-caption"
                  style="font-size:11px;opacity:0.7;"
                ></div>
              </div>
              <div class="hub-nav">
                <button
                  type="button"
                  class="chip-btn hub-nav-btn active"
                  data-view="apps"
                  id="btnViewApps"
                >
                  <span data-i18n="navYourApps">ØªØ·Ø¨ÙŠÙ‚Ø§ØªÙƒ</span>
                </button>
                <button
                  type="button"
                  class="chip-btn hub-nav-btn"
                  data-view="marketplace"
                  id="btnViewMarketplace"
                >
                  <span data-i18n="navMarketplace">Ù…ØªØ¬Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª</span>
                </button>
                <button
                  type="button"
                  class="chip-btn hub-nav-btn"
                  data-view="gift"
                  id="btnViewGift"
                >
                  <span data-i18n="navGiftEngine">Ù…Ø­Ø±Ùƒ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§</span>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Your Apps -->
        <section id="viewApps" class="card">
          <div class="card-header">
            <div>
              <div class="card-title" data-i18n="appsTitle">
                ØªØ·Ø¨ÙŠÙ‚Ø§ØªÙƒ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø³Ø§Ø­Ø©
              </div>
              <div class="card-caption" data-i18n="appsSub">
                Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ù…Ø«Ø¨ØªØ© Ø¹Ù„Ù‰ Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠØ©.
              </div>
            </div>
          </div>
          <div class="card-body">
            <div id="appsEmpty" class="empty-state hidden">
              <span data-i18n="appsEmpty">
                Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ù…Ø«Ø¨ØªØ© Ø¹Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.
              </span>
            </div>
            <div id="appsGrid" class="apps-grid"></div>
          </div>
        </section>

        <!-- Marketplace -->
        <section id="viewMarketplace" class="card hidden">
          <div class="card-header">
            <div>
              <div class="card-title" data-i18n="mpTitle">
                Ù…ØªØ¬Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª
              </div>
              <div class="card-caption" data-i18n="mpSub">
                Ø«Ø¨Ù‘Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø£Ùˆ Ø§Ù„Ø­Ø²Ù… (Modules) Ø¹Ù„Ù‰ Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠØ©.
              </div>
            </div>
          </div>
          <div class="card-body">
            <div id="mpEmpty" class="empty-state hidden">
              <span data-i18n="mpEmpty">
                Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± ÙÙŠ Ø§Ù„Ù…ØªØ¬Ø± Ø­Ø§Ù„ÙŠØ§Ù‹.
              </span>
            </div>
            <div id="mpList" class="marketplace-list"></div>
          </div>
        </section>

        <!-- Gift Engine -->
        <section id="viewGift" class="card hidden">
          <div class="card-header">
            <div>
              <div class="card-title" data-i18n="giftTitle">
                Ù…Ø­Ø±Ùƒ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ (Coming Soon)
              </div>
              <div class="card-caption" data-i18n="giftSub">
                Ø£Ø±Ø³Ù„ Ø­Ø²Ù… ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø£Ùˆ Ù…Ø²Ø§ÙŠØ§ ÙƒÙ‡Ø¯ÙŠØ© Ù„Ù…Ø³Ø§Ø­Ø§Øª Ø¹Ù…Ù„ Ø£Ø®Ø±Ù‰.
              </div>
            </div>
          </div>
          <div class="card-body gift-body">
            <p data-i18n="giftBody1">
              Ù‚Ø±ÙŠØ¨Ø§Ù‹ Ø³ØªØªÙ…ÙƒÙ† Ù…Ù† Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø§Ù‚Ø§Øª Ø¬Ø§Ù‡Ø²Ø© (Gift Bundles) ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰
              ØªØ·Ø¨ÙŠÙ‚Ø§Øª ÙˆØ­Ø²Ù… ÙŠÙ…ÙƒÙ† Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ù„Ù…Ø³Ø§Ø­Ø§Øª Ø¹Ù…Ù„ Ø£Ø®Ø±Ù‰.
            </p>
            <p data-i18n="giftBody2">
              Ø³ÙŠÙ…ÙƒÙ†Ùƒ Ø£ÙŠØ¶Ø§Ù‹ ØªØªØ¨Ø¹ Ø£ÙŠ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ ØªÙ… ØªÙØ¹ÙŠÙ„Ù‡Ø§ØŒ ÙˆÙ…Ù† Ù‚Ø§Ù… Ø¨ØªØ«Ø¨ÙŠØªÙ‡Ø§.
            </p>
          </div>
        </section>
      </section>
    </main>
  </div>

  <script>
    (function () {
      "use strict";

      var API_URL = "/api/hub/manage";
      var STORAGE_SESSION_KEY = "nahlhub_session_key";
      var STORAGE_LANG = "nahlhub_lang";
      var STORAGE_THEME = "nahlhub_theme";

      var currentLang = localStorage.getItem(STORAGE_LANG) || "ar";
      var currentTheme = localStorage.getItem(STORAGE_THEME) || "light";
      var currentSessionKey =
        localStorage.getItem(STORAGE_SESSION_KEY) || null;

      var currentUser = null;
      var allWorkspaces = [];
      var workspaceApps = [];
      var marketplaceItems = [];
      var currentWorkspaceId = null;

      var bodyEl = document.body;
      var statusPill = document.getElementById("statusPill");
      var statusText = document.getElementById("statusText");

      var welcomeCard = document.getElementById("welcomeCard");

      var authOverlay = document.getElementById("authOverlay");
      var stepMobile = document.getElementById("stepMobile");
      var stepOtp = document.getElementById("stepOtp");

      var mobileInput = document.getElementById("mobileInput");
      var btnSendOtp = document.getElementById("btnSendOtp");
      var btnVerifyOtp = document.getElementById("btnVerifyOtp");
      var btnChangeMobile = document.getElementById("btnChangeMobile");

      var otpInputs = [
        document.getElementById("otp1"),
        document.getElementById("otp2"),
        document.getElementById("otp3"),
        document.getElementById("otp4")
      ];

      var hubSection = document.getElementById("hubSection");
      var hubUserLabel = document.getElementById("hubUserLabel");
      var btnLogout = document.getElementById("btnLogout");

      var btnTheme = document.getElementById("btnTheme");
      var themeIcon = document.getElementById("themeIcon");
      var btnLangAr = document.getElementById("btnLangAr");
      var btnLangEn = document.getElementById("btnLangEn");

      var workspaceSelect = document.getElementById("workspaceSelect");
      var workspaceHint = document.getElementById("workspaceHint");

      var btnViewApps = document.getElementById("btnViewApps");
      var btnViewMarketplace = document.getElementById("btnViewMarketplace");
      var btnViewGift = document.getElementById("btnViewGift");

      var viewApps = document.getElementById("viewApps");
      var viewMarketplace = document.getElementById("viewMarketplace");
      var viewGift = document.getElementById("viewGift");

      var appsGrid = document.getElementById("appsGrid");
      var appsEmpty = document.getElementById("appsEmpty");

      var mpList = document.getElementById("mpList");
      var mpEmpty = document.getElementById("mpEmpty");

      var currentMobileRaw = "";

      var tDict = {
        hubTitle: { ar: "NahlHub", en: "NahlHub" },
        hubSub: {
          ar: "ØªØ·Ø¨ÙŠÙ‚Ø§ØªÙƒ ÙÙŠ Ù†Ø­Ù„ Ù‡Ø¨",
          en: "Your apps in NahlHub"
        },
        welcomeTitle: { ar: "Ù…Ø±Ø­Ø¨Ø§Ù‹ ğŸ‘‹", en: "Welcome ğŸ‘‹" },
        welcomeSub: {
          ar: "Ø§Ø¯Ø®Ù„ Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø«Ù… Ø§Ø®ØªØ± Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„ ÙˆØ§Ù„ØªØ·Ø¨ÙŠÙ‚.",
          en: "Enter your mobile, then choose workspace and app."
        },
        step1Title: { ar: "Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„", en: "Mobile number" },
        step1Sub: { ar: "Ø§Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„.", en: "Enter your mobile." },
        step1Label: { ar: "Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„", en: "Mobile" },
        btnSendOtp: { ar: "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²", en: "Send code" },
        step2Title: { ar: "Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„", en: "Login code" },
        step2Sub: {
          ar: "Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ù¤ Ø£Ø±Ù‚Ø§Ù….",
          en: "Enter the 4-digit code."
        },
        changeMobile: { ar: "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ù‚Ù…", en: "Change number" },
        btnVerify: { ar: "ØªØ£ÙƒÙŠØ¯", en: "Confirm" },
        logout: { ar: "ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬", en: "Logout" },

        statusIdle: { ar: "Ø¬Ø§Ù‡Ø².", en: "Ready." },
        statusSendingOtp: {
          ar: "ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²...",
          en: "Sending code..."
        },
        statusOtpSent: {
          ar: "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø² Ø¥Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨.",
          en: "Code sent to WhatsApp."
        },
        statusVerifying: { ar: "ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚...", en: "Verifying..." },
        statusError: {
          ar: "Ø­Ø¯Ø« Ø®Ø·Ø£. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.",
          en: "Something went wrong. Try again."
        },

        hubMainTitle: { ar: "Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… NahlHub", en: "NahlHub Hub" },
        workspaceLabel: { ar: "Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„", en: "Workspace" },
        workspaceHintNoWs: {
          ar: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³Ø§Ø­Ø§Øª Ø¹Ù…Ù„ Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø­Ø³Ø§Ø¨Ùƒ.",
          en: "No workspaces linked to your account."
        },
        workspaceHintSelect: {
          ar: "Ø§Ø®ØªØ± Ù…Ø³Ø§Ø­Ø© Ø¹Ù…Ù„ Ù„Ø§Ø³ØªØ¹Ø±Ø§Ø¶ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª ÙˆØ§Ù„Ù…ØªØ¬Ø±.",
          en: "Choose a workspace to view apps and marketplace."
        },

        navYourApps: { ar: "ØªØ·Ø¨ÙŠÙ‚Ø§ØªÙƒ", en: "Your Apps" },
        navMarketplace: { ar: "Ù…ØªØ¬Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª", en: "App Marketplace" },
        navGiftEngine: { ar: "Ù…Ø­Ø±Ùƒ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§", en: "Gift Engine" },

        appsTitle: {
          ar: "ØªØ·Ø¨ÙŠÙ‚Ø§ØªÙƒ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø³Ø§Ø­Ø©",
          en: "Your apps in this workspace"
        },
        appsSub: {
          ar: "Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ù…Ø«Ø¨ØªØ© Ø¹Ù„Ù‰ Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠØ©.",
          en: "Apps installed on the current workspace."
        },
        appsEmpty: {
          ar: "Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ù…Ø«Ø¨ØªØ© Ø¹Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.",
          en: "No apps installed on this workspace yet."
        },

        mpTitle: { ar: "Ù…ØªØ¬Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª", en: "App Marketplace" },
        mpSub: {
          ar: "Ø«Ø¨Ù‘Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø£Ùˆ Ø§Ù„Ø­Ø²Ù… (Modules) Ø¹Ù„Ù‰ Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠØ©.",
          en: "Install single apps or modules into this workspace."
        },
        mpEmpty: {
          ar: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± ÙÙŠ Ø§Ù„Ù…ØªØ¬Ø± Ø­Ø§Ù„ÙŠØ§Ù‹.",
          en: "No marketplace items available yet."
        },

        giftTitle: { ar: "Ù…Ø­Ø±Ùƒ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ (Ù‚Ø±ÙŠØ¨Ø§Ù‹)", en: "Gift Engine (Coming Soon)" },
        giftSub: {
          ar: "Ø£Ù†Ø´Ø¦ Ø¨Ø§Ù‚Ø§Øª ØªØ·Ø¨ÙŠÙ‚Ø§Øª ÙƒÙ‡Ø¯Ø§ÙŠØ§ Ù„Ù…Ø³Ø§Ø­Ø§Øª Ø¹Ù…Ù„ Ø£Ø®Ø±Ù‰.",
          en: "Create app bundles as gifts for other workspaces."
        },
        giftBody1: {
          ar: "Ù‚Ø±ÙŠØ¨Ø§Ù‹ Ø³ØªØªÙ…ÙƒÙ† Ù…Ù† Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø§Ù‚Ø§Øª Ø¬Ø§Ù‡Ø²Ø© (Gift Bundles) ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ØªØ·Ø¨ÙŠÙ‚Ø§Øª ÙˆØ­Ø²Ù… ÙŠÙ…ÙƒÙ† Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ù„Ù…Ø³Ø§Ø­Ø§Øª Ø¹Ù…Ù„ Ø£Ø®Ø±Ù‰.",
          en: "Soon youâ€™ll be able to build gift bundles that contain apps/modules, and send them to other workspaces."
        },
        giftBody2: {
          ar: "Ø³ÙŠÙ…ÙƒÙ†Ùƒ Ø£ÙŠØ¶Ø§Ù‹ ØªØªØ¨Ø¹ Ø£ÙŠ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ ØªÙ… ØªÙØ¹ÙŠÙ„Ù‡Ø§ØŒ ÙˆÙ…Ù† Ù‚Ø§Ù… Ø¨ØªØ«Ø¨ÙŠØªÙ‡Ø§.",
          en: "Youâ€™ll also track which gifts were activated, and who installed them."
        },

        mpTypeApp: { ar: "ØªØ·Ø¨ÙŠÙ‚", en: "App" },
        mpTypeModule: { ar: "Ø­Ø²Ù…Ø©", en: "Module" },
        mpInstall: { ar: "ØªØ«Ø¨ÙŠØª", en: "Install" },

        appsOpen: { ar: "ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚", en: "Open app" }
      };

      function t(key) {
        var entry = tDict[key];
        if (!entry) return key;
        return entry[currentLang] || entry.ar || key;
      }

      function applyLanguage() {
        document.documentElement.lang = currentLang;
        document.documentElement.dir = currentLang === "ar" ? "rtl" : "ltr";

        var nodes = document.querySelectorAll("[data-i18n]");
        nodes.forEach(function (node) {
          var key = node.getAttribute("data-i18n");
          node.textContent = t(key);
        });

        if (currentLang === "ar") {
          btnLangAr.classList.add("active");
          btnLangEn.classList.remove("active");
          mobileInput.placeholder = "5XXXXXXXX";
        } else {
          btnLangAr.classList.remove("active");
          btnLangEn.classList.add("active");
          mobileInput.placeholder = "5XXXXXXXX";
        }

        updateUserUi();
        renderWorkspaceHint();
        renderApps();
        renderMarketplace();
      }

      function applyTheme() {
        bodyEl.setAttribute("data-theme", currentTheme);
        themeIcon.textContent = currentTheme === "light" ? "ğŸŒ" : "ğŸŒ™";
      }

      function setStatus(msgKeyOrText, type) {
        if (!msgKeyOrText) {
          statusText.textContent = "";
          statusPill.classList.remove("ok", "error");
          return;
        }
        var text =
          tDict[msgKeyOrText] && tDict[msgKeyOrText][currentLang]
            ? t(msgKeyOrText)
            : msgKeyOrText;
        statusPill.classList.remove("ok", "error");
        if (type === "ok") statusPill.classList.add("ok");
        else if (type === "error") statusPill.classList.add("error");
        statusText.textContent = text;
      }

      function showAuthStep(name) {
        stepMobile.classList.add("hidden");
        stepOtp.classList.add("hidden");

        if (name === "mobile") {
          authOverlay.classList.remove("hidden");
          stepMobile.classList.remove("hidden");
          mobileInput.focus();
        } else if (name === "otp") {
          authOverlay.classList.remove("hidden");
          stepOtp.classList.remove("hidden");
          otpInputs[0].focus();
        }
      }

      function showHub() {
        authOverlay.classList.add("hidden");
        hubSection.classList.remove("hidden");
        if (welcomeCard) welcomeCard.classList.add("hidden");
      }

      function postJson(payload) {
        return fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload || {})
        }).then(function (res) {
          return res
            .json()
            .catch(function () {
              var err = new Error(
                "Invalid JSON from backend. HTTP " + res.status
              );
              err.httpStatus = res.status;
              throw err;
            });
        });
      }

      /* OTP behaviour */

      otpInputs.forEach(function (input, idx) {
        input.addEventListener("input", function (e) {
          var value = e.target.value.replace(/\D/g, "");
          e.target.value = value.slice(0, 1);
          if (value && idx < otpInputs.length - 1) {
            otpInputs[idx + 1].focus();
          }
        });

        input.addEventListener("keydown", function (e) {
          if (e.key === "Backspace" && !e.target.value && idx > 0) {
            otpInputs[idx - 1].focus();
          }
          if (e.key === "ArrowLeft" && idx > 0) {
            otpInputs[idx - 1].focus();
          }
          if (e.key === "ArrowRight" && idx < otpInputs.length - 1) {
            otpInputs[idx + 1].focus();
          }
          if (e.key === "Enter") {
            e.preventDefault();
            verifyOtp();
          }
        });
      });

      function readOtp() {
        return otpInputs
          .map(function (el) {
            return el.value || "";
          })
          .join("");
      }

      function clearOtpInputs() {
        otpInputs.forEach(function (el) {
          el.value = "";
        });
      }

      function sendOtp() {
        var mobile = (mobileInput.value || "").trim();
        if (!mobile) {
          setStatus(
            currentLang === "ar"
              ? "Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„."
              : "Enter your mobile.",
            "error"
          );
          mobileInput.focus();
          return;
        }

        currentMobileRaw = mobile;
        btnSendOtp.disabled = true;
        setStatus("statusSendingOtp", null);

        postJson({
          action: "sendOtp",
          mobile: mobile
        })
          .then(function (res) {
            console.log("sendOtp response", res);
            if (!res || !res.success) {
              var msg =
                (res && res.error) ||
                (currentLang === "ar"
                  ? "ØªØ¹Ø°Ø± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²."
                  : "Failed to send code.");
              setStatus(msg, "error");
              return;
            }
            setStatus("statusOtpSent", "ok");

            // For debugging only: show OTP in console
            if (res.debugOtp) {
              console.log("DEBUG OTP:", res.debugOtp);
            }

            clearOtpInputs();
            showAuthStep("otp");
          })
          .catch(function (err) {
            console.error("sendOtp error", err);
            setStatus("statusError", "error");
          })
          .finally(function () {
            btnSendOtp.disabled = false;
          });
      }

      function verifyOtp() {
        var otp = readOtp();
        if (!otp || otp.length !== 4) {
          setStatus(
            currentLang === "ar"
              ? "Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ù¤ Ø£Ø±Ù‚Ø§Ù…."
              : "Enter the 4-digit code.",
            "error"
          );
          otpInputs[0].focus();
          return;
        }

        btnVerifyOtp.disabled = true;
        setStatus("statusVerifying", null);

        postJson({
          action: "verifyOtp",
          mobile: currentMobileRaw,
          otp: otp
        })
          .then(function (res) {
            console.log("verifyOtp response", res);
            if (!res || !res.success) {
              var msg =
                (res && res.error) ||
                (currentLang === "ar"
                  ? "Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ Ù…Ù†ØªÙ‡ÙŠ."
                  : "Invalid or expired code.");
              setStatus(msg, "error");
              clearOtpInputs();
              otpInputs[0].focus();
              return;
            }

            // Expect sessionKey + possibly user + state
            currentSessionKey = res.sessionKey || null;
            if (currentSessionKey) {
              localStorage.setItem(STORAGE_SESSION_KEY, currentSessionKey);
            }

            // If backend already returned full state, use it
            currentUser = res.user || null;
            allWorkspaces = res.workspaces || res.workspaceList || [];
            workspaceApps = res.workspaceApps || res.apps || [];
            marketplaceItems =
              res.marketplaceItems ||
              res.marketplaceTemplates ||
              res.templates ||
              res.items ||
              [];

            showHub();
            updateUserUi();

            if (!allWorkspaces.length && currentSessionKey) {
              // Try to load state via hub.loadState
              return loadHubState().then(function () {
                setStatus("statusIdle", null);
              });
            } else {
              initWorkspaceSelection();
              renderApps();
              renderMarketplace();
              setStatus("statusIdle", null);
            }
          })
          .catch(function (err) {
            console.error("verifyOtp error", err);
            setStatus("statusError", "error");
          })
          .finally(function () {
            btnVerifyOtp.disabled = false;
          });
      }

      function loadHubState() {
        if (!currentSessionKey) return Promise.resolve();

        return postJson({
          action: "hub.loadState",
          sessionKey: currentSessionKey
        })
          .then(function (res) {
            console.log("hub.loadState response", res);
            if (!res || !res.success) {
              var msg =
                (res && res.error) ||
                (currentLang === "ar"
                  ? "ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª NahlHub."
                  : "Failed to load NahlHub state.");
              setStatus(msg, "error");
              return;
            }

            currentUser = res.user || currentUser;
            allWorkspaces = res.workspaces || res.workspaceList || [];
            workspaceApps = res.workspaceApps || res.apps || [];
            marketplaceItems =
              res.marketplaceItems ||
              res.marketplaceTemplates ||
              res.templates ||
              res.items ||
              [];

            showHub();
            updateUserUi();
            initWorkspaceSelection();
            renderApps();
            renderMarketplace();
          })
          .catch(function (err) {
            console.error("hub.loadState error", err);
            setStatus("statusError", "error");
          });
      }

      function logout() {
        var key = currentSessionKey;
        currentSessionKey = null;
        localStorage.removeItem(STORAGE_SESSION_KEY);
        currentUser = null;
        allWorkspaces = [];
        workspaceApps = [];
        marketplaceItems = [];
        currentWorkspaceId = null;

        hubSection.classList.add("hidden");
        if (welcomeCard) welcomeCard.classList.remove("hidden");

        setStatus("statusIdle", null);
        showAuthStep("mobile");

        if (!key) return;
        // Optional: notify backend that session ended (if action exists)
        postJson({ action: "auth.logout", sessionKey: key }).catch(
          function () {}
        );
      }

      function updateUserUi() {
        if (!currentUser) {
          hubUserLabel.textContent = "";
          return;
        }
        var suffix = currentUser.mobile ? " Â· " + currentUser.mobile : "";
        var greetName =
          currentLang === "ar"
            ? "Ù…Ø±Ø­Ø¨Ø§Ù‹ " + (currentUser.name || "")
            : "Hi " + (currentUser.name || "");
        hubUserLabel.textContent = greetName + suffix;
      }

      function initWorkspaceSelection() {
        workspaceSelect.innerHTML = "";

        if (!allWorkspaces || !allWorkspaces.length) {
          // No workspaces
          var opt = document.createElement("option");
          opt.value = "";
          opt.textContent =
            currentLang === "ar"
              ? "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³Ø§Ø­Ø§Øª Ø¹Ù…Ù„"
              : "No workspaces";
          workspaceSelect.appendChild(opt);
          workspaceSelect.disabled = true;
          currentWorkspaceId = null;
        } else {
          workspaceSelect.disabled = false;
          allWorkspaces.forEach(function (ws, idx) {
            var opt = document.createElement("option");
            opt.value = ws.workspaceId || ws.id || "";
            opt.textContent =
              currentLang === "ar"
                ? ws.name || ws.slug || opt.value
                : ws.name || ws.slug || opt.value;
            workspaceSelect.appendChild(opt);

            if (!currentWorkspaceId && idx === 0) {
              currentWorkspaceId = opt.value;
            }
          });

          if (currentWorkspaceId) {
            workspaceSelect.value = currentWorkspaceId;
          }
        }

        renderWorkspaceHint();
      }

      function renderWorkspaceHint() {
        if (!workspaceHint) return;

        if (!allWorkspaces || !allWorkspaces.length) {
          workspaceHint.textContent = t("workspaceHintNoWs");
        } else {
          workspaceHint.textContent = t("workspaceHintSelect");
        }
      }

      function renderApps() {
        appsGrid.innerHTML = "";

        if (!currentWorkspaceId) {
          appsEmpty.classList.remove("hidden");
          return;
        }

        var filtered = (workspaceApps || []).filter(function (app) {
          var wsId = app.workspaceId || app.workspaceID || app.workspace_id;
          return String(wsId || "") === String(currentWorkspaceId || "");
        });

        if (!filtered.length) {
          appsEmpty.classList.remove("hidden");
          return;
        }

        appsEmpty.classList.add("hidden");

        filtered.forEach(function (app) {
          var card = document.createElement("div");
          card.className = "app-card";

          var header = document.createElement("div");
          header.className = "app-card-header";

          var icon = document.createElement("div");
          icon.className = "app-card-icon";
          icon.textContent = "â‹¯";

          var title = document.createElement("div");
          title.className = "app-card-title";
          title.textContent = app.name || app.appName || app.appId || "";

          header.appendChild(icon);
          header.appendChild(title);

          var body = document.createElement("div");
          body.className = "app-card-body";
          body.textContent =
            app.shortDesc ||
            app.description ||
            (currentLang === "ar"
              ? "ØªØ·Ø¨ÙŠÙ‚ Ù…Ø«Ø¨Øª Ø¯Ø§Ø®Ù„ Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„."
              : "Installed app in this workspace.");

          var footer = document.createElement("div");
          footer.className = "app-card-footer";

          var catSpan = document.createElement("span");
          catSpan.textContent = app.category || "";

          var btn = document.createElement("button");
          btn.type = "button";
          btn.className = "btn-ghost";
          btn.textContent = t("appsOpen");

          btn.addEventListener("click", function (e) {
            e.stopPropagation();
            openApp(app);
          });

          footer.appendChild(catSpan);
          footer.appendChild(btn);

          card.appendChild(header);
          card.appendChild(body);
          card.appendChild(footer);

          card.addEventListener("click", function () {
            openApp(app);
          });

          appsGrid.appendChild(card);
        });
      }

      function openApp(app) {
        // Expect app.baseUrl or app.defaultRoute from backend
        var base =
          (app.baseUrl || app.defaultRoute || app.route || "").trim();
        if (!base) {
          console.warn("No URL configured for app", app);
          setStatus(
            currentLang === "ar"
              ? "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¨Ø· Ù„Ù„ØªØ·Ø¨ÙŠÙ‚."
              : "App URL is not configured.",
            "error"
          );
          return;
        }
        var sep = base.indexOf("?") === -1 ? "?" : "&";
        var url =
          base +
          sep +
          "appid=" +
          encodeURIComponent(currentUser && currentUser.userId
            ? currentUser.userId
            : "");

        window.open(url, "_blank");
      }

      function renderMarketplace() {
        mpList.innerHTML = "";

        if (!marketplaceItems || !marketplaceItems.length) {
          mpEmpty.classList.remove("hidden");
          return;
        }
        mpEmpty.classList.add("hidden");

        marketplaceItems.forEach(function (item) {
          var type = (item.type || "app").toLowerCase();
          var typeLabel =
            type === "module" ? t("mpTypeModule") : t("mpTypeApp");

          var el = document.createElement("div");
          el.className = "mp-item";

          var header = document.createElement("div");
          header.className = "mp-item-header";

          var titleWrap = document.createElement("div");
          var title = document.createElement("div");
          title.className = "mp-item-title";
          title.textContent = item.name || item.templateName || "";

          var sub = document.createElement("div");
          sub.className = "mp-item-sub";
          sub.textContent =
            item.shortDesc ||
            item.description ||
            (currentLang === "ar"
              ? "Ø¹Ù†ØµØ± ÙÙŠ Ù…ØªØ¬Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª."
              : "Marketplace item.");

          titleWrap.appendChild(title);
          titleWrap.appendChild(sub);

          var badge = document.createElement("span");
          badge.className = "badge-soft";
          badge.textContent = typeLabel;

          header.appendChild(titleWrap);
          header.appendChild(badge);

          var footer = document.createElement("div");
          footer.className = "mp-item-footer";

          var tagsWrap = document.createElement("div");
          tagsWrap.className = "mp-tags";

          if (item.featureTags) {
            String(item.featureTags)
              .split(",")
              .map(function (s) {
                return s.trim();
              })
              .filter(Boolean)
              .forEach(function (tag) {
                var tagEl = document.createElement("span");
                tagEl.className = "badge-soft";
                tagEl.textContent = tag;
                tagsWrap.appendChild(tagEl);
              });
          }

          var installBtn = document.createElement("button");
          installBtn.type = "button";
          installBtn.className = "btn btn-primary";
          installBtn.textContent = t("mpInstall");

          installBtn.addEventListener("click", function () {
            installMarketplaceItem(item);
          });

          footer.appendChild(tagsWrap);
          footer.appendChild(installBtn);

          el.appendChild(header);
          el.appendChild(footer);

          mpList.appendChild(el);
        });
      }

      function installMarketplaceItem(item) {
        if (!currentSessionKey) {
          setStatus(
            currentLang === "ar"
              ? "Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹."
              : "Please login first.",
            "error"
          );
          return;
        }
        if (!currentWorkspaceId) {
          setStatus(
            currentLang === "ar"
              ? "Ø§Ø®ØªØ± Ù…Ø³Ø§Ø­Ø© Ø¹Ù…Ù„ Ù‚Ø¨Ù„ Ø§Ù„ØªØ«Ø¨ÙŠØª."
              : "Select a workspace before installing.",
            "error"
          );
          return;
        }

        var type = (item.type || "app").toLowerCase();

        setStatus(
          currentLang === "ar"
            ? "Ø¬Ø§Ø±ÙŠ ØªØ«Ø¨ÙŠØª Ø§Ù„Ø¹Ù†ØµØ±..."
            : "Installing item...",
          null
        );

        postJson({
          action: "marketplace.installTemplate",
          sessionKey: currentSessionKey,
          workspaceId: currentWorkspaceId,
          templateId: item.templateId || item.id || "",
          installType: type
        })
          .then(function (res) {
            console.log("installTemplate response", res);
            if (!res || !res.success) {
              var msg =
                (res && res.error) ||
                (currentLang === "ar"
                  ? "ØªØ¹Ø°Ø± Ø§Ù„ØªØ«Ø¨ÙŠØª."
                  : "Install failed.");
              setStatus(msg, "error");
              return;
            }

            setStatus(
              currentLang === "ar"
                ? "ØªÙ… Ø§Ù„ØªØ«Ø¨ÙŠØª Ø¨Ù†Ø¬Ø§Ø­."
                : "Installed successfully.",
              "ok"
            );

            // Refresh state so new app appears in "Your Apps"
            return loadHubState();
          })
          .catch(function (err) {
            console.error("installTemplate error", err);
            setStatus("statusError", "error");
          });
      }

      function setActiveHubView(view) {
        // Toggle buttons
        [btnViewApps, btnViewMarketplace, btnViewGift].forEach(function (btn) {
          if (btn.dataset.view === view) btn.classList.add("active");
          else btn.classList.remove("active");
        });

        // Toggle sections
        viewApps.classList.add("hidden");
        viewMarketplace.classList.add("hidden");
        viewGift.classList.add("hidden");

        if (view === "apps") viewApps.classList.remove("hidden");
        else if (view === "marketplace")
          viewMarketplace.classList.remove("hidden");
        else if (view === "gift") viewGift.classList.remove("hidden");
      }

      /* Event bindings */

      btnSendOtp.addEventListener("click", sendOtp);
      mobileInput.addEventListener("keydown", function (e) {
        if (e.key === "Enter") {
          e.preventDefault();
          sendOtp();
        }
      });

      btnVerifyOtp.addEventListener("click", verifyOtp);

      btnChangeMobile.addEventListener("click", function () {
        showAuthStep("mobile");
        setStatus("statusIdle", null);
      });

      btnLogout.addEventListener("click", logout);

      btnTheme.addEventListener("click", function () {
        currentTheme = currentTheme === "light" ? "dark" : "light";
        localStorage.setItem(STORAGE_THEME, currentTheme);
        applyTheme();
      });

      btnLangAr.addEventListener("click", function () {
        currentLang = "ar";
        localStorage.setItem(STORAGE_LANG, currentLang);
        applyLanguage();
        setStatus("statusIdle", null);
      });

      btnLangEn.addEventListener("click", function () {
        currentLang = "en";
        localStorage.setItem(STORAGE_LANG, currentLang);
        applyLanguage();
        setStatus("statusIdle", null);
      });

      workspaceSelect.addEventListener("change", function () {
        currentWorkspaceId = workspaceSelect.value || null;
        renderApps();
        renderMarketplace();
      });

      btnViewApps.addEventListener("click", function () {
        setActiveHubView("apps");
      });
      btnViewMarketplace.addEventListener("click", function () {
        setActiveHubView("marketplace");
      });
      btnViewGift.addEventListener("click", function () {
        setActiveHubView("gift");
      });

      /* Init */

      applyTheme();
      applyLanguage();
      setStatus("statusIdle", null);

      if (currentSessionKey) {
        // Try to resume session
        setStatus(
          currentLang === "ar"
            ? "ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¬Ù„Ø³Ø©..."
            : "Checking session...",
          null
        );
        loadHubState().then(function () {
          if (currentUser) {
            showHub();
            setStatus("statusIdle", null);
          } else {
            // Failed to restore; show login
            showAuthStep("mobile");
            setStatus("statusIdle", null);
          }
        });
      } else {
        showAuthStep("mobile");
      }
    })();
  </script>
</body>
</html>
