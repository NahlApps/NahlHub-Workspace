<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <title>NahlHub</title>

  <!-- Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap"
    rel="stylesheet"
  />

  <style>
    :root {
      --bg-light: #f5f7f8;
      --bg-dark: #020617;
      --card-light: #ffffff;
      --card-dark: #020617;
      --border-light: rgba(15, 23, 42, 0.08);
      --border-dark: rgba(148, 163, 184, 0.25);
      --accent: #f4ce14;
      --text-light: #0f172a;
      --text-dark: #e5e7eb;
      --muted-light: #6b7280;
      --muted-dark: #9ca3af;
      --surface-radius: 18px;
      --transition-fast: 0.18s ease-out;
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: "Cairo", system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", sans-serif;
    }

    body[data-theme="light"] {
      background: radial-gradient(
          circle at top left,
          rgba(244, 206, 20, 0.18),
          transparent 55%
        ),
        var(--bg-light);
      color: var(--text-light);
    }

    body[data-theme="dark"] {
      background: radial-gradient(
          circle at top left,
          rgba(250, 204, 21, 0.14),
          transparent 50%
        ),
        linear-gradient(145deg, #020617, #020617);
      color: var(--text-dark);
    }

    .app-shell {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 6px;
      gap: 8px;
      position: relative;
    }

    /* Topbar */

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid;
      backdrop-filter: blur(14px);
      gap: 12px;
      position: relative;
      z-index: 10;
    }

    body[data-theme="light"] .topbar {
      background: rgba(255, 255, 255, 0.72);
      border-color: var(--border-light);
    }

    body[data-theme="dark"] .topbar {
      background: rgba(15, 23, 42, 0.8);
      border-color: var(--border-dark);
    }

    .topbar-left {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
    }

    .brand-logo {
      width: 30px;
      height: 30px;
      border-radius: 11px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 18px;
      background: radial-gradient(circle at 20% 0, #facc15, #f97316);
      color: #111827;
    }

    .brand-text {
      display: flex;
      flex-direction: column;
      gap: 0;
      font-size: 13px;
      line-height: 1.2;
    }

    .brand-title {
      font-weight: 700;
      letter-spacing: 0.02em;
      white-space: nowrap;
    }

    .brand-subtitle {
      font-size: 11px;
      opacity: 0.75;
    }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .chip-group {
      display: inline-flex;
      padding: 2px;
      border-radius: 999px;
      border: 1px solid transparent;
      background: transparent;
      gap: 2px;
    }

    body[data-theme="light"] .chip-group {
      border-color: rgba(148, 163, 184, 0.42);
      background: rgba(255, 255, 255, 0.9);
    }

    body[data-theme="dark"] .chip-group {
      border-color: rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.95);
    }

    .chip-btn {
      border: none;
      outline: none;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
      cursor: pointer;
      background: transparent;
      color: inherit;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: background var(--transition-fast),
        color var(--transition-fast), transform var(--transition-fast),
        box-shadow var(--transition-fast);
      white-space: nowrap;
    }

    .chip-btn span.icon {
      font-size: 13px;
      line-height: 1;
    }

    .chip-btn.active {
      background: var(--accent);
      color: #111827;
      box-shadow: 0 6px 18px rgba(250, 204, 21, 0.4);
      transform: translateY(-0.5px);
    }

    .chip-btn:not(.active):hover {
      background: rgba(148, 163, 184, 0.25);
    }

    body[data-theme="dark"] .chip-btn:not(.active):hover {
      background: rgba(31, 41, 55, 0.8);
    }

    .chip-btn-mini {
      border-radius: 999px;
      padding: 5px 7px;
      font-size: 11px;
    }

    /* Apps burger menu (header) */

    .apps-menu-btn {
      border-radius: 999px;
      padding: 5px 9px;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .apps-menu-panel {
      position: absolute;
      top: 48px;
      inset-inline-end: 10px;
      min-width: 200px;
      max-width: 260px;
      max-height: 260px;
      overflow-y: auto;
      border-radius: 16px;
      border: 1px solid;
      padding: 6px;
      z-index: 20;
    }

    body[data-theme="light"] .apps-menu-panel {
      background: #ffffff;
      border-color: rgba(148, 163, 184, 0.4);
      box-shadow: 0 18px 30px rgba(15, 23, 42, 0.16);
    }

    body[data-theme="dark"] .apps-menu-panel {
      background: rgba(15, 23, 42, 0.98);
      border-color: rgba(148, 163, 184, 0.6);
      box-shadow: 0 18px 34px rgba(15, 23, 42, 0.8);
    }

    .apps-menu-item {
      width: 100%;
      border-radius: 12px;
      border: 1px solid transparent;
      padding: 6px 8px;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      background: transparent;
      color: inherit;
      cursor: pointer;
      text-align: start;
      transition: background var(--transition-fast),
        border-color var(--transition-fast), transform var(--transition-fast);
    }

    .apps-menu-item-title {
      font-weight: 500;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .apps-menu-item-cat {
      font-size: 11px;
      opacity: 0.6;
    }

    body[data-theme="light"] .apps-menu-item:hover {
      background: rgba(248, 250, 252, 0.9);
      border-color: rgba(148, 163, 184, 0.35);
    }

    body[data-theme="dark"] .apps-menu-item:hover {
      background: rgba(30, 64, 175, 0.2);
      border-color: rgba(129, 140, 248, 0.6);
    }

    .apps-menu-item.active {
      border-color: rgba(250, 204, 21, 0.9);
      background: rgba(250, 204, 21, 0.14);
    }

    /* Status pill */

    .status-pill {
      align-self: stretch;
      margin: 0 4px;
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: 1px solid transparent;
      max-width: 100%;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }

    body[data-theme="light"] .status-pill {
      background: rgba(255, 255, 255, 0.9);
      border-color: var(--border-light);
      color: var(--muted-light);
    }

    body[data-theme="dark"] .status-pill {
      background: rgba(15, 23, 42, 0.9);
      border-color: var(--border-dark);
      color: var(--muted-dark);
    }

    .status-pill.ok {
      border-color: rgba(34, 197, 94, 0.7);
      color: rgba(34, 197, 94, 0.95);
    }

    .status-pill.error {
      border-color: rgba(239, 68, 68, 0.85);
      color: rgba(248, 113, 113, 0.96);
    }

    .status-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--accent);
    }

    /* Main content */

    .main-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 0;
    }

    .welcome-card {
      border-radius: var(--surface-radius);
      padding: 12px 14px;
      border: 1px solid;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    body[data-theme="light"] .welcome-card {
      background: linear-gradient(
        135deg,
        rgba(244, 206, 20, 0.12),
        rgba(255, 255, 255, 0.96)
      );
      border-color: var(--border-light);
    }

    body[data-theme="dark"] .welcome-card {
      background: linear-gradient(
        145deg,
        rgba(250, 204, 21, 0.16),
        rgba(15, 23, 42, 0.96)
      );
      border-color: rgba(148, 163, 184, 0.45);
    }

    .welcome-header-line {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .welcome-title {
      font-size: 16px;
      font-weight: 700;
    }

    .welcome-sub {
      font-size: 12px;
      opacity: 0.85;
    }

    /* Generic card */

    .card {
      border-radius: var(--surface-radius);
      padding: 12px 14px 14px;
      border: 1px solid;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    body[data-theme="light"] .card {
      background: #ffffff;
      border-color: var(--border-light);
    }

    body[data-theme="dark"] .card {
      background: rgba(15, 23, 42, 0.96);
      border-color: var(--border-dark);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .card-title {
      font-size: 15px;
      font-weight: 600;
    }

    .card-caption {
      font-size: 12px;
      opacity: 0.7;
    }

    .card-body {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .field-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .field-label {
      font-size: 12px;
      opacity: 0.85;
    }

    .field-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .input {
      flex: 1;
      border-radius: 999px;
      border: 1px solid;
      padding: 8px 12px;
      font-size: 13px;
      outline: none;
      transition: border-color var(--transition-fast),
        box-shadow var(--transition-fast), background var(--transition-fast);
    }

    body[data-theme="light"] .input {
      background: rgba(248, 250, 252, 0.95);
      border-color: rgba(148, 163, 184, 0.5);
      color: var(--text-light);
    }

    body[data-theme="dark"] .input {
      background: rgba(15, 23, 42, 0.96);
      border-color: rgba(148, 163, 184, 0.6);
      color: var(--text-dark);
    }

    .input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(250, 204, 21, 0.55);
      background: rgba(255, 251, 235, 0.9);
    }

    body[data-theme="dark"] .input:focus {
      background: rgba(15, 23, 42, 0.98);
    }

    .btn {
      border-radius: 999px;
      border: none;
      outline: none;
      padding: 9px 18px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: transform var(--transition-fast),
        box-shadow var(--transition-fast), background var(--transition-fast),
        color var(--transition-fast), opacity var(--transition-fast);
      white-space: nowrap;
    }

    .btn-primary {
      background: var(--accent);
      color: #111827;
      box-shadow: 0 8px 20px rgba(250, 204, 21, 0.45);
    }

    .btn-primary:hover:enabled {
      transform: translateY(-0.5px);
      box-shadow: 0 10px 28px rgba(250, 204, 21, 0.6);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: default;
      box-shadow: none;
      transform: none;
    }

    .btn-ghost {
      background: transparent;
      color: inherit;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 11px;
      border: none;
      cursor: pointer;
    }

    body[data-theme="light"] .btn-ghost:hover {
      background: rgba(148, 163, 184, 0.18);
    }

    body[data-theme="dark"] .btn-ghost:hover {
      background: rgba(31, 41, 55, 0.9);
    }

    /* OTP row: left to right */

    .otp-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      direction: ltr;
    }

    .otp-input {
      width: 44px;
      height: 44px;
      text-align: center;
      font-size: 18px;
      font-weight: 600;
      border-radius: 16px;
      border: 1px solid;
      outline: none;
      transition: border-color var(--transition-fast),
        box-shadow var(--transition-fast), background var(--transition-fast);
    }

    body[data-theme="light"] .otp-input {
      background: rgba(248, 250, 252, 0.96);
      border-color: rgba(148, 163, 184, 0.5);
      color: var(--text-light);
    }

    body[data-theme="dark"] .otp-input {
      background: rgba(15, 23, 42, 0.97);
      border-color: rgba(148, 163, 184, 0.7);
      color: var(--text-dark);
    }

    .otp-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(250, 204, 21, 0.55);
      background: rgba(255, 251, 235, 0.96);
    }

    body[data-theme="dark"] .otp-input:focus {
      background: rgba(15, 23, 42, 1);
    }

    /* Apps layout + sections */

    .apps-layout {
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 0;
      flex: 1;
    }

    .hub-header-row {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    @media (min-width: 640px) {
      .hub-header-row {
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
      }
    }

    .workspace-select-wrap {
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 0;
    }

    .workspace-select-label {
      font-size: 11px;
      opacity: 0.8;
    }

    .workspace-select-pill {
      display: flex;
      align-items: center;
      gap: 6px;
      border-radius: 999px;
      padding: 4px 8px 4px 10px;
      border: 1px solid;
      cursor: pointer;
      max-width: 280px;
    }

    body[data-theme="light"] .workspace-select-pill {
      background: rgba(255, 255, 255, 0.96);
      border-color: rgba(148, 163, 184, 0.6);
    }

    body[data-theme="dark"] .workspace-select-pill {
      background: rgba(15, 23, 42, 0.96);
      border-color: rgba(148, 163, 184, 0.7);
    }

    .workspace-select-pill select {
      border: none;
      outline: none;
      background: transparent;
      font: inherit;
      font-size: 13px;
      width: 100%;
      color: inherit;
      padding: 4px 0;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      direction: rtl;
    }

    [dir="ltr"] .workspace-select-pill select {
      direction: ltr;
    }

    .workspace-pill-icon {
      width: 20px;
      height: 20px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      background: rgba(244, 206, 20, 0.2);
      flex-shrink: 0;
    }

    .workspace-pill-meta {
      font-size: 10px;
      opacity: 0.7;
    }

    .workspace-pill-chevron {
      font-size: 12px;
      opacity: 0.7;
      flex-shrink: 0;
    }

    .hub-nav-chips {
      display: inline-flex;
      border-radius: 999px;
      padding: 3px;
      border: 1px solid;
      gap: 2px;
    }

    body[data-theme="light"] .hub-nav-chips {
      background: rgba(255, 255, 255, 0.96);
      border-color: rgba(148, 163, 184, 0.5);
    }

    body[data-theme="dark"] .hub-nav-chips {
      background: rgba(15, 23, 42, 0.98);
      border-color: rgba(148, 163, 184, 0.7);
    }

    .hub-nav-btn {
      border-radius: 999px;
      border: none;
      background: transparent;
      font-size: 11px;
      padding: 5px 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      color: inherit;
      transition: background var(--transition-fast), color var(--transition-fast),
        box-shadow var(--transition-fast), transform var(--transition-fast);
    }

    .hub-nav-btn span.icon {
      font-size: 13px;
    }

    .hub-nav-btn.active {
      background: var(--accent);
      color: #111827;
      box-shadow: 0 8px 18px rgba(250, 204, 21, 0.5);
      transform: translateY(-0.5px);
    }

    .hub-nav-btn:not(.active):hover {
      background: rgba(148, 163, 184, 0.2);
    }

    body[data-theme="dark"] .hub-nav-btn:not(.active):hover {
      background: rgba(31, 41, 55, 0.9);
    }

    #appsCard {
      padding-bottom: 12px;
    }

    .apps-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
      max-height: 220px;
      overflow-y: auto;
      padding-top: 4px;
    }

    .app-card {
      border-radius: 16px;
      border: 1px solid;
      padding: 10px 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      cursor: pointer;
      position: relative;
      transition: background var(--transition-fast),
        border-color var(--transition-fast), transform var(--transition-fast),
        box-shadow var(--transition-fast);
    }

    body[data-theme="light"] .app-card {
      background: rgba(255, 255, 255, 0.96);
      border-color: rgba(148, 163, 184, 0.35);
    }

    body[data-theme="dark"] .app-card {
      background: rgba(15, 23, 42, 0.96);
      border-color: rgba(148, 163, 184, 0.55);
    }

    .app-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 26px rgba(15, 23, 42, 0.18);
      border-color: rgba(250, 204, 21, 0.9);
    }

    .app-card-header {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .app-card-icon {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      background: rgba(244, 206, 20, 0.15);
      color: #92400e;
    }

    body[data-theme="dark"] .app-card-icon {
      background: rgba(250, 204, 21, 0.14);
      color: #facc15;
    }

    .app-card-title {
      font-size: 13px;
      font-weight: 600;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .app-card-body {
      font-size: 11px;
      opacity: 0.78;
      height: 2.4em;
      overflow: hidden;
    }

    .app-card-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 11px;
      opacity: 0.75;
      margin-top: 2px;
    }

    .badge-pinned {
      border-radius: 999px;
      padding: 2px 6px;
      font-size: 10px;
      background: rgba(250, 204, 21, 0.16);
      color: #92400e;
    }

    body[data-theme="dark"] .badge-pinned {
      background: rgba(250, 204, 21, 0.22);
      color: #facc15;
    }

    .badge-type {
      border-radius: 999px;
      padding: 2px 6px;
      font-size: 10px;
      background: rgba(148, 163, 184, 0.16);
      opacity: 0.9;
    }

    .app-view {
      flex: 1;
      border-radius: 14px;
      border: 1px solid;
      overflow: hidden;
      min-height: 220px;
    }

    body[data-theme="light"] .app-view {
      background: #ffffff;
      border-color: var(--border-light);
    }

    body[data-theme="dark"] .app-view {
      background: rgba(15, 23, 42, 0.96);
      border-color: var(--border-dark);
    }

    .app-view-header {
      padding: 7px 10px;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      border-bottom: 1px solid;
    }

    body[data-theme="light"] .app-view-header {
      border-color: rgba(148, 163, 184, 0.25);
      background: rgba(248, 250, 252, 0.96);
    }

    body[data-theme="dark"] .app-view-header {
      border-color: rgba(51, 65, 85, 0.9);
      background: rgba(15, 23, 42, 0.98);
    }

    .app-frame-wrap {
      width: 100%;
      height: calc(100vh - 230px);
      max-height: calc(100vh - 210px);
    }

    .app-frame {
      width: 100%;
      height: 100%;
      border: none;
      display: block;
      background: transparent;
    }

    .app-frame-placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      opacity: 0.6;
      padding: 10px;
      text-align: center;
    }

    .hidden {
      display: none !important;
    }

    /* Marketplace layout */

    .marketplace-columns {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }

    @media (min-width: 900px) {
      .marketplace-columns {
        grid-template-columns: 1.1fr 1.1fr;
      }
    }

    .marketplace-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 250px;
      overflow-y: auto;
      margin-top: 4px;
    }

    .marketplace-item {
      border-radius: 16px;
      border: 1px solid;
      padding: 8px 10px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    body[data-theme="light"] .marketplace-item {
      background: rgba(255, 255, 255, 0.96);
      border-color: rgba(148, 163, 184, 0.35);
    }

    body[data-theme="dark"] .marketplace-item {
      background: rgba(15, 23, 42, 0.96);
      border-color: rgba(148, 163, 184, 0.55);
    }

    .marketplace-item-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    .marketplace-item-title {
      font-size: 13px;
      font-weight: 600;
    }

    .marketplace-item-tags {
      font-size: 10px;
      opacity: 0.75;
    }

    .marketplace-item-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      margin-top: 4px;
      font-size: 11px;
      opacity: 0.8;
    }

    .gift-placeholder {
      font-size: 12px;
      opacity: 0.75;
      line-height: 1.6;
    }

    /* AUTH POPUP OVERLAY */

    .auth-overlay {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 12px;
      z-index: 30;
      backdrop-filter: blur(10px);
    }

    body[data-theme="light"] .auth-overlay {
      background: radial-gradient(
          circle at top,
          rgba(148, 163, 184, 0.16),
          transparent 60%
        ),
        rgba(15, 23, 42, 0.18);
    }

    body[data-theme="dark"] .auth-overlay {
      background: radial-gradient(
          circle at top,
          rgba(15, 23, 42, 0.95),
          rgba(15, 23, 42, 0.98)
        );
    }

    .auth-modal {
      width: 100%;
      max-width: 420px;
      border-radius: 22px;
      border: 1px solid;
      padding: 14px 12px 12px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.55);
    }

    body[data-theme="light"] .auth-modal {
      background: linear-gradient(
        140deg,
        rgba(244, 206, 20, 0.12),
        #ffffff
      );
      border-color: rgba(148, 163, 184, 0.5);
    }

    body[data-theme="dark"] .auth-modal {
      background: radial-gradient(
          circle at top left,
          rgba(250, 204, 21, 0.18),
          transparent 50%
        ),
        rgba(15, 23, 42, 0.98);
      border-color: rgba(148, 163, 184, 0.6);
    }

    .auth-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 2px 4px 10px;
    }

    .auth-title {
      font-size: 15px;
      font-weight: 700;
    }

    .auth-sub {
      font-size: 12px;
      opacity: 0.78;
    }

    .auth-badge {
      font-size: 11px;
      border-radius: 999px;
      padding: 3px 8px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      opacity: 0.9;
    }

    .auth-modal-body {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    @media (min-width: 768px) {
      .app-shell {
        padding: 6px 10px;
      }
      .main-panel {
        max-width: 100%;
        width: 100%;
        margin: 0;
      }
      .app-frame-wrap {
        height: calc(100vh - 230px);
        max-height: calc(100vh - 210px);
      }
      .apps-list {
        max-height: 220px;
      }
    }
  </style>
</head>
<body data-theme="light">
  <div class="app-shell">
    <!-- Apps burger panel -->
    <div id="appsMenuPanel" class="apps-menu-panel hidden"></div>

    <!-- Top bar -->
    <header class="topbar">
      <div class="topbar-left">
        <div class="brand-logo">N</div>
        <div class="brand-text">
          <div class="brand-title" data-i18n="hubTitle">NahlHub</div>
          <div class="brand-subtitle" data-i18n="hubSub">
            ØªØ·Ø¨ÙŠÙ‚Ø§ØªÙƒ ÙÙŠ Ù†Ø­Ù„ Ù‡Ø¨
          </div>
        </div>
      </div>
      <div class="topbar-right">
        <button
          class="chip-btn chip-btn-mini apps-menu-btn hidden"
          id="btnAppsMenu"
          type="button"
        >
          <span class="icon">â˜°</span>
          <span data-i18n="appsTitle">ØªØ·Ø¨ÙŠÙ‚Ø§ØªÙƒ</span>
        </button>

        <div class="chip-group">
          <button
            class="chip-btn"
            id="btnLangAr"
            type="button"
            data-lang="ar"
          >
            <span>Ø¹Ø±Ø¨ÙŠ</span>
          </button>
          <button
            class="chip-btn"
            id="btnLangEn"
            type="button"
            data-lang="en"
          >
            <span>EN</span>
          </button>
        </div>
        <button
          class="chip-btn chip-btn-mini"
          id="btnTheme"
          type="button"
        >
          <span class="icon" id="themeIcon">ğŸŒ</span>
        </button>
      </div>
    </header>

    <!-- Status -->
    <div id="statusPill" class="status-pill">
      <span class="status-dot"></span>
      <span id="statusText"></span>
    </div>

    <!-- AUTH POPUP -->
    <div id="authOverlay" class="auth-overlay">
      <div class="auth-modal">
        <div class="auth-modal-header">
          <div>
            <div class="auth-title" data-i18n="welcomeTitle">Ù…Ø±Ø­Ø¨Ø§Ù‹ ğŸ‘‹</div>
            <div class="auth-sub" data-i18n="welcomeSub">
              Ø§Ø¯Ø®Ù„ Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø«Ù… Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„.
            </div>
          </div>
          <div class="auth-badge">
            <span data-i18n="step1Title">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</span> Â·
            <span data-i18n="step2Title">Ø±Ù…Ø²</span>
          </div>
        </div>
        <div class="auth-modal-body">
          <!-- Step 1: Mobile (inside popup) -->
          <section id="stepMobile" class="card" style="margin: 0">
            <div class="card-header">
              <div>
                <div class="card-title" data-i18n="step1Title">
                  Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„
                </div>
                <div class="card-caption" data-i18n="step1Sub">
                  Ø§Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„.
                </div>
              </div>
            </div>
            <div class="card-body">
              <div class="field-group">
                <label
                  class="field-label"
                  for="mobileInput"
                  data-i18n="step1Label"
                >
                  Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„
                </label>
                <div class="field-row">
                  <input
                    id="mobileInput"
                    class="input"
                    type="tel"
                    inputmode="tel"
                    autocomplete="tel"
                    placeholder="5XXXXXXXX"
                  />
                </div>
              </div>
              <div class="field-row" style="justify-content: flex-end">
                <button
                  id="btnSendOtp"
                  class="btn btn-primary"
                  type="button"
                >
                  <span data-i18n="btnSendOtp">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²</span>
                </button>
              </div>
            </div>
          </section>

          <!-- Step 2: OTP (inside popup) -->
          <section id="stepOtp" class="card hidden" style="margin: 0">
            <div class="card-header">
              <div>
                <div class="card-title" data-i18n="step2Title">
                  Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„
                </div>
                <div class="card-caption" data-i18n="step2Sub">
                  Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ù¤ Ø£Ø±Ù‚Ø§Ù….
                </div>
              </div>
              <button
                type="button"
                class="btn-ghost"
                id="btnChangeMobile"
              >
                <span data-i18n="changeMobile">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ù‚Ù…</span>
              </button>
            </div>
            <div class="card-body">
              <div class="otp-row">
                <input
                  class="otp-input"
                  id="otp1"
                  type="tel"
                  inputmode="numeric"
                  maxlength="1"
                />
                <input
                  class="otp-input"
                  id="otp2"
                  type="tel"
                  inputmode="numeric"
                  maxlength="1"
                />
                <input
                  class="otp-input"
                  id="otp3"
                  type="tel"
                  inputmode="numeric"
                  maxlength="1"
                />
                <input
                  class="otp-input"
                  id="otp4"
                  type="tel"
                  inputmode="numeric"
                  maxlength="1"
                />
              </div>
              <div
                class="field-row"
                style="justify-content: flex-end; margin-top: 10px"
              >
                <button
                  id="btnVerifyOtp"
                  class="btn btn-primary"
                  type="button"
                >
                  <span data-i18n="btnVerify">ØªØ£ÙƒÙŠØ¯</span>
                </button>
              </div>
            </div>
          </section>
        </div>
      </div>
    </div>

    <!-- Main -->
    <main class="main-panel">
      <!-- Welcome (after login we hide it) -->
      <section class="welcome-card" id="welcomeCard">
        <div class="welcome-header-line">
          <div>
            <div class="welcome-title" data-i18n="welcomeTitle">Ù…Ø±Ø­Ø¨Ø§Ù‹ ğŸ‘‹</div>
            <div class="welcome-sub" data-i18n="welcomeSub">
              Ø§Ø¯Ø®Ù„ Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø«Ù… Ø§Ø®ØªØ± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚.
            </div>
          </div>
        </div>
      </section>

      <!-- Hub (after login) -->
      <section id="stepApps" class="apps-layout hidden">
        <!-- Hub header: workspace + nav chips + logout -->
        <div class="card">
          <div class="card-header hub-header-row">
            <div class="workspace-select-wrap">
              <div class="workspace-select-label" data-i18n="workspaceLabel">
                Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„
              </div>
              <div class="workspace-select-pill">
                <div class="workspace-pill-icon">ğŸ¢</div>
                <div style="flex:1; min-width:0;">
                  <select id="workspaceSelect">
                    <!-- options added via JS -->
                  </select>
                  <div id="workspaceMeta" class="workspace-pill-meta"></div>
                </div>
                <div class="workspace-pill-chevron">â–¾</div>
              </div>
            </div>

            <div style="display:flex; align-items:center; gap:8px; justify-content:flex-end;">
              <div class="hub-nav-chips">
                <button
                  type="button"
                  class="hub-nav-btn active"
                  id="navYourApps"
                  data-section="apps"
                >
                  <span class="icon">ğŸ§©</span>
                  <span data-i18n="navApps">ØªØ·Ø¨ÙŠÙ‚Ø§ØªÙƒ</span>
                </button>
                <button
                  type="button"
                  class="hub-nav-btn"
                  id="navMarketplace"
                  data-section="marketplace"
                >
                  <span class="icon">ğŸ¬</span>
                  <span data-i18n="navMarketplace">Ù…ØªØ¬Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª</span>
                </button>
                <button
                  type="button"
                  class="hub-nav-btn"
                  id="navGift"
                  data-section="gift"
                >
                  <span class="icon">ğŸ</span>
                  <span data-i18n="navGift">Ù…Ø­Ø±Ùƒ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§</span>
                </button>
              </div>

              <button
                class="btn-ghost"
                type="button"
                id="btnLogout"
              >
                <span data-i18n="logout">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</span>
              </button>
            </div>
          </div>
          <div class="card-body">
            <div class="card-caption" id="userNameLabel"></div>
          </div>
        </div>

        <!-- SECTION: YOUR APPS -->
        <section id="appsSection">
          <div class="card" id="appsCard">
            <div class="card-header">
              <div>
                <div class="card-title" data-i18n="appsTitle">
                  ØªØ·Ø¨ÙŠÙ‚Ø§ØªÙƒ
                </div>
                <div class="card-caption" data-i18n="appsSubtitle">
                  Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ù…Ø«Ø¨ØªØ© ÙÙŠ Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠØ©.
                </div>
              </div>
            </div>
            <div class="card-body">
              <div id="appsList" class="apps-list"></div>
            </div>
          </div>

          <div class="app-view hidden" id="appView">
            <div class="app-view-header">
              <div id="currentAppTitle" class="card-caption">
                <span data-i18n="appPlaceholder">
                  Ø§Ø®ØªØ± ØªØ·Ø¨ÙŠÙ‚Ø§Ù‹ Ù…Ù† Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©.
                </span>
              </div>
              <div style="display:flex; align-items:center; gap:6px;">
                <button
                  id="btnHome"
                  class="btn-ghost hidden"
                  type="button"
                  aria-label="Home"
                >
                  ğŸ 
                </button>
              </div>
            </div>
            <div class="app-frame-wrap">
              <iframe
                id="appFrame"
                class="app-frame hidden"
                src=""
                title="NahlHub App"
              ></iframe>
              <div
                id="appFramePlaceholder"
                class="app-frame-placeholder"
              >
                <span data-i18n="appPlaceholder">
                  Ø§Ø®ØªØ± ØªØ·Ø¨ÙŠÙ‚Ø§Ù‹ Ù…Ù† Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©.
                </span>
              </div>
            </div>
          </div>
        </section>

        <!-- SECTION: MARKETPLACE -->
        <section id="marketplaceSection" class="hidden">
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title" data-i18n="marketplaceTitle">
                  Ù…ØªØ¬Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª
                </div>
                <div class="card-caption" data-i18n="marketplaceSub">
                  Ø«Ø¨Ù‘Øª ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ù…Ù†ÙØ±Ø¯Ø© Ø£Ùˆ Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Modules Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠØ©.
                </div>
              </div>
            </div>
            <div class="card-body">
              <div class="marketplace-columns">
                <!-- Apps only -->
                <div>
                  <div class="card-title" style="font-size:13px;" data-i18n="marketplaceApps">
                    ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ù…Ù†ÙØ±Ø¯Ø©
                  </div>
                  <div id="marketplaceAppsList" class="marketplace-list"></div>
                </div>

                <!-- Modules (bundles of apps) -->
                <div>
                  <div class="card-title" style="font-size:13px;" data-i18n="marketplaceModules">
                    Modules (Ø­Ø²Ù… Ù…Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª)
                  </div>
                  <div id="marketplaceModulesList" class="marketplace-list"></div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- SECTION: GIFT ENGINE -->
        <section id="giftSection" class="hidden">
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title" data-i18n="giftTitle">
                  Ù…Ø­Ø±Ùƒ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§
                </div>
                <div class="card-caption" data-i18n="giftSub">
                  Ø§Ø³ØªØ®Ø¯Ù… Modules Ø®Ø§ØµØ© Ù„Ù„Ù‡Ø¯Ø§ÙŠØ§ØŒ Ø§Ù„Ù†Ù‚Ø§Ø·ØŒ ÙˆØ§Ù„Ù‚Ø³Ø§Ø¦Ù… Ù„Ø¹Ù…Ù„Ø§Ø¦Ùƒ.
                </div>
              </div>
            </div>
            <div class="card-body">
              <div class="gift-placeholder" data-i18n="giftPlaceholder">
                Ø³ÙŠØªÙ… ØªØ´ØºÙŠÙ„ Ù…Ø­Ø±Ùƒ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ù…Ù† Ø®Ù„Ø§Ù„ Modules Ø®Ø§ØµØ© ÙÙŠ Marketplace
                (Ù…Ø«Ù„ Loyalty, Coupons, Referral). Ø¹Ù†Ø¯ ØªØ«Ø¨ÙŠØª Ù‡Ø°Ù‡ Ø§Ù„Ù€ ModulesØŒ
                Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ù„Ù„Ù‡Ø¯Ø§ÙŠØ§ ÙˆØ§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„ØªØ³ÙˆÙŠÙ‚ÙŠØ©. âœ¨
              </div>
            </div>
          </div>
        </section>
      </section>
    </main>
  </div>

  <script>
    (function () {
      "use strict";

      var API_URL = "/api/hub/manage";
      var STORAGE_SESSION_KEY = "nahlhub_session_key";
      var STORAGE_LANG = "nahlhub_lang";
      var STORAGE_THEME = "nahlhub_theme";

      var currentLang = localStorage.getItem(STORAGE_LANG) || "ar";
      var currentTheme = localStorage.getItem(STORAGE_THEME) || "light";
      var currentSessionKey = localStorage.getItem(STORAGE_SESSION_KEY) || null;

      var currentUser = null;
      var workspaces = [];
      var currentWorkspaceId = null;

      var allWorkspaceApps = {}; // workspaceId -> [apps]
      var marketplaceTemplates = []; // all templates (apps + modules) for current workspace
      var currentApps = []; // apps for current workspace
      var currentAppId = null;
      var currentMobileRaw = "";
      var currentSection = "apps";

      var bodyEl = document.body;
      var statusPill = document.getElementById("statusPill");
      var statusText = document.getElementById("statusText");

      var welcomeCard = document.getElementById("welcomeCard");

      var authOverlay = document.getElementById("authOverlay");
      var stepMobile = document.getElementById("stepMobile");
      var stepOtp = document.getElementById("stepOtp");
      var stepApps = document.getElementById("stepApps");

      var mobileInput = document.getElementById("mobileInput");
      var btnSendOtp = document.getElementById("btnSendOtp");

      var otpInputs = [
        document.getElementById("otp1"),
        document.getElementById("otp2"),
        document.getElementById("otp3"),
        document.getElementById("otp4")
      ];
      var btnVerifyOtp = document.getElementById("btnVerifyOtp");
      var btnChangeMobile = document.getElementById("btnChangeMobile");

      var appsCard = document.getElementById("appsCard");
      var appsListEl = document.getElementById("appsList");
      var appView = document.getElementById("appView");
      var appFrame = document.getElementById("appFrame");
      var appFramePlaceholder = document.getElementById("appFramePlaceholder");
      var currentAppTitle = document.getElementById("currentAppTitle");
      var userNameLabel = document.getElementById("userNameLabel");
      var btnLogout = document.getElementById("btnLogout");

      var btnTheme = document.getElementById("btnTheme");
      var themeIcon = document.getElementById("themeIcon");
      var btnLangAr = document.getElementById("btnLangAr");
      var btnLangEn = document.getElementById("btnLangEn");

      var btnAppsMenu = document.getElementById("btnAppsMenu");
      var appsMenuPanel = document.getElementById("appsMenuPanel");

      var btnHome = document.getElementById("btnHome");

      var navYourApps = document.getElementById("navYourApps");
      var navMarketplace = document.getElementById("navMarketplace");
      var navGift = document.getElementById("navGift");

      var appsSection = document.getElementById("appsSection");
      var marketplaceSection = document.getElementById("marketplaceSection");
      var giftSection = document.getElementById("giftSection");

      var workspaceSelect = document.getElementById("workspaceSelect");
      var workspaceMeta = document.getElementById("workspaceMeta");

      var marketplaceAppsList = document.getElementById("marketplaceAppsList");
      var marketplaceModulesList = document.getElementById("marketplaceModulesList");

      var tDict = {
        hubTitle: { ar: "NahlHub", en: "NahlHub" },
        hubSub: {
          ar: "ØªØ·Ø¨ÙŠÙ‚Ø§ØªÙƒ ÙÙŠ Ù†Ø­Ù„ Ù‡Ø¨",
          en: "Your apps in NahlHub"
        },
        welcomeTitle: { ar: "Ù…Ø±Ø­Ø¨Ø§Ù‹ ğŸ‘‹", en: "Welcome ğŸ‘‹" },
        welcomeSub: {
          ar: "Ø§Ø¯Ø®Ù„ Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø«Ù… Ø§Ø®ØªØ± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚.",
          en: "Enter your mobile then choose an app."
        },
        step1Title: { ar: "Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„", en: "Mobile number" },
        step1Sub: { ar: "Ø§Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„.", en: "Enter your mobile." },
        step1Label: { ar: "Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„", en: "Mobile" },
        btnSendOtp: { ar: "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²", en: "Send code" },
        step2Title: { ar: "Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„", en: "Login code" },
        step2Sub: {
          ar: "Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ù¤ Ø£Ø±Ù‚Ø§Ù….",
          en: "Enter the 4-digit code."
        },
        changeMobile: { ar: "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ù‚Ù…", en: "Change number" },
        btnVerify: { ar: "ØªØ£ÙƒÙŠØ¯", en: "Confirm" },
        appsTitle: { ar: "ØªØ·Ø¨ÙŠÙ‚Ø§ØªÙƒ", en: "Your apps" },
        appsSubtitle: {
          ar: "Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ù…Ø«Ø¨ØªØ© ÙÙŠ Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠØ©.",
          en: "Apps installed in the current workspace."
        },
        logout: { ar: "ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬", en: "Logout" },
        appPlaceholder: {
          ar: "Ø§Ø®ØªØ± ØªØ·Ø¨ÙŠÙ‚Ø§Ù‹ Ù…Ù† Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©.",
          en: "Choose an app from the home cards."
        },
        statusIdle: { ar: "Ø¬Ø§Ù‡Ø².", en: "Ready." },
        statusSendingOtp: {
          ar: "ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²...",
          en: "Sending code..."
        },
        statusOtpSent: {
          ar: "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø² Ø¥Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨.",
          en: "Code sent to WhatsApp."
        },
        statusVerifying: { ar: "ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚...", en: "Verifying..." },
        statusNoApps: {
          ar: "Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ù…ØªØ§Ø­Ø©.",
          en: "No apps available."
        },
        statusNoWorkspaces: {
          ar: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³Ø§Ø­Ø§Øª Ø¹Ù…Ù„ Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨.",
          en: "No workspaces for this account."
        },
        statusError: {
          ar: "Ø­Ø¯Ø« Ø®Ø·Ø£. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.",
          en: "Something went wrong. Try again."
        },
        workspaceLabel: { ar: "Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„", en: "Workspace" },
        navApps: { ar: "ØªØ·Ø¨ÙŠÙ‚Ø§ØªÙƒ", en: "Your apps" },
        navMarketplace: { ar: "Ù…ØªØ¬Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª", en: "Marketplace" },
        navGift: { ar: "Ù…Ø­Ø±Ùƒ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§", en: "Gift engine" },
        marketplaceTitle: { ar: "Ù…ØªØ¬Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª", en: "App Marketplace" },
        marketplaceSub: {
          ar: "Ø«Ø¨Ù‘Øª ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ù…Ù†ÙØ±Ø¯Ø© Ø£Ùˆ Modules Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠØ©.",
          en: "Install single apps or Modules into the current workspace."
        },
        marketplaceApps: {
          ar: "ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ù…Ù†ÙØ±Ø¯Ø©",
          en: "Single apps"
        },
        marketplaceModules: {
          ar: "Modules (Ø­Ø²Ù… Ù…Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª)",
          en: "Modules (bundles of apps)"
        },
        giftTitle: {
          ar: "Ù…Ø­Ø±Ùƒ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§",
          en: "Gift Engine"
        },
        giftSub: {
          ar: "Ø¨Ø±Ø§Ù…Ø¬ ÙˆÙ„Ø§Ø¡ ÙˆÙ‡Ø¯Ø§ÙŠØ§ Ù…Ø¨Ù†ÙŠØ© Ø¹Ù„Ù‰ Modules Ù…Ù† Ø§Ù„Ù…ØªØ¬Ø±.",
          en: "Loyalty and gift programs powered by Modules from the marketplace."
        },
        giftPlaceholder: {
          ar: "Ø³ÙŠØªÙ… ØªØ´ØºÙŠÙ„ Ù…Ø­Ø±Ùƒ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ù…Ù† Ø®Ù„Ø§Ù„ Modules Ø®Ø§ØµØ© ÙÙŠ Marketplace (Ù…Ø«Ù„ Loyalty, Coupons, Referral). Ø¹Ù†Ø¯ ØªØ«Ø¨ÙŠØª Ù‡Ø°Ù‡ Ø§Ù„Ù€ ModulesØŒ Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ù„Ù„Ù‡Ø¯Ø§ÙŠØ§ ÙˆØ§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„ØªØ³ÙˆÙŠÙ‚ÙŠØ©. âœ¨",
          en: "The gift engine will be powered by special Modules in the Marketplace (e.g. Loyalty, Coupons, Referral). Once these Modules are installed, a control panel will appear here for gifts and marketing programs. âœ¨"
        },
        btnInstallApp: { ar: "ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚", en: "Install app" },
        btnInstallModule: { ar: "ØªØ«Ø¨ÙŠØª Module", en: "Install module" },
        statusInstalling: { ar: "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ«Ø¨ÙŠØª...", en: "Installing..." },
        statusInstalled: { ar: "ØªÙ… Ø§Ù„ØªØ«Ø¨ÙŠØª Ø¨Ù†Ø¬Ø§Ø­.", en: "Installed successfully." }
      };

      function t(key) {
        var entry = tDict[key];
        if (!entry) return key;
        return entry[currentLang] || entry.ar || key;
      }

      function applyLanguage() {
        document.documentElement.lang = currentLang;
        document.documentElement.dir = currentLang === "ar" ? "rtl" : "ltr";

        var nodes = document.querySelectorAll("[data-i18n]");
        nodes.forEach(function (node) {
          var key = node.getAttribute("data-i18n");
          node.textContent = t(key);
        });

        if (currentLang === "ar") {
          btnLangAr.classList.add("active");
          btnLangEn.classList.remove("active");
          mobileInput.placeholder = "5XXXXXXXX";
        } else {
          btnLangAr.classList.remove("active");
          btnLangEn.classList.add("active");
          mobileInput.placeholder = "5XXXXXXXX";
        }

        updateUserUi();
        renderWorkspacesDropdown();
        renderApps();
        renderMarketplace();
      }

      function applyTheme() {
        bodyEl.setAttribute("data-theme", currentTheme);
        themeIcon.textContent = currentTheme === "light" ? "ğŸŒ" : "ğŸŒ™";
      }

      function setStatus(msgKeyOrText, type) {
        if (!msgKeyOrText) {
          statusText.textContent = "";
          statusPill.classList.remove("ok", "error");
          return;
        }
        var text =
          tDict[msgKeyOrText] && tDict[msgKeyOrText][currentLang]
            ? t(msgKeyOrText)
            : msgKeyOrText;
        statusPill.classList.remove("ok", "error");
        if (type === "ok") statusPill.classList.add("ok");
        else if (type === "error") statusPill.classList.add("error");
        statusText.textContent = text;
      }

      function showStep(name) {
        stepMobile.classList.add("hidden");
        stepOtp.classList.add("hidden");
        stepApps.classList.add("hidden");

        if (name === "mobile") {
          authOverlay.classList.remove("hidden");
          stepMobile.classList.remove("hidden");
          mobileInput.focus();
        } else if (name === "otp") {
          authOverlay.classList.remove("hidden");
          stepOtp.classList.remove("hidden");
          otpInputs[0].focus();
        } else if (name === "apps") {
          authOverlay.classList.add("hidden");
          stepApps.classList.remove("hidden");
        }
      }

      function callHubApi(action, payload) {
        var body = Object.assign({}, payload || {}, { action: action });
        return fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        }).then(function (res) {
          return res.json().catch(function () {
            throw new Error("Server did not return valid JSON.");
          });
        });
      }

      // OTP behaviour (L â†’ R)
      otpInputs.forEach(function (input, idx) {
        input.addEventListener("input", function (e) {
          var value = e.target.value.replace(/\D/g, "");
          e.target.value = value.slice(0, 1);
          if (value && idx < otpInputs.length - 1) {
            otpInputs[idx + 1].focus();
          }
        });

        input.addEventListener("keydown", function (e) {
          if (e.key === "Backspace" && !e.target.value && idx > 0) {
            otpInputs[idx - 1].focus();
          }
          if (e.key === "ArrowLeft" && idx > 0) {
            otpInputs[idx - 1].focus();
          }
          if (e.key === "ArrowRight" && idx < otpInputs.length - 1) {
            otpInputs[idx + 1].focus();
          }
          if (e.key === "Enter") {
            e.preventDefault();
            verifyOtp();
          }
        });
      });

      function readOtp() {
        return otpInputs
          .map(function (el) {
            return el.value || "";
          })
          .join("");
      }

      function clearOtpInputs() {
        otpInputs.forEach(function (el) {
          el.value = "";
        });
      }

      function sendOtp() {
        var mobile = (mobileInput.value || "").trim();
        if (!mobile) {
          setStatus(
            currentLang === "ar" ? "Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„." : "Enter your mobile.",
            "error"
          );
          mobileInput.focus();
          return;
        }

        currentMobileRaw = mobile;
        btnSendOtp.disabled = true;
        setStatus("statusSendingOtp", null);

        callHubApi("auth.requestOtp", { mobile: mobile })
          .then(function (res) {
            if (!res || !res.success) {
              var msg =
                (res && res.error) ||
                (currentLang === "ar"
                  ? "ØªØ¹Ø°Ø± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²."
                  : "Failed to send code.");
              setStatus(msg, "error");
              return;
            }
            setStatus("statusOtpSent", "ok");
            clearOtpInputs();
            showStep("otp");
          })
          .catch(function (err) {
            console.error(err);
            setStatus("statusError", "error");
          })
          .finally(function () {
            btnSendOtp.disabled = false;
          });
      }

      function verifyOtp() {
        var otp = readOtp();
        if (!otp || otp.length !== 4) {
          setStatus(
            currentLang === "ar"
              ? "Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ù¤ Ø£Ø±Ù‚Ø§Ù…."
              : "Enter the 4-digit code.",
            "error"
          );
          otpInputs[0].focus();
          return;
        }

        btnVerifyOtp.disabled = true;
        setStatus("statusVerifying", null);

        callHubApi("auth.verifyOtp", {
          mobile: currentMobileRaw,
          otp: otp
        })
          .then(function (res) {
            if (!res || !res.success) {
              var msg =
                (res && res.error) ||
                (currentLang === "ar"
                  ? "Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ Ù…Ù†ØªÙ‡ÙŠ."
                  : "Invalid or expired code.");
              setStatus(msg, "error");
              clearOtpInputs();
              otpInputs[0].focus();
              return;
            }

            handleLoginSuccess(res);
          })
          .catch(function (err) {
            console.error(err);
            setStatus("statusError", "error");
          })
          .finally(function () {
            btnVerifyOtp.disabled = false;
          });
      }

      function handleLoginSuccess(res) {
        currentSessionKey = res.sessionKey || null;
        if (currentSessionKey) {
          localStorage.setItem(STORAGE_SESSION_KEY, currentSessionKey);
        }

        currentUser = res.user || null;
        workspaces = res.workspaces || [];
        marketplaceTemplates = res.marketplaceTemplates || res.templates || [];
        allWorkspaceApps = {};

        // Optional: initial apps array from backend (flattened)
        if (Array.isArray(res.apps)) {
          res.apps.forEach(function (app) {
            var wsId = app.workspaceId || "default";
            if (!allWorkspaceApps[wsId]) allWorkspaceApps[wsId] = [];
            allWorkspaceApps[wsId].push(app);
          });
        }

        if (welcomeCard) welcomeCard.classList.add("hidden");
        updateUserUi();
        renderWorkspacesDropdown();

        if (!workspaces.length) {
          setStatus("statusNoWorkspaces", "error");
        } else {
          // Select first workspace by default
          currentWorkspaceId = workspaces[0].workspaceId || workspaces[0].id;
          workspaceSelect.value = currentWorkspaceId;
          updateWorkspaceContext();
        }

        showStep("apps");
        setHubSection("apps");
        setStatus("statusIdle", null);
      }

      function updateUserUi() {
        if (!currentUser) {
          userNameLabel.textContent = "";
          return;
        }
        var suffix = " Â· " + (currentUser.mobile || "");
        var greetName =
          currentLang === "ar"
            ? "Ù…Ø±Ø­Ø¨Ø§Ù‹ " + (currentUser.name || "")
            : "Hi " + (currentUser.name || "");
        userNameLabel.textContent = greetName + suffix;
      }

      function renderWorkspacesDropdown() {
        if (!workspaceSelect) return;

        workspaceSelect.innerHTML = "";
        if (!workspaces || !workspaces.length) {
          var opt = document.createElement("option");
          opt.value = "";
          opt.textContent =
            currentLang === "ar"
              ? "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³Ø§Ø­Ø§Øª Ø¹Ù…Ù„"
              : "No workspaces";
          workspaceSelect.appendChild(opt);
          workspaceMeta.textContent = "";
          return;
        }

        workspaces.forEach(function (ws) {
          var opt = document.createElement("option");
          opt.value = ws.workspaceId || ws.id;
          var name = ws.name || ws.slug || opt.value;
          opt.textContent = name;
          workspaceSelect.appendChild(opt);
        });

        if (!currentWorkspaceId) {
          currentWorkspaceId = workspaces[0].workspaceId || workspaces[0].id;
        }
        workspaceSelect.value = currentWorkspaceId;

        var ws = workspaces.find(function (w) {
          return (
            w.workspaceId === currentWorkspaceId || w.id === currentWorkspaceId
          );
        });
        if (ws) {
          var meta =
            (currentLang === "ar" ? "Ø§Ù„Ø®Ø·Ø©: " : "Plan: ") +
            (ws.plan || "free");
          if (ws.role) {
            meta +=
              " Â· " +
              (currentLang === "ar" ? "Ø¯ÙˆØ±Ùƒ: " : "Role: ") +
              ws.role;
          }
          workspaceMeta.textContent = meta;
        }
      }

      function updateWorkspaceContext() {
        if (!currentWorkspaceId) {
          currentApps = [];
          renderApps();
          renderMarketplace();
          return;
        }

        // 1) Apps for this workspace (from cache)
        currentApps = allWorkspaceApps[currentWorkspaceId] || [];

        // 2) If no apps cached yet, we can fetch
        if (!currentApps.length && currentUser) {
          callHubApi("marketplace.listWorkspaceApps", {
            workspaceId: currentWorkspaceId
          })
            .then(function (res) {
              if (res && res.success && Array.isArray(res.items)) {
                allWorkspaceApps[currentWorkspaceId] = res.items;
                currentApps = res.items;
                renderApps();
              } else {
                renderApps();
              }
            })
            .catch(function (err) {
              console.error(err);
              renderApps();
            });
        } else {
          renderApps();
        }

        // 3) Marketplace templates for this workspace
        loadMarketplaceForWorkspace();
      }

      function renderApps() {
        appsListEl.innerHTML = "";
        currentAppId = null;

        appFrame.src = "";
        appFrame.classList.add("hidden");
        appFramePlaceholder.classList.remove("hidden");
        currentAppTitle.textContent = t("appPlaceholder");

        appsCard.classList.remove("hidden");
        btnHome.classList.add("hidden");
        appView.classList.add("hidden");

        if (!currentApps || !currentApps.length) {
          setStatus("statusNoApps", "error");
          btnAppsMenu.classList.add("hidden");
          appsMenuPanel.classList.add("hidden");
          appView.classList.add("hidden");
          return;
        }

        btnAppsMenu.classList.remove("hidden");
        buildAppsMenu();

        currentApps.forEach(function (app) {
          var card = document.createElement("div");
          card.className =
            "app-card" + (app.pinned ? " app-card-pinned" : "");
          card.dataset.appId = app.appId;

          var header = document.createElement("div");
          header.className = "app-card-header";

          var icon = document.createElement("div");
          icon.className = "app-card-icon";
          icon.textContent = app.iconEmoji || "â‹¯";

          var title = document.createElement("div");
          title.className = "app-card-title";
          var name =
            currentLang === "ar"
              ? app.appNameAr || app.appNameEn || app.name
              : app.appNameEn || app.appNameAr || app.name;
          title.textContent = name || app.appId;

          header.appendChild(icon);
          header.appendChild(title);

          var body = document.createElement("div");
          body.className = "app-card-body";
          var desc =
            currentLang === "ar"
              ? app.descriptionAr || app.descriptionEn || app.description
              : app.descriptionEn || app.descriptionAr || app.description;
          body.textContent = desc || "";

          var footer = document.createElement("div");
          footer.className = "app-card-footer";

          var catSpan = document.createElement("span");
          catSpan.textContent = app.category || "";

          var pinnedSpan = document.createElement("span");
          if (app.pinned) {
            pinnedSpan.className = "badge-pinned";
            pinnedSpan.textContent =
              currentLang === "ar" ? "Ù…Ø«Ø¨Ù‘Øª" : "Pinned";
          }

          footer.appendChild(catSpan);
          if (app.pinned) footer.appendChild(pinnedSpan);

          card.appendChild(header);
          card.appendChild(body);
          card.appendChild(footer);

          card.addEventListener("click", function () {
            openAppFromHome(app);
          });

          appsListEl.appendChild(card);
        });

        setStatus("statusIdle", null);
      }

      function buildAppsMenu() {
        appsMenuPanel.innerHTML = "";
        if (!currentApps || !currentApps.length) return;

        currentApps.forEach(function (app) {
          var item = document.createElement("button");
          item.type = "button";
          item.className = "apps-menu-item";
          item.dataset.appId = app.appId;

          var left = document.createElement("div");
          left.style.display = "flex";
          left.style.flexDirection = "column";
          left.style.gap = "2px";
          left.style.flex = "1";

          var title = document.createElement("div");
          title.className = "apps-menu-item-title";
          var name =
            currentLang === "ar"
              ? app.appNameAr || app.appNameEn || app.name
              : app.appNameEn || app.appNameAr || app.name;
          title.textContent = name || app.appId;

          var cat = document.createElement("div");
          cat.className = "apps-menu-item-cat";
          cat.textContent = app.category || "";

          left.appendChild(title);
          left.appendChild(cat);

          var dot = document.createElement("div");
          dot.style.width = "8px";
          dot.style.height = "8px";
          dot.style.borderRadius = "999px";
          dot.style.background = app.pinned
            ? "rgba(250,204,21,0.95)"
            : "rgba(34,197,94,0.9)";

          item.appendChild(left);
          item.appendChild(dot);

          item.addEventListener("click", function (e) {
            e.stopPropagation();
            openApp(app);
            appsMenuPanel.classList.add("hidden");
          });

          appsMenuPanel.appendChild(item);
        });

        updateAppsMenuActiveState();
      }

      function updateAppsMenuActiveState() {
        var items = appsMenuPanel.querySelectorAll(".apps-menu-item");
        items.forEach(function (item) {
          if (item.dataset.appId === currentAppId) {
            item.classList.add("active");
          } else {
            item.classList.remove("active");
          }
        });
      }

      function openAppFromHome(app) {
        appsCard.classList.add("hidden");
        btnHome.classList.remove("hidden");
        appView.classList.remove("hidden");
        openApp(app);
      }

      function openApp(app) {
        if (!app || !currentUser) return;
        currentAppId = app.appId;

        var name =
          currentLang === "ar"
            ? app.appNameAr || app.appNameEn || app.name
            : app.appNameEn || app.appNameAr || app.name;
        currentAppTitle.textContent = name || "";

        var base = (app.baseUrl || "").trim();
        if (!base) return;
        var sep = base.indexOf("?") === -1 ? "?" : "&";
        // For now: pass userId as appid in query
        var finalUrl =
          base + sep + "appid=" + encodeURIComponent(currentUser.userId);

        appFramePlaceholder.classList.add("hidden");
        appFrame.classList.remove("hidden");
        appFrame.src = finalUrl;

        btnHome.classList.remove("hidden");
        appView.classList.remove("hidden");
        updateAppsMenuActiveState();
      }

      function goHome() {
        if (!currentApps || !currentApps.length) return;

        appsCard.classList.remove("hidden");

        appFrame.classList.add("hidden");
        appFramePlaceholder.classList.remove("hidden");
        currentAppTitle.textContent = t("appPlaceholder");
        currentAppId = null;
        updateAppsMenuActiveState();

        appView.classList.add("hidden");
      }

      function logout() {
        var key = currentSessionKey;
        currentSessionKey = null;
        localStorage.removeItem(STORAGE_SESSION_KEY);
        currentUser = null;
        workspaces = [];
        currentWorkspaceId = null;
        allWorkspaceApps = {};
        marketplaceTemplates = [];
        currentApps = [];
        currentAppId = null;

        appFrame.src = "";
        appFrame.classList.add("hidden");
        appFramePlaceholder.classList.remove("hidden");
        currentAppTitle.textContent = t("appPlaceholder");
        appsListEl.innerHTML = "";
        appsCard.classList.remove("hidden");
        btnAppsMenu.classList.add("hidden");
        appsMenuPanel.classList.add("hidden");
        btnHome.classList.add("hidden");
        appView.classList.add("hidden");

        marketplaceAppsList.innerHTML = "";
        marketplaceModulesList.innerHTML = "";

        workspaceSelect.innerHTML = "";
        workspaceMeta.textContent = "";

        if (welcomeCard) welcomeCard.classList.remove("hidden");

        setHubSection("apps");
        setStatus("statusIdle", null);
        showStep("mobile");

        if (!key) return;
        // optional backend logout
        callHubApi("auth.logout", { sessionKey: key }).catch(function () {});
      }

      function setHubSection(section) {
        currentSection = section;

        // nav active states
        [navYourApps, navMarketplace, navGift].forEach(function (btn) {
          if (btn.dataset.section === section) btn.classList.add("active");
          else btn.classList.remove("active");
        });

        // show one section only
        if (section === "apps") {
          appsSection.classList.remove("hidden");
          marketplaceSection.classList.add("hidden");
          giftSection.classList.add("hidden");
        } else if (section === "marketplace") {
          appsSection.classList.add("hidden");
          marketplaceSection.classList.remove("hidden");
          giftSection.classList.add("hidden");
        } else if (section === "gift") {
          appsSection.classList.add("hidden");
          marketplaceSection.classList.add("hidden");
          giftSection.classList.remove("hidden");
        }
      }

      function loadMarketplaceForWorkspace() {
        if (!currentWorkspaceId) {
          marketplaceTemplates = [];
          renderMarketplace();
          return;
        }

        callHubApi("marketplace.listTemplates", {
          workspaceId: currentWorkspaceId
        })
          .then(function (res) {
            if (res && res.success && Array.isArray(res.items)) {
              marketplaceTemplates = res.items;
            } else {
              marketplaceTemplates = [];
            }
            renderMarketplace();
          })
          .catch(function (err) {
            console.error(err);
            marketplaceTemplates = [];
            renderMarketplace();
          });
      }

      function renderMarketplace() {
        marketplaceAppsList.innerHTML = "";
        marketplaceModulesList.innerHTML = "";

        if (!marketplaceTemplates || !marketplaceTemplates.length) {
          var emptyText =
            currentLang === "ar"
              ? "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± Ù…ØªØ§Ø­Ø© ÙÙŠ Ø§Ù„Ù…ØªØ¬Ø±."
              : "No items available in the marketplace.";
          var p1 = document.createElement("div");
          p1.textContent = emptyText;
          p1.style.fontSize = "12px";
          p1.style.opacity = "0.8";
          marketplaceAppsList.appendChild(p1);
          return;
        }

        var apps = [];
        var modules = [];

        marketplaceTemplates.forEach(function (tpl) {
          var type =
            tpl.templateType || tpl.type || (tpl.isModule ? "module" : "app");
          if (type === "module" || type === "MODULE") {
            modules.push(tpl);
          } else {
            apps.push(tpl);
          }
        });

        if (!apps.length) {
          var emptyApps = document.createElement("div");
          emptyApps.style.fontSize = "12px";
          emptyApps.style.opacity = "0.8";
          emptyApps.textContent =
            currentLang === "ar"
              ? "Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ù…Ù†ÙØ±Ø¯Ø©."
              : "No single apps.";
          marketplaceAppsList.appendChild(emptyApps);
        } else {
          apps.forEach(function (tpl) {
            marketplaceAppsList.appendChild(
              buildMarketplaceItem(tpl, "app")
            );
          });
        }

        if (!modules.length) {
          var emptyModules = document.createElement("div");
          emptyModules.style.fontSize = "12px";
          emptyModules.style.opacity = "0.8";
          emptyModules.textContent =
            currentLang === "ar"
              ? "Ù„Ø§ ØªÙˆØ¬Ø¯ Modules Ù…ØªØ§Ø­Ø©."
              : "No Modules available.";
          marketplaceModulesList.appendChild(emptyModules);
        } else {
          modules.forEach(function (tpl) {
            marketplaceModulesList.appendChild(
              buildMarketplaceItem(tpl, "module")
            );
          });
        }
      }

      function buildMarketplaceItem(tpl, kind) {
        var root = document.createElement("div");
        root.className = "marketplace-item";

        var header = document.createElement("div");
        header.className = "marketplace-item-header";

        var title = document.createElement("div");
        title.className = "marketplace-item-title";
        title.textContent = tpl.name || tpl.templateId;

        var typeBadge = document.createElement("div");
        typeBadge.className = "badge-type";
        typeBadge.textContent =
          kind === "module"
            ? currentLang === "ar"
              ? "Module"
              : "Module"
            : currentLang === "ar"
            ? "App"
            : "App";

        header.appendChild(title);
        header.appendChild(typeBadge);

        var body = document.createElement("div");
        body.style.fontSize = "11px";
        body.style.opacity = "0.8";
        body.textContent = tpl.shortDesc || tpl.description || "";

        var tags = document.createElement("div");
        tags.className = "marketplace-item-tags";
        tags.textContent = tpl.featureTags || "";

        var footer = document.createElement("div");
        footer.className = "marketplace-item-footer";

        var plan = document.createElement("span");
        plan.textContent =
          (currentLang === "ar" ? "Ø§Ù„Ø®Ø·Ø©: " : "Plan: ") +
          (tpl.planRequired || "any");

        var btn = document.createElement("button");
        btn.type = "button";
        btn.className = "btn btn-primary";
        btn.style.fontSize = "11px";
        btn.style.padding = "4px 10px";
        btn.textContent =
          kind === "module" ? t("btnInstallModule") : t("btnInstallApp");

        btn.addEventListener("click", function () {
          installTemplate(tpl, kind, btn);
        });

        footer.appendChild(plan);
        footer.appendChild(btn);

        root.appendChild(header);
        root.appendChild(body);
        if (tpl.featureTags) root.appendChild(tags);
        root.appendChild(footer);

        return root;
      }

      function installTemplate(tpl, kind, btnEl) {
        if (!currentWorkspaceId || !currentUser) return;

        var payload = {
          workspaceId: currentWorkspaceId,
          templateId: tpl.templateId || tpl.id,
          name: tpl.name,
          userId: currentUser.userId
        };

        var action =
          kind === "module"
            ? "marketplace.installModule"
            : "marketplace.installApp";

        btnEl.disabled = true;
        var originalText = btnEl.textContent;
        btnEl.textContent = t("statusInstalling");
        setStatus("statusInstalling", null);

        callHubApi(action, payload)
          .then(function (res) {
            if (!res || !res.success) {
              var msg =
                (res && res.error) ||
                (currentLang === "ar"
                  ? "ÙØ´Ù„ Ø§Ù„ØªØ«Ø¨ÙŠØª."
                  : "Install failed.");
              setStatus(msg, "error");
              return;
            }

            setStatus("statusInstalled", "ok");

            // refresh apps for this workspace
            updateWorkspaceContext();
          })
          .catch(function (err) {
            console.error(err);
            setStatus("statusError", "error");
          })
          .finally(function () {
            btnEl.disabled = false;
            btnEl.textContent = originalText;
          });
      }

      // Events
      btnSendOtp.addEventListener("click", sendOtp);
      mobileInput.addEventListener("keydown", function (e) {
        if (e.key === "Enter") {
          e.preventDefault();
          sendOtp();
        }
      });

      btnVerifyOtp.addEventListener("click", verifyOtp);

      btnChangeMobile.addEventListener("click", function () {
        showStep("mobile");
        setStatus("statusIdle", null);
      });

      btnLogout.addEventListener("click", logout);

      btnTheme.addEventListener("click", function () {
        currentTheme = currentTheme === "light" ? "dark" : "light";
        localStorage.setItem(STORAGE_THEME, currentTheme);
        applyTheme();
      });

      btnLangAr.addEventListener("click", function () {
        currentLang = "ar";
        localStorage.setItem(STORAGE_LANG, currentLang);
        applyLanguage();
        setStatus("statusIdle", null);
      });

      btnLangEn.addEventListener("click", function () {
        currentLang = "en";
        localStorage.setItem(STORAGE_LANG, currentLang);
        applyLanguage();
        setStatus("statusIdle", null);
      });

      btnAppsMenu.addEventListener("click", function (e) {
        e.stopPropagation();
        if (appsMenuPanel.classList.contains("hidden")) {
          buildAppsMenu();
          appsMenuPanel.classList.remove("hidden");
        } else {
          appsMenuPanel.classList.add("hidden");
        }
      });

      document.addEventListener("click", function () {
        appsMenuPanel.classList.add("hidden");
      });

      appsMenuPanel.addEventListener("click", function (e) {
        e.stopPropagation();
      });

      btnHome.addEventListener("click", function (e) {
        e.stopPropagation();
        goHome();
      });

      workspaceSelect.addEventListener("change", function () {
        currentWorkspaceId = workspaceSelect.value || null;
        renderWorkspacesDropdown();
        updateWorkspaceContext();
      });

      navYourApps.addEventListener("click", function () {
        setHubSection("apps");
      });
      navMarketplace.addEventListener("click", function () {
        setHubSection("marketplace");
      });
      navGift.addEventListener("click", function () {
        setHubSection("gift");
      });

      // Init
      applyTheme();
      applyLanguage();
      setStatus("statusIdle", null);
      showStep("mobile");

      // Optional: resume session
      if (currentSessionKey) {
        callHubApi("auth.me", { sessionKey: currentSessionKey })
          .then(function (res) {
            if (!res || !res.success) {
              throw new Error("Session invalid");
            }
            handleLoginSuccess(res);
          })
          .catch(function () {
            currentSessionKey = null;
            localStorage.removeItem(STORAGE_SESSION_KEY);
            showStep("mobile");
            setStatus("statusIdle", null);
          });
      }
    })();
  </script>
</body>
</html>
