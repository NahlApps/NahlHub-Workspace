<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NahlHub â€“ Hub</title>

  <style>
    :root {
      --bg: #f3f4f6;
      --card: #ffffff;
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --border: #e5e7eb;
      --text: #111827;
      --muted: #6b7280;
      --danger: #b91c1c;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    header {
      background: #0f172a;
      color: #f9fafb;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    header .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 700;
      font-size: 18px;
    }

    header .brand span {
      opacity: 0.9;
      font-size: 13px;
      font-weight: 400;
    }

    header .user-info {
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    header .user-info button {
      background: transparent;
      border: 1px solid #f9fafb33;
      border-radius: 999px;
      color: #f9fafb;
      padding: 4px 10px;
      font-size: 12px;
      cursor: pointer;
    }

    header .user-info button:hover {
      background: #f9fafb11;
    }

    main {
      max-width: 1120px;
      margin: 24px auto;
      padding: 0 16px 40px;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 2fr);
      gap: 20px;
    }

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: var(--card);
      border-radius: 16px;
      border: 1px solid var(--border);
      padding: 16px 18px 18px;
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.06);
    }

    .card h2 {
      font-size: 18px;
      margin: 0 0 4px;
    }

    .card p.sub {
      margin: 0 0 12px;
      font-size: 13px;
      color: var(--muted);
    }

    label {
      display: block;
      font-size: 13px;
      margin-bottom: 4px;
    }

    input[type="text"],
    input[type="tel"],
    input[type="number"],
    input[type="email"] {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      font-size: 14px;
      outline: none;
    }

    input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.2);
    }

    button.primary {
      background: var(--primary);
      color: #ffffff;
      border-radius: 999px;
      padding: 8px 16px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    button.primary:hover {
      background: var(--primary-dark);
    }

    button.secondary {
      background: transparent;
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 7px 14px;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    button.secondary:hover {
      background: #f9fafb;
    }

    button:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .row {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .row.space {
      justify-content: space-between;
    }

    .mt-8 {
      margin-top: 8px;
    }

    .mt-12 {
      margin-top: 12px;
    }

    .mt-16 {
      margin-top: 16px;
    }

    .small {
      font-size: 12px;
      color: var(--muted);
    }

    .status {
      font-size: 13px;
      margin-top: 8px;
    }

    .status.error {
      color: var(--danger);
    }

    .status.ok {
      color: #15803d;
    }

    .hidden {
      display: none !important;
    }

    .stepper {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 12px;
      font-size: 12px;
      color: var(--muted);
    }

    .stepper span.badge {
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
    }

    .stepper span.badge.active {
      border-color: var(--primary);
      color: var(--primary);
      background: rgba(37, 99, 235, 0.07);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: #eff6ff;
      color: #1d4ed8;
      font-size: 12px;
    }

    .section-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .workspace-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 260px;
      overflow-y: auto;
      margin-top: 6px;
    }

    .workspace-item {
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      cursor: pointer;
      font-size: 13px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .workspace-item span.slug {
      color: var(--muted);
      font-size: 12px;
    }

    .workspace-item.active {
      border-color: var(--primary);
      background: #eff6ff;
    }

    .workspace-item .tag {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #e5e7eb;
      color: #374151;
    }

    .apps-list,
    .templates-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 260px;
      overflow-y: auto;
    }

    .app-card,
    .tpl-card {
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 8px 10px;
      font-size: 13px;
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }

    .app-card h3,
    .tpl-card h3 {
      margin: 0 0 4px;
      font-size: 13px;
    }

    .app-card p,
    .tpl-card p {
      margin: 0;
      font-size: 12px;
      color: var(--muted);
    }

    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 4px;
    }

    .chip {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
    }

    .label-muted {
      font-size: 11px;
      color: var(--muted);
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      ğŸ NahlHub
      <span>Hub â€“ Workspaces & Apps</span>
    </div>
    <div class="user-info" id="headerUserInfo" style="display:none;">
      <span id="headerUserName"></span>
      <span id="headerUserMobile" class="small"></span>
      <button type="button" id="btnLogout">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
    </div>
  </header>

  <main>
    <!-- Auth Section -->
    <section id="authSection" class="card">
      <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</h2>
      <p class="sub">
        Ø§Ø³ØªØ®Ø¯Ù… Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„Ùƒ Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨ØŒ Ø¨Ø¯ÙˆÙ† ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±.
      </p>

      <div class="stepper">
        <span class="badge active" id="stepBadge1">1. Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</span>
        <span>â€º</span>
        <span class="badge" id="stepBadge2">2. Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚</span>
      </div>

      <div id="step1">
        <label for="mobileInput">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ (Ù…Ø«Ø§Ù„: 5xxxxxxxx)</label>
        <input
          type="tel"
          id="mobileInput"
          placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„Ùƒ"
          autocomplete="tel"
        />
        <div class="row space mt-8">
          <button class="primary" id="btnSendOtp">
            Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨
          </button>
          <span class="small">Ø³ÙŠØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø¨Ø± Green API Ø§Ù„Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø­Ø³Ø§Ø¨.</span>
        </div>
        <div id="sendOtpStatus" class="status"></div>
      </div>

      <div id="step2" class="mt-16 hidden">
        <label for="otpInput">Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù…ÙƒÙˆÙ† Ù…Ù† 4 Ø£Ø±Ù‚Ø§Ù…</label>
        <input
          type="text"
          id="otpInput"
          maxlength="4"
          placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø²"
        />
        <div class="row space mt-8">
          <div class="row" style="gap:6px;">
            <button class="primary" id="btnVerifyOtp">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø±Ù…Ø² ÙˆØ§Ù„Ø¯Ø®ÙˆÙ„</button>
            <button class="secondary" id="btnBackToMobile">ØªØ¹Ø¯ÙŠÙ„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</button>
          </div>
          <span class="small">ÙŠÙ†ØªÙ‡ÙŠ Ø§Ù„Ø±Ù…Ø² Ø¨Ø¹Ø¯ Ù¡Ù  Ø¯Ù‚Ø§Ø¦Ù‚.</span>
        </div>
        <div id="verifyOtpStatus" class="status"></div>
      </div>
    </section>

    <!-- App Section -->
    <section id="appSection" class="layout hidden">
      <!-- Left: Workspaces -->
      <div class="card">
        <div class="row space">
          <div>
            <div class="section-title">Ù…Ø³Ø§Ø­Ø§Øª Ø§Ù„Ø¹Ù…Ù„ (Workspaces)</div>
            <p class="sub">Ø£Ù†Ø´Ø¦ Ù…Ø³Ø§Ø­Ø© Ø¹Ù…Ù„ Ù„ÙƒÙ„ Ù…Ø´Ø±ÙˆØ¹ Ø£Ùˆ ÙØ±ÙŠÙ‚.</p>
          </div>
          <span class="pill" id="userPill">
            Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ
          </span>
        </div>

        <div class="mt-8">
          <label>Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³Ø§Ø­Ø© Ø¹Ù…Ù„ Ø¬Ø¯ÙŠØ¯Ø©</label>
          <div class="row mt-4">
            <input
              type="text"
              id="workspaceNameInput"
              placeholder="Ù…Ø«Ø§Ù„: Nahl Studio / Sponge & Soap / Client ABC"
            />
            <button class="primary" id="btnCreateWorkspace">Ø¥Ù†Ø´Ø§Ø¡</button>
          </div>
          <div id="workspaceCreateStatus" class="status small"></div>
        </div>

        <div class="mt-16">
          <div class="row space">
            <span class="section-title">Ù…Ø³Ø§Ø­Ø§ØªÙŠ</span>
            <span class="label-muted" id="workspaceCountLabel">0 Ù…Ø³Ø§Ø­Ø©</span>
          </div>
          <div class="workspace-list" id="workspaceList"></div>
          <div id="workspaceListStatus" class="status small"></div>
        </div>
      </div>

      <!-- Right: Apps + Marketplace -->
      <div class="card">
        <div class="row space">
          <div>
            <div class="section-title">Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª & Ø§Ù„Ø³ÙˆÙ‚</div>
            <p class="sub" id="workspaceTitle">Ø§Ø®ØªØ± Ù…Ø³Ø§Ø­Ø© Ø¹Ù…Ù„ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙŠÙ…Ù†Ù‰.</p>
          </div>
          <div class="chips">
            <span class="chip">AppCatalog</span>
            <span class="chip">Modules</span>
          </div>
        </div>

        <div class="mt-12">
          <div class="section-title">Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ù…Ø«Ø¨ØªØ© ÙÙŠ Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„</div>
          <div class="apps-list" id="workspaceAppsList"></div>
          <div id="workspaceAppsStatus" class="status small"></div>
        </div>

        <div class="mt-16">
          <div class="section-title">Ø§Ù„Ø³ÙˆÙ‚ â€“ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª & Ø§Ù„Ù€ Modules</div>
          <p class="small">
            Ø§Ø®ØªØ± ØªØ·Ø¨ÙŠÙ‚ Ø£Ùˆ Module Ø«Ù… Ø§Ø¶ØºØ· "ØªØ«Ø¨ÙŠØª ÙÙŠ Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„".
          </p>
          <div class="templates-list" id="templatesList"></div>
          <div id="templatesStatus" class="status small"></div>
        </div>
      </div>
    </section>
  </main>

  <script>
    const API_URL = "/api/hub/manage"; // Vercel API â†’ Apps Script proxy

    let sessionKey = null;
    let currentUser = null;
    let currentWorkspaceId = null;

    // -------------------------------------------------------------
    // Generic API helper
    // -------------------------------------------------------------
    async function hubApi(action, payload = {}) {
      const body = { action, ...payload };
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });

      let data;
      const text = await res.text();
      try {
        data = JSON.parse(text);
      } catch (err) {
        console.error("Non-JSON response from API:", text);
        throw new Error("Server returned invalid JSON");
      }

      if (!res.ok) {
        const msg =
          (data && (data.error || data.message)) ||
          `HTTP ${res.status}`;
        throw new Error(msg);
      }

      return data;
    }

    // -------------------------------------------------------------
    // UI helpers
    // -------------------------------------------------------------
    function showAuthSection() {
      document.getElementById("authSection").classList.remove("hidden");
      document.getElementById("appSection").classList.add("hidden");
      document.getElementById("headerUserInfo").style.display = "none";
    }

    function showAppSection() {
      document.getElementById("authSection").classList.add("hidden");
      document.getElementById("appSection").classList.remove("hidden");
      document.getElementById("headerUserInfo").style.display = "flex";
    }

    function setStep(step) {
      const b1 = document.getElementById("stepBadge1");
      const b2 = document.getElementById("stepBadge2");
      const s1 = document.getElementById("step1");
      const s2 = document.getElementById("step2");

      if (step === 1) {
        b1.classList.add("active");
        b2.classList.remove("active");
        s1.classList.remove("hidden");
        s2.classList.add("hidden");
      } else {
        b1.classList.remove("active");
        b2.classList.add("active");
        s1.classList.add("hidden");
        s2.classList.remove("hidden");
      }
    }

    function setStatus(id, msg, type = "info") {
      const el = document.getElementById(id);
      if (!el) return;
      el.textContent = msg || "";
      el.classList.remove("error", "ok");
      if (type === "error") el.classList.add("error");
      if (type === "ok") el.classList.add("ok");
    }

    function setLoading(button, isLoading, textWhenLoading, textNormal) {
      if (!button) return;
      button.disabled = isLoading;
      if (isLoading) {
        button.dataset.originalText = textNormal || button.textContent.trim();
        button.textContent = textWhenLoading || "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°...";
      } else {
        button.textContent =
          textNormal || button.dataset.originalText || button.textContent;
      }
    }

    // -------------------------------------------------------------
    // Auth: send OTP
    // -------------------------------------------------------------
    async function onSendOtp() {
      const mobileInput = document.getElementById("mobileInput");
      const mobile = (mobileInput.value || "").trim();
      const btn = document.getElementById("btnSendOtp");

      setStatus("sendOtpStatus", "");
      if (!mobile) {
        setStatus("sendOtpStatus", "Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„.", "error");
        return;
      }

      try {
        setLoading(btn, true, "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...", "Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨");
        const resp = await hubApi("sendOtp", { mobile });
        if (!resp.success) {
          setStatus(
            "sendOtpStatus",
            resp.error || "ØªØ¹Ø°Ø± Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„.",
            "error"
          );
          return;
        }
        setStatus(
          "sendOtpStatus",
          "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ù…Ø². Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨ Ø®Ù„Ø§Ù„ Ù„Ø­Ø¸Ø§Øª.",
          "ok"
        );
        setStep(2);
        document.getElementById("otpInput").focus();
      } catch (err) {
        console.error("sendOtp error:", err);
        setStatus(
          "sendOtpStatus",
          err.message || "Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø².",
          "error"
        );
      } finally {
        setLoading(btn, false, "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...", "Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨");
      }
    }

    // -------------------------------------------------------------
    // Auth: verify OTP
    // -------------------------------------------------------------
    async function onVerifyOtp() {
      const mobile = (document.getElementById("mobileInput").value || "").trim();
      const otp = (document.getElementById("otpInput").value || "").trim();
      const btn = document.getElementById("btnVerifyOtp");

      setStatus("verifyOtpStatus", "");
      if (!mobile || !otp) {
        setStatus(
          "verifyOtpStatus",
          "Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ ÙˆØ§Ù„Ø±Ù…Ø².",
          "error"
        );
        return;
      }

      try {
        setLoading(btn, true, "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...", "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø±Ù…Ø² ÙˆØ§Ù„Ø¯Ø®ÙˆÙ„");
        const resp = await hubApi("verifyOtp", { mobile, otp });
        if (!resp.success) {
          setStatus(
            "verifyOtpStatus",
            resp.error || "Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ Ù…Ù†ØªÙ‡ÙŠ.",
            "error"
          );
          return;
        }

        // Save session & user
        sessionKey = resp.sessionKey;
        currentUser = resp.user || null;
        if (sessionKey) {
          localStorage.setItem("nh_sessionKey", sessionKey);
        }

        setStatus(
          "verifyOtpStatus",
          "ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ù†Ø¬Ø§Ø­. ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ø³Ø§Ø­Ø§Øª Ø§Ù„Ø¹Ù…Ù„...",
          "ok"
        );

        // Load full session via auth.me (gets apps, etc.)
        await loadSessionViaMe();
      } catch (err) {
        console.error("verifyOtp error:", err);
        setStatus(
          "verifyOtpStatus",
          err.message || "Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚.",
          "error"
        );
      } finally {
        setLoading(btn, false, "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...", "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø±Ù…Ø² ÙˆØ§Ù„Ø¯Ø®ÙˆÙ„");
      }
    }

    async function loadSessionViaMe() {
      if (!sessionKey) return;
      try {
        const resp = await hubApi("auth.me", { sessionKey });
        if (!resp.success) {
          console.warn("auth.me failed:", resp.error);
          // If session invalid, go back to login
          localStorage.removeItem("nh_sessionKey");
          sessionKey = null;
          currentUser = null;
          showAuthSection();
          return;
        }

        currentUser = resp.user || currentUser;
        // Update header
        updateHeaderUser();

        // Show app section
        showAppSection();
        // Load workspaces for user
        if (currentUser && currentUser.userId) {
          await loadWorkspaces(currentUser.userId);
        }
      } catch (err) {
        console.error("auth.me error:", err);
        showAuthSection();
      }
    }

    function updateHeaderUser() {
      const name = (currentUser && currentUser.name) || "Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…";
      const mobile = currentUser && currentUser.mobile ? currentUser.mobile : "";
      document.getElementById("headerUserName").textContent = name;
      document.getElementById("headerUserMobile").textContent = mobile
        ? "ğŸ“± " + mobile
        : "";
      document.getElementById("userPill").textContent = name;
    }

    // -------------------------------------------------------------
    // Logout
    // -------------------------------------------------------------
    async function onLogout() {
      try {
        const key = sessionKey || localStorage.getItem("nh_sessionKey");
        if (key) {
          await hubApi("auth.logout", { sessionKey: key });
        }
      } catch (err) {
        console.warn("logout error:", err);
      }
      sessionKey = null;
      currentUser = null;
      currentWorkspaceId = null;
      localStorage.removeItem("nh_sessionKey");
      showAuthSection();
    }

    // -------------------------------------------------------------
    // Workspaces
    // -------------------------------------------------------------
    async function loadWorkspaces(userId) {
      setStatus("workspaceListStatus", "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ø³Ø§Ø­Ø§Øª Ø§Ù„Ø¹Ù…Ù„...");
      try {
        const resp = await hubApi("workspace.listForUser", { userId });
        if (!resp.success) {
          setStatus(
            "workspaceListStatus",
            resp.error || "ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù…Ø³Ø§Ø­Ø§Øª Ø§Ù„Ø¹Ù…Ù„.",
            "error"
          );
          return;
        }

        const items = resp.items || [];
        renderWorkspaceList(items);
        setStatus(
          "workspaceListStatus",
          items.length
            ? "Ø§Ø®ØªØ± Ù…Ø³Ø§Ø­Ø© Ø¹Ù…Ù„ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©."
            : "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³Ø§Ø­Ø§Øª Ø¹Ù…Ù„ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†. Ø£Ù†Ø´Ø¦ Ø£ÙˆÙ„ Ù…Ø³Ø§Ø­Ø© Ø¹Ù…Ù„.",
          "ok"
        );
      } catch (err) {
        console.error("loadWorkspaces error:", err);
        setStatus(
          "workspaceListStatus",
          err.message || "Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø­Ø§Øª.",
          "error"
        );
      }
    }

    function renderWorkspaceList(items) {
      const container = document.getElementById("workspaceList");
      container.innerHTML = "";
      const countLabel = document.getElementById("workspaceCountLabel");
      countLabel.textContent = items.length + " Ù…Ø³Ø§Ø­Ø©";

      if (!items.length) {
        return;
      }

      items.forEach((ws) => {
        const div = document.createElement("div");
        div.className = "workspace-item";
        div.dataset.workspaceId = ws.workspaceId;

        if (ws.workspaceId === currentWorkspaceId) {
          div.classList.add("active");
        }

        const left = document.createElement("div");
        const nameEl = document.createElement("div");
        nameEl.textContent = ws.name;
        const slugEl = document.createElement("div");
        slugEl.className = "slug";
        slugEl.textContent =
          (ws.slug ? ws.slug + " Â· " : "") + (ws.plan || "free");

        left.appendChild(nameEl);
        left.appendChild(slugEl);

        const tag = document.createElement("span");
        tag.className = "tag";
        tag.textContent = ws.role === "admin" ? "Admin" : "Member";

        div.appendChild(left);
        div.appendChild(tag);

        div.addEventListener("click", () => {
          selectWorkspace(ws.workspaceId, ws.name);
        });

        container.appendChild(div);
      });

      // If no workspace selected yet, pick first
      if (!currentWorkspaceId && items[0]) {
        selectWorkspace(items[0].workspaceId, items[0].name);
      }
    }

    async function onCreateWorkspace() {
      if (!currentUser || !currentUser.userId) {
        setStatus(
          "workspaceCreateStatus",
          "Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.",
          "error"
        );
        return;
      }

      const input = document.getElementById("workspaceNameInput");
      const name = (input.value || "").trim();
      const btn = document.getElementById("btnCreateWorkspace");

      setStatus("workspaceCreateStatus", "");
      if (!name) {
        setStatus(
          "workspaceCreateStatus",
          "Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„.",
          "error"
        );
        return;
      }

      try {
        setLoading(btn, true, "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡...", "Ø¥Ù†Ø´Ø§Ø¡");
        const resp = await hubApi("workspace.create", {
          userId: currentUser.userId,
          name,
        });

        if (!resp.success) {
          setStatus(
            "workspaceCreateStatus",
            resp.error || "ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„.",
            "error"
          );
          return;
        }

        setStatus(
          "workspaceCreateStatus",
          "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­.",
          "ok"
        );
        input.value = "";

        // Reload workspaces
        await loadWorkspaces(currentUser.userId);
      } catch (err) {
        console.error("workspace.create error:", err);
        setStatus(
          "workspaceCreateStatus",
          err.message || "Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³Ø§Ø­Ø©.",
          "error"
        );
      } finally {
        setLoading(btn, false, "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡...", "Ø¥Ù†Ø´Ø§Ø¡");
      }
    }

    async function selectWorkspace(workspaceId, workspaceName) {
      currentWorkspaceId = workspaceId;

      // update selected style
      Array.from(
        document.querySelectorAll(".workspace-item")
      ).forEach((el) => {
        el.classList.toggle(
          "active",
          el.dataset.workspaceId === workspaceId
        );
      });

      document.getElementById("workspaceTitle").textContent =
        "Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠØ©: " + (workspaceName || workspaceId);

      // load apps & templates
      await loadWorkspaceApps(workspaceId);
      await loadTemplates(workspaceId);
    }

    // -------------------------------------------------------------
    // Workspace Apps
    // -------------------------------------------------------------
    async function loadWorkspaceApps(workspaceId) {
      if (!workspaceId) return;
      setStatus("workspaceAppsStatus", "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª...");
      const container = document.getElementById("workspaceAppsList");
      container.innerHTML = "";

      try {
        const resp = await hubApi("marketplace.listWorkspaceApps", {
          workspaceId,
        });
        if (!resp.success) {
          setStatus(
            "workspaceAppsStatus",
            resp.error || "ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª.",
            "error"
          );
          return;
        }

        const items = resp.items || [];
        if (!items.length) {
          setStatus(
            "workspaceAppsStatus",
            "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ù…Ø«Ø¨ØªØ© ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø³Ø§Ø­Ø©.",
            "info"
          );
          return;
        }

        items.forEach((app) => {
          const card = document.createElement("div");
          card.className = "app-card";

          const left = document.createElement("div");
          const title = document.createElement("h3");
          title.textContent = app.nameAr || app.nameEn || app.templateId;
          const desc = document.createElement("p");
          desc.textContent =
            "Template: " +
            (app.templateId || "") +
            " Â· Status: " +
            (app.status || "");

          left.appendChild(title);
          left.appendChild(desc);

          const right = document.createElement("div");
          right.className = "chips";
          const chip = document.createElement("span");
          chip.className = "chip";
          chip.textContent = app.visibleInHub === "Yes" ? "Visible" : "Hidden";
          right.appendChild(chip);

          card.appendChild(left);
          card.appendChild(right);

          container.appendChild(card);
        });

        setStatus(
          "workspaceAppsStatus",
          items.length + " ØªØ·Ø¨ÙŠÙ‚ Ù…Ø«Ø¨Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø³Ø§Ø­Ø©.",
          "ok"
        );
      } catch (err) {
        console.error("listWorkspaceApps error:", err);
        setStatus(
          "workspaceAppsStatus",
          err.message || "Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª.",
          "error"
        );
      }
    }

    // -------------------------------------------------------------
    // Marketplace Templates
    // -------------------------------------------------------------
    async function loadTemplates(workspaceId) {
      setStatus("templatesStatus", "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³ÙˆÙ‚...");
      const container = document.getElementById("templatesList");
      container.innerHTML = "";

      try {
        const resp = await hubApi("marketplace.listTemplates", {
          workspaceId: workspaceId || "",
        });
        if (!resp.success) {
          setStatus(
            "templatesStatus",
            resp.error || "ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³ÙˆÙ‚.",
            "error"
          );
          return;
        }

        const items = resp.items || [];
        if (!items.length) {
          setStatus(
            "templatesStatus",
            "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù‚ÙˆØ§Ù„Ø¨ Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.",
            "info"
          );
          return;
        }

        items.forEach((tpl) => {
          const card = document.createElement("div");
          card.className = "tpl-card";

          const left = document.createElement("div");
          const title = document.createElement("h3");
          title.textContent =
            tpl.nameAr || tpl.nameEn || "Template " + tpl.templateId;

          const desc = document.createElement("p");
          desc.textContent =
            (tpl.shortDescAr ||
              tpl.shortDescEn ||
              tpl.descriptionAr ||
              tpl.descriptionEn ||
              "") + "";

          const chipsRow = document.createElement("div");
          chipsRow.className = "chips";

          if (tpl.type) {
            const chipType = document.createElement("span");
            chipType.className = "chip";
            chipType.textContent =
              tpl.type === "module" ? "Module" : "App";
            chipsRow.appendChild(chipType);
          }

          if (tpl.category) {
            const chipCat = document.createElement("span");
            chipCat.className = "chip";
            chipCat.textContent = tpl.category;
            chipsRow.appendChild(chipCat);
          }

          if (tpl.planRequired) {
            const chipPlan = document.createElement("span");
            chipPlan.className = "chip";
            chipPlan.textContent = "Plan: " + tpl.planRequired;
            chipsRow.appendChild(chipPlan);
          }

          left.appendChild(title);
          if (desc.textContent) left.appendChild(desc);
          if (chipsRow.children.length) left.appendChild(chipsRow);

          const right = document.createElement("div");
          const btn = document.createElement("button");
          btn.className = "primary";
          btn.textContent = tpl.installed
            ? "Ù…Ø«Ø¨Øª ÙÙŠ Ø§Ù„Ù…Ø³Ø§Ø­Ø© âœ“"
            : "ØªØ«Ø¨ÙŠØª ÙÙŠ Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„";

          if (tpl.installed) {
            btn.disabled = true;
          }

          btn.addEventListener("click", () => {
            onInstallTemplate(tpl);
          });

          right.appendChild(btn);

          card.appendChild(left);
          card.appendChild(right);

          container.appendChild(card);
        });

        setStatus(
          "templatesStatus",
          items.length + " Ù‚Ø§Ù„Ø¨ Ù…ØªØ§Ø­ ÙÙŠ Ø§Ù„Ø³ÙˆÙ‚.",
          "ok"
        );
      } catch (err) {
        console.error("listTemplates error:", err);
        setStatus(
          "templatesStatus",
          err.message || "Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³ÙˆÙ‚.",
          "error"
        );
      }
    }

    async function onInstallTemplate(tpl) {
      if (!currentWorkspaceId) {
        setStatus(
          "templatesStatus",
          "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø³Ø§Ø­Ø© Ø¹Ù…Ù„ Ø£ÙˆÙ„Ø§Ù‹.",
          "error"
        );
        return;
      }
      if (!currentUser || !currentUser.userId) {
        setStatus(
          "templatesStatus",
          "Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬Ù„Ø³Ø©. Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.",
          "error"
        );
        return;
      }

      setStatus(
        "templatesStatus",
        "Ø¬Ø§Ø±ÙŠ ØªØ«Ø¨ÙŠØª Ø§Ù„Ù‚Ø§Ù„Ø¨ ÙÙŠ Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„...",
        "info"
      );
      try {
        const resp = await hubApi("marketplace.install", {
          workspaceId: currentWorkspaceId,
          templateId: tpl.templateId,
          userId: currentUser.userId,
        });

        if (!resp.success) {
          setStatus(
            "templatesStatus",
            resp.error || "ØªØ¹Ø°Ø± ØªØ«Ø¨ÙŠØª Ø§Ù„Ù‚Ø§Ù„Ø¨.",
            "error"
          );
          return;
        }

        setStatus(
          "templatesStatus",
          "ØªÙ… ØªØ«Ø¨ÙŠØª Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­.",
          "ok"
        );

        // Reload apps + templates to reflect "installed" state
        await loadWorkspaceApps(currentWorkspaceId);
        await loadTemplates(currentWorkspaceId);
      } catch (err) {
        console.error("install template error:", err);
        setStatus(
          "templatesStatus",
          err.message || "Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ«Ø¨ÙŠØª.",
          "error"
        );
      }
    }

    // -------------------------------------------------------------
    // Initial load (restore session if exists)
    // -------------------------------------------------------------
    async function init() {
      // Attach handlers
      document
        .getElementById("btnSendOtp")
        .addEventListener("click", onSendOtp);
      document
        .getElementById("btnVerifyOtp")
        .addEventListener("click", onVerifyOtp);
      document
        .getElementById("btnBackToMobile")
        .addEventListener("click", () => setStep(1));
      document
        .getElementById("btnCreateWorkspace")
        .addEventListener("click", onCreateWorkspace);
      document
        .getElementById("btnLogout")
        .addEventListener("click", onLogout);

      // Allow pressing Enter in OTP field
      document
        .getElementById("otpInput")
        .addEventListener("keyup", (e) => {
          if (e.key === "Enter") onVerifyOtp();
        });

      // Try to restore existing session
      const storedKey = localStorage.getItem("nh_sessionKey");
      if (storedKey) {
        sessionKey = storedKey;
        await loadSessionViaMe();
      } else {
        showAuthSection();
      }
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
