<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <title>NahlHub – Hub</title>

  <!-- Simple light theme, no heavy redesign -->
  <style>
    :root {
      --nh-bg: #f5f5f5;
      --nh-card-bg: #ffffff;
      --nh-border: #dddddd;
      --nh-primary: #01657a;
      --nh-primary-soft: #e0f4f7;
      --nh-text-main: #1f2933;
      --nh-text-muted: #6b7280;
      --nh-radius-lg: 14px;
      --nh-radius-md: 10px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: var(--nh-bg);
      color: var(--nh-text-main);
    }

    .nh-shell {
      max-width: 960px;
      margin: 0 auto;
      padding: 24px 16px 32px;
    }

    header.nh-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 18px;
    }

    .nh-header-main {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .nh-logo {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      background: var(--nh-primary-soft);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: var(--nh-primary);
      font-size: 18px;
    }

    .nh-title-block h1 {
      margin: 0;
      font-size: 20px;
    }

    .nh-title-block p {
      margin: 2px 0 0;
      font-size: 13px;
      color: var(--nh-text-muted);
    }

    .nh-session-chip {
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      color: #4b5563;
      max-width: 220px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      text-align: left;
      direction: ltr;
    }

    .nh-main-grid {
      display: grid;
      grid-template-columns: minmax(0, 320px) minmax(0, 1fr);
      gap: 16px;
      align-items: flex-start;
    }

    @media (max-width: 768px) {
      .nh-main-grid {
        grid-template-columns: minmax(0, 1fr);
      }

      header.nh-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .nh-session-chip {
        width: 100%;
      }
    }

    .nh-card {
      background: var(--nh-card-bg);
      border-radius: var(--nh-radius-lg);
      border: 1px solid var(--nh-border);
      box-shadow: 0 1px 2px rgba(15, 23, 42, 0.04);
      padding: 16px 16px 14px;
    }

    .nh-card + .nh-card {
      margin-top: 10px;
    }

    .nh-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .nh-card-title {
      font-size: 14px;
      font-weight: 600;
    }

    .nh-card-subtitle {
      font-size: 12px;
      color: var(--nh-text-muted);
      margin-top: 2px;
    }

    .nh-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      font-size: 11px;
      color: #4b5563;
      background: #f9fafb;
    }

    .nh-badge-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
    }

    .nh-badge-dot.off {
      background: #9ca3af;
    }

    .nh-label {
      display: block;
      margin-bottom: 4px;
      font-size: 12px;
      font-weight: 500;
    }

    .nh-label span {
      font-size: 11px;
      color: var(--nh-text-muted);
      font-weight: 400;
    }

    .nh-input,
    .nh-select {
      width: 100%;
      padding: 9px 10px;
      border-radius: 9px;
      border: 1px solid #d1d5db;
      font-size: 13px;
      outline: none;
      background: #ffffff;
      color: var(--nh-text-main);
    }

    .nh-input:focus,
    .nh-select:focus {
      border-color: var(--nh-primary);
      box-shadow: 0 0 0 1px rgba(1, 101, 122, 0.08);
    }

    .nh-input::placeholder {
      color: #9ca3af;
    }

    .nh-btn {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: background 0.15s ease, transform 0.05s ease,
        box-shadow 0.1s ease;
    }

    .nh-btn:disabled {
      opacity: 0.6;
      cursor: default;
      transform: none;
      box-shadow: none;
    }

    .nh-btn-primary {
      background: var(--nh-primary);
      color: #ffffff;
      box-shadow: 0 1px 4px rgba(1, 101, 122, 0.24);
    }

    .nh-btn-primary:hover:not(:disabled) {
      background: #015063;
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(1, 101, 122, 0.3);
    }

    .nh-btn-secondary {
      background: #f3f4f6;
      color: #374151;
      border: 1px solid #e5e7eb;
    }

    .nh-btn-secondary:hover:not(:disabled) {
      background: #e5e7eb;
    }

    .nh-btn-xs {
      padding: 4px 10px;
      font-size: 11px;
    }

    .nh-actions-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .nh-help-text {
      margin-top: 6px;
      font-size: 11px;
      color: var(--nh-text-muted);
      line-height: 1.5;
    }

    .nh-status {
      margin-top: 8px;
      font-size: 12px;
      padding: 6px 8px;
      border-radius: 8px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      color: #374151;
      display: none;
      white-space: pre-line;
    }

    .nh-status.ok {
      border-color: #bbf7d0;
      background: #f0fdf4;
      color: #166534;
    }

    .nh-status.err {
      border-color: #fecaca;
      background: #fef2f2;
      color: #b91c1c;
    }

    .nh-pill-tabs {
      display: inline-flex;
      padding: 3px;
      border-radius: 999px;
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
      font-size: 11px;
      gap: 2px;
    }

    .nh-pill-tabs button {
      border-radius: 999px;
      border: none;
      padding: 5px 9px;
      background: transparent;
      font-size: 11px;
      cursor: pointer;
      color: #4b5563;
    }

    .nh-pill-tabs button.active {
      background: #ffffff;
      color: #111827;
      box-shadow: 0 1px 2px rgba(15, 23, 42, 0.08);
    }

    .nh-divider {
      height: 1px;
      background: #e5e7eb;
      margin: 10px 0;
    }

    .nh-user-summary {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 12px;
      color: var(--nh-text-muted);
    }

    .nh-user-summary strong {
      color: var(--nh-text-main);
    }

    .nh-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 9px;
      font-size: 11px;
      border-radius: 999px;
      background: #eff6ff;
      color: #1d4ed8;
      border: 1px solid #bfdbfe;
    }

    /* Workspaces & apps list */

    .nh-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 8px;
      max-height: 240px;
      overflow-y: auto;
    }

    .nh-list-item {
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 12px;
    }

    .nh-list-item:hover {
      background: #f9fafb;
    }

    .nh-list-item.active {
      border-color: var(--nh-primary);
      background: #ecfeff;
    }

    .nh-list-item-title {
      font-weight: 600;
      font-size: 13px;
    }

    .nh-list-item-meta {
      font-size: 11px;
      color: var(--nh-text-muted);
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .nh-tag {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 1px 7px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      font-size: 10px;
      color: #4b5563;
      background: #f9fafb;
    }

    /* Marketplace cards */

    .nh-market-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(210px, 1fr));
      gap: 8px;
      margin-top: 8px;
    }

    .nh-market-item {
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      padding: 8px 9px;
      background: #ffffff;
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 12px;
    }

    .nh-market-title-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    .nh-market-title {
      font-weight: 600;
      font-size: 12px;
    }

    .nh-market-desc {
      font-size: 11px;
      color: var(--nh-text-muted);
      line-height: 1.5;
    }

    .nh-market-footer {
      margin-top: 4px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    .nh-empty {
      font-size: 11px;
      color: var(--nh-text-muted);
      margin-top: 6px;
    }

    .nh-section-title-line {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-top: 4px;
    }

    .nh-section-title-line h3 {
      margin: 0;
      font-size: 13px;
      font-weight: 600;
    }

    .nh-section-title-line span {
      font-size: 11px;
      color: var(--nh-text-muted);
    }

    .nh-inline-row {
      display: flex;
      gap: 6px;
      margin-top: 6px;
      flex-wrap: wrap;
    }

    .nh-inline-row > * {
      flex: 1 1 0;
      min-width: 0;
    }

    .nh-inline-row.fixed-left {
      align-items: center;
    }

    .nh-inline-row.fixed-left > :first-child {
      flex: 0 0 auto;
    }

    .nh-badge-plan {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #fef3c7;
      color: #92400e;
      border: 1px solid #fde68a;
    }

    .nh-footer-note {
      margin-top: 16px;
      font-size: 10px;
      color: #9ca3af;
      text-align: center;
    }

    .nh-footer-note a {
      color: inherit;
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="nh-shell">
    <!-- Header: Logo + title + session chip -->
    <header class="nh-header">
      <div class="nh-header-main">
        <div class="nh-logo">Nh</div>
        <div class="nh-title-block">
          <h1>NahlHub – Hub</h1>
          <p>لوحة تحكم بسيطة لتجربة المساحات والتطبيقات داخل منظومة نحل هب.</p>
        </div>
      </div>
      <div id="sessionChip" class="nh-session-chip" style="display: none;">
        session: –
      </div>
    </header>

    <div class="nh-main-grid">
      <!-- Left column: Login / auth -->
      <div>
        <!-- Login card -->
        <div class="nh-card">
          <div class="nh-card-header">
            <div>
              <div class="nh-card-title">تسجيل الدخول برقم الجوال</div>
              <div class="nh-card-subtitle">
                خطوة واحدة، رمز عبر واتساب أو SMS، بدون كلمة مرور.
              </div>
            </div>
            <div class="nh-badge" id="authStateBadge">
              <span class="nh-badge-dot off" id="authStateDot"></span>
              <span id="authStateLabel">غير مسجل</span>
            </div>
          </div>

          <label class="nh-label" for="mobileInput">
            رقم الجوال (مع أو بدون +966)
            <span>لن يتم مشاركته مع أي جهة.</span>
          </label>
          <input
            id="mobileInput"
            class="nh-input"
            type="tel"
            placeholder="مثلًا: 5xxxxxxxx أو +9665xxxxxxx"
            autocomplete="tel"
          />

          <div class="nh-actions-row">
            <button
              id="btnSendOtp"
              class="nh-btn nh-btn-primary"
              type="button"
            >
              <span>إرسال رمز التحقق</span>
            </button>
            <button
              id="btnClearAuth"
              class="nh-btn nh-btn-secondary nh-btn-xs"
              type="button"
            >
              مسح الحقول
            </button>
          </div>

          <div class="nh-help-text">
            ✳️ سيتم إنشاء حساب جديد تلقائيًا لو لم يكن لديك حساب مسبقًا.
          </div>

          <div id="otpStatus" class="nh-status"></div>
        </div>

        <!-- OTP card -->
        <div class="nh-card" id="otpCard" style="display: none;">
          <div class="nh-card-header">
            <div>
              <div class="nh-card-title">أدخل رمز التحقق</div>
              <div class="nh-card-subtitle">
                الرمز مكون من ٤ أرقام وصالح لمدة ١٠ دقائق.
              </div>
            </div>
            <div class="nh-pill-tabs">
              <button
                type="button"
                class="active"
                id="tabOtpAr"
                onclick="setLocale('ar')"
              >
                عربي
              </button>
              <button
                type="button"
                id="tabOtpEn"
                onclick="setLocale('en')"
              >
                EN
              </button>
            </div>
          </div>

          <label class="nh-label" for="otpInput">
            رمز التحقق
          </label>
          <input
            id="otpInput"
            class="nh-input"
            type="text"
            maxlength="6"
            inputmode="numeric"
            placeholder="••••"
          />

          <div class="nh-actions-row">
            <button
              id="btnVerifyOtp"
              class="nh-btn nh-btn-primary"
              type="button"
            >
              تأكيد الرمز والدخول
            </button>
            <button
              id="btnResendOtp"
              class="nh-btn nh-btn-secondary nh-btn-xs"
              type="button"
            >
              إعادة إرسال الرمز
            </button>
          </div>

          <div class="nh-help-text">
            في حال لم يصلك الرمز، انتظر قليلًا ثم جرّب إعادة الإرسال.
          </div>

          <div id="verifyStatus" class="nh-status"></div>
        </div>

        <!-- Logged-in user summary -->
        <div
          class="nh-card"
          id="userCard"
          style="display: none; margin-top: 12px;"
        >
          <div class="nh-card-header">
            <div>
              <div class="nh-card-title">بيانات الحساب الحالي</div>
              <div class="nh-card-subtitle">
                هذا الحساب مرتبط برقم الجوال الذي استخدمته في الدخول.
              </div>
            </div>
            <button
              id="btnLogout"
              class="nh-btn nh-btn-secondary nh-btn-xs"
              type="button"
            >
              تسجيل خروج
            </button>
          </div>

          <div class="nh-user-summary">
            <div>
              <strong>الاسم:</strong>
              <span id="userNameLabel">—</span>
            </div>
            <div>
              <strong>الجوال:</strong>
              <span id="userMobileLabel">—</span>
            </div>
            <div>
              <strong>المعرف:</strong>
              <span id="userIdLabel">—</span>
            </div>
          </div>

          <div class="nh-divider"></div>

          <div class="nh-help-text">
            بعد تسجيل الدخول يمكنك إدارة المساحات (Workspaces) وتركيب
            التطبيقات من المتجر.
          </div>
        </div>
      </div>

      <!-- Right column: Workspaces + Marketplace -->
      <div id="appView" style="display: none;">
        <!-- Workspaces -->
        <div class="nh-card">
          <div class="nh-card-header">
            <div>
              <div class="nh-card-title">المساحات (Workspaces)</div>
              <div class="nh-card-subtitle">
                مساحة العمل هي المكان الذي تُثبّت فيه التطبيقات والحلول.
              </div>
            </div>
            <button
              id="btnReloadWorkspaces"
              class="nh-btn nh-btn-secondary nh-btn-xs"
              type="button"
            >
              تحديث
            </button>
          </div>

          <div class="nh-inline-row">
            <div>
              <label class="nh-label" for="workspaceNameInput">
                إنشاء مساحة جديدة
              </label>
              <input
                id="workspaceNameInput"
                class="nh-input"
                type="text"
                placeholder="مثال: Simplicity Coffee أو NahlTime Demo"
              />
            </div>
            <div class="nh-inline-row fixed-left">
              <button
                id="btnCreateWorkspace"
                class="nh-btn nh-btn-primary"
                type="button"
              >
                إنشاء مساحة
              </button>
            </div>
          </div>

          <div class="nh-help-text">
            بإمكانك إنشاء أكثر من مساحة وتجربة حلول مختلفة داخل كل مساحة.
          </div>

          <div id="workspacesList" class="nh-list"></div>
          <div id="workspacesEmpty" class="nh-empty" style="display: none;">
            لا توجد مساحات بعد. ابدأ بإنشاء أول مساحة لك.
          </div>

          <div id="workspaceStatus" class="nh-status"></div>
        </div>

        <!-- Apps in selected workspace -->
        <div class="nh-card" style="margin-top: 10px;">
          <div class="nh-section-title-line">
            <div>
              <h3>التطبيقات المثبّتة في المساحة</h3>
              <span id="appsSubtitle"
                >اختر مساحة من القائمة أعلاه لعرض التطبيقات.</span
              >
            </div>
            <span class="nh-tag" id="currentWorkspaceTag">لا يوجد</span>
          </div>

          <div id="workspaceAppsList" class="nh-list"></div>
          <div
            id="workspaceAppsEmpty"
            class="nh-empty"
            style="display: none;"
          >
            لم يتم تثبيت أي تطبيق في هذه المساحة حتى الآن.
          </div>

          <div id="appsStatus" class="nh-status"></div>
        </div>

        <!-- Marketplace -->
        <div class="nh-card" style="margin-top: 10px;">
          <div class="nh-section-title-line">
            <div>
              <h3>متجر نحل هب (Marketplace)</h3>
              <span>ثبّت التطبيقات أو الحزم (Modules) داخل المساحة المحددة.</span>
            </div>
            <span class="nh-badge-plan">نسخة تجريبية</span>
          </div>

          <div class="nh-inline-row fixed-left" style="margin-top: 8px;">
            <button
              id="btnReloadMarketplace"
              class="nh-btn nh-btn-secondary nh-btn-xs"
              type="button"
            >
              تحديث قائمة المتجر
            </button>
            <span class="nh-help-text" style="margin-top: 0;">
              تأكد من اختيار مساحة عمل أولاً.
            </span>
          </div>

          <div id="marketplaceGrid" class="nh-market-grid"></div>
          <div
            id="marketplaceEmpty"
            class="nh-empty"
            style="display: none;"
          >
            لا توجد قوالب منشورة في المتجر حتى الآن.
          </div>

          <div id="marketplaceStatus" class="nh-status"></div>
        </div>

        <div class="nh-footer-note">
          NahlHub Hub – نسخة أولية للتجارب الداخلية. لأي ملاحظات تواصل مع
          فريق نحل.
        </div>
      </div>
    </div>
  </div>

  <script>
    // ==========================
    // Simple Frontend State
    // ==========================

    let currentSessionKey = null;
    let currentUser = null;
    let currentWorkspaceId = null;
    let currentLocale = "ar";

    function setLocale(locale) {
      currentLocale = locale === "en" ? "en" : "ar";
      const tabAr = document.getElementById("tabOtpAr");
      const tabEn = document.getElementById("tabOtpEn");
      if (tabAr && tabEn) {
        if (currentLocale === "ar") {
          tabAr.classList.add("active");
          tabEn.classList.remove("active");
        } else {
          tabEn.classList.add("active");
          tabAr.classList.remove("active");
        }
      }
    }

    function setLoading(buttonId, loading) {
      const btn = document.getElementById(buttonId);
      if (!btn) return;
      if (loading) {
        btn.disabled = true;
        if (!btn.dataset.originalText) {
          btn.dataset.originalText = btn.innerText;
        }
        btn.innerText = "جارٍ التنفيذ...";
      } else {
        btn.disabled = false;
        if (btn.dataset.originalText) {
          btn.innerText = btn.dataset.originalText;
        }
      }
    }

    function showStatus(elId, message, ok) {
      const el = document.getElementById(elId);
      if (!el) return;
      if (!message) {
        el.style.display = "none";
        el.classList.remove("ok", "err");
        el.innerText = "";
        return;
      }
      el.style.display = "block";
      el.classList.remove("ok", "err");
      el.classList.add(ok ? "ok" : "err");
      el.innerText = message;
    }

    function updateAuthBadge() {
      const dot = document.getElementById("authStateDot");
      const label = document.getElementById("authStateLabel");
      const chip = document.getElementById("sessionChip");
      if (!dot || !label || !chip) return;

      if (currentSessionKey && currentUser) {
        dot.classList.remove("off");
        label.innerText = "مسجل الدخول";
        chip.style.display = "block";
        chip.innerText = "session: " + currentSessionKey;
      } else {
        dot.classList.add("off");
        label.innerText = "غير مسجل";
        chip.style.display = "none";
        chip.innerText = "session: –";
      }
    }

    function showLoggedInUI(show) {
      const appView = document.getElementById("appView");
      const userCard = document.getElementById("userCard");
      if (!appView || !userCard) return;
      appView.style.display = show ? "block" : "none";
      userCard.style.display = show ? "block" : "none";
    }

    function updateUserCard() {
      const nameEl = document.getElementById("userNameLabel");
      const mobileEl = document.getElementById("userMobileLabel");
      const idEl = document.getElementById("userIdLabel");
      if (!currentUser) {
        if (nameEl) nameEl.innerText = "—";
        if (mobileEl) mobileEl.innerText = "—";
        if (idEl) idEl.innerText = "—";
        return;
      }
      if (nameEl) nameEl.innerText = currentUser.name || "—";
      if (mobileEl)
        mobileEl.innerText = currentUser.mobile || "—";
      if (idEl) idEl.innerText = currentUser.userId || "—";
    }

    // ==========================
    // API Helper
    // ==========================

    async function callHub(action, payload) {
      const body = Object.assign({}, payload || {}, { action });
      const res = await fetch("/api/hub/manage", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });
      const text = await res.text();
      let data;
      try {
        data = JSON.parse(text);
      } catch (err) {
        console.error("Non-JSON response:", text);
        throw new Error("Unexpected response from backend.");
      }
      if (!res.ok) {
        throw new Error(data.error || "Backend error");
      }
      return data;
    }

    // ==========================
    // Auth Flow (Mobile + OTP)
    // ==========================

    async function handleSendOtp() {
      const mobileInput = document.getElementById("mobileInput");
      const otpCard = document.getElementById("otpCard");
      if (!mobileInput) return;

      const rawMobile = (mobileInput.value || "").trim();
      if (!rawMobile) {
        showStatus("otpStatus", "الرجاء إدخال رقم الجوال أولاً.", false);
        return;
      }

      showStatus("otpStatus", "", true);
      showStatus("verifyStatus", "", true);
      setLoading("btnSendOtp", true);

      try {
        const result = await callHub("sendOtp", { mobile: rawMobile });

        if (!result || result.success === false) {
          showStatus(
            "otpStatus",
            result && result.error
              ? result.error
              : "تعذر إرسال الرمز. حاول مرة أخرى.",
            false
          );
          return;
        }

        let msg =
          "✅ تم إنشاء رمز الدخول.\nتحقق من واتساب / الرسائل خلال لحظات.";
        if (result.whatsappSent === false && result.whatsappError) {
          msg +=
            "\n\n⚠️ لم نستطع الإرسال عبر واتساب تلقائيًا، لكن تم إنشاء الرمز ويمكن استخدامه لوصلك بأي طريقة أخرى.";
        }

        showStatus("otpStatus", msg, true);
        if (otpCard) otpCard.style.display = "block";
        document.getElementById("otpInput").focus();
      } catch (err) {
        console.error("sendOtp error:", err);
        showStatus(
          "otpStatus",
          "حدث خطأ غير متوقع أثناء إرسال الرمز. حاول مرة أخرى.",
          false
        );
      } finally {
        setLoading("btnSendOtp", false);
      }
    }

    async function handleVerifyOtp() {
      const mobileInput = document.getElementById("mobileInput");
      const otpInput = document.getElementById("otpInput");
      if (!mobileInput || !otpInput) return;

      const mobile = (mobileInput.value || "").trim();
      const otp = (otpInput.value || "").trim();

      if (!mobile || !otp) {
        showStatus(
          "verifyStatus",
          "الرجاء إدخال رقم الجوال والرمز.",
          false
        );
        return;
      }

      showStatus("verifyStatus", "", true);
      setLoading("btnVerifyOtp", true);

      try {
        const result = await callHub("verifyOtp", { mobile, otp });

        if (!result || result.success === false) {
          showStatus(
            "verifyStatus",
            result && result.error
              ? result.error
              : "تعذر التحقق من الرمز. حاول مرة أخرى.",
            false
          );
          return;
        }

        currentSessionKey = result.sessionKey || null;
        currentUser = result.user || null;
        updateAuthBadge();
        updateUserCard();
        showLoggedInUI(true);

        showStatus(
          "verifyStatus",
          "✅ تم التحقق من الرمز وتسجيل الدخول بنجاح.",
          true
        );
        showStatus(
          "otpStatus",
          "يمكنك الآن إدارة المساحات والتطبيقات من العمود الأيمن.",
          true
        );

        await refreshAuthMe();
        await loadWorkspaces();
      } catch (err) {
        console.error("verifyOtp error:", err);
        showStatus(
          "verifyStatus",
          "حدث خطأ غير متوقع أثناء التحقق من الرمز.",
          false
        );
      } finally {
        setLoading("btnVerifyOtp", false);
      }
    }

    async function refreshAuthMe() {
      if (!currentSessionKey) return;
      try {
        const result = await callHub("auth.me", {
          sessionKey: currentSessionKey,
        });
        if (!result || result.success === false) {
          console.warn("auth.me failed:", result);
          return;
        }
        currentUser = result.user || currentUser;
        updateUserCard();
      } catch (err) {
        console.warn("auth.me error:", err);
      }
    }

    async function handleLogout() {
      if (currentSessionKey) {
        try {
          await callHub("auth.logout", {
            sessionKey: currentSessionKey,
          });
        } catch (err) {
          console.warn("logout error:", err);
        }
      }
      currentSessionKey = null;
      currentUser = null;
      currentWorkspaceId = null;
      updateAuthBadge();
      updateUserCard();
      showLoggedInUI(false);
      clearWorkspacesUI();
      clearAppsUI();
      clearMarketplaceUI();
      showStatus("otpStatus", "", true);
      showStatus("verifyStatus", "", true);
      showStatus("workspaceStatus", "", true);
      showStatus("appsStatus", "", true);
      showStatus("marketplaceStatus", "", true);
    }

    function clearAuthFields() {
      const mobileInput = document.getElementById("mobileInput");
      const otpInput = document.getElementById("otpInput");
      if (mobileInput) mobileInput.value = "";
      if (otpInput) otpInput.value = "";
      showStatus("otpStatus", "", true);
      showStatus("verifyStatus", "", true);
    }

    // ==========================
    // Workspaces
    // ==========================

    function clearWorkspacesUI() {
      const list = document.getElementById("workspacesList");
      const empty = document.getElementById("workspacesEmpty");
      if (list) list.innerHTML = "";
      if (empty) empty.style.display = "none";
    }

    async function loadWorkspaces() {
      clearWorkspacesUI();
      showStatus("workspaceStatus", "", true);

      if (!currentUser || !currentUser.userId) {
        showStatus(
          "workspaceStatus",
          "الرجاء تسجيل الدخول أولاً.",
          false
        );
        return;
      }

      try {
        const result = await callHub("workspace.listForUser", {
          userId: currentUser.userId,
        });

        const items = (result && result.items) || [];
        const list = document.getElementById("workspacesList");
        const empty = document.getElementById("workspacesEmpty");
        if (!list || !empty) return;

        if (items.length === 0) {
          empty.style.display = "block";
          return;
        }

        empty.style.display = "none";
        list.innerHTML = "";

        items.forEach((ws) => {
          const el = document.createElement("div");
          el.className = "nh-list-item";
          el.dataset.wsId = ws.workspaceId;

          const title = document.createElement("div");
          title.className = "nh-list-item-title";
          title.innerText = ws.name || "بدون اسم";

          const meta = document.createElement("div");
          meta.className = "nh-list-item-meta";

          const slug = document.createElement("span");
          slug.innerText = "slug: " + (ws.slug || "—");
          meta.appendChild(slug);

          const role = document.createElement("span");
          role.className = "nh-tag";
          role.innerText = ws.role === "admin" ? "مدير المساحة" : "عضو";
          meta.appendChild(role);

          const plan = document.createElement("span");
          plan.className = "nh-tag";
          plan.innerText = "الخطة: " + (ws.plan || "free");
          meta.appendChild(plan);

          el.appendChild(title);
          el.appendChild(meta);

          el.addEventListener("click", () => {
            selectWorkspace(ws.workspaceId, ws.name, ws.plan);
          });

          list.appendChild(el);
        });

        // Keep selection state if exists
        if (currentWorkspaceId) {
          highlightSelectedWorkspace();
        }
      } catch (err) {
        console.error("loadWorkspaces error:", err);
        showStatus(
          "workspaceStatus",
          "تعذر تحميل المساحات. حاول مرة أخرى.",
          false
        );
      }
    }

    function highlightSelectedWorkspace() {
      const list = document.getElementById("workspacesList");
      if (!list) return;
      const children = Array.from(list.children);
      children.forEach((el) => {
        if (el.dataset.wsId === currentWorkspaceId) {
          el.classList.add("active");
        } else {
          el.classList.remove("active");
        }
      });
    }

    async function selectWorkspace(wsId, name, plan) {
      currentWorkspaceId = wsId;
      highlightSelectedWorkspace();

      const wsTag = document.getElementById("currentWorkspaceTag");
      if (wsTag) {
        wsTag.innerText = name || "بدون اسم";
      }

      const appsSubtitle = document.getElementById("appsSubtitle");
      if (appsSubtitle) {
        appsSubtitle.innerText =
          "التطبيقات المرتبطة بالمساحة: " + (name || wsId);
      }

      showStatus("appsStatus", "", true);
      showStatus("marketplaceStatus", "", true);
      await loadWorkspaceApps();
      await loadMarketplace();
    }

    async function handleCreateWorkspace() {
      const nameInput = document.getElementById("workspaceNameInput");
      if (!nameInput || !currentUser) return;

      const name = (nameInput.value || "").trim();
      if (!name) {
        showStatus(
          "workspaceStatus",
          "الرجاء إدخال اسم للمساحة قبل الإنشاء.",
          false
        );
        return;
      }

      setLoading("btnCreateWorkspace", true);
      showStatus("workspaceStatus", "", true);

      try {
        const result = await callHub("workspace.create", {
          userId: currentUser.userId,
          name,
          plan: "free",
        });

        if (!result || result.success === false) {
          showStatus(
            "workspaceStatus",
            result && result.error
              ? result.error
              : "تعذر إنشاء المساحة. حاول مرة أخرى.",
            false
          );
          return;
        }

        showStatus(
          "workspaceStatus",
          "✅ تم إنشاء المساحة بنجاح.",
          true
        );
        nameInput.value = "";
        await loadWorkspaces();
      } catch (err) {
        console.error("create workspace error:", err);
        showStatus(
          "workspaceStatus",
          "حدث خطأ غير متوقع أثناء إنشاء المساحة.",
          false
        );
      } finally {
        setLoading("btnCreateWorkspace", false);
      }
    }

    // ==========================
    // Workspace Apps
    // ==========================

    function clearAppsUI() {
      const list = document.getElementById("workspaceAppsList");
      const empty = document.getElementById("workspaceAppsEmpty");
      if (list) list.innerHTML = "";
      if (empty) empty.style.display = "none";
    }

    async function loadWorkspaceApps() {
      clearAppsUI();
      if (!currentWorkspaceId) {
        showStatus(
          "appsStatus",
          "اختر مساحة من الأعلى لعرض التطبيقات.",
          false
        );
        return;
      }

      try {
        const result = await callHub("marketplace.listWorkspaceApps", {
          workspaceId: currentWorkspaceId,
        });

        const items = (result && result.items) || [];
        const list = document.getElementById("workspaceAppsList");
        const empty = document.getElementById("workspaceAppsEmpty");
        if (!list || !empty) return;

        if (items.length === 0) {
          empty.style.display = "block";
          return;
        }

        empty.style.display = "none";
        list.innerHTML = "";

        items.forEach((app) => {
          const el = document.createElement("div");
          el.className = "nh-list-item";

          const title = document.createElement("div");
          title.className = "nh-list-item-title";
          title.innerText = app.nameAr || app.nameEn || "App";

          const meta = document.createElement("div");
          meta.className = "nh-list-item-meta";

          const idSpan = document.createElement("span");
          idSpan.innerText = "AppId: " + (app.appId || "—");
          meta.appendChild(idSpan);

          const tplSpan = document.createElement("span");
          tplSpan.className = "nh-tag";
          tplSpan.innerText = "Template: " + (app.templateId || "—");
          meta.appendChild(tplSpan);

          const statusSpan = document.createElement("span");
          statusSpan.className = "nh-tag";
          statusSpan.innerText = "Status: " + (app.status || "installed");
          meta.appendChild(statusSpan);

          el.appendChild(title);
          el.appendChild(meta);
          list.appendChild(el);
        });
      } catch (err) {
        console.error("loadWorkspaceApps error:", err);
        showStatus(
          "appsStatus",
          "تعذر تحميل التطبيقات المثبّتة.",
          false
        );
      }
    }

    // ==========================
    // Marketplace
    // ==========================

    function clearMarketplaceUI() {
      const grid = document.getElementById("marketplaceGrid");
      const empty = document.getElementById("marketplaceEmpty");
      if (grid) grid.innerHTML = "";
      if (empty) empty.style.display = "none";
    }

    async function loadMarketplace() {
      clearMarketplaceUI();

      if (!currentWorkspaceId) {
        showStatus(
          "marketplaceStatus",
          "اختر مساحة عمل لعرض المتجر.",
          false
        );
        return;
      }

      try {
        const result = await callHub("marketplace.listTemplates", {
          workspaceId: currentWorkspaceId,
        });

        const items = (result && result.items) || [];
        const grid = document.getElementById("marketplaceGrid");
        const empty = document.getElementById("marketplaceEmpty");
        if (!grid || !empty) return;

        if (items.length === 0) {
          empty.style.display = "block";
          return;
        }

        empty.style.display = "none";
        grid.innerHTML = "";

        items.forEach((tpl) => {
          const card = document.createElement("div");
          card.className = "nh-market-item";

          const titleRow = document.createElement("div");
          titleRow.className = "nh-market-title-row";

          const title = document.createElement("div");
          title.className = "nh-market-title";
          const displayName =
            currentLocale === "en"
              ? tpl.nameEn || tpl.nameAr
              : tpl.nameAr || tpl.nameEn;
          title.innerText = displayName || tpl.code || "Template";

          const typeTag = document.createElement("span");
          typeTag.className = "nh-tag";
          typeTag.innerText =
            tpl.type === "module" ? "Module" : "App";

          titleRow.appendChild(title);
          titleRow.appendChild(typeTag);

          const desc = document.createElement("div");
          desc.className = "nh-market-desc";
          const descText =
            currentLocale === "en"
              ? tpl.shortDescEn || tpl.descriptionEn || ""
              : tpl.shortDescAr || tpl.descriptionAr || "";
          desc.innerText =
            descText || "بدون وصف مختصر لهذا القالب حاليًا.";

          const footer = document.createElement("div");
          footer.className = "nh-market-footer";

          const left = document.createElement("div");
          left.style.display = "flex";
          left.style.flexDirection = "column";
          left.style.gap = "2px";

          if (tpl.category) {
            const cat = document.createElement("span");
            cat.className = "nh-tag";
            cat.innerText = tpl.category;
            left.appendChild(cat);
          }

          if (tpl.planRequired) {
            const plan = document.createElement("span");
            plan.className = "nh-tag";
            plan.innerText = "Plan: " + tpl.planRequired;
            left.appendChild(plan);
          }

          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "nh-btn nh-btn-primary nh-btn-xs";
          btn.innerText = tpl.installed ? "مثبّت" : "تثبيت";
          btn.disabled = !!tpl.installed;

          btn.addEventListener("click", () => {
            handleInstallTemplate(tpl);
          });

          footer.appendChild(left);
          footer.appendChild(btn);

          card.appendChild(titleRow);
          card.appendChild(desc);
          card.appendChild(footer);

          grid.appendChild(card);
        });
      } catch (err) {
        console.error("loadMarketplace error:", err);
        showStatus(
          "marketplaceStatus",
          "تعذر تحميل المتجر. حاول مرة أخرى.",
          false
        );
      }
    }

    async function handleInstallTemplate(tpl) {
      if (!currentWorkspaceId || !currentUser) {
        showStatus(
          "marketplaceStatus",
          "الرجاء اختيار مساحة وتسجيل الدخول.",
          false
        );
        return;
      }

      showStatus("marketplaceStatus", "", true);

      try {
        const result = await callHub("marketplace.install", {
          workspaceId: currentWorkspaceId,
          templateId: tpl.templateId,
          userId: currentUser.userId,
        });

        if (!result || result.success === false) {
          showStatus(
            "marketplaceStatus",
            result && result.error
              ? result.error
              : "تعذر تثبيت القالب.",
            false
          );
          return;
        }

        showStatus(
          "marketplaceStatus",
          "✅ تم تثبيت القالب/الحزمة بنجاح.",
          true
        );
        await loadWorkspaceApps();
        await loadMarketplace();
      } catch (err) {
        console.error("install template error:", err);
        showStatus(
          "marketplaceStatus",
          "حدث خطأ أثناء تثبيت القالب.",
          false
        );
      }
    }

    // ==========================
    // DOM Events
    // ==========================

    document.addEventListener("DOMContentLoaded", () => {
      updateAuthBadge();
      showLoggedInUI(false);

      const btnSendOtp = document.getElementById("btnSendOtp");
      const btnVerifyOtp = document.getElementById("btnVerifyOtp");
      const btnResendOtp = document.getElementById("btnResendOtp");
      const btnLogout = document.getElementById("btnLogout");
      const btnClearAuth = document.getElementById("btnClearAuth");
      const btnCreateWorkspace = document.getElementById(
        "btnCreateWorkspace"
      );
      const btnReloadWorkspaces = document.getElementById(
        "btnReloadWorkspaces"
      );
      const btnReloadMarketplace = document.getElementById(
        "btnReloadMarketplace"
      );

      if (btnSendOtp) btnSendOtp.addEventListener("click", handleSendOtp);
      if (btnVerifyOtp)
        btnVerifyOtp.addEventListener("click", handleVerifyOtp);
      if (btnResendOtp)
        btnResendOtp.addEventListener("click", handleSendOtp);
      if (btnLogout) btnLogout.addEventListener("click", handleLogout);
      if (btnClearAuth)
        btnClearAuth.addEventListener("click", clearAuthFields);
      if (btnCreateWorkspace)
        btnCreateWorkspace.addEventListener(
          "click",
          handleCreateWorkspace
        );
      if (btnReloadWorkspaces)
        btnReloadWorkspaces.addEventListener("click", loadWorkspaces);
      if (btnReloadMarketplace)
        btnReloadMarketplace.addEventListener("click", loadMarketplace);

      // Enter key for OTP
      const otpInput = document.getElementById("otpInput");
      if (otpInput) {
        otpInput.addEventListener("keyup", (e) => {
          if (e.key === "Enter") handleVerifyOtp();
        });
      }
    });
  </script>
</body>
</html>
